id: dev.diff_risk_tags_v1
version: 1.0.0
domain: dev
title: Diff-Derived Risk Tags are Addressed in Review
statement: 'Compute risk tags from the diff and require the review to explicitly address
  each tag.

  Tags include (non-exhaustive): security, performance, migration, breaking, dependency,

  infrastructure, tests, docs. Review must mention each inferred tag.'
witnesses:
- name: pr_review_covers_risks
  language: python
  entrypoint: python3
  args: []
  env:
    REVIEW_PATH: artifacts/examples/dev/pr_review_good.md
    DIFF_PATH: artifacts/examples/dev/pr_diff.patch
  timeout_ms: 5000
  memory_mb: 128
  net: false
  fs_mode: ro
  code: "import os, re, json, sys\n\ndef read(path):\n    with open(path, \"r\", errors=\"\
    ignore\") as f:\n        return f.read()\n\nTAG_PATTERNS = {\n    \"security\"\
    : [r\"\\bauth\\b\", r\"\\bjwt\\b\", r\"\\bxss\\b\", r\"\\bcsrf\\b\", r\"\\bencrypt\"\
    , r\"\\bsecret\\b\", r\"\\btoken\\b\", r\"\\bhash\\b\", r\"\\baes\\b\", r\"\\\
    brsa\\b\"],\n    \"performance\": [r\"\\bO\\([Nn]\\)\", r\"\\bhot path\\b\", r\"\
    \\blatency\\b\", r\"\\bthroughput\\b\", r\"\\bcach\", r\"\\balloc\"],\n    # Migration:\
    \ require SQL-ish context or migration frameworks/paths (NO plain 'index')\n \
    \   \"migration\": [\n        r\"\\bmigrations?/\", r\"\\b(alembic|flyway|liquibase)\\\
    b\",\n        r\"\\bcreate\\s+(table|index)\\b\", r\"\\bdrop\\s+(column|table|index)\\\
    b\",\n        r\"\\balter\\s+table\\b\", r\"\\bddl\\b\", r\"\\bschema\\b\"\n \
    \   ],\n    \"breaking\": [r\"BREAKING CHANGE\", r\"\\brename\\b\", r\"\\bremove\
    \ public\\b\", r\"\\bsignature\\b\", r\"\\bsemver[- ]?major\\b\"],\n    \"dependency\"\
    : [r\"package\\.json\", r\"requirements\\.txt\", r\"poetry\\.lock\", r\"yarn\\\
    .lock\", r\"pnpm-lock\", r\"go\\.mod\", r\"Cargo\\.toml\"],\n    \"infrastructure\"\
    : [r\"Dockerfile\", r\"\\bk8s\\b\", r\"helm\", r\"terraform\", r\"ansible\", r\"\
    systemd\"],\n    \"tests\": [r\"\\btests?/\", r\"\\btest\", r\"\\bspec\\b\", r\"\
    \\bfixture\\b\", r\"\\bcoverage\\b\"],\n    \"docs\": [r\"README\", r\"\\bdocs?/\"\
    , r\"\\.md\\b\"]\n}\n\ndef infer_tags_from_diff(diff_text):\n    tags = set()\n\
    \    lowered = diff_text.lower()\n    for tag, pats in TAG_PATTERNS.items():\n\
    \        for pat in pats:\n            if re.search(pat, lowered):\n         \
    \       tags.add(tag); break\n    return sorted(tags)\n\ndef tags_in_text(text):\n\
    \    found = set()\n    for tag in TAG_PATTERNS.keys():\n        if re.search(rf\"\
    \\b{tag}\\b\", text, flags=re.I):\n            found.add(tag)\n    m = re.search(r\"\
    tags?\\s*:\\s*([a-z, ]+)\", text, flags=re.I)\n    if m:\n        for t in re.split(r\"\
    [, ]+\", m.group(1).strip()):\n            if t.lower() in TAG_PATTERNS.keys():\n\
    \                found.add(t.lower())\n    return sorted(found)\n\ndef main():\n\
    \    review_path = os.environ.get(\"REVIEW_PATH\", \"artifacts/examples/dev/pr_review_good.md\"\
    )\n    diff_path = os.environ.get(\"DIFF_PATH\", \"artifacts/examples/dev/pr_diff.patch\"\
    )\n    if os.path.isdir(review_path): review_path = os.path.join(review_path,\
    \ \"pr_review_good.md\")\n    if os.path.isdir(diff_path):   diff_path   = os.path.join(diff_path,\
    \ \"pr_diff.patch\")\n\n    diff_text = read(diff_path)\n    review_text = read(review_path)\n\
    \n    needed  = infer_tags_from_diff(diff_text)\n    present = tags_in_text(review_text)\n\
    \    missing = [t for t in needed if t not in present]\n\n    print(json.dumps({\n\
    \        \"ok\": len(missing) == 0,\n        \"needed\": needed, \"present\":\
    \ present, \"missing\": missing,\n        \"review\": review_path, \"diff\": diff_path\n\
    \    }, indent=2))\n    sys.exit(0 if not missing else 1)\n\nif __name__ == \"\
    __main__\":\n    main()"
provenance:
  schema: provenance.v1
  author: John Macgregor
  org: Truth Capsules Demo
  license: MIT
  source_url: https://example.com/truth-capsules/dev
  created: '2025-11-10T20:25:00Z'
  updated: '2025-11-10T20:25:00Z'
  review:
    status: draft
    reviewers: []
    last_reviewed: null
  signing:
    method: ed25519
    key_id: null
    pubkey: null
    digest: 00a78d5d211e962ef712935c3db5c91a9a80845c5a849dbb6f4c3920da30f598
    signature: null
applies_to:
- conversation
- code_assistant
- review
security:
  sensitivity: medium
  notes: ''
