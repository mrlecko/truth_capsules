id: dev.enforce_todo_ticket_v1
version: 1.0.0
domain: dev
title: TODO/FIXME Must Reference a Ticket
statement: |-
  Any added TODO/FIXME in the diff must include a ticket reference matching TICKET_REGEX.
  Default regex targets common trackers like ABC-123, PROJ-42, etc.

witnesses:
  - name: todo_refs_present
    language: python
    entrypoint: python3
    args: []
    env:
      DIFF_PATH: artifacts/examples/dev/pr_diff.patch
      TICKET_REGEX: "[A-Z]{2,10}-\d+"
    timeout_ms: 5000
    memory_mb: 128
    net: false
    fs_mode: ro
    code: |-
      import os, re, json, sys

      def read(path):
          with open(path, "r", errors="ignore") as f:
              return f.readlines()

      def main():
          diff_path = os.environ.get("DIFF_PATH", "artifacts/examples/dev/pr_diff.patch")
          ticket_regex = os.environ.get("TICKET_REGEX", r"[A-Z]{2,10}-\d+")
          rx_ticket = re.compile(ticket_regex)

          if os.path.isdir(diff_path):
              diff_path = os.path.join(diff_path, "pr_diff.patch")

          lines = read(diff_path)
          violations = []
          for line in lines:
              if not line.startswith("+") or line.startswith("+++ "):
                  continue
              if re.search(r"\b(TODO|FIXME)\b", line, flags=re.I):
                  if not rx_ticket.search(line):
                      violations.append(line.strip())

          result = {"ok": len(violations) == 0, "missing_ticket_refs": violations, "diff": diff_path, "ticket_regex": ticket_regex}
          print(json.dumps(result, indent=2))
          sys.exit(0 if result["ok"] else 1)

      if __name__ == "__main__":
          main()
provenance:
  schema: provenance.v1
  author: John Macgregor
  org: Truth Capsules Demo
  license: MIT
  source_url: https://example.com/truth-capsules/dev
  created: '2025-11-10T20:25:00Z'
  updated: '2025-11-10T20:25:00Z'
  review:
    status: draft
    reviewers: []
    last_reviewed: null
  signing:
    method: ed25519
    key_id: null
    pubkey: null
    digest: null
    signature: null
applies_to:
- conversation
- code_assistant
- review
security:
  sensitivity: medium
  notes: ""
