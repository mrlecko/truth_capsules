id: dev.secret_scan_baseline_v1
version: 1.0.0
domain: dev
title: Secret Scan Baseline (No Keys, No High-Entropy Blobs)
statement: |-
  Scan source tree for obvious secrets and high-entropy blobs. Skip vendor and binary paths.
  Fail on suspected credentials or suspicious entropy across text files.

witnesses:
  - name: no_high_entropy_or_keys
    language: python
    entrypoint: python3
    args: []
    env:
      REPO_PATH: artifacts/examples/dev/repo_demo
    timeout_ms: 8000
    memory_mb: 256
    net: false
    fs_mode: ro
    code: |-
      import os, re, sys, json, math

      SKIP_DIRS = {".git", "node_modules", "dist", "build", "vendor", "__pycache__", ".venv", "venv", ".idea", ".vscode", ".cache", ".next"}
      SKIP_FILE_EXT = {".png", ".jpg", ".jpeg", ".gif", ".webp", ".pdf", ".ico", ".lockb", ".woff", ".woff2", ".ttf", ".otf", ".zip", ".gz", ".bz2", ".7z", ".jar", ".min.js"}
      ALLOWLIST_NAMES = {".env.example", "config.sample", "secrets.example", "example.env"}

      KEY_PATTERNS = {
          "aws_access_key": re.compile(r"AKIA[0-9A-Z]{16}"),
          "aws_secret_key": re.compile(r"(?i)aws(.{0,20})?(secret|access).{0,20}?[:=]\s*['\"]?[A-Za-z0-9/+=]{40}"),
          "gh_token": re.compile(r"ghp_[A-Za-z0-9]{36,}"),
          "slack_token": re.compile(r"xox[baprs]-[A-Za-z0-9-]{10,48}"),
          "gcp_json_key": re.compile(r'"private_key":\s*"-----BEGIN PRIVATE KEY-----'),
          "private_key_block": re.compile(r"-----BEGIN (?:RSA|EC|DSA|OPENSSH) PRIVATE KEY-----"),
      }

      def shannon_entropy(s):
          if not s:
              return 0.0
          freq = { }
          for ch in s:
              freq[ch] = freq.get(ch, 0) + 1
          ent = 0.0
          n = len(s)
          for c in freq.values():
              p = c / n
              ent -= p * math.log2(p)
          return ent

      def scan_file(path):
          findings = []
          try:
              with open(path, "r", errors="ignore") as f:
                  for ln, line in enumerate(f, 1):
                      for name, rx in KEY_PATTERNS.items():
                          if rx.search(line):
                              if os.path.basename(path) in ALLOWLIST_NAMES:
                                  continue
                              findings.append({"file": path, "line": ln, "kind": name, "value": line.strip(), "severity": "high"})
                      tokens = re.findall(r"[A-Za-z0-9_\-/+=]{20,}", line)
                      for tok in tokens:
                          ent = shannon_entropy(tok)
                          if ent >= 4.5 and not tok.islower() and not tok.isupper():
                              if "/" in tok and ":" in tok:
                                  continue
                              findings.append({"file": path, "line": ln, "kind": "high_entropy", "value": tok[:64], "entropy": ent, "severity": "high"})
          except Exception as e:
              findings.append({"file": path, "error": str(e), "severity": "info"})
          return findings

      def main():
          root = os.environ.get("REPO_PATH", "artifacts/examples/dev/repo_demo")
          if os.path.isfile(root):
              root = os.path.dirname(root)

          results = []
          for dirpath, dirnames, filenames in os.walk(root):
              dirnames[:] = [d for d in dirnames if d not in SKIP_DIRS]
              for fn in filenames:
                  if os.path.splitext(fn)[1].lower() in SKIP_FILE_EXT:
                      continue
                  if fn in ALLOWLIST_NAMES:
                      continue
                  path = os.path.join(dirpath, fn)
                  results.extend(scan_file(path))

          fail = any(f.get("severity") == "high" for f in results)
          print(json.dumps({"ok": not fail, "findings": results, "scanned_root": root}, indent=2))
          sys.exit(0 if not fail else 1)

      if __name__ == "__main__":
          main()
provenance:
  schema: provenance.v1
  author: John Macgregor
  org: Truth Capsules Demo
  license: MIT
  source_url: https://example.com/truth-capsules/dev
  created: '2025-11-10T20:25:00Z'
  updated: '2025-11-10T20:25:00Z'
  review:
    status: draft
    reviewers: []
    last_reviewed: null
  signing:
    method: ed25519
    key_id: null
    pubkey: null
    digest: null
    signature: null
applies_to:
- conversation
- code_assistant
- review
security:
  sensitivity: medium
  notes: ""
