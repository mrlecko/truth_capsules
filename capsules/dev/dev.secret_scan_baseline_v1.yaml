id: dev.secret_scan_baseline_v1
version: 1.0.0
domain: dev
title: Secret Scan Baseline (No Keys, No High-Entropy Blobs)
statement: |-
  Scan source tree for obvious secrets and high-entropy blobs. Skip vendor and binary paths.
  Fail on suspected credentials or suspicious entropy across text files.
witnesses:
  - name: no_high_entropy_or_keys
    language: python
    entrypoint: python3
    args: []
    env:
      REPO_PATH: .
      # Scan only code-ish files by default; you can widen with INCLUDE_GLOBS_JSON
      INCLUDE_GLOBS_JSON: '["**/*.py","**/*.js","**/*.ts","**/*.go","**/*.rs","**/*.java","**/*.sh","**/*.yaml","**/*.yml","**/*.toml","**/*.ini","**/*.cfg","**/*.conf"]'
      # Skip heavy/noisy dirs/files
      EXCLUDE_GLOBS_JSON: '["**/.env*","**/out/**","**/dist/**","**/build/**","**/node_modules/**","**/.git/**","**/__pycache__/**","**/*.json","**/*.ndjson","**/*.ttl","**/*.md"]'
      SKIP_DIRS_JSON: '[".git","node_modules","venv",".venv",".cache","dist","build","__pycache__"]'
      MAX_FILES: "2000"
      MAX_FILE_BYTES: "200000"
      ENTROPY_THRESHOLD: "5.2"             # higher to avoid “normal text” trips
      # Candidate token pattern: long base64/hex-ish strings
      TOKEN_MINLEN: "20"
      KEY_REGEXES_JSON: |
        [
          "(?i)aws[_-]?access[_-]?key[_-]?id",
          "(?i)aws[_-]?secret[_-]?access[_-]?key",
          "(?i)gh[_-]?token|github[_-]?token",
          "(?i)slack[_-]?(token|webhook)",
          "(?i)api[_-]?key|secret[_-]?key|private[_-]?key",
          "-----BEGIN\\s+PRIVATE\\s+KEY-----"
        ]
    timeout_ms: 8000
    memory_mb: 256
    net: false
    fs_mode: ro
    code: |-
      import os, sys, json, math, fnmatch, re

      def env_json(name, default):
          try: return json.loads(os.environ.get(name, json.dumps(default)))
          except Exception: return default

      def env_int(name, default):
          try: return int(os.environ.get(name, str(default)))
          except Exception: return default

      def env_float(name, default):
          try: return float(os.environ.get(name, str(default)))
          except Exception: return default

      def shannon_entropy(s):
          if not s: return 0.0
          freq = {}
          for ch in s: freq[ch] = freq.get(ch, 0) + 1
          H = 0.0
          ln = len(s)
          for c in freq.values():
              p = c / ln
              H -= p * math.log2(p)
          return H

      def looks_binary(b):
          return (b.count(b"\x00") > 0) or any(c < 9 for c in b[:64])

      def read_limited(path, max_bytes):
          with open(path, "rb") as f: return f.read(max_bytes)

      def match_any_glob(path, globs):
          return any(fnmatch.fnmatch(path, g) for g in globs)

      def main():
          root = os.environ.get("REPO_PATH", ".")
          include_globs = env_json("INCLUDE_GLOBS_JSON", [])
          exclude_globs = env_json("EXCLUDE_GLOBS_JSON", [])
          skip_dirs = set(env_json("SKIP_DIRS_JSON", []))
          max_files = env_int("MAX_FILES", 2000)
          max_bytes = env_int("MAX_FILE_BYTES", 200000)
          thr = env_float("ENTROPY_THRESHOLD", 5.2)
          token_min = env_int("TOKEN_MINLEN", 20)
          key_res = [re.compile(p) for p in env_json("KEY_REGEXES_JSON", [])]
          token_re = re.compile(rf"[A-Za-z0-9+/=_-]{{{token_min},}}")

          findings, scanned = [], 0

          for cur, dirs, files in os.walk(root):
              dirs[:] = [d for d in dirs if os.path.join(cur, d).split(os.sep)[-1] not in skip_dirs]
              for name in files:
                  rel = os.path.relpath(os.path.join(cur, name), root)
                  if exclude_globs and match_any_glob(rel, exclude_globs): continue
                  if include_globs and not match_any_glob(rel, include_globs): continue

                  scanned += 1
                  if scanned > max_files:
                      findings.append({"limit": "max_files_reached", "scanned": scanned})
                      break

                  try: data = read_limited(os.path.join(root, rel), max_bytes)
                  except Exception: continue
                  if looks_binary(data): continue

                  try: text = data.decode("utf-8", "ignore")
                  except Exception: continue

                  # Regex hits (keys/secrets style)
                  regex_hits = []
                  for rx in key_res:
                      if rx.search(text):
                          regex_hits.append(rx.pattern)

                  # Token-level entropy (not whole file): find long base64/hex-ish substrings
                  token_hits = []
                  for tok in token_re.findall(text):
                      H = shannon_entropy(tok)
                      if H >= thr:
                          token_hits.append({"token_len": len(tok), "entropy": round(H, 3)})

                  if regex_hits or token_hits:
                      findings.append({
                          "file": rel,
                          "regex_hits": regex_hits,
                          "token_hits": token_hits[:5]
                      })

              if scanned > max_files: break

          ok = len([f for f in findings if "file" in f]) == 0
          out = {
              "ok": ok,
              "findings": findings[:50],
              "scanned_files": scanned,
              "root": root,
              "limits": {
                  "max_files": max_files,
                  "max_file_bytes": max_bytes,
                  "entropy_threshold": thr,
                  "token_minlen": token_min
              },
              "skipped_dirs": sorted(skip_dirs),
              "include_globs": include_globs,
              "exclude_globs": exclude_globs
          }
          print(json.dumps(out, indent=2))
          sys.exit(0 if ok else 1)

      if __name__ == "__main__":
          main()

provenance:
  schema: provenance.v1
  author: John Macgregor
  org: Truth Capsules Demo
  license: MIT
  source_url: https://example.com/truth-capsules/dev
  created: '2025-11-10T20:25:00Z'
  updated: '2025-11-10T20:25:00Z'
  review:
    status: draft
    reviewers: []
    last_reviewed: null
  signing:
    method: ed25519
    key_id: null
    pubkey: null
    digest: null
    signature: null
applies_to:
- conversation
- code_assistant
- review
security:
  sensitivity: medium
  notes: ""
