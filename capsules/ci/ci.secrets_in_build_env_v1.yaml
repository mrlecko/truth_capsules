id: ci.secrets_in_build_env_v1
version: 1.0.0
domain: ci
title: Build Environment â€” No Secrets in Env Dump
statement: |-
  The build environment dump must not contain forbidden keys. Fail if any env var key matches a forbidden prefix or exact name.

witnesses:
  - name: no_forbidden_env_keys
    language: python
    entrypoint: python3
    args: []
    env:
      ENV_DUMP_PATH: artifacts/examples/ci/env_dump.txt
      FORBIDDEN_PREFIXES_JSON: '["AWS_","GCP_","AZURE_","GH_TOKEN","SLACK_","PRIVATE_KEY","OPENAI_API_KEY","SECRET","TOKEN"]'
    timeout_ms: 4000
    memory_mb: 128
    net: false
    fs_mode: ro
    code: |-
      import os, sys, json

      def parse_env_dump(path):
          env = {}
          with open(path, "r", errors="ignore") as f:
              for line in f:
                  line = line.strip()
                  if not line or line.startswith("#"):
                      continue
                  if "=" in line:
                      k, v = line.split("=", 1)
                      env[k.strip()] = v.strip()
          return env

      def main():
          dump = os.environ.get("ENV_DUMP_PATH", "artifacts/examples/ci/env_dump.txt")
          pref_json = os.environ.get("FORBIDDEN_PREFIXES_JSON", '["AWS_","GCP_","AZURE_","GH_TOKEN","SLACK_","PRIVATE_KEY","OPENAI_API_KEY","SECRET","TOKEN"]')
          try:
              prefixes = json.loads(pref_json)
          except Exception:
              prefixes = ["AWS_","GCP_","AZURE_","GH_TOKEN","SLACK_","PRIVATE_KEY","OPENAI_API_KEY","SECRET","TOKEN"]

          env = parse_env_dump(dump)
          bad = []
          for k in env.keys():
              for p in prefixes:
                  if k == p or k.startswith(p):
                      bad.append(k)
                      break

          result = {"ok": len(bad) == 0, "forbidden_matches": sorted(set(bad)), "scanned": len(env), "path": dump}
          print(json.dumps(result, indent=2))
          sys.exit(0 if result["ok"] else 1)

      if __name__ == "__main__":
          main()
provenance:
  schema: provenance.v1
  author: John Macgregor
  org: Truth Capsules Demo
  license: MIT
  source_url: https://example.com/truth-capsules/ci
  created: '2025-11-10T21:10:00Z'
  updated: '2025-11-10T21:10:00Z'
  review:
    status: draft
    reviewers: []
    last_reviewed: null
  signing:
    method: ed25519
    key_id: null
    pubkey: null
    digest: null
    signature: null
applies_to:
- ci
- release
security:
  sensitivity: medium
  notes: "Runs in restricted CI; no network by default; read-only FS recommended."
