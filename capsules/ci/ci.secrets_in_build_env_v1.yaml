id: ci.secrets_in_build_env_v1
version: 1.0.0
domain: ci
title: Build Environment â€” No Secrets in Env Dump
statement: The build environment dump must not contain forbidden keys. Fail if any
  env var key matches a forbidden prefix or exact name.
witnesses:
- name: no_forbidden_env_keys
  language: python
  entrypoint: python3
  args: []
  env:
    ENV_DUMP_PATH: artifacts/examples/ci/env_dump.txt
    FORBIDDEN_PREFIXES_JSON: '["AWS_","GCP_","AZURE_","GH_TOKEN","SLACK_","PRIVATE_KEY","OPENAI_API_KEY","SECRET","TOKEN"]'
  timeout_ms: 4000
  memory_mb: 128
  net: false
  fs_mode: ro
  code: "import os, sys, json\n\ndef parse_env_dump(path):\n    env = {}\n    with\
    \ open(path, \"r\", errors=\"ignore\") as f:\n        for line in f:\n       \
    \     line = line.strip()\n            if not line or line.startswith(\"#\"):\n\
    \                continue\n            if \"=\" in line:\n                k, v\
    \ = line.split(\"=\", 1)\n                env[k.strip()] = v.strip()\n    return\
    \ env\n\ndef main():\n    dump = os.environ.get(\"ENV_DUMP_PATH\", \"artifacts/examples/ci/env_dump.txt\"\
    )\n    pref_json = os.environ.get(\"FORBIDDEN_PREFIXES_JSON\", '[\"AWS_\",\"GCP_\"\
    ,\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\"\
    ,\"TOKEN\"]')\n    try:\n        prefixes = json.loads(pref_json)\n    except\
    \ Exception:\n        prefixes = [\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"\
    SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]\n\n    env =\
    \ parse_env_dump(dump)\n    bad = []\n    for k in env.keys():\n        for p\
    \ in prefixes:\n            if k == p or k.startswith(p):\n                bad.append(k)\n\
    \                break\n\n    result = {\"ok\": len(bad) == 0, \"forbidden_matches\"\
    : sorted(set(bad)), \"scanned\": len(env), \"path\": dump}\n    print(json.dumps(result,\
    \ indent=2))\n    sys.exit(0 if result[\"ok\"] else 1)\n\nif __name__ == \"__main__\"\
    :\n    main()"
provenance:
  schema: provenance.v1
  author: John Macgregor
  org: Truth Capsules Demo
  license: MIT
  source_url: https://example.com/truth-capsules/ci
  created: '2025-11-10T21:10:00Z'
  updated: '2025-11-10T21:10:00Z'
  review:
    status: draft
    reviewers: []
    last_reviewed: null
  signing:
    method: ed25519
    key_id: null
    pubkey: null
    digest: d383e5c270249265986592516a34418ee3463ebe9fb50bce25790fecb0c2cbca
    signature: null
applies_to:
- ci
- release
security:
  sensitivity: medium
  notes: Runs in restricted CI; no network by default; read-only FS recommended.
