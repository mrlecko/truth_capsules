id: ci.container_hardening_v1
version: 1.0.0
domain: ci
title: Container Hardening â€” Non-Root + No-Cache + Version Pins
statement: |-
  The Dockerfile must:
    1) drop privileges with a non-root USER,
    2) avoid build-time caches for package managers (e.g., pip --no-cache-dir or apt lists cleanup),
    3) pin versions for installed packages (e.g., pip ==, apt package=version).

witnesses:
  - name: dockerfile_has_nonroot_nocache_pins
    language: python
    entrypoint: python3
    args: []
    env:
      DOCKERFILE_PATH: artifacts/examples/ci/Dockerfile
    timeout_ms: 5000
    memory_mb: 128
    net: false
    fs_mode: ro
    code: |-
      import os, sys, json, re

      def read(path):
          with open(path, "r", errors="ignore") as f:
              return f.read()

      def has_nonroot_user(text):
          for m in re.finditer(r"^\s*USER\s+(.+)$", text, flags=re.M|re.I):
              val = m.group(1).strip()
              if re.match(r"(?i)root\b|0\b", val):
                  return False
              return True
          return False

      def has_no_cache(text):
          patterns = [
              r"pip\s+install[^\n]*--no-cache-dir",
              r"apt-get\s+update[^\n]*\n[^\n]*apt-get\s+install[^\n]*\n[^\n]*rm\s+-rf\s+/var/lib/apt/lists/"
          ]
          return any(re.search(p, text, flags=re.I|re.S) for p in patterns)

      def has_version_pins(text):
          return bool(re.search(r"==\d+\.\d+|=\d+\.\d+", text))

      def main():
          path = os.environ.get("DOCKERFILE_PATH", "artifacts/examples/ci/Dockerfile")
          content = read(path)

          res = {
              "nonroot_user": has_nonroot_user(content),
              "no_cache": has_no_cache(content),
              "version_pins": has_version_pins(content),
              "path": path
          }
          res["ok"] = res["nonroot_user"] and res["no_cache"] and res["version_pins"]
          print(json.dumps(res, indent=2))
          sys.exit(0 if res["ok"] else 1)

      if __name__ == "__main__":
          main()
provenance:
  schema: provenance.v1
  author: John Macgregor
  org: Truth Capsules Demo
  license: MIT
  source_url: https://example.com/truth-capsules/ci
  created: '2025-11-10T21:10:00Z'
  updated: '2025-11-10T21:10:00Z'
  review:
    status: draft
    reviewers: []
    last_reviewed: null
  signing:
    method: ed25519
    key_id: null
    pubkey: null
    digest: null
    signature: null
applies_to:
- ci
- release
security:
  sensitivity: medium
  notes: "Runs in restricted CI; no network by default; read-only FS recommended."
