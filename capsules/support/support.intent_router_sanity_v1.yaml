id: support.intent_router_sanity_v1
version: 1.0.0
domain: support
title: Intent Router Sanity Check
statement: |-
  Validate that baseline rules classify common support intents correctly. Defaults read
  fixtures under artifacts/examples/support_agent/. Accuracy must meet or exceed 0.8.
assumptions:
pedagogy:
witnesses:
  - name: routes_top_intents_correctly
    language: python
    code: |-
      import os, sys, json, re

      def load_json(path):
          with open(path, "r") as f:
              return json.load(f)

      def classify(text, rules):
          text_l = text.lower()
          for intent, pats in rules.items():
              for pat in pats:
                  if re.search(pat, text_l):
                      return intent
          return "unknown"

      def main():
          intents_path = os.environ.get("INTENTS_JSON", "").strip()
          rules_path = os.environ.get("RULES_JSON", "").strip()
          acc_threshold = float(os.environ.get("ACC_THRESHOLD", "0.8"))

          if not intents_path or not rules_path:
              print(json.dumps({"ok": False, "error": "INTENTS_JSON or RULES_JSON not set"}))
              sys.exit(2)

          intents = load_json(intents_path)  # list of {text, expected}
          rules = load_json(rules_path)      # {intent: [regex,...]}

          total = len(intents)
          correct = 0
          details = []

          for item in intents:
              text = item["text"]
              expected = item["expected"]
              pred = classify(text, rules)
              correct += 1 if pred == expected else 0
              details.append({"text": text, "expected": expected, "pred": pred})

          acc = (correct / total) if total else 0.0
          ok = acc >= acc_threshold

          print(json.dumps({"ok": ok, "accuracy": acc, "threshold": acc_threshold, "total": total, "correct": correct, "details": details}, indent=2))
          sys.exit(0 if ok else 1)

      if __name__ == "__main__":
          main()

    env:
      INTENTS_JSON: artifacts/examples/support_agent/intents.json
      RULES_JSON: artifacts/examples/support_agent/router_rules.json
      ACC_THRESHOLD: "0.8"
    success_message: "Intent router accuracy meets threshold."
    failure_message: "Intent router below threshold â€” refine rules or examples."
provenance:
  schema: provenance.v1
  author: John Macgregor
  org: Truth Capsules Demo
  license: MIT
  source_url: https://example.com/truth-capsules/support
  created: '2025-11-10T18:12:37Z'
  updated: '2025-11-10T18:12:37Z'
  review:
    status: draft
    reviewers: []
    last_reviewed: null
  signing:
    method: ed25519
    key_id: null
    pubkey: null
    digest: null
    signature: null
applies_to:
- conversation
- support
dependencies: []
incompatible_with: []
security:
  sensitivity: medium
  notes: ''
