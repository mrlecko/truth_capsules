<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Truth Capsule Viewer & Prompt Composer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon"
    href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='.8%20.8%2014.4%2014.4'%3e%3cpath%20d='M10%208.99a1%201%200%2000-.695%201.717l4.004%204a1%201%200%20101.414-1.414l-4.004-4A1%201%200%200010%208.99z'%20fill='%2380b0ff'%20stroke='%235D7FDDaa'%20stroke-width='.3'/%3e%3cpath%20d='M6.508%201C3.48%201%201.002%203.474%201.002%206.5S3.48%2012%206.508%2012s5.504-2.474%205.504-5.5S9.536%201%206.508%201zm0%202a3.486%203.486%200%20013.504%203.5c0%201.944-1.556%203.5-3.504%203.5a3.488%203.488%200%2001-3.506-3.5C3.002%204.556%204.56%203%206.508%203z'%20fill='%2380b0ff'%20stroke='%235D7FDDaa'%20stroke-width='.3'/%3e%3c/svg%3e">
  <!-- THEME + LAYOUT -->
  <style>
    /* ============================
   MODERN THEME  -  PREMIUM CUT
   ============================ */

    /* ---- Tokens (Dark default) ---- */
    :root {
      /* Surfaces */
      --bg: #0e1116;
      --panel: #151a21;
      --panel-raise: #171d24;
      /* subtle elevated */
      --panel-alt: #1a212b;
      --divider: #232a36;
      /* hairlines / separators */
      --border: #232a36;

      /* Text & accents */
      --text: #e8ecf2;
      --muted: #a6b0c2;
      --accent: #76a2ff;
      /* link/brand */
      --accent-strong: #4b86ff;
      --ok: #19e184;
      --danger: #ff6b6b;
      --warn: #ffae3a;

      /* UI */
      --chip: #1f2632;
      --chip-border: #2a3444;

      /* Controls */
      --input-bg: #0f141d;
      --btn-bg: #0f141d;
      --btn-fg: var(--text);

      /* Textareas (default, non-terminal) */
      --textarea-bg: var(--panel-alt);
      --textarea-fg: var(--text);

      /* Terminal (syscode) */
      --code-bg: #0f1117;
      --code-fg: #a9ffb8;
      --code-border: #1c2330;

      /* Shadows */
      --shadow-sm: 0 1px 0 rgba(0, 0, 0, .04);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, .22);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, .28);

      /* Motion & radii */
      --radius: 12px;
      --radius-sm: 10px;
      --transition: 140ms cubic-bezier(.2, .8, .2, 1);

      /* Scroll & gutters */
      --scroll-thumb: #2a3546;
      --scroll-track: var(--bg);
      --gutter-idle: linear-gradient(to right, transparent, rgba(255, 255, 255, .08), transparent);
      --gutter-hover: linear-gradient(to right, transparent, rgba(118, 162, 255, .35), transparent);
    }

    /* Explicit light theme: override ALL tokens */
    html[data-theme="light"] {
      color-scheme: light;

      --bg: #f6f8fc;
      --panel: #ffffff;
      --panel-raise: #ffffff;
      --panel-alt: #f4f7fd;
      --divider: #e8eef7;
      --border: #175cb7;

      --text: #0e1320;
      --muted: #5b6680;
      --accent: #265ff1;
      --accent-strong: #1f55e6;
      --ok: #19e184;
      --danger: #d83a3a;
      --warn: #d48a14;

      --chip: #eef2fb;
      --chip-border: #d8e1f1;

      --input-bg: #f1f5fb;
      --btn-bg: #c5c5c5;
      --btn-fg: var(--text);

      /* Keep terminals dark in light mode for contrast */
      --textarea-bg: #f7f9ff;
      --textarea-fg: #0e1320;

      --code-bg: #0f1117;
      --code-fg: #a9ffb8;
      --code-border: #1c2330;

      --shadow-sm: 0 1px 0 rgba(0, 0, 0, .05);
      --shadow-md: 0 8px 28px rgba(12, 26, 54, .10);
      --shadow-lg: 0 16px 52px rgba(12, 26, 54, .14);

      --scroll-thumb: #c9d4e8;
      --scroll-track: var(--bg);
      --gutter-idle: linear-gradient(to right, transparent, rgba(13, 26, 49, .10), transparent);
      --gutter-hover: linear-gradient(to right, transparent, rgba(36, 99, 235, .35), transparent);
    }

    /* Optional: make an explicit dark theme switch also work */
    html[data-theme="dark"] {
      color-scheme: dark;
      /* (No token overrides needed since :root is already dark) */
    }


    /* Follow OS if no explicit theme attribute is set */
    @media (prefers-color-scheme: light) {
      html:not([data-theme]) {
        color-scheme: light;

        --bg: #f6f8fc;
        --panel: #ffffff;
        --panel-raise: #ffffff;
        --panel-alt: #f4f7fd;
        --divider: #e8eef7;
        --border: #dde6f2;

        --text: #0e1320;
        --muted: #5b6680;
        --accent: #265ff1;
        --accent-strong: #1f55e6;

        --chip: #eef2fb;
        --chip-border: #d8e1f1;

        --input-bg: #f1f5fb;
        --btn-bg: #c5c5c5;
        --btn-fg: var(--text);

        --textarea-bg: #f7f9ff;
        --textarea-fg: #0e1320;

        /* Keep terminal dark in light mode for contrast */
        --code-bg: #0f1117;
        --code-fg: #a9ffb8;
        --code-border: #1c2330;

        --shadow-sm: 0 1px 0 rgba(0, 0, 0, .05);
        --shadow-md: 0 8px 28px rgba(12, 26, 54, .10);
        --shadow-lg: 0 16px 52px rgba(12, 26, 54, .14);

        --scroll-thumb: #c9d4e8;
        --scroll-track: var(--bg);
        --gutter-idle: linear-gradient(to right, transparent, rgba(13, 26, 49, .10), transparent);
        --gutter-hover: linear-gradient(to right, transparent, rgba(36, 99, 235, .35), transparent);
      }
    }

    /* Explicit theme overrides */
    html[data-theme="dark"] {
      color-scheme: dark;
    }

    html[data-theme="light"] {
      color-scheme: light;
    }

    /* ---------- Light theme refinement ---------- */
    html[data-theme="light"] {
      /* neutrals */
      --bg: #f8fafc;
      --panel: #ffffff;
      --panel-alt: #f7f9fc;
      /* less blue than before */
      --text: #0f172a;
      --muted: #64748b;

      /* accents & structure */
      --accent: #2563eb;
      --border: #568fe0;
      /* neutral, not saturated blue */
      --border-strong: #d6dde7;
      /* for separators/hover */
      --chip: #f5f7fb;
      --chip-border: #e4eaf4;

      --input-bg: #f9fbfe;
      --btn-bg: #ced3df;
      --btn-fg: var(--text);

      /* code stays dark in light mode */
      --code-bg: #0f1117;
      --code-fg: #c7ffcf;
      --code-border: #1d2330;

      /* rings & elevation */
      --ring: color-mix(in oklab, var(--accent), white 70%);
      --ring-strong: color-mix(in oklab, var(--accent), white 55%);
      --shadow: 0 1px 2px rgba(17, 24, 39, .05), 0 2px 12px rgba(17, 24, 39, .08);
    }

    /* vertical separator between panes */
    #left {
      border-right: 1px solid var(--border-strong);
    }

    /* cards/items: neutral frames, modern hover */
    .card,
    .item,
    .chip {
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .item:hover,
    .card:hover {
      border-color: var(--border-strong);
      box-shadow: 0 1px 2px rgba(17, 24, 39, .06), 0 8px 20px rgba(17, 24, 39, .08);
    }

    .section-title {
      color: var(--muted);
      letter-spacing: .02em;
      font-weight: 600;
    }

    /* inputs/selects */
    input[type="text"],
    select {
      background: var(--input-bg);
      border: 1px solid var(--border);
      color: var(--text);
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: var(--ring-strong);
      box-shadow: 0 0 0 3px var(--ring);
    }

    /* text areas: use .code to get dark terminal treatment */
    textarea:not(.code),
    pre:not(.code) {
      background: var(--panel-alt);
      color: var(--text);
      border-color: var(--border);
    }

    textarea.code,
    pre.code,
    .terminal {
      background: var(--code-bg);
      color: var(--code-fg);
      border-color: var(--code-border);
    }

    /* buttons */
    .btn {
      background: var(--btn-bg);
      color: var(--btn-fg);
      border: 1px solid var(--border);
    }

    .btn:hover {
      border-color: var(--ring-strong);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), white 85%);
    }

    /* chips / badges */
    .chip {
      background: var(--chip);
      border-color: var(--chip-border);
      color: var(--muted);
    }

    .badge {
      background: #eef2f8;
      color: #3b4a6b;
      border: 1px solid #d7deea;
    }

    .badge.ok {
      background: #eaf7f0;
      color: #166534;
      border-color: #cde8d9;
    }

    .badge.err {
      background: #fdecec;
      color: #7f1d1d;
      border-color: #f6b4b4;
    }

    /* softer, consistent focus across the app */
    :focus-visible {
      outline: none;
      border-color: var(--ring-strong);
      box-shadow: 0 0 0 3px var(--ring);
      border-radius: var(--radius);
    }


    /* ==============
   Base / Layout
   ============== */
    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font: 16px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial, "Noto Sans";
      letter-spacing: .01em;
    }

    /* Typographic scale */
    h1 {
      font-size: 15px;
      font-weight: 650;
      margin: 0;
      letter-spacing: .02em;
    }

    h2.section-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin: 0 0 8px;
    }

    /* Scrollbars (webkit) */
    *::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    *::-webkit-scrollbar-thumb {
      background: var(--scroll-thumb);
      border-radius: 8px;
      border: 2px solid var(--scroll-track);
    }

    *::-webkit-scrollbar-track {
      background: var(--scroll-track);
    }

    /* Smooth theme transitions */
    html,
    body,
    .card,
    .item,
    header,
    section,
    textarea,
    pre,
    input,
    select,
    .chip,
    .badge,
    details,
    .collapsible,
    #gutter,
    .gutter {
      transition: background-color var(--transition), color var(--transition), border-color var(--transition), box-shadow var(--transition);
    }

    /* Focus ring */
    :focus-visible {
      outline: 2px solid color-mix(in oklab, var(--accent), transparent 30%);
      outline-offset: 2px;
      border-radius: calc(var(--radius-sm) - 2px);
    }

    /* Header / App bar */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--panel-raise);
      border-bottom: 1px solid var(--divider);
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow-sm);
    }

    header .small {
      color: var(--muted);
    }

    /* Split layout */
    main {
      height: calc(100vh - 54px);
      position: relative;
    }

    #split {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #left,
    #right {
      overflow: hidden;
    }

    #left {
      flex: 0 0 auto;
      min-width: 280px;
      max-width: 42vw;
      display: flex;
      flex-direction: column;
      background: var(--panel);
      /* Always-visible hairline on left panel edge in case gutter collapses */
      box-shadow: inset -1px 0 0 var(--divider);
    }

    #right {
      flex: 1 1 auto;
      min-width: 0;
      overflow: auto;
      background: var(--panel-raise);
    }

    /* Visible vertical separator (Split.js gutter) */
    .gutter {
      width: 10px !important;
      cursor: col-resize;
      background: var(--gutter-idle);
    }

    .gutter:hover {
      background: var(--gutter-hover);
    }

    .gutter.gutter-vertical {
      height: 8px;
      cursor: row-resize;
      width: 100% !important;
      background: var(--gutter-idle);
    }

    .gutter.gutter-vertical:hover {
      background: linear-gradient(to bottom, transparent, rgba(118, 162, 255, .35), transparent);
    }

    /* Left panel internals */
    #leftTop {
      padding: 25px;
      border-bottom: 1px solid var(--divider);
      background: var(--panel-raise);
    }

    #leftSplit {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .section-block {
      display: flex;
      flex-direction: column;
      padding: 12px;
      min-height: 0;
      gap: 10px;
    }

    .section-title {
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    /* Lists */
    .list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: auto;
      min-height: 0;
      padding: 2px;
    }

    .item {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px;
      box-shadow: var(--shadow-sm), var(--shadow-md);
    }

    .item:hover {
      border-color: color-mix(in oklab, var(--accent), transparent 70%);
    }

    .item.is-active {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 82%);
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .small,
    .muted {
      color: var(--muted) !important;
    }

    /* Chips & badges */
    .chip {
      background: var(--chip);
      border: 1px solid var(--chip-border);
      color: var(--text);
      border-radius: 12px;
      padding: 4px 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 550;
      letter-spacing: .02em;
    }

    .chip:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent), transparent 82%);
      transform: translateY(-1px);
    }

    .chip.domain {
      background: color-mix(in oklab, var(--chip), var(--accent) 10%);
    }

    .chip.applies {
      background: color-mix(in oklab, var(--chip), var(--ok) 10%);
    }

    .badge {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      background: color-mix(in oklab, var(--chip), #000 0%);
      color: color-mix(in oklab, var(--text), #fff 0%);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: .02em;
      border: 1px solid var(--chip-border);
    }

    .badge.ok {
      background: var(--ok);
      color: #000;
    }

    .badge.err {
      background: color-mix(in oklab, var(--danger), #000 70%);
      color: #ffe0e0;
      border-color: #4a1b1b;
    }

    .badge.witnessed {
      background: var(--warn);
      color: #fff4dd;
    }

    /* Cards */
    section {
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 14px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow-sm), var(--shadow-md);
    }

    /* Buttons */
    .btn {
      padding: 7px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--btn-bg);
      color: var(--btn-fg);
      cursor: pointer;
      font-weight: 600;
      letter-spacing: .02em;
      box-shadow: var(--shadow-sm);
    }

    .btn.small {
      font-size: 13px;
      padding: 4px 9px;
      border-radius: 9px;
    }

    .btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 85%);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.primary {
      background: color-mix(in oklab, var(--accent), #000 80%);
      border-color: var(--accent);
    }

    .btn.warn {
      background: color-mix(in oklab, var(--danger), #571d1d 80%);
      color: #ffdcdc;
    }

    /* Inputs */
    select,
    input[type="text"] {
      background: var(--input-bg);
      border: 2px solid #444;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 14px;
    }

    input[type="checkbox"] {
      accent-color: var(--accent);
    }

    /* Textareas & pre */
    textarea,
    pre {
      width: 100%;
      min-height: 240px;
      background: var(--textarea-bg);
      color: var(--textarea-fg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 15.5px;
      line-height: 1.55;
      tab-size: 2;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Terminal-style (prompt + LLM output) */
    .syscode {
      background: var(--code-bg) !important;
      color: var(--code-fg) !important;
      border: 1px solid var(--code-border) !important;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .02);
      caret-color: var(--code-fg);
    }

    .syscode::selection {
      background: rgba(122, 162, 255, .25);
    }

    textarea.syscode {
      min-height: 240px;
      resize: vertical;
      white-space: pre;
      overflow: auto;
    }

    /* Details / collapsibles */
    details.domain-group {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
      box-shadow: var(--shadow-sm);
      padding: 6px 6px 8px;
    }

    details.domain-group+details.domain-group {
      margin-top: 8px;
    }

    details.domain-group>summary {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--panel-raise);
      border: 1px solid var(--border);
    }

    details.domain-group>summary::-webkit-details-marker {
      display: none;
    }

    .domain-title {
      font-weight: 700;
      letter-spacing: .02em;
    }

    .domain-spacer {
      flex: 1;
    }

    .domain-body {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Collapsible content blocks (panels) */
    details.panel-collapsible {
      display: flex;
      flex-direction: column;
      min-height: 0;
      max-height: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
      box-shadow: var(--shadow-sm);
    }

    details.panel-collapsible>summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
      padding: 10px 12px;
      border-bottom: 1px solid var(--divider);
      border-radius: 10px;
      background: var(--panel-raise);
      font-weight: 650;
    }

    details.panel-collapsible>summary::-webkit-details-marker {
      display: none;
    }

    details.panel-collapsible>.list {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 8px;
    }

    /* Bundles wrap variants */
    #bundlesWrap details.panel-collapsible {
      flex: 1 1 0;
    }

    #bundlesWrap details.panel-collapsible>summary {
      flex: 0 0 auto;
    }

    #bundlesWrap details.panel-collapsible>.list {
      flex: 1 1 0;
    }

    /* Non-<details> collapsible */
    #bundlesWrap .collapsible {
      display: flex;
      flex-direction: column;
      flex: 1 1 0;
      min-height: 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
      box-shadow: var(--shadow-sm);
    }

    #bundlesWrap .collapsible-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--panel-raise);
      border-bottom: 1px solid var(--divider);
      border-radius: 10px 10px 0 0;
      font-weight: 650;
    }

    #bundlesWrap .collapsible-body {
      display: flex;
      flex-direction: column;
      flex: 1 1 0;
      min-height: 0;
      border-radius: 0 0 10px 10px;
    }

    #bundlesWrap .collapsible-body[hidden] {
      display: none;
    }

    #bundlesWrap #bundles.list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 8px;
    }

    /* Utility */
    .clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Modal */
    #modal,
    #llmModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .48);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(2px);
    }

    #modal .modal-inner,
    #llmModal .modal-inner {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 900px;
      width: 92%;
      max-height: 80vh;
      overflow: auto;
      padding: 14px;
      box-shadow: var(--shadow-lg);
    }

    #llmModal .form-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
    }

    #llmModal label {
      font-weight: 600;
      font-size: 12px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    #llmModal textarea {
      min-height: 120px;
    }

    #llmModal .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--panel-raise);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      z-index: 99;
      box-shadow: var(--shadow-md);
    }

    /* Hover affordances */
    .item:hover,
    .chip:hover,
    .btn:hover,
    details.panel-collapsible>summary:hover {
      transform: translateY(-1px);
    }

    /* Normalize radii on interactive blocks */
    .item,
    .chip,
    .badge,
    .btn,
    .card,
    pre,
    textarea {
      border-radius: var(--radius);
    }


    .label-with-help {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .icon-btn {
      border: 1px solid var(--border);
      background: var(--btn-bg);
      color: var(--text);
      width: 28px;
      height: 28px;
      line-height: 26px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
    }

    .icon-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 85%)
    }

    #profileHelp .muted {
      color: var(--muted)
    }

    #profileDesc {
      margin-left: .5ch
    }

    .help-box {
      margin-top: 6px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 10px;
    }

    .help-box>summary {
      list-style: none;
      cursor: pointer;
      font-weight: 600;
      color: var(--muted);
      margin: -2px 0 4px 0;
    }

    .help-box[open]>summary {
      margin-bottom: 6px;
    }

    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--btn-bg);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      line-height: 1;
      padding: 0;
    }

    .icon-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 85%);
    }

    .help-box {
      margin-top: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
    }

    .help-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .muted {
      color: var(--muted);
    }

    /* Layout */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toolbar .title-wrap {
      display: flex;
      flex-direction: column;
      padding-left: 30px;
    }

    .toolbar-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-right: 30px;
    }

    /* Groups = compact button clusters */
    .group {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px;
      /* border: 1px solid var(--border, #3a3f55); */
      border-radius: 10px;
      background: var(--panel, rgba(127, 127, 127, 0.08));
    }

    /* Icon-sized buttons */
    .btn.icon {
      padding: 6px 8px;
      min-width: auto;
    }

    /* Dropdown menu built from <details> */
    .menu {
      position: relative;
    }

    .menu>summary {
      list-style: none;
      cursor: pointer;
    }

    .menu>summary::-webkit-details-marker {
      display: none;
    }

    .menu[open] .menu-list {
      display: block;
    }

    .menu-list {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 6px;
      padding: 6px;
      background: var(--bgElevated, var(--bg));
      border: 1px solid var(--border, #3a3f55);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      z-index: 1000;
      min-width: 220px;
    }

    .menu-item {
      display: block;
      width: 100%;
      padding: 8px 10px;
      text-align: left;
      background: none;
      border: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
    }

    .menu-item:hover {
      background: rgba(127, 127, 127, 0.12);
      border-radius: 8px;
    }

    .menu-item.warn {
      color: var(--danger, #e06c75);
    }

    .menu-field {
      padding: 4px 6px 8px;
    }

    .menu-row {
      display: flex;
      gap: 6px;
      padding: 4px 6px;
    }

    .menu-sep {
      border: 0;
      height: 1px;
      margin: 6px 0;
      background: linear-gradient(to right, transparent, var(--border, #3a3f55), transparent);
    }

    /* Small muted label */
    .small.muted {
      opacity: 0.7;
      font-size: 12px;
    }

    /* === Modern ghost pills (borderless groups) === */
    :root {
      --btn-h: 30px;
      --btn-r: 12px;
      --hairline: color-mix(in oklab, var(--border), transparent 35%);
      --hover: color-mix(in oklab, var(--accent), transparent 88%);
      --press: color-mix(in oklab, var(--accent), transparent 70%);
    }

    .toolbar {
      gap: 10px;
      padding: 6px 0;
    }

    .toolbar-actions {
      gap: 8px;
    }

    /* No chrome around clusters */
    .group {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0;
      border: 0;
      background: transparent;
      border-radius: 0;
    }

    /* kill any old highlight rings */
    .group:has(.menu[open]) {
      box-shadow: none;
    }

    /* Pills */
    .btn {
      -webkit-appearance: none;
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: var(--btn-h);
      padding: 0 12px;
      border-radius: var(--btn-r);
      border: 1px solid var(--hairline);
      /* hairline, not heavy */
      background: color-mix(in oklab, var(--btn-bg), transparent 10%);
      color: var(--text);
      font-weight: 600;
      line-height: 1;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease,
        box-shadow .15s ease, transform .04s ease;
    }

    .btn:hover {
      background: var(--hover);
      border-color: color-mix(in oklab, var(--border), var(--accent) 40%);
      box-shadow: 0 2px 10px rgba(0, 0, 0, .12);
    }

    .btn:active {
      background: var(--press);
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(0, 0, 0, .18) inset;
    }

    /* Subtle, accessible focus */
    .btn:focus {
      outline: none;
    }

    .btn:focus-visible {
      outline: 2px solid color-mix(in oklab, var(--accent), transparent 60%);
      outline-offset: 2px;
      box-shadow: none;
    }

    /* Icon-only = circular ghost */
    .btn.icon {
      width: var(--btn-h);
      min-width: var(--btn-h);
      padding: 0;
      border-radius: 999px;
    }

    /* Caution tone stays ghost (no filled red blob) */
    .btn.warn {
      color: var(--danger, #e06c75);
      background: color-mix(in oklab, var(--btn-bg), transparent 6%);
      border-color: color-mix(in oklab, var(--danger, #e06c75), var(--border) 75%);
    }

    /* Details/summary dropdown matches pills */
    .menu {
      position: relative;
    }

    .menu>summary {
      list-style: none;
      cursor: pointer;
    }

    .menu>summary::-webkit-details-marker {
      display: none;
    }

    /* Panel */
    .menu[open] .menu-list {
      display: block;
    }

    .menu-list {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      padding: 8px;
      background: var(--bgElevated, var(--bg));
      border: 1px solid var(--hairline);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      z-index: 1000;
    }

    .menu-item {
      display: block;
      width: 100%;
      padding: 8px 10px;
      text-align: left;
      background: none;
      border: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
      border-radius: 8px;
    }

    .menu-item:hover {
      background: color-mix(in oklab, var(--panel), var(--text) 4%);
    }

    .menu-item.warn {
      color: var(--danger, #e06c75);
    }

    .menu-field {
      padding: 6px 6px 8px;
    }

    .menu-row {
      display: flex;
      gap: 6px;
      padding: 4px 6px;
    }

    .menu-row .menu-item {
      flex: 1;
      text-align: center;
    }

    .menu-sep {
      border: 0;
      height: 1px;
      margin: 6px 0;
      background: linear-gradient(to right, transparent, var(--hairline), transparent);
    }

    /* Tiny screen tweak */
    @media (max-width: 900px) {
      :root {
        --btn-h: 28px;
      }
    }
  </style>


  <!-- Prism / Split / Sortable -->
  
  <!-- digests (supply-chain breadcrumbs) -->
  <!-- prism_css: sha256=1b15fe2971998a048aebb60f26f6eed76122071db9ef3b995abd003224f52a98 -->
  <!-- prism_core: sha256=4b9994fc5f441d4c4fff23dee2535c09010bf93b1d90c2c72b0430c3d3f1008e -->
  <!-- prism_yaml: sha256=719c8e8b8c344dc9de510c729f65ba840b1502a0a8e7e25e2ad19ee715f65c02 -->
  <!-- prism_json: sha256=956d86baa5ae7ec4106758f354ac2d140bdcd7fc103dece02f73ed12b8d663e4 -->
  <!-- split_js: sha256=c32bd277fed98cd8a04033d4eef37201d9b50886189b4bb4d099d133feaf16dc -->
  <!-- sortable_js: sha256=ca68430703c4f5960e90735867c6e94d29b5a3de37107d8100e5a301007e9e6e -->

  <style>code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style>

  <script>{ { prism_core_inline | safe } }</script>
  <script>{ { prism_yaml_inline | safe } }</script>
  <script>{ { prism_json_inline | safe } }</script>
  <script>{ { split_js_inline | safe } }</script>
  <script>{ { sortable_js_inline | safe } }</script>
  

</head>

<body>
  <header class="toolbar">
    <div class="title-wrap">
      <h1>Truth Capsule Viewer & Prompt Composer</h1>
      <div class="small" style="font-size:12px;margin-top:4px;">Generated 2025-11-11T01:58:59.014635Z</div>
    </div>

    <nav class="toolbar-actions">

      <!-- Group 1: Prompt (primary = Copy; extras in dropdown) -->
      <div class="group">
        <button style="display:none;" class="btn" id="composeBtn" title="Compose (Ctrl/Cmd+Enter)">üü¢ Compose</button>
        <button class="btn" id="copyBtn" title="Copy prompt">üìã Copy</button>
        <details class="menu">
          <summary class="btn icon" title="More prompt actions">‚ñæ</summary>
          <div class="menu-list">
            <button class="menu-item" id="dlBtn" title="Download prompt">‚¨áÔ∏è Download Prompt</button>
            <button class="menu-item" id="copyLlmBtn" title="Copy LLM command">üíª Copy LLM Bash</button>
            <button class="menu-item" id="shareLinkBtn" title="Copy shareable link">üîó Share Deeplink</button>
          </div>
        </details>
      </div>

      <!-- Group 2: Manifests (primary = Save; dropdown holds Select, Load, Delete, JSON I/O) -->
      <div class="group">
        <button class="btn" id="manifestSaveBtn" title="Save manifest to this browser">üíæ Save</button>
        <details class="menu">
          <summary class="btn icon" title="More manifest actions">‚ñæ</summary>
          <div class="menu-list" style="min-width:280px">
            <div class="menu-field">
              <label class="small muted" for="manifestSelect" style="display:block;margin-bottom:4px;">Saved
                manifests</label>
              <select id="manifestSelect" title="Saved manifests" style="width:100%"></select>
            </div>
            <div class="menu-row">
              <button class="menu-item" id="manifestLoadBtn" title="Load selected manifest">üìÇ Load</button>
              <button class="menu-item warn" id="manifestDeleteBtn" title="Delete selected manifest">üóëÔ∏è Delete</button>
            </div>
            <hr class="menu-sep">
            <button class="menu-item" id="dlJsonBtn" title="Download manifest JSON">‚¨áÔ∏è Download JSON Manifest</button>
            <button class="menu-item" id="loadJsonBtn" title="Load manifest JSON">‚¨ÜÔ∏è Load JSON Manifest</button>
          </div>
        </details>
      </div>

      <!-- Group 3: Tools (quick actions) -->
      <div class="group">
        <button class="btn icon" id="validateAllBtn" title="Validate digests for selected">üîê</button>
        <button class="btn icon warn" id="clearBtn" title="Clear selection">üßπ</button>
      </div>

      <!-- Theme -->
      <button class="btn icon" id="themeBtn" title="Toggle theme" aria-label="Toggle color theme">üåô</button>
    </nav>
  </header>


  <main>
    <div id="split">
      <!-- LEFT COLUMN -->
      <aside id="left">
        <div id="leftTop">

          <div class="row" style="margin-top:10px; align-items:center; gap:8px">
            <label for="profiles" class="section-title">PROFILES</label>
            <button id="profileInfo" class="icon-btn" type="button" aria-haspopup="dialog" aria-expanded="false"
              title="What are Profiles?">?</button>
            <select id="profiles"></select>
            <button id="profileView" class="btn small" type="button" title="View profile YAML">View</button>
          </div>

          <div id="profileDesc" class="small" style="margin-top:4px"></div>

          <div id="profileHelp" class="help-box" hidden>
            <div class="help-title">What are Profiles?</div>
            <p class="small">
              Profiles are presets for a specific use-case (e.g., CI Judge, Code Patch, PR Review).
              A profile sets the basic <em>system prompt</em> and which <em>capsule properties/policies</em> are applied
              (visible).
              Switching profiles does not modify your capsule library; it only changes the composed rules for this run.
            </p>
          </div>

        </div>

        <!-- RESIZABLE HORIZONTAL SPLIT: Bundles ‚ü∑ Capsules -->
        <div id="leftSplit">
          <div id="bundlesWrap" class="section-block">
            <div id="bundlesPanel" class="collapsible">
              <div class="collapsible-header">
                <span class="section-title">BUNDLES (<span id="bundlesCount">0</span>)</span>
                <span class="domain-spacer"></span>
                <button id="bundlesToggle" class="btn small" type="button" aria-expanded="true">Hide</button>
              </div>
              <div id="bundlesBody" class="collapsible-body">
                <div id="bundles" class="list"></div>
              </div>
            </div>
          </div>

          <div id="capsulesWrap" class="section-block">
            <div style="padding-left:12px; padding-right:12px;" class="section-title">
              CAPSULES (<span id="capsulesCount">0</span>)
              <span style="float:right; display:flex; gap:6px;">
                <button class="btn small" id="expandAllBtn">Expand all</button>
                <button class="btn small" id="collapseAllBtn">Collapse all</button>
              </span>
            </div>
            <input id="search" type="text" placeholder="Filter loaded capsules by id/title/domain/statement‚Ä¶"
              style="margin-left: 12px; max-width:432px; width:100%">
            <div id="capsules" class="list"></div>
          </div>
        </div>
      </aside>

      <!-- RIGHT COLUMN -->
      <section id="right">
        <div class="card">
          <div class="row">
            <label style="display:none;"><input type="checkbox" id="includePed" checked> include pedagogy</label>
            <label><input type="checkbox" id="markdown"> markdown preview</label>
            <!-- <span class="small">Drag to reorder in Preview</span> -->
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>COMPOSED SYSTEM PROMPT</strong>
          </div>
          <textarea id="out" style="margin-top:5px;"></textarea>
        </div>

        <div class="card">
          <strong>PREVIEW ‚Äì SELECTED CAPSULES</strong> (DRAG TO REORDER)
          <div id="preview" style="margin-top:5px;" class="list"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Capsule modal (YAML highlighted) -->
  <div id="modal">
    <div class="modal-inner">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="m_title">Capsule</strong>
        <button class="btn small" id="m_close">Close</button>
      </div>
      <div class="row" style="margin:6px 0">
        <button class="btn small" id="m_copy_yaml">Copy YAML</button>
        <button class="btn small" id="m_copy_prov">Copy Provenance</button>
        <button class="btn small" id="m_validate">Validate Digest</button>
        <span id="m_result" class="badge">idle</span>
      </div>
      <pre><code id="m_body_code" class="language-yaml"></code></pre>
    </div>
  </div>

  <!-- LLM Command modal -->
  <div id="llmModal">
    <div class="modal-inner">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Copy LLM Command</strong>
        <div style="margin-top:-3px; font-weight:bolder;">‚ö†Ô∏è bash only - requires the awesome <a style="color:#7aa2ff"
            target="_blank" href="https://llm.datasette.io/en/stable/">llm</a> python package</div>
        <button class="btn small" id="llm_close">Close</button>
      </div>

      <div class="form-row">
        <label for="llm_template">Template:</label>
        <select id="llm_template"></select>
        <div class="hint" id="llm_template_desc"></div>
      </div>

      <div class="form-row" id="llm_input_row">
        <label for="llm_user_input">User input:</label>
        <textarea id="llm_user_input" placeholder="Enter your prompt/question here..."></textarea>
        <div class="hint" id="llm_input_hint"></div>
      </div>

      <div class="form-row" id="llm_file_row" style="display:none">
        <label for="llm_file_path">File path:</label>
        <input type="text" id="llm_file_path" placeholder="/path/to/input.txt" value="input.txt">
      </div>

      <div class="form-row">
        <label>
          <input type="checkbox" id="llm_minify">
          Minify system prompt (collapse whitespace to single line)
        </label>
        <div class="hint">Minification removes newlines and extra spaces. May affect formatting.</div>
      </div>

      <div class="form-row">
        <label for="llm_preview">Generated shell command: (‚ö†Ô∏è <u>always sanity check what you execute in your
            shell!</u>)</label>
        <textarea id="llm_preview" readonly
          style="min-height:200px;font-family:monospace;font-size:12px;background:var(--bg);color:var(--text)"></textarea>
        <div class="hint">This is what will be copied to your clipboard</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="llm_copy">üìã Copy Command</button>
        <button class="btn" id="llm_save">üíæ Save Script</button>
        <button class="btn" id="llm_cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script id="tc-data" type="application/json">{
  "capsules": {
    "llm.citation_required_v1": {
      "id": "llm.citation_required_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Citations required",
      "statement": "Answers must include at least one citation or abstain.",
      "assumptions": [
        "Operating in a general context"
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What evidence supports this claim?"
        },
        {
          "kind": "Aphorism",
          "text": "Cite or abstain."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:53:50.511776Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "0a51607ced8bd646d4a3bcaf8fa3c8ef4c5519afe87615669c6ad389d725cb39",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./tests/fixtures/capsules/llm.citation_required_v1.yaml",
      "_raw": "id: llm.citation_required_v1\nversion: 1.0.0\ndomain: llm\ntitle: Citations required\nstatement: Answers must include at least one citation or abstain.\nassumptions:\n- Operating in a general context\npedagogy:\n- kind: Socratic\n  text: What evidence supports this claim?\n- kind: Aphorism\n  text: Cite or abstain.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:53:50.511776Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 0a51607ced8bd646d4a3bcaf8fa3c8ef4c5519afe87615669c6ad389d725cb39\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "meta.truth_capsules_v1": {
      "id": "meta.truth_capsules_v1",
      "version": "1.0.0",
      "domain": "meta",
      "title": "Truth Capsules ‚Äî Golden Explainer (v1)",
      "statement": "TRUTH CAPSULES (v1): What they are, why they matter, and how to use them.\n\n‚Äî WHAT ‚Äî\nTruth Capsules are small, signed YAML knowledge objects that bundle:\n  ‚Ä¢ A clear normative STATEMENT (human-readable rule, method, or explainer)\n  ‚Ä¢ PEDAGOGY (Socratic prompts + aphorisms for fast onboarding)\n  ‚Ä¢ Optional WITNESSES (executable checks that emit machine-readable JSON and GREEN/RED outcomes)\nThey are designed to be ‚Äúprojection-friendly‚Äù: profiles decide which fields to render (usually just `title` + `statement`), while witnesses provide proof-carrying automation for CI, codereview, or ops.\n\n‚Äî WHY (Proof-carrying knowledge) ‚Äî\n  1) Reproducibility: capsules can include runnable checks; outputs are JSON with crisp GREEN/RED.\n  2) Composability: bundles group capsules into kits (e.g., CI gates, MacGyver pedagogy, Code Assistant).\n  3) Safety: witnesses run in locked-down sandboxes; provenance+signing provide audit trails.\n  4) Projection discipline: a profile creates consistent system prompts from the same source of truth.\n  5) Career/Org leverage: ‚Äúshow, don‚Äôt tell‚Äù ‚Äî every claim can ship with a verifiable witness.\n\n‚Äî HOW (Views, Bundles, Witnesses) ‚Äî\n  ‚Ä¢ Profiles (view): define which capsule fields are projected (e.g., title+statement) and output style (e.g., ‚Äúfail fast on RED‚Äù).\n  ‚Ä¢ Bundles (kit): ordered lists of capsules for a task/context (e.g., ci_quality_gates_v1).\n  ‚Ä¢ Capsules: information-only (explainer/guidance) or witnessed (proof-carrying).\n    ‚Äì Information-only: pedagogy-forward explainers for onboarding and conversation quality.\n    ‚Äì Witnessed: executable checks (python/node/bash) with `code: |-` blocks and explicit `env` mappings.\n  ‚Ä¢ Execution model: a runner loads capsule YAML, extracts each witness, executes in a constrained environment, captures `{ok: bool, ...}` JSON, and returns exit code 0 (GREEN) or 1 (RED/error). CI treats any RED as a failing gate.\n\n‚Äî SCHEMA V1 (essentials) ‚Äî\n  Required: `id`, `version`, `domain`, `statement`.\n  Recommended: `title`, `pedagogy`, `provenance`, `applies_to`, `security`.\n  Witnesses use inline code and should specify: `name`, `language`, `entrypoint`, `env` (mapping), `timeout_ms`, and `fs_mode`.\n  All human-visible guidance should live in `statement` so profiles can project a single coherent explainer.\n\n‚Äî SECURITY & OPERATIONAL NOTES ‚Äî\n  ‚Ä¢ Run witnesses in containers (non-root, no network, read-only FS unless explicitly required).\n  ‚Ä¢ Use minimal `env:` allowlists; record provenance, review status, and signing metadata.\n  ‚Ä¢ Prefer deterministic fixtures for demo reliability; keep failure modes crisp and legible.\n\n‚Äî QUICKSTART (mental model) ‚Äî\n  1) Choose a profile (view): e.g., conversational explainer vs CI gate reporter.\n  2) Load a bundle (kit): the ordered set of capsules for your task.\n  3) Project ‚Üí the profile renders title+statement for humans; optionally execute witnesses for proofs.\n  4) Read the JSON evidence; GREEN/RED is the contract.\n\n‚Äî THIS GOLDEN EXPLAINER ‚Äî\n  This capsule is the ‚Äúrootmost‚Äù documentary explainer for the v1 demo. It‚Äôs informational (pedagogy-heavy) and ships with a tiny, self-contained witness that demonstrates canonicalization and hashing of ‚Äúcore content‚Äù (the proof-carrying ethos) without requiring any external files. Use it to sanity-test your runner and to onboard readers to the Truth Capsules approach.",
      "assumptions": [
        "Profiles will project `statement` (and optionally `title`) to build consistent, reproducible prompts.",
        "Witnesses execute in a minimal sandbox with explicit env allowlists and short timeouts.",
        "Readers value GREEN/RED + JSON evidence over prose alone."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What decision becomes safer or faster if it ships with a GREEN/RED witness instead of prose claims?"
        },
        {
          "kind": "Socratic",
          "text": "Which part of our process needs an explainer (info) versus a gate (witnessed)?"
        },
        {
          "kind": "Socratic",
          "text": "If this statement were wrong, what short witness would falsify it?"
        },
        {
          "kind": "Socratic",
          "text": "What minimal JSON evidence would convince a skeptical reviewer?"
        },
        {
          "kind": "Socratic",
          "text": "Which fields should your profile project so prompts stay stable across tools?"
        },
        {
          "kind": "Aphorism",
          "text": "No witness, no claim."
        },
        {
          "kind": "Aphorism",
          "text": "Project once, reuse everywhere."
        },
        {
          "kind": "Aphorism",
          "text": "Small gates, big safety."
        },
        {
          "kind": "Aphorism",
          "text": "Prose persuades; proofs endure."
        },
        {
          "kind": "Aphorism",
          "text": "One JSON beats ten opinions."
        }
      ],
      "witnesses": [
        {
          "name": "canonical_digest_demo",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {},
          "timeout_ms": 3000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "stdin": "",
          "code": "import json, hashlib, sys\n\n# Minimal ‚Äúcore content‚Äù sample to demonstrate canonicalization & digesting,\n# mirroring what a real signing step would cover.\ncore = {\n  \"id\": \"meta.truth_capsules_v1\",\n  \"version\": \"1.0.0\",\n  \"domain\": \"meta\",\n  \"title\": \"Truth Capsules ‚Äî Golden Explainer (v1)\",\n  \"statement\": \"Proof-carrying explainer capsule demo (canonical digest).\",\n  \"assumptions\": [\n    \"Profiles project `statement`\",\n    \"Witnesses run in sandbox\"\n  ],\n  \"pedagogy\": [\n    {\"kind\": \"Aphorism\", \"text\": \"No witness, no claim.\"},\n    {\"kind\": \"Socratic\", \"text\": \"What would falsify this?\"}\n  ]\n}\n\ndef canonical_json(obj):\n  # Deterministic JSON (keys sorted, no spaces beyond separators)\n  return json.dumps(obj, ensure_ascii=False, sort_keys=True, separators=(\",\", \":\"))\n\ncj = canonical_json(core)\ndigest = hashlib.sha256(cj.encode(\"utf-8\")).hexdigest()\n\nout = {\n  \"ok\": True,\n  \"canonical_size\": len(cj),\n  \"sha256\": digest,\n  \"canonical_keys\": list(sorted(core.keys()))\n}\nprint(json.dumps(out, indent=2))\nsys.exit(0)"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-10T00:00:00Z",
        "updated": "2025-11-10T00:00:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci",
        "release",
        "education"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": "Witness is self-contained, reads no files, produces JSON only. Safe for demo."
      },
      "_file": "./capsules/meta.truth_capsules_v1.yaml",
      "_raw": "id: meta.truth_capsules_v1\nversion: 1.0.0\ndomain: meta\ntitle: Truth Capsules ‚Äî Golden Explainer (v1)\nstatement: |-\n  TRUTH CAPSULES (v1): What they are, why they matter, and how to use them.\n\n  ‚Äî WHAT ‚Äî\n  Truth Capsules are small, signed YAML knowledge objects that bundle:\n    ‚Ä¢ A clear normative STATEMENT (human-readable rule, method, or explainer)\n    ‚Ä¢ PEDAGOGY (Socratic prompts + aphorisms for fast onboarding)\n    ‚Ä¢ Optional WITNESSES (executable checks that emit machine-readable JSON and GREEN/RED outcomes)\n  They are designed to be ‚Äúprojection-friendly‚Äù: profiles decide which fields to render (usually just `title` + `statement`), while witnesses provide proof-carrying automation for CI, codereview, or ops.\n\n  ‚Äî WHY (Proof-carrying knowledge) ‚Äî\n    1) Reproducibility: capsules can include runnable checks; outputs are JSON with crisp GREEN/RED.\n    2) Composability: bundles group capsules into kits (e.g., CI gates, MacGyver pedagogy, Code Assistant).\n    3) Safety: witnesses run in locked-down sandboxes; provenance+signing provide audit trails.\n    4) Projection discipline: a profile creates consistent system prompts from the same source of truth.\n    5) Career/Org leverage: ‚Äúshow, don‚Äôt tell‚Äù ‚Äî every claim can ship with a verifiable witness.\n\n  ‚Äî HOW (Views, Bundles, Witnesses) ‚Äî\n    ‚Ä¢ Profiles (view): define which capsule fields are projected (e.g., title+statement) and output style (e.g., ‚Äúfail fast on RED‚Äù).\n    ‚Ä¢ Bundles (kit): ordered lists of capsules for a task/context (e.g., ci_quality_gates_v1).\n    ‚Ä¢ Capsules: information-only (explainer/guidance) or witnessed (proof-carrying).\n      ‚Äì Information-only: pedagogy-forward explainers for onboarding and conversation quality.\n      ‚Äì Witnessed: executable checks (python/node/bash) with `code: |-` blocks and explicit `env` mappings.\n    ‚Ä¢ Execution model: a runner loads capsule YAML, extracts each witness, executes in a constrained environment, captures `{ok: bool, ...}` JSON, and returns exit code 0 (GREEN) or 1 (RED/error). CI treats any RED as a failing gate.\n\n  ‚Äî SCHEMA V1 (essentials) ‚Äî\n    Required: `id`, `version`, `domain`, `statement`.\n    Recommended: `title`, `pedagogy`, `provenance`, `applies_to`, `security`.\n    Witnesses use inline code and should specify: `name`, `language`, `entrypoint`, `env` (mapping), `timeout_ms`, and `fs_mode`.\n    All human-visible guidance should live in `statement` so profiles can project a single coherent explainer.\n\n  ‚Äî SECURITY & OPERATIONAL NOTES ‚Äî\n    ‚Ä¢ Run witnesses in containers (non-root, no network, read-only FS unless explicitly required).\n    ‚Ä¢ Use minimal `env:` allowlists; record provenance, review status, and signing metadata.\n    ‚Ä¢ Prefer deterministic fixtures for demo reliability; keep failure modes crisp and legible.\n\n  ‚Äî QUICKSTART (mental model) ‚Äî\n    1) Choose a profile (view): e.g., conversational explainer vs CI gate reporter.\n    2) Load a bundle (kit): the ordered set of capsules for your task.\n    3) Project ‚Üí the profile renders title+statement for humans; optionally execute witnesses for proofs.\n    4) Read the JSON evidence; GREEN/RED is the contract.\n\n  ‚Äî THIS GOLDEN EXPLAINER ‚Äî\n    This capsule is the ‚Äúrootmost‚Äù documentary explainer for the v1 demo. It‚Äôs informational (pedagogy-heavy) and ships with a tiny, self-contained witness that demonstrates canonicalization and hashing of ‚Äúcore content‚Äù (the proof-carrying ethos) without requiring any external files. Use it to sanity-test your runner and to onboard readers to the Truth Capsules approach.\n\nassumptions:\n  - Profiles will project `statement` (and optionally `title`) to build consistent, reproducible prompts.\n  - Witnesses execute in a minimal sandbox with explicit env allowlists and short timeouts.\n  - Readers value GREEN/RED + JSON evidence over prose alone.\n\npedagogy:\n  - kind: Socratic\n    text: What decision becomes safer or faster if it ships with a GREEN/RED witness instead of prose claims?\n  - kind: Socratic\n    text: Which part of our process needs an explainer (info) versus a gate (witnessed)?\n  - kind: Socratic\n    text: If this statement were wrong, what short witness would falsify it?\n  - kind: Socratic\n    text: What minimal JSON evidence would convince a skeptical reviewer?\n  - kind: Socratic\n    text: Which fields should your profile project so prompts stay stable across tools?\n\n  - kind: Aphorism\n    text: No witness, no claim.\n  - kind: Aphorism\n    text: Project once, reuse everywhere.\n  - kind: Aphorism\n    text: Small gates, big safety.\n  - kind: Aphorism\n    text: Prose persuades; proofs endure.\n  - kind: Aphorism\n    text: One JSON beats ten opinions.\n\nwitnesses:\n  - name: canonical_digest_demo\n    language: python\n    entrypoint: python3\n    args: []\n    env: {}\n    timeout_ms: 3000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    stdin: \"\"\n    code: |-\n      import json, hashlib, sys\n\n      # Minimal ‚Äúcore content‚Äù sample to demonstrate canonicalization & digesting,\n      # mirroring what a real signing step would cover.\n      core = {\n        \"id\": \"meta.truth_capsules_v1\",\n        \"version\": \"1.0.0\",\n        \"domain\": \"meta\",\n        \"title\": \"Truth Capsules ‚Äî Golden Explainer (v1)\",\n        \"statement\": \"Proof-carrying explainer capsule demo (canonical digest).\",\n        \"assumptions\": [\n          \"Profiles project `statement`\",\n          \"Witnesses run in sandbox\"\n        ],\n        \"pedagogy\": [\n          {\"kind\": \"Aphorism\", \"text\": \"No witness, no claim.\"},\n          {\"kind\": \"Socratic\", \"text\": \"What would falsify this?\"}\n        ]\n      }\n\n      def canonical_json(obj):\n        # Deterministic JSON (keys sorted, no spaces beyond separators)\n        return json.dumps(obj, ensure_ascii=False, sort_keys=True, separators=(\",\", \":\"))\n\n      cj = canonical_json(core)\n      digest = hashlib.sha256(cj.encode(\"utf-8\")).hexdigest()\n\n      out = {\n        \"ok\": True,\n        \"canonical_size\": len(cj),\n        \"sha256\": digest,\n        \"canonical_keys\": list(sorted(core.keys()))\n      }\n      print(json.dumps(out, indent=2))\n      sys.exit(0)\n\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-10T00:00:00Z'\n  updated: '2025-11-10T00:00:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\n\napplies_to:\n  - conversation\n  - code_assistant\n  - ci\n  - release\n  - education\n\ndependencies: []\nincompatible_with: []\n\nsecurity:\n  sensitivity: low\n  notes: \"Witness is self-contained, reads no files, produces JSON only. Safe for demo.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.container_hardening_v1": {
      "id": "ci.container_hardening_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "Container Hardening ‚Äî Non-Root + No-Cache + Version Pins",
      "statement": "The Dockerfile must:\n  1) drop privileges with a non-root USER,\n  2) avoid build-time caches for package managers (e.g., pip --no-cache-dir or apt lists cleanup),\n  3) pin versions for installed packages (e.g., pip ==, apt package=version).",
      "witnesses": [
        {
          "name": "dockerfile_has_nonroot_nocache_pins",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "DOCKERFILE_PATH": "artifacts/examples/ci/Dockerfile"
          },
          "timeout_ms": 5000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, sys, json, re\n\ndef read(path):\n    with open(path, \"r\", errors=\"ignore\") as f:\n        return f.read()\n\ndef has_nonroot_user(text):\n    for m in re.finditer(r\"^\\s*USER\\s+(.+)$\", text, flags=re.M|re.I):\n        val = m.group(1).strip()\n        if re.match(r\"(?i)root\\b|0\\b\", val):\n            return False\n        return True\n    return False\n\ndef has_no_cache(text):\n    patterns = [\n        r\"pip\\s+install[^\\n]*--no-cache-dir\",\n        r\"apt-get\\s+update[^\\n]*\\n[^\\n]*apt-get\\s+install[^\\n]*\\n[^\\n]*rm\\s+-rf\\s+/var/lib/apt/lists/\"\n    ]\n    return any(re.search(p, text, flags=re.I|re.S) for p in patterns)\n\ndef has_version_pins(text):\n    return bool(re.search(r\"==\\d+\\.\\d+|=\\d+\\.\\d+\", text))\n\ndef main():\n    path = os.environ.get(\"DOCKERFILE_PATH\", \"artifacts/examples/ci/Dockerfile\")\n    content = read(path)\n\n    res = {\n        \"nonroot_user\": has_nonroot_user(content),\n        \"no_cache\": has_no_cache(content),\n        \"version_pins\": has_version_pins(content),\n        \"path\": path\n    }\n    res[\"ok\"] = res[\"nonroot_user\"] and res[\"no_cache\"] and res[\"version_pins\"]\n    print(json.dumps(res, indent=2))\n    sys.exit(0 if res[\"ok\"] else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.container_hardening_v1.yaml",
      "_raw": "id: ci.container_hardening_v1\nversion: 1.0.0\ndomain: ci\ntitle: Container Hardening ‚Äî Non-Root + No-Cache + Version Pins\nstatement: |-\n  The Dockerfile must:\n    1) drop privileges with a non-root USER,\n    2) avoid build-time caches for package managers (e.g., pip --no-cache-dir or apt lists cleanup),\n    3) pin versions for installed packages (e.g., pip ==, apt package=version).\n\nwitnesses:\n  - name: dockerfile_has_nonroot_nocache_pins\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      DOCKERFILE_PATH: artifacts/examples/ci/Dockerfile\n    timeout_ms: 5000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, sys, json, re\n\n      def read(path):\n          with open(path, \"r\", errors=\"ignore\") as f:\n              return f.read()\n\n      def has_nonroot_user(text):\n          for m in re.finditer(r\"^\\s*USER\\s+(.+)$\", text, flags=re.M|re.I):\n              val = m.group(1).strip()\n              if re.match(r\"(?i)root\\b|0\\b\", val):\n                  return False\n              return True\n          return False\n\n      def has_no_cache(text):\n          patterns = [\n              r\"pip\\s+install[^\\n]*--no-cache-dir\",\n              r\"apt-get\\s+update[^\\n]*\\n[^\\n]*apt-get\\s+install[^\\n]*\\n[^\\n]*rm\\s+-rf\\s+/var/lib/apt/lists/\"\n          ]\n          return any(re.search(p, text, flags=re.I|re.S) for p in patterns)\n\n      def has_version_pins(text):\n          return bool(re.search(r\"==\\d+\\.\\d+|=\\d+\\.\\d+\", text))\n\n      def main():\n          path = os.environ.get(\"DOCKERFILE_PATH\", \"artifacts/examples/ci/Dockerfile\")\n          content = read(path)\n\n          res = {\n              \"nonroot_user\": has_nonroot_user(content),\n              \"no_cache\": has_no_cache(content),\n              \"version_pins\": has_version_pins(content),\n              \"path\": path\n          }\n          res[\"ok\"] = res[\"nonroot_user\"] and res[\"no_cache\"] and res[\"version_pins\"]\n          print(json.dumps(res, indent=2))\n          sys.exit(0 if res[\"ok\"] else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.license_compliance_v1": {
      "id": "ci.license_compliance_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "License Compliance ‚Äî Allowlist Only",
      "statement": "All package licenses in the SBOM must be on an allowlist. Fail on any package with a disallowed or unknown license.",
      "witnesses": [
        {
          "name": "spdx_allowlist_only",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "SBOM_PATH": "artifacts/examples/ci/sbom.json",
            "ALLOWED_LICENSES_JSON": "[\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"]",
            "STRICT_FIELDS_ONLY": "true",
            "IGNORE_NUMERIC_TOKENS": "true"
          },
          "timeout_ms": 5000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, json, sys, re\n\nVERSION_RE = re.compile(r\"^\\d+(?:\\.\\d+){0,3}$\")\n\ndef env_bool(name, default):\n    v = os.environ.get(name, str(default)).strip().lower()\n    return v in (\"1\",\"true\",\"yes\",\"on\")\n\ndef load_json(path):\n    with open(path, \"r\", errors=\"ignore\") as f:\n        return json.load(f)\n\ndef norm(s):\n    return (s or \"\").strip()\n\ndef collect_from_known_fields(sbom):\n    out = set()\n\n    # CycloneDX components\n    comps = sbom.get(\"components\") or []\n    for c in comps:\n        # CycloneDX license list format\n        lic_list = c.get(\"licenses\") or []\n        for it in lic_list:\n            if isinstance(it, dict):\n                lic = it.get(\"license\")\n                if isinstance(lic, dict):\n                    out.add(norm(lic.get(\"id\") or lic.get(\"name\")))\n                elif isinstance(lic, str):\n                    out.add(norm(lic))\n        # simple fallback: component.license\n        if isinstance(c.get(\"license\"), str):\n            out.add(norm(c[\"license\"]))\n        elif isinstance(c.get(\"license\"), dict):\n            out.add(norm(c[\"license\"].get(\"id\") or c[\"license\"].get(\"name\")))\n\n    # SPDX packages\n    pkgs = sbom.get(\"packages\") or []\n    for p in pkgs:\n        for key in (\"licenseConcluded\",\"licenseDeclared\",\"license\"):\n            if key in p and p[key]:\n                if isinstance(p[key], str):\n                    out.add(norm(p[key]))\n                elif isinstance(p[key], dict):\n                    out.add(norm(p[key].get(\"id\") or p[key].get(\"name\")))\n\n    return {x for x in out if x}\n\ndef collect_heuristic_tokens(sbom):\n    # Last-resort heuristic over raw text; may misfire.\n    # We will filter numeric/version-looking tokens below.\n    text = json.dumps(sbom, ensure_ascii=False)\n    # Simple token pass for SPDX-like ids\n    toks = set(re.findall(r\"\\b[A-Za-z][A-Za-z0-9\\.\\-\\+]{1,}\\b\", text))\n    return toks\n\ndef main():\n    sbom_path = os.environ.get(\"SBOM_PATH\", \"artifacts/examples/ci/sbom.json\")\n    try:\n        allow = set(json.loads(os.environ.get(\n            \"ALLOWED_LICENSES_JSON\",\n            '[\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"]'\n        )))\n    except Exception:\n        allow = {\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"}\n\n    STRICT = env_bool(\"STRICT_FIELDS_ONLY\", True)\n    IGN_NUM = env_bool(\"IGNORE_NUMERIC_TOKENS\", True)\n\n    try:\n        sbom = load_json(sbom_path)\n    except Exception as e:\n        print(json.dumps({\"ok\": False, \"error\": f\"load:{e}\", \"sbom_path\": sbom_path}, indent=2))\n        sys.exit(1)\n\n    licenses = set()\n    # Prefer structured fields\n    licenses |= collect_from_known_fields(sbom)\n\n    if not STRICT:\n        # Heuristic fallback (filtered)\n        licenses |= collect_heuristic_tokens(sbom)\n\n    # Filter empties and numeric/version-looking tokens\n    cleaned = []\n    for x in licenses:\n        if not x: \n            continue\n        if IGN_NUM and VERSION_RE.match(x):\n            continue\n        cleaned.append(x)\n\n    cleaned = sorted(set(map(str, cleaned)))\n    disallowed = sorted({x for x in cleaned if x not in allow})\n\n    result = {\n        \"ok\": len(disallowed) == 0,\n        \"licenses\": cleaned,\n        \"disallowed\": disallowed,\n        \"allowlist\": sorted(allow),\n        \"strict_fields_only\": STRICT,\n        \"ignore_numeric_tokens\": IGN_NUM\n    }\n    print(json.dumps(result, indent=2))\n    sys.exit(0 if result[\"ok\"] else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.license_compliance_v1.yaml",
      "_raw": "id: ci.license_compliance_v1\nversion: 1.0.0\ndomain: ci\ntitle: License Compliance ‚Äî Allowlist Only\nstatement: |-\n  All package licenses in the SBOM must be on an allowlist. Fail on any package with a disallowed or unknown license.\n\nwitnesses:\n  - name: spdx_allowlist_only\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      SBOM_PATH: artifacts/examples/ci/sbom.json\n      ALLOWED_LICENSES_JSON: '[\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"]'\n      STRICT_FIELDS_ONLY: \"true\"          # prefer known SBOM fields, avoid heuristics\n      IGNORE_NUMERIC_TOKENS: \"true\"       # ignore tokens that look like versions/numbers\n    timeout_ms: 5000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, json, sys, re\n\n      VERSION_RE = re.compile(r\"^\\d+(?:\\.\\d+){0,3}$\")\n\n      def env_bool(name, default):\n          v = os.environ.get(name, str(default)).strip().lower()\n          return v in (\"1\",\"true\",\"yes\",\"on\")\n\n      def load_json(path):\n          with open(path, \"r\", errors=\"ignore\") as f:\n              return json.load(f)\n\n      def norm(s):\n          return (s or \"\").strip()\n\n      def collect_from_known_fields(sbom):\n          out = set()\n\n          # CycloneDX components\n          comps = sbom.get(\"components\") or []\n          for c in comps:\n              # CycloneDX license list format\n              lic_list = c.get(\"licenses\") or []\n              for it in lic_list:\n                  if isinstance(it, dict):\n                      lic = it.get(\"license\")\n                      if isinstance(lic, dict):\n                          out.add(norm(lic.get(\"id\") or lic.get(\"name\")))\n                      elif isinstance(lic, str):\n                          out.add(norm(lic))\n              # simple fallback: component.license\n              if isinstance(c.get(\"license\"), str):\n                  out.add(norm(c[\"license\"]))\n              elif isinstance(c.get(\"license\"), dict):\n                  out.add(norm(c[\"license\"].get(\"id\") or c[\"license\"].get(\"name\")))\n\n          # SPDX packages\n          pkgs = sbom.get(\"packages\") or []\n          for p in pkgs:\n              for key in (\"licenseConcluded\",\"licenseDeclared\",\"license\"):\n                  if key in p and p[key]:\n                      if isinstance(p[key], str):\n                          out.add(norm(p[key]))\n                      elif isinstance(p[key], dict):\n                          out.add(norm(p[key].get(\"id\") or p[key].get(\"name\")))\n\n          return {x for x in out if x}\n\n      def collect_heuristic_tokens(sbom):\n          # Last-resort heuristic over raw text; may misfire.\n          # We will filter numeric/version-looking tokens below.\n          text = json.dumps(sbom, ensure_ascii=False)\n          # Simple token pass for SPDX-like ids\n          toks = set(re.findall(r\"\\b[A-Za-z][A-Za-z0-9\\.\\-\\+]{1,}\\b\", text))\n          return toks\n\n      def main():\n          sbom_path = os.environ.get(\"SBOM_PATH\", \"artifacts/examples/ci/sbom.json\")\n          try:\n              allow = set(json.loads(os.environ.get(\n                  \"ALLOWED_LICENSES_JSON\",\n                  '[\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"]'\n              )))\n          except Exception:\n              allow = {\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"}\n\n          STRICT = env_bool(\"STRICT_FIELDS_ONLY\", True)\n          IGN_NUM = env_bool(\"IGNORE_NUMERIC_TOKENS\", True)\n\n          try:\n              sbom = load_json(sbom_path)\n          except Exception as e:\n              print(json.dumps({\"ok\": False, \"error\": f\"load:{e}\", \"sbom_path\": sbom_path}, indent=2))\n              sys.exit(1)\n\n          licenses = set()\n          # Prefer structured fields\n          licenses |= collect_from_known_fields(sbom)\n\n          if not STRICT:\n              # Heuristic fallback (filtered)\n              licenses |= collect_heuristic_tokens(sbom)\n\n          # Filter empties and numeric/version-looking tokens\n          cleaned = []\n          for x in licenses:\n              if not x: \n                  continue\n              if IGN_NUM and VERSION_RE.match(x):\n                  continue\n              cleaned.append(x)\n\n          cleaned = sorted(set(map(str, cleaned)))\n          disallowed = sorted({x for x in cleaned if x not in allow})\n\n          result = {\n              \"ok\": len(disallowed) == 0,\n              \"licenses\": cleaned,\n              \"disallowed\": disallowed,\n              \"allowlist\": sorted(allow),\n              \"strict_fields_only\": STRICT,\n              \"ignore_numeric_tokens\": IGN_NUM\n          }\n          print(json.dumps(result, indent=2))\n          sys.exit(0 if result[\"ok\"] else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.secrets_in_build_env_v1": {
      "id": "ci.secrets_in_build_env_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "Build Environment ‚Äî No Secrets in Env Dump",
      "statement": "The build environment dump must not contain forbidden keys. Fail if any env var key matches a forbidden prefix or exact name.",
      "witnesses": [
        {
          "name": "no_forbidden_env_keys",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "ENV_DUMP_PATH": "artifacts/examples/ci/env_dump.txt",
            "FORBIDDEN_PREFIXES_JSON": "[\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]"
          },
          "timeout_ms": 4000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, sys, json\n\ndef parse_env_dump(path):\n    env = {}\n    with open(path, \"r\", errors=\"ignore\") as f:\n        for line in f:\n            line = line.strip()\n            if not line or line.startswith(\"#\"):\n                continue\n            if \"=\" in line:\n                k, v = line.split(\"=\", 1)\n                env[k.strip()] = v.strip()\n    return env\n\ndef main():\n    dump = os.environ.get(\"ENV_DUMP_PATH\", \"artifacts/examples/ci/env_dump.txt\")\n    pref_json = os.environ.get(\"FORBIDDEN_PREFIXES_JSON\", '[\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]')\n    try:\n        prefixes = json.loads(pref_json)\n    except Exception:\n        prefixes = [\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]\n\n    env = parse_env_dump(dump)\n    bad = []\n    for k in env.keys():\n        for p in prefixes:\n            if k == p or k.startswith(p):\n                bad.append(k)\n                break\n\n    result = {\"ok\": len(bad) == 0, \"forbidden_matches\": sorted(set(bad)), \"scanned\": len(env), \"path\": dump}\n    print(json.dumps(result, indent=2))\n    sys.exit(0 if result[\"ok\"] else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.secrets_in_build_env_v1.yaml",
      "_raw": "id: ci.secrets_in_build_env_v1\nversion: 1.0.0\ndomain: ci\ntitle: Build Environment ‚Äî No Secrets in Env Dump\nstatement: |-\n  The build environment dump must not contain forbidden keys. Fail if any env var key matches a forbidden prefix or exact name.\nwitnesses:\n  - name: no_forbidden_env_keys\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      ENV_DUMP_PATH: artifacts/examples/ci/env_dump.txt\n      FORBIDDEN_PREFIXES_JSON: '[\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]'\n    timeout_ms: 4000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, sys, json\n\n      def parse_env_dump(path):\n          env = {}\n          with open(path, \"r\", errors=\"ignore\") as f:\n              for line in f:\n                  line = line.strip()\n                  if not line or line.startswith(\"#\"):\n                      continue\n                  if \"=\" in line:\n                      k, v = line.split(\"=\", 1)\n                      env[k.strip()] = v.strip()\n          return env\n\n      def main():\n          dump = os.environ.get(\"ENV_DUMP_PATH\", \"artifacts/examples/ci/env_dump.txt\")\n          pref_json = os.environ.get(\"FORBIDDEN_PREFIXES_JSON\", '[\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]')\n          try:\n              prefixes = json.loads(pref_json)\n          except Exception:\n              prefixes = [\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]\n\n          env = parse_env_dump(dump)\n          bad = []\n          for k in env.keys():\n              for p in prefixes:\n                  if k == p or k.startswith(p):\n                      bad.append(k)\n                      break\n\n          result = {\"ok\": len(bad) == 0, \"forbidden_matches\": sorted(set(bad)), \"scanned\": len(env), \"path\": dump}\n          print(json.dumps(result, indent=2))\n          sys.exit(0 if result[\"ok\"] else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.reproducible_artifact_hash_v1": {
      "id": "ci.reproducible_artifact_hash_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "Reproducible Build ‚Äî Repeatable Artifact Hash",
      "statement": "Running the build command twice in a clean workspace should produce byte-identical artifacts (same SHA-256).",
      "witnesses": [
        {
          "name": "repeatable_hash_check",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "BUILD_CMD": "bash artifacts/examples/ci/build_demo.sh",
            "ARTIFACT_PATH": "artifacts/examples/ci/build/out/demo-artifact.txt"
          },
          "timeout_ms": 10000,
          "memory_mb": 256,
          "net": false,
          "fs_mode": "rw",
          "code": "import os, sys, json, hashlib, subprocess, time\n\ndef sha256(path):\n    h = hashlib.sha256()\n    with open(path, \"rb\") as f:\n        for chunk in iter(lambda: f.read(65536), b\"\"):\n            h.update(chunk)\n    return h.hexdigest()\n\ndef run_cmd(cmd):\n    completed = subprocess.run(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)\n    return completed.returncode, completed.stdout, completed.stderr\n\ndef main():\n    cmd = os.environ.get(\"BUILD_CMD\", \"\")\n    artifact = os.environ.get(\"ARTIFACT_PATH\", \"\")\n\n    if cmd:\n        rc1, out1, err1 = run_cmd(cmd)\n        rc2, out2, err2 = run_cmd(cmd)\n        build_ok = (rc1 == 0 and rc2 == 0)\n    else:\n        build_ok = True\n        out1 = out2 = err1 = err2 = \"\"\n\n    if not os.path.isfile(artifact):\n        print(json.dumps({\"ok\": False, \"error\": \"artifact missing\", \"artifact\": artifact, \"build_ok\": build_ok, \"stdout\": out2, \"stderr\": err2}, indent=2))\n        sys.exit(1)\n\n    h1 = sha256(artifact)\n    time.sleep(0.1)\n    h2 = sha256(artifact)\n\n    ok = build_ok and (h1 == h2)\n    print(json.dumps({\"ok\": ok, \"artifact\": artifact, \"sha256_first\": h1, \"sha256_second\": h2, \"build_ok\": build_ok}, indent=2))\n    sys.exit(0 if ok else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.reproducible_artifact_hash_v1.yaml",
      "_raw": "id: ci.reproducible_artifact_hash_v1\nversion: 1.0.0\ndomain: ci\ntitle: Reproducible Build ‚Äî Repeatable Artifact Hash\nstatement: |-\n  Running the build command twice in a clean workspace should produce byte-identical artifacts (same SHA-256).\n\nwitnesses:\n  - name: repeatable_hash_check\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      BUILD_CMD: \"bash artifacts/examples/ci/build_demo.sh\"\n      ARTIFACT_PATH: artifacts/examples/ci/build/out/demo-artifact.txt\n    timeout_ms: 10000\n    memory_mb: 256\n    net: false\n    fs_mode: rw\n    code: |-\n      import os, sys, json, hashlib, subprocess, time\n\n      def sha256(path):\n          h = hashlib.sha256()\n          with open(path, \"rb\") as f:\n              for chunk in iter(lambda: f.read(65536), b\"\"):\n                  h.update(chunk)\n          return h.hexdigest()\n\n      def run_cmd(cmd):\n          completed = subprocess.run(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)\n          return completed.returncode, completed.stdout, completed.stderr\n\n      def main():\n          cmd = os.environ.get(\"BUILD_CMD\", \"\")\n          artifact = os.environ.get(\"ARTIFACT_PATH\", \"\")\n\n          if cmd:\n              rc1, out1, err1 = run_cmd(cmd)\n              rc2, out2, err2 = run_cmd(cmd)\n              build_ok = (rc1 == 0 and rc2 == 0)\n          else:\n              build_ok = True\n              out1 = out2 = err1 = err2 = \"\"\n\n          if not os.path.isfile(artifact):\n              print(json.dumps({\"ok\": False, \"error\": \"artifact missing\", \"artifact\": artifact, \"build_ok\": build_ok, \"stdout\": out2, \"stderr\": err2}, indent=2))\n              sys.exit(1)\n\n          h1 = sha256(artifact)\n          time.sleep(0.1)\n          h2 = sha256(artifact)\n\n          ok = build_ok and (h1 == h2)\n          print(json.dumps({\"ok\": ok, \"artifact\": artifact, \"sha256_first\": h1, \"sha256_second\": h2, \"build_ok\": build_ok}, indent=2))\n          sys.exit(0 if ok else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.sbom_present_v1": {
      "id": "ci.sbom_present_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "SBOM Present for the Release",
      "statement": "A Software Bill of Materials (SBOM) must be attached to every release artifact.\nThe SBOM file must exist, be non-empty, and parse as JSON or SPDX tag-value text.",
      "witnesses": [
        {
          "name": "sbom_file_exists",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "ARTIFACTS_DIR": "artifacts/examples/ci",
            "SBOM_NAME": "sbom.json"
          },
          "timeout_ms": 4000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, json, sys\n\ndef is_nonempty_file(path):\n    try:\n        return os.path.isfile(path) and os.path.getsize(path) > 0\n    except Exception:\n        return False\n\ndef try_parse_json(path):\n    try:\n        with open(path, \"r\", errors=\"ignore\") as f:\n            json.load(f)\n        return True, \"json\"\n    except Exception:\n        return False, None\n\ndef try_spdx_tagvalue(path):\n    try:\n        with open(path, \"r\", errors=\"ignore\") as f:\n            head = f.read(2048)\n        return \"SPDXVersion:\" in head or \"PackageName:\" in head\n    except Exception:\n        return False\n\ndef main():\n    artifacts = os.environ.get(\"ARTIFACTS_DIR\", \"artifacts/examples/ci\")\n    name = os.environ.get(\"SBOM_NAME\", \"sbom.json\")\n    path = os.path.join(artifacts, name)\n\n    exists = is_nonempty_file(path)\n    parsed = False\n    fmt = None\n    if exists:\n        ok, fmt = try_parse_json(path)\n        if not ok:\n            if try_spdx_tagvalue(path):\n                parsed = True\n                fmt = \"spdx-tagvalue\"\n            else:\n                parsed = False\n        else:\n            parsed = True\n\n    result = {\"ok\": exists and parsed, \"path\": path, \"exists\": exists, \"parsed\": parsed, \"format\": fmt}\n    print(json.dumps(result, indent=2))\n    sys.exit(0 if result[\"ok\"] else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.sbom_present_v1.yaml",
      "_raw": "id: ci.sbom_present_v1\nversion: 1.0.0\ndomain: ci\ntitle: SBOM Present for the Release\nstatement: |-\n  A Software Bill of Materials (SBOM) must be attached to every release artifact.\n  The SBOM file must exist, be non-empty, and parse as JSON or SPDX tag-value text.\n\nwitnesses:\n  - name: sbom_file_exists\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      ARTIFACTS_DIR: artifacts/examples/ci\n      SBOM_NAME: sbom.json\n    timeout_ms: 4000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, json, sys\n\n      def is_nonempty_file(path):\n          try:\n              return os.path.isfile(path) and os.path.getsize(path) > 0\n          except Exception:\n              return False\n\n      def try_parse_json(path):\n          try:\n              with open(path, \"r\", errors=\"ignore\") as f:\n                  json.load(f)\n              return True, \"json\"\n          except Exception:\n              return False, None\n\n      def try_spdx_tagvalue(path):\n          try:\n              with open(path, \"r\", errors=\"ignore\") as f:\n                  head = f.read(2048)\n              return \"SPDXVersion:\" in head or \"PackageName:\" in head\n          except Exception:\n              return False\n\n      def main():\n          artifacts = os.environ.get(\"ARTIFACTS_DIR\", \"artifacts/examples/ci\")\n          name = os.environ.get(\"SBOM_NAME\", \"sbom.json\")\n          path = os.path.join(artifacts, name)\n\n          exists = is_nonempty_file(path)\n          parsed = False\n          fmt = None\n          if exists:\n              ok, fmt = try_parse_json(path)\n              if not ok:\n                  if try_spdx_tagvalue(path):\n                      parsed = True\n                      fmt = \"spdx-tagvalue\"\n                  else:\n                      parsed = False\n              else:\n                  parsed = True\n\n          result = {\"ok\": exists and parsed, \"path\": path, \"exists\": exists, \"parsed\": parsed, \"format\": fmt}\n          print(json.dumps(result, indent=2))\n          sys.exit(0 if result[\"ok\"] else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "macgyver.world_as_typed_graph_v1": {
      "id": "macgyver.world_as_typed_graph_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "World as a Typed Graph",
      "statement": "Model materials and energies as nodes with typed edges for conversions; plan paths with minimal risk and cost.",
      "assumptions": [
        "Graph mindset helps enumerate options and constraints."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What is the next low‚Äërisk edge from here to the goal?"
        },
        {
          "kind": "Aphorism",
          "text": "Map the edges; choose the gentlest path."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.world_as_typed_graph_v1.yaml",
      "_raw": "id: macgyver.world_as_typed_graph_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: World as a Typed Graph\nstatement: Model materials and energies as nodes with typed edges for conversions;\n  plan paths with minimal risk and cost.\nassumptions:\n- Graph mindset helps enumerate options and constraints.\npedagogy:\n- kind: Socratic\n  text: What is the next low‚Äërisk edge from here to the goal?\n- kind: Aphorism\n  text: Map the edges; choose the gentlest path.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.reality_check_v1": {
      "id": "macgyver.reality_check_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Reality Check vs Fiction",
      "statement": "Use TV scenarios only as metaphors for safe, legal, non‚Äëhazard practice. Substitute benign analogues.",
      "assumptions": [
        "No hazardous chemistry/electrics or bypassing of security systems."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What benign analogue teaches the same principle?"
        },
        {
          "kind": "Aphorism",
          "text": "Learn the law; keep the lesson."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": "Explicitly rejects hazardous replication."
      },
      "_file": "./capsules/macgyver/macgyver.reality_check_v1.yaml",
      "_raw": "id: macgyver.reality_check_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Reality Check vs Fiction\nstatement: Use TV scenarios only as metaphors for safe, legal, non‚Äëhazard practice.\n  Substitute benign analogues.\nassumptions:\n- No hazardous chemistry/electrics or bypassing of security systems.\npedagogy:\n- kind: Socratic\n  text: What benign analogue teaches the same principle?\n- kind: Aphorism\n  text: Learn the law; keep the lesson.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: Explicitly rejects hazardous replication.\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.functional_fixedness_avoidance_v1": {
      "id": "macgyver.functional_fixedness_avoidance_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Avoid Functional Fixedness",
      "statement": "Intentionally re-label objects by their properties and verbs to unlock alternative roles.",
      "assumptions": [
        "User practices re-framing and is open to substitution."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What else can this become if I ignore its default name?"
        },
        {
          "kind": "Socratic",
          "text": "Which property, not present in this item, can be paired to create a new role?"
        },
        {
          "kind": "Aphorism",
          "text": "Every object hides a verb."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.functional_fixedness_avoidance_v1.yaml",
      "_raw": "id: macgyver.functional_fixedness_avoidance_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Avoid Functional Fixedness\nstatement: Intentionally re-label objects by their properties and verbs to unlock\n  alternative roles.\nassumptions:\n- User practices re-framing and is open to substitution.\npedagogy:\n- kind: Socratic\n  text: What else can this become if I ignore its default name?\n- kind: Socratic\n  text: Which property, not present in this item, can be paired to create a new role?\n- kind: Aphorism\n  text: Every object hides a verb.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.fail_safe_defaults_v1": {
      "id": "macgyver.fail_safe_defaults_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Fail‚ÄëSafe Defaults",
      "statement": "Design so that interruptions and errors do not cause harm; plan graceful aborts.",
      "assumptions": [
        "Interruption is likely; failure must be safe."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What happens if we stop at Step 2? Make that harmless."
        },
        {
          "kind": "Aphorism",
          "text": "If it must fail, let it fail safe."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.fail_safe_defaults_v1.yaml",
      "_raw": "id: macgyver.fail_safe_defaults_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Fail‚ÄëSafe Defaults\nstatement: Design so that interruptions and errors do not cause harm; plan graceful\n  aborts.\nassumptions:\n- Interruption is likely; failure must be safe.\npedagogy:\n- kind: Socratic\n  text: What happens if we stop at Step 2? Make that harmless.\n- kind: Aphorism\n  text: If it must fail, let it fail safe.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.affordance_matrix_template_v1": {
      "id": "macgyver.affordance_matrix_template_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Affordance Matrix Template",
      "statement": "Tabulate assets‚Üíproperties‚Üílaw‚Üírole‚Üírisk to externalize options and surface safer substitutions.",
      "assumptions": [
        "Externalizing information reduces oversight."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Fill three rows: what role can each asset play safely?"
        },
        {
          "kind": "Aphorism",
          "text": "What you table, you can reason about."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.affordance_matrix_template_v1.yaml",
      "_raw": "id: macgyver.affordance_matrix_template_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Affordance Matrix Template\nstatement: Tabulate assets‚Üíproperties‚Üílaw‚Üírole‚Üírisk to externalize options and surface\n  safer substitutions.\nassumptions:\n- Externalizing information reduces oversight.\npedagogy:\n- kind: Socratic\n  text: 'Fill three rows: what role can each asset play safely?'\n- kind: Aphorism\n  text: What you table, you can reason about.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.legal_ethical_guardrails_v1": {
      "id": "macgyver.legal_ethical_guardrails_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Legal & Ethical Guardrails",
      "statement": "Operate with consent, legality, and non‚Äëmaleficence; solutions are for safety, rescue, education, prototyping.",
      "assumptions": [
        "User agrees to legal and ethical constraints."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Whose consent or safety is implicated? Stop if unclear."
        },
        {
          "kind": "Aphorism",
          "text": "Better a delayed win than a wrongful one."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.legal_ethical_guardrails_v1.yaml",
      "_raw": "id: macgyver.legal_ethical_guardrails_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Legal & Ethical Guardrails\nstatement: Operate with consent, legality, and non‚Äëmaleficence; solutions are for\n  safety, rescue, education, prototyping.\nassumptions:\n- User agrees to legal and ethical constraints.\npedagogy:\n- kind: Socratic\n  text: Whose consent or safety is implicated? Stop if unclear.\n- kind: Aphorism\n  text: Better a delayed win than a wrongful one.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.property_matching_v1": {
      "id": "macgyver.property_matching_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Property-to-Law Matching",
      "statement": "Map constraints to physical laws (pressure, torque, optics, buoyancy, friction) and then to available properties and parts.",
      "assumptions": [
        "Basic physics are more portable than specific tools."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which law satisfies the need with the fewest steps?"
        },
        {
          "kind": "Socratic",
          "text": "What property‚Äëset makes that law easy to apply here?"
        },
        {
          "kind": "Aphorism",
          "text": "Name the energy, not the object."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.property_matching_v1.yaml",
      "_raw": "id: macgyver.property_matching_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Property-to-Law Matching\nstatement: Map constraints to physical laws (pressure, torque, optics, buoyancy, friction)\n  and then to available properties and parts.\nassumptions:\n- Basic physics are more portable than specific tools.\npedagogy:\n- kind: Socratic\n  text: Which law satisfies the need with the fewest steps?\n- kind: Socratic\n  text: What property‚Äëset makes that law easy to apply here?\n- kind: Aphorism\n  text: Name the energy, not the object.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.affordances_over_objects_v1": {
      "id": "macgyver.affordances_over_objects_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Affordances Over Objects",
      "statement": "Prioritize material properties (conducts, insulates, reflects, absorbs, seals, flexes, burns, reacts) over brand-form labels to unlock repurposing.",
      "assumptions": [
        "Scene contains everyday materials with varied properties."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "For each nearby object, list three properties that could serve your goal."
        },
        {
          "kind": "Socratic",
          "text": "Which property is missing‚Äîand what simple substitute adds it?"
        },
        {
          "kind": "Aphorism",
          "text": "Every object hides a verb."
        },
        {
          "kind": "Aphorism",
          "text": "Properties beat brand names."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.affordances_over_objects_v1.yaml",
      "_raw": "id: macgyver.affordances_over_objects_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Affordances Over Objects\nstatement: Prioritize material properties (conducts, insulates, reflects, absorbs,\n  seals, flexes, burns, reacts) over brand-form labels to unlock repurposing.\nassumptions:\n- Scene contains everyday materials with varied properties.\npedagogy:\n- kind: Socratic\n  text: For each nearby object, list three properties that could serve your goal.\n- kind: Socratic\n  text: Which property is missing‚Äîand what simple substitute adds it?\n- kind: Aphorism\n  text: Every object hides a verb.\n- kind: Aphorism\n  text: Properties beat brand names.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.transduction_chains_v1": {
      "id": "macgyver.transduction_chains_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Transduction Chains",
      "statement": "Route one energy into the effect you need: chemical‚Üíthermal‚Üímechanical, optical‚Üíthermal, electrical‚Üímagnetic, pneumatic/hydraulic‚Üíforce.",
      "assumptions": [
        "Safer energy conversions exist than direct brute force."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which energy form is easiest to start from in your scene?"
        },
        {
          "kind": "Socratic",
          "text": "What two-stage conversion achieves the effect with lower risk?"
        },
        {
          "kind": "Aphorism",
          "text": "Route energy; don‚Äôt brute energy."
        },
        {
          "kind": "Aphorism",
          "text": "Two cheap stages outrun one clever stage."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.transduction_chains_v1.yaml",
      "_raw": "id: macgyver.transduction_chains_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Transduction Chains\nstatement: 'Route one energy into the effect you need: chemical‚Üíthermal‚Üímechanical,\n  optical‚Üíthermal, electrical‚Üímagnetic, pneumatic/hydraulic‚Üíforce.'\nassumptions:\n- Safer energy conversions exist than direct brute force.\npedagogy:\n- kind: Socratic\n  text: Which energy form is easiest to start from in your scene?\n- kind: Socratic\n  text: What two-stage conversion achieves the effect with lower risk?\n- kind: Aphorism\n  text: Route energy; don‚Äôt brute energy.\n- kind: Aphorism\n  text: Two cheap stages outrun one clever stage.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.prompt_skeleton_v1": {
      "id": "macgyver.prompt_skeleton_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "LLM Prompt Skeleton",
      "statement": "A structured prompt to force safe, legal, non‚Äëdestructive chain synthesis for a defined goal and setting.",
      "assumptions": [
        "LLMs need structure and guardrails for reliable outputs."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Does the prompt enforce assets, laws, three chains, premortem, and micro‚Äëtest?"
        },
        {
          "kind": "Aphorism",
          "text": "Prompts are levers for minds."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "training"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.prompt_skeleton_v1.yaml",
      "_raw": "id: macgyver.prompt_skeleton_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: LLM Prompt Skeleton\nstatement: A structured prompt to force safe, legal, non‚Äëdestructive chain synthesis\n  for a defined goal and setting.\nassumptions:\n- LLMs need structure and guardrails for reliable outputs.\npedagogy:\n- kind: Socratic\n  text: Does the prompt enforce assets, laws, three chains, premortem, and micro‚Äëtest?\n- kind: Aphorism\n  text: Prompts are levers for minds.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- training\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.chain_design_v1": {
      "id": "macgyver.chain_design_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Chain Design: Sense‚ÜíGate‚ÜíAmplify‚ÜíActuate",
      "statement": "Build solutions as short chains with a clear trigger and amplification before actuation.",
      "assumptions": [
        "Multi‚Äëstage steps increase control and predictability."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Where is the gate/trigger? How is the effect amplified?"
        },
        {
          "kind": "Socratic",
          "text": "Can sensing/illusion replace force?"
        },
        {
          "kind": "Aphorism",
          "text": "Think chains: sense‚Üígate‚Üíamplify‚Üíactuate."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.chain_design_v1.yaml",
      "_raw": "id: macgyver.chain_design_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: 'Chain Design: Sense‚ÜíGate‚ÜíAmplify‚ÜíActuate'\nstatement: Build solutions as short chains with a clear trigger and amplification\n  before actuation.\nassumptions:\n- Multi‚Äëstage steps increase control and predictability.\npedagogy:\n- kind: Socratic\n  text: Where is the gate/trigger? How is the effect amplified?\n- kind: Socratic\n  text: Can sensing/illusion replace force?\n- kind: Aphorism\n  text: 'Think chains: sense‚Üígate‚Üíamplify‚Üíactuate.'\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.parallel_options_v1": {
      "id": "macgyver.parallel_options_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Parallel Optioning",
      "statement": "Always generate three routes: Physical, Informational, Environmental.",
      "assumptions": [
        "Time allows at least brief divergent ideation."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "List one Physical, one Informational, one Environmental route."
        },
        {
          "kind": "Aphorism",
          "text": "Don‚Äôt hunt with one arrow."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.parallel_options_v1.yaml",
      "_raw": "id: macgyver.parallel_options_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Parallel Optioning\nstatement: 'Always generate three routes: Physical, Informational, Environmental.'\nassumptions:\n- Time allows at least brief divergent ideation.\npedagogy:\n- kind: Socratic\n  text: List one Physical, one Informational, one Environmental route.\n- kind: Aphorism\n  text: Don‚Äôt hunt with one arrow.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.redundancy_chokepoints_v1": {
      "id": "macgyver.redundancy_chokepoints_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Redundancy & Choke Points",
      "statement": "Protect your own single points of failure while removing the opponent‚Äôs options.",
      "assumptions": [
        "System thinking improves robustness and containment."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Where is the single point of failure‚Äîand how do we cushion it?"
        },
        {
          "kind": "Aphorism",
          "text": "Add a backup or remove a choke."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.redundancy_chokepoints_v1.yaml",
      "_raw": "id: macgyver.redundancy_chokepoints_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Redundancy & Choke Points\nstatement: Protect your own single points of failure while removing the opponent‚Äôs\n  options.\nassumptions:\n- System thinking improves robustness and containment.\npedagogy:\n- kind: Socratic\n  text: Where is the single point of failure‚Äîand how do we cushion it?\n- kind: Aphorism\n  text: Add a backup or remove a choke.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.mvp_mechanism_bias_v1": {
      "id": "macgyver.mvp_mechanism_bias_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "MVP Mechanism Bias",
      "statement": "Prefer the smallest reversible mechanism that might work; escalate complexity only as needed.",
      "assumptions": [
        "Reversible steps reduce risk and damage."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What is the least‚Äëeffort, reversible move that could work?"
        },
        {
          "kind": "Aphorism",
          "text": "Use reversibility as a brake."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.mvp_mechanism_bias_v1.yaml",
      "_raw": "id: macgyver.mvp_mechanism_bias_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: MVP Mechanism Bias\nstatement: Prefer the smallest reversible mechanism that might work; escalate complexity\n  only as needed.\nassumptions:\n- Reversible steps reduce risk and damage.\npedagogy:\n- kind: Socratic\n  text: What is the least‚Äëeffort, reversible move that could work?\n- kind: Aphorism\n  text: Use reversibility as a brake.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.prompts_as_programs_v1": {
      "id": "macgyver.prompts_as_programs_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Prompts as Programs",
      "statement": "Use structured prompts/checklists to force enumeration, comparison, and premortems.",
      "assumptions": [
        "Structure improves breadth and reduces blind spots."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Have we enumerated three routes and a premortem yet?"
        },
        {
          "kind": "Aphorism",
          "text": "Prompt the mind you want."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.prompts_as_programs_v1.yaml",
      "_raw": "id: macgyver.prompts_as_programs_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Prompts as Programs\nstatement: Use structured prompts/checklists to force enumeration, comparison, and\n  premortems.\nassumptions:\n- Structure improves breadth and reduces blind spots.\npedagogy:\n- kind: Socratic\n  text: Have we enumerated three routes and a premortem yet?\n- kind: Aphorism\n  text: Prompt the mind you want.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.low_tech_first_v1": {
      "id": "macgyver.low_tech_first_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Low-Tech First",
      "statement": "Prefer simple mechanisms (rope, wedge, lever, mirror) before powered or chemical routes.",
      "assumptions": [
        "Simple tools are present; powered tools are risky/unavailable."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What non‚Äëpowered mechanism could replace this powered step?"
        },
        {
          "kind": "Aphorism",
          "text": "Small forces win with leverage, pressure, and time."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.low_tech_first_v1.yaml",
      "_raw": "id: macgyver.low_tech_first_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Low-Tech First\nstatement: Prefer simple mechanisms (rope, wedge, lever, mirror) before powered or\n  chemical routes.\nassumptions:\n- Simple tools are present; powered tools are risky/unavailable.\npedagogy:\n- kind: Socratic\n  text: What non‚Äëpowered mechanism could replace this powered step?\n- kind: Aphorism\n  text: Small forces win with leverage, pressure, and time.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.five_rails_v1": {
      "id": "macgyver.five_rails_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "The Five Rails of Action",
      "statement": "Operate along five rails: Sensing, Shaping, Timing, Power, Signaling. Compose minimally sufficient sets to achieve the goal.",
      "assumptions": [
        "Any solution can be decomposed across the five rails."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which rails are absolutely necessary for this problem?"
        },
        {
          "kind": "Socratic",
          "text": "Can sensing replace force (e.g., bypass over break)?"
        },
        {
          "kind": "Aphorism",
          "text": "If you can‚Äôt make it stronger, make it smarter."
        },
        {
          "kind": "Aphorism",
          "text": "Reduce the problem, not the world."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.five_rails_v1.yaml",
      "_raw": "id: macgyver.five_rails_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: The Five Rails of Action\nstatement: 'Operate along five rails: Sensing, Shaping, Timing, Power, Signaling.\n  Compose minimally sufficient sets to achieve the goal.'\nassumptions:\n- Any solution can be decomposed across the five rails.\npedagogy:\n- kind: Socratic\n  text: Which rails are absolutely necessary for this problem?\n- kind: Socratic\n  text: Can sensing replace force (e.g., bypass over break)?\n- kind: Aphorism\n  text: If you can‚Äôt make it stronger, make it smarter.\n- kind: Aphorism\n  text: Reduce the problem, not the world.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.bias_checklist_v1": {
      "id": "macgyver.bias_checklist_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Bias & Mode Collapse Check",
      "statement": "Before finalizing, scan for confirmation bias, selection bias, overconfidence, and mode collapse.",
      "assumptions": [
        "Brief self‚Äëaudit improves reliability."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which plausible alternative did we ignore?"
        },
        {
          "kind": "Aphorism",
          "text": "Doubt is a feature."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.bias_checklist_v1.yaml",
      "_raw": "id: macgyver.bias_checklist_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Bias & Mode Collapse Check\nstatement: Before finalizing, scan for confirmation bias, selection bias, overconfidence,\n  and mode collapse.\nassumptions:\n- Brief self‚Äëaudit improves reliability.\npedagogy:\n- kind: Socratic\n  text: Which plausible alternative did we ignore?\n- kind: Aphorism\n  text: Doubt is a feature.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.latency_control_v1": {
      "id": "macgyver.latency_control_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Latency Control",
      "statement": "Design predictable timing via burn, dissolve, flow, charging, cooling; prefer slow, observable delays.",
      "assumptions": [
        "Delays can be made visible and interruptible."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What delay is safest and most observable here?"
        },
        {
          "kind": "Aphorism",
          "text": "Delay is a component."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.latency_control_v1.yaml",
      "_raw": "id: macgyver.latency_control_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Latency Control\nstatement: Design predictable timing via burn, dissolve, flow, charging, cooling;\n  prefer slow, observable delays.\nassumptions:\n- Delays can be made visible and interruptible.\npedagogy:\n- kind: Socratic\n  text: What delay is safest and most observable here?\n- kind: Aphorism\n  text: Delay is a component.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.deliberate_practice_v1": {
      "id": "macgyver.deliberate_practice_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Deliberate Practice Drills",
      "statement": "Short, repeatable drills: 2‚Äëminute affordance scans; law‚Äëmatching flashcards; chain sketches from household scenes.",
      "assumptions": [
        "Skill improves with frequent, safe micro‚Äëreps."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What 2‚Äëminute drill can you run right now in this room?"
        },
        {
          "kind": "Aphorism",
          "text": "Small drills make big instincts."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.deliberate_practice_v1.yaml",
      "_raw": "id: macgyver.deliberate_practice_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Deliberate Practice Drills\nstatement: 'Short, repeatable drills: 2‚Äëminute affordance scans; law‚Äëmatching flashcards;\n  chain sketches from household scenes.'\nassumptions:\n- Skill improves with frequent, safe micro‚Äëreps.\npedagogy:\n- kind: Socratic\n  text: What 2‚Äëminute drill can you run right now in this room?\n- kind: Aphorism\n  text: Small drills make big instincts.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.inventory_thinking_v1": {
      "id": "macgyver.inventory_thinking_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Inventory Thinking",
      "statement": "Represent the scene as {assets, properties, converters, storers, triggers, constraints}.",
      "assumptions": [
        "A fast written inventory improves plan quality."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "List assets‚Üíproperties in 60 seconds. What‚Äôs missing?"
        },
        {
          "kind": "Aphorism",
          "text": "What you write down exists for strategy."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.inventory_thinking_v1.yaml",
      "_raw": "id: macgyver.inventory_thinking_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Inventory Thinking\nstatement: Represent the scene as {assets, properties, converters, storers, triggers,\n  constraints}.\nassumptions:\n- A fast written inventory improves plan quality.\npedagogy:\n- kind: Socratic\n  text: List assets‚Üíproperties in 60 seconds. What‚Äôs missing?\n- kind: Aphorism\n  text: What you write down exists for strategy.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.reflection_loop_v1": {
      "id": "macgyver.reflection_loop_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Reflection Loop",
      "statement": "After action: identify the governing law, the choke point, and one substitution that would lower risk next time.",
      "assumptions": [
        "Retrospective improves future plan quality."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which law actually did the work? What will you change next time?"
        },
        {
          "kind": "Aphorism",
          "text": "Name the win mechanism or you won‚Äôt keep it."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.reflection_loop_v1.yaml",
      "_raw": "id: macgyver.reflection_loop_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Reflection Loop\nstatement: 'After action: identify the governing law, the choke point, and one substitution\n  that would lower risk next time.'\nassumptions:\n- Retrospective improves future plan quality.\npedagogy:\n- kind: Socratic\n  text: Which law actually did the work? What will you change next time?\n- kind: Aphorism\n  text: Name the win mechanism or you won‚Äôt keep it.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.deception_force_multiplier_v1": {
      "id": "macgyver.deception_force_multiplier_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Deception as Force Multiplier",
      "statement": "Use diversions and illusions to buy time and reduce the need for force.",
      "assumptions": [
        "Solutions should avoid harm and de-escalate."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What harmless diversion buys a safe minute?"
        },
        {
          "kind": "Aphorism",
          "text": "A signal that buys a minute beats a force that breaks a wall."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.deception_force_multiplier_v1.yaml",
      "_raw": "id: macgyver.deception_force_multiplier_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Deception as Force Multiplier\nstatement: Use diversions and illusions to buy time and reduce the need for force.\nassumptions:\n- Solutions should avoid harm and de-escalate.\npedagogy:\n- kind: Socratic\n  text: What harmless diversion buys a safe minute?\n- kind: Aphorism\n  text: A signal that buys a minute beats a force that breaks a wall.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.sop_10min_loop_v1": {
      "id": "macgyver.sop_10min_loop_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "SOP: The 10‚ÄëMinute MacGyver Loop",
      "statement": "A 10‚Äëstep loop: clarify target, map layout, inventory properties, pick a law, sketch three chains, choose low‚Äërisk, add timing control, premortem, micro‚Äëtest, execute & observe.",
      "assumptions": [
        "Timeboxed planning increases safety and success."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which step can you perform in under 60 seconds right now?"
        },
        {
          "kind": "Aphorism",
          "text": "Process is the parachute."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping",
        "training"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.sop_10min_loop_v1.yaml",
      "_raw": "id: macgyver.sop_10min_loop_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: 'SOP: The 10‚ÄëMinute MacGyver Loop'\nstatement: 'A 10‚Äëstep loop: clarify target, map layout, inventory properties, pick\n  a law, sketch three chains, choose low‚Äërisk, add timing control, premortem, micro‚Äëtest,\n  execute & observe.'\nassumptions:\n- Timeboxed planning increases safety and success.\npedagogy:\n- kind: Socratic\n  text: Which step can you perform in under 60 seconds right now?\n- kind: Aphorism\n  text: Process is the parachute.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\n- training\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver_problem_collapse_v1": {
      "id": "macgyver_problem_collapse_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Problem Space Collapse ‚Üí New Solutions",
      "statement": "Collapse a problem like macgyver.",
      "assumptions": [
        "Assumptions are enumerated or can be elicited with one question."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which single assumption, if wrong, invalidates the plan?"
        },
        {
          "kind": "Aphorism",
          "text": "Make failure explicit and reversible."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": null,
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "life"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.problem_collapse_v1.yaml",
      "_raw": "id: macgyver_problem_collapse_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Problem Space Collapse ‚Üí New Solutions\nstatement: Collapse a problem like macgyver.\nassumptions:\n- Assumptions are enumerated or can be elicited with one question.\npedagogy:\n- kind: Socratic\n  text: Which single assumption, if wrong, invalidates the plan?\n- kind: Aphorism\n  text: Make failure explicit and reversible.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: null\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- life\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.stock_verbs_v1": {
      "id": "macgyver.stock_verbs_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Stock Verbs",
      "statement": "Memorize a small verb lexicon: tie, wedge, knot, jam, twist, short, bridge, reflect, refract, siphon, vent, pack, wick, damp, shim, lash.",
      "assumptions": [
        "Motor skills and basic materials available."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which two verbs change the state with least effort?"
        },
        {
          "kind": "Aphorism",
          "text": "Verbs, not nouns, move worlds."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.stock_verbs_v1.yaml",
      "_raw": "id: macgyver.stock_verbs_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Stock Verbs\nstatement: 'Memorize a small verb lexicon: tie, wedge, knot, jam, twist, short, bridge,\n  reflect, refract, siphon, vent, pack, wick, damp, shim, lash.'\nassumptions:\n- Motor skills and basic materials available.\npedagogy:\n- kind: Socratic\n  text: Which two verbs change the state with least effort?\n- kind: Aphorism\n  text: Verbs, not nouns, move worlds.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.rails_ledgers_hub_mapping_v1": {
      "id": "macgyver.rails_ledgers_hub_mapping_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Rails/Ledgers/Hub Mapping",
      "statement": "Map solutions to rails (Sensing, Shaping, Timing, Power, Signaling), bundle minimal commuting rails as a ledger, schedule steps via the hub (ordered gates/delays).",
      "assumptions": [
        "A shared vocabulary improves collaboration and auditability."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which minimal set of rails forms the ledger here?"
        },
        {
          "kind": "Aphorism",
          "text": "Gate‚ÜíGear‚ÜíHub keeps projects clean."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.rails_ledgers_hub_mapping_v1.yaml",
      "_raw": "id: macgyver.rails_ledgers_hub_mapping_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Rails/Ledgers/Hub Mapping\nstatement: Map solutions to rails (Sensing, Shaping, Timing, Power, Signaling), bundle\n  minimal commuting rails as a ledger, schedule steps via the hub (ordered gates/delays).\nassumptions:\n- A shared vocabulary improves collaboration and auditability.\npedagogy:\n- kind: Socratic\n  text: Which minimal set of rails forms the ledger here?\n- kind: Aphorism\n  text: Gate‚ÜíGear‚ÜíHub keeps projects clean.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.blast_radius_humility_v1": {
      "id": "macgyver.blast_radius_humility_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Blast-Radius Humility",
      "statement": "Prefer diversion, disablement, and exit over destructive outcomes; minimize the space of unintended effects.",
      "assumptions": [
        "Safety and ethics are paramount; bystanders matter."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "If this misfires, who is at risk? How do we shrink that radius?"
        },
        {
          "kind": "Aphorism",
          "text": "Build exits before entries."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": "Discourages hazardous actions; focuses on reduction of harm."
      },
      "_file": "./capsules/macgyver/macgyver.blast_radius_humility_v1.yaml",
      "_raw": "id: macgyver.blast_radius_humility_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Blast-Radius Humility\nstatement: Prefer diversion, disablement, and exit over destructive outcomes; minimize\n  the space of unintended effects.\nassumptions:\n- Safety and ethics are paramount; bystanders matter.\npedagogy:\n- kind: Socratic\n  text: If this misfires, who is at risk? How do we shrink that radius?\n- kind: Aphorism\n  text: Build exits before entries.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: Discourages hazardous actions; focuses on reduction of harm.\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.environment_as_component_v1": {
      "id": "macgyver.environment_as_component_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Environment as a Component",
      "statement": "Treat gravity, sunlight, water, wind, terrain, and architecture as active parts of the design.",
      "assumptions": [
        "The environment can safely contribute force, flow, or information."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which environmental asset can replace a bought part?"
        },
        {
          "kind": "Socratic",
          "text": "How can layout (doors, shafts, slopes) create or remove options?"
        },
        {
          "kind": "Aphorism",
          "text": "The floorplan is your toolkit."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.environment_as_component_v1.yaml",
      "_raw": "id: macgyver.environment_as_component_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Environment as a Component\nstatement: Treat gravity, sunlight, water, wind, terrain, and architecture as active\n  parts of the design.\nassumptions:\n- The environment can safely contribute force, flow, or information.\npedagogy:\n- kind: Socratic\n  text: Which environmental asset can replace a bought part?\n- kind: Socratic\n  text: How can layout (doors, shafts, slopes) create or remove options?\n- kind: Aphorism\n  text: The floorplan is your toolkit.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.style_guide_js_v1": {
      "id": "dev.style_guide_js_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "JS/TS Style Guide (Practical Defaults)",
      "statement": "Keep the surface consistent; let tools fight bikeshedding.\n\nFormatter & Lint\n  ‚Ä¢ Prettier; ESLint with recommended + security (eslint-plugin-security) + import/order.\n  ‚Ä¢ TypeScript strict for libraries; app code minimally typed but typed at boundaries.\n\nTesting & UI\n  ‚Ä¢ Jest/Vitest + Testing Library; prefer role-based queries; avoid brittle snapshots.\n  ‚Ä¢ Keep components pure; derive state; lift state when two consumers need it.\n\nExamples\n  ‚Ä¢ API calls have abort controllers and sane timeouts.\n  ‚Ä¢ Avoid implicit any; prefer union types to magic strings.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.style_guide_js_v1.yaml",
      "_raw": "id: dev.style_guide_js_v1\nversion: 1.0.0\ndomain: dev\ntitle: JS/TS Style Guide (Practical Defaults)\nstatement: |-\n  Keep the surface consistent; let tools fight bikeshedding.\n\n  Formatter & Lint\n    ‚Ä¢ Prettier; ESLint with recommended + security (eslint-plugin-security) + import/order.\n    ‚Ä¢ TypeScript strict for libraries; app code minimally typed but typed at boundaries.\n\n  Testing & UI\n    ‚Ä¢ Jest/Vitest + Testing Library; prefer role-based queries; avoid brittle snapshots.\n    ‚Ä¢ Keep components pure; derive state; lift state when two consumers need it.\n\n  Examples\n    ‚Ä¢ API calls have abort controllers and sane timeouts.\n    ‚Ä¢ Avoid implicit any; prefer union types to magic strings.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.diff_risk_tags_v1": {
      "id": "dev.diff_risk_tags_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Diff-Derived Risk Tags are Addressed in Review",
      "statement": "Compute risk tags from the diff and require the review to explicitly address each tag.\nTags include (non-exhaustive): security, performance, migration, breaking, dependency,\ninfrastructure, tests, docs. Review must mention each inferred tag.",
      "witnesses": [
        {
          "name": "pr_review_covers_risks",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "REVIEW_PATH": "artifacts/examples/dev/pr_review_good.md",
            "DIFF_PATH": "artifacts/examples/dev/pr_diff.patch"
          },
          "timeout_ms": 5000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, re, json, sys\n\ndef read(path):\n    with open(path, \"r\", errors=\"ignore\") as f:\n        return f.read()\n\nTAG_PATTERNS = {\n    \"security\": [r\"\\bauth\\b\", r\"\\bjwt\\b\", r\"\\bxss\\b\", r\"\\bcsrf\\b\", r\"\\bencrypt\", r\"\\bsecret\\b\", r\"\\btoken\\b\", r\"\\bhash\\b\", r\"\\baes\\b\", r\"\\brsa\\b\"],\n    \"performance\": [r\"\\bO\\([Nn]\\)\", r\"\\bhot path\\b\", r\"\\blatency\\b\", r\"\\bthroughput\\b\", r\"\\bcach\", r\"\\balloc\"],\n    # Migration: require SQL-ish context or migration frameworks/paths (NO plain 'index')\n    \"migration\": [\n        r\"\\bmigrations?/\", r\"\\b(alembic|flyway|liquibase)\\b\",\n        r\"\\bcreate\\s+(table|index)\\b\", r\"\\bdrop\\s+(column|table|index)\\b\",\n        r\"\\balter\\s+table\\b\", r\"\\bddl\\b\", r\"\\bschema\\b\"\n    ],\n    \"breaking\": [r\"BREAKING CHANGE\", r\"\\brename\\b\", r\"\\bremove public\\b\", r\"\\bsignature\\b\", r\"\\bsemver[- ]?major\\b\"],\n    \"dependency\": [r\"package\\.json\", r\"requirements\\.txt\", r\"poetry\\.lock\", r\"yarn\\.lock\", r\"pnpm-lock\", r\"go\\.mod\", r\"Cargo\\.toml\"],\n    \"infrastructure\": [r\"Dockerfile\", r\"\\bk8s\\b\", r\"helm\", r\"terraform\", r\"ansible\", r\"systemd\"],\n    \"tests\": [r\"\\btests?/\", r\"\\btest\", r\"\\bspec\\b\", r\"\\bfixture\\b\", r\"\\bcoverage\\b\"],\n    \"docs\": [r\"README\", r\"\\bdocs?/\", r\"\\.md\\b\"]\n}\n\ndef infer_tags_from_diff(diff_text):\n    tags = set()\n    lowered = diff_text.lower()\n    for tag, pats in TAG_PATTERNS.items():\n        for pat in pats:\n            if re.search(pat, lowered):\n                tags.add(tag); break\n    return sorted(tags)\n\ndef tags_in_text(text):\n    found = set()\n    for tag in TAG_PATTERNS.keys():\n        if re.search(rf\"\\b{tag}\\b\", text, flags=re.I):\n            found.add(tag)\n    m = re.search(r\"tags?\\s*:\\s*([a-z, ]+)\", text, flags=re.I)\n    if m:\n        for t in re.split(r\"[, ]+\", m.group(1).strip()):\n            if t.lower() in TAG_PATTERNS.keys():\n                found.add(t.lower())\n    return sorted(found)\n\ndef main():\n    review_path = os.environ.get(\"REVIEW_PATH\", \"artifacts/examples/dev/pr_review_good.md\")\n    diff_path = os.environ.get(\"DIFF_PATH\", \"artifacts/examples/dev/pr_diff.patch\")\n    if os.path.isdir(review_path): review_path = os.path.join(review_path, \"pr_review_good.md\")\n    if os.path.isdir(diff_path):   diff_path   = os.path.join(diff_path, \"pr_diff.patch\")\n\n    diff_text = read(diff_path)\n    review_text = read(review_path)\n\n    needed  = infer_tags_from_diff(diff_text)\n    present = tags_in_text(review_text)\n    missing = [t for t in needed if t not in present]\n\n    print(json.dumps({\n        \"ok\": len(missing) == 0,\n        \"needed\": needed, \"present\": present, \"missing\": missing,\n        \"review\": review_path, \"diff\": diff_path\n    }, indent=2))\n    sys.exit(0 if not missing else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.diff_risk_tags_v1.yaml",
      "_raw": "id: dev.diff_risk_tags_v1\nversion: 1.0.0\ndomain: dev\ntitle: Diff-Derived Risk Tags are Addressed in Review\nstatement: |-\n  Compute risk tags from the diff and require the review to explicitly address each tag.\n  Tags include (non-exhaustive): security, performance, migration, breaking, dependency,\n  infrastructure, tests, docs. Review must mention each inferred tag.\n\nwitnesses:\n  - name: pr_review_covers_risks\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      REVIEW_PATH: artifacts/examples/dev/pr_review_good.md\n      DIFF_PATH: artifacts/examples/dev/pr_diff.patch\n    timeout_ms: 5000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n        import os, re, json, sys\n\n        def read(path):\n            with open(path, \"r\", errors=\"ignore\") as f:\n                return f.read()\n\n        TAG_PATTERNS = {\n            \"security\": [r\"\\bauth\\b\", r\"\\bjwt\\b\", r\"\\bxss\\b\", r\"\\bcsrf\\b\", r\"\\bencrypt\", r\"\\bsecret\\b\", r\"\\btoken\\b\", r\"\\bhash\\b\", r\"\\baes\\b\", r\"\\brsa\\b\"],\n            \"performance\": [r\"\\bO\\([Nn]\\)\", r\"\\bhot path\\b\", r\"\\blatency\\b\", r\"\\bthroughput\\b\", r\"\\bcach\", r\"\\balloc\"],\n            # Migration: require SQL-ish context or migration frameworks/paths (NO plain 'index')\n            \"migration\": [\n                r\"\\bmigrations?/\", r\"\\b(alembic|flyway|liquibase)\\b\",\n                r\"\\bcreate\\s+(table|index)\\b\", r\"\\bdrop\\s+(column|table|index)\\b\",\n                r\"\\balter\\s+table\\b\", r\"\\bddl\\b\", r\"\\bschema\\b\"\n            ],\n            \"breaking\": [r\"BREAKING CHANGE\", r\"\\brename\\b\", r\"\\bremove public\\b\", r\"\\bsignature\\b\", r\"\\bsemver[- ]?major\\b\"],\n            \"dependency\": [r\"package\\.json\", r\"requirements\\.txt\", r\"poetry\\.lock\", r\"yarn\\.lock\", r\"pnpm-lock\", r\"go\\.mod\", r\"Cargo\\.toml\"],\n            \"infrastructure\": [r\"Dockerfile\", r\"\\bk8s\\b\", r\"helm\", r\"terraform\", r\"ansible\", r\"systemd\"],\n            \"tests\": [r\"\\btests?/\", r\"\\btest\", r\"\\bspec\\b\", r\"\\bfixture\\b\", r\"\\bcoverage\\b\"],\n            \"docs\": [r\"README\", r\"\\bdocs?/\", r\"\\.md\\b\"]\n        }\n\n        def infer_tags_from_diff(diff_text):\n            tags = set()\n            lowered = diff_text.lower()\n            for tag, pats in TAG_PATTERNS.items():\n                for pat in pats:\n                    if re.search(pat, lowered):\n                        tags.add(tag); break\n            return sorted(tags)\n\n        def tags_in_text(text):\n            found = set()\n            for tag in TAG_PATTERNS.keys():\n                if re.search(rf\"\\b{tag}\\b\", text, flags=re.I):\n                    found.add(tag)\n            m = re.search(r\"tags?\\s*:\\s*([a-z, ]+)\", text, flags=re.I)\n            if m:\n                for t in re.split(r\"[, ]+\", m.group(1).strip()):\n                    if t.lower() in TAG_PATTERNS.keys():\n                        found.add(t.lower())\n            return sorted(found)\n\n        def main():\n            review_path = os.environ.get(\"REVIEW_PATH\", \"artifacts/examples/dev/pr_review_good.md\")\n            diff_path = os.environ.get(\"DIFF_PATH\", \"artifacts/examples/dev/pr_diff.patch\")\n            if os.path.isdir(review_path): review_path = os.path.join(review_path, \"pr_review_good.md\")\n            if os.path.isdir(diff_path):   diff_path   = os.path.join(diff_path, \"pr_diff.patch\")\n\n            diff_text = read(diff_path)\n            review_text = read(review_path)\n\n            needed  = infer_tags_from_diff(diff_text)\n            present = tags_in_text(review_text)\n            missing = [t for t in needed if t not in present]\n\n            print(json.dumps({\n                \"ok\": len(missing) == 0,\n                \"needed\": needed, \"present\": present, \"missing\": missing,\n                \"review\": review_path, \"diff\": diff_path\n            }, indent=2))\n            sys.exit(0 if not missing else 1)\n\n        if __name__ == \"__main__\":\n            main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "dev.enforce_todo_ticket_v1": {
      "id": "dev.enforce_todo_ticket_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Enforce TODO/FIXME Lines Reference a Ticket",
      "statement": "Any newly added TODO/FIXME lines in a diff must include a valid ticket reference.\nDefault format is `(PROJ|JIRA)-[0-9]+` and can be customized with env `TICKET_REGEX`.\nScope: added lines only (unified diff), excluding headers (`+++`, `@@`, `diff --git`).\nPass criteria:\n  ‚Ä¢ If no TODO/FIXME were added ‚áí PASS.\n  ‚Ä¢ If TODO/FIXME were added ‚áí each TODO line must contain a ticket reference that matches `TICKET_REGEX`.",
      "assumptions": [
        "Diff is a standard unified diff (e.g., `git diff`).",
        "Reviewers accept TODOs only when linked to tracked work.",
        "Ticket prefix is stable and communicated to the team."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "If this TODO is worth shipping, where‚Äôs the ticket to follow it up?"
        },
        {
          "kind": "Socratic",
          "text": "What template would keep TODOs actionable and time-bounded?"
        },
        {
          "kind": "Aphorism",
          "text": "No ticket, no TODO."
        }
      ],
      "witnesses": [
        {
          "name": "todo_refs_present",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "DIFF_PATH": "artifacts/examples/pr_diff.patch",
            "TICKET_REGEX": "(PROJ|JIRA)-[0-9]+"
          },
          "timeout_ms": 5000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, sys, re, json\n\nDIFF_PATH = os.environ.get(\"DIFF_PATH\", \"artifacts/examples/pr_diff.patch\")\nTICKET_REGEX = os.environ.get(\"TICKET_REGEX\", r\"(PROJ|JIRA)-[0-9]+\")\nticket_rx = re.compile(TICKET_REGEX)\n\ndef iter_added_lines(p):\n    with open(p, \"r\", errors=\"ignore\") as f:\n        for line in f:\n            if line.startswith(\"+++ \") or line.startswith(\"--- \"):  # file headers\n                continue\n            if line.startswith(\"@@ \"):  # hunk headers\n                continue\n            if line.startswith(\"diff --git \"):  # git headers\n                continue\n            if line.startswith(\"+++\"):  # guard against \"+++b/file\"\n                continue\n            if line.startswith(\"+\") and not line.startswith(\"+++\") and not line.startswith(\"+@@\"):\n                yield line[1:].rstrip(\"\\n\")\n\ndef main():\n    todo_lines = []\n    with_ticket = []\n    missing = []\n\n    for added in iter_added_lines(DIFF_PATH):\n        # We treat \"TODO\" or \"FIXME\" (any case) as a tracked to-do marker\n        if re.search(r\"(?i)\\b(TODO|FIXME)\\b\", added):\n            todo_lines.append(added)\n            if ticket_rx.search(added):\n                with_ticket.append(added)\n            else:\n                missing.append(added)\n\n    ok = (len(todo_lines) == 0) or (len(missing) == 0)\n\n    out = {\n        \"ok\": ok,\n        \"diff\": DIFF_PATH,\n        \"regex\": TICKET_REGEX,\n        \"todo_added_count\": len(todo_lines),\n        \"todo_with_ticket\": len(with_ticket),\n        \"todo_missing_ticket\": len(missing),\n        \"examples_missing\": missing[:5]\n    }\n    print(json.dumps(out, indent=2))\n    sys.exit(0 if ok else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "Truth Capsules",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-10T00:00:00+00:00",
        "updated": "2025-11-10T00:00:00+00:00"
      },
      "applies_to": [
        "ci",
        "code_assistant"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.enforce_todo_ticket_v1.yaml",
      "_raw": "id: dev.enforce_todo_ticket_v1\nversion: 1.0.0\ndomain: dev\ntitle: Enforce TODO/FIXME Lines Reference a Ticket\nstatement: |-\n  Any newly added TODO/FIXME lines in a diff must include a valid ticket reference.\n  Default format is `(PROJ|JIRA)-[0-9]+` and can be customized with env `TICKET_REGEX`.\n  Scope: added lines only (unified diff), excluding headers (`+++`, `@@`, `diff --git`).\n  Pass criteria:\n    ‚Ä¢ If no TODO/FIXME were added ‚áí PASS.\n    ‚Ä¢ If TODO/FIXME were added ‚áí each TODO line must contain a ticket reference that matches `TICKET_REGEX`.\n\nassumptions:\n  - Diff is a standard unified diff (e.g., `git diff`).\n  - Reviewers accept TODOs only when linked to tracked work.\n  - Ticket prefix is stable and communicated to the team.\n\npedagogy:\n  - kind: Socratic\n    text: If this TODO is worth shipping, where‚Äôs the ticket to follow it up?\n  - kind: Socratic\n    text: What template would keep TODOs actionable and time-bounded?\n  - kind: Aphorism\n    text: No ticket, no TODO.\n\nwitnesses:\n  - name: todo_refs_present\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      DIFF_PATH: artifacts/examples/pr_diff.patch\n      TICKET_REGEX: \"(PROJ|JIRA)-[0-9]+\"\n    timeout_ms: 5000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, sys, re, json\n\n      DIFF_PATH = os.environ.get(\"DIFF_PATH\", \"artifacts/examples/pr_diff.patch\")\n      TICKET_REGEX = os.environ.get(\"TICKET_REGEX\", r\"(PROJ|JIRA)-[0-9]+\")\n      ticket_rx = re.compile(TICKET_REGEX)\n\n      def iter_added_lines(p):\n          with open(p, \"r\", errors=\"ignore\") as f:\n              for line in f:\n                  if line.startswith(\"+++ \") or line.startswith(\"--- \"):  # file headers\n                      continue\n                  if line.startswith(\"@@ \"):  # hunk headers\n                      continue\n                  if line.startswith(\"diff --git \"):  # git headers\n                      continue\n                  if line.startswith(\"+++\"):  # guard against \"+++b/file\"\n                      continue\n                  if line.startswith(\"+\") and not line.startswith(\"+++\") and not line.startswith(\"+@@\"):\n                      yield line[1:].rstrip(\"\\n\")\n\n      def main():\n          todo_lines = []\n          with_ticket = []\n          missing = []\n\n          for added in iter_added_lines(DIFF_PATH):\n              # We treat \"TODO\" or \"FIXME\" (any case) as a tracked to-do marker\n              if re.search(r\"(?i)\\b(TODO|FIXME)\\b\", added):\n                  todo_lines.append(added)\n                  if ticket_rx.search(added):\n                      with_ticket.append(added)\n                  else:\n                      missing.append(added)\n\n          ok = (len(todo_lines) == 0) or (len(missing) == 0)\n\n          out = {\n              \"ok\": ok,\n              \"diff\": DIFF_PATH,\n              \"regex\": TICKET_REGEX,\n              \"todo_added_count\": len(todo_lines),\n              \"todo_with_ticket\": len(with_ticket),\n              \"todo_missing_ticket\": len(missing),\n              \"examples_missing\": missing[:5]\n          }\n          print(json.dumps(out, indent=2))\n          sys.exit(0 if ok else 1)\n\n      if __name__ == \"__main__\":\n          main()\n\nprovenance:\n  schema: provenance.v1\n  author: Truth Capsules\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: 2025-11-10T00:00:00Z\n  updated: 2025-11-10T00:00:00Z\n\napplies_to:\n  - ci\n  - code_assistant\n\ndependencies: []\nincompatible_with: []\n\nsecurity:\n  sensitivity: low\n  notes: \"\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "dev.secret_scan_baseline_v1": {
      "id": "dev.secret_scan_baseline_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Secret Scan Baseline (No Keys, No High-Entropy Blobs)",
      "statement": "Scan source tree for obvious secrets and high-entropy blobs. Skip vendor and binary paths.\nFail on suspected credentials or suspicious entropy across text files.",
      "witnesses": [
        {
          "name": "no_high_entropy_or_keys",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "REPO_PATH": ".",
            "INCLUDE_GLOBS_JSON": "[\"**/*.py\",\"**/*.js\",\"**/*.ts\",\"**/*.go\",\"**/*.rs\",\"**/*.java\",\"**/*.sh\",\"**/*.yaml\",\"**/*.yml\",\"**/*.toml\",\"**/*.ini\",\"**/*.cfg\",\"**/*.conf\"]",
            "EXCLUDE_GLOBS_JSON": "[\"**/.env*\",\"**/out/**\",\"**/dist/**\",\"**/build/**\",\"**/node_modules/**\",\"**/.git/**\",\"**/__pycache__/**\",\"**/*.json\",\"**/*.ndjson\",\"**/*.ttl\",\"**/*.md\"]",
            "SKIP_DIRS_JSON": "[\".git\",\"node_modules\",\"venv\",\".venv\",\".cache\",\"dist\",\"build\",\"__pycache__\"]",
            "MAX_FILES": "2000",
            "MAX_FILE_BYTES": "200000",
            "ENTROPY_THRESHOLD": "5.2",
            "TOKEN_MINLEN": "20",
            "KEY_REGEXES_JSON": "[\n  \"(?i)aws[_-]?access[_-]?key[_-]?id\",\n  \"(?i)aws[_-]?secret[_-]?access[_-]?key\",\n  \"(?i)gh[_-]?token|github[_-]?token\",\n  \"(?i)slack[_-]?(token|webhook)\",\n  \"(?i)api[_-]?key|secret[_-]?key|private[_-]?key\",\n  \"-----BEGIN\\\\s+PRIVATE\\\\s+KEY-----\"\n]\n"
          },
          "timeout_ms": 8000,
          "memory_mb": 256,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, sys, json, math, fnmatch, re\n\ndef env_json(name, default):\n    try: return json.loads(os.environ.get(name, json.dumps(default)))\n    except Exception: return default\n\ndef env_int(name, default):\n    try: return int(os.environ.get(name, str(default)))\n    except Exception: return default\n\ndef env_float(name, default):\n    try: return float(os.environ.get(name, str(default)))\n    except Exception: return default\n\ndef shannon_entropy(s):\n    if not s: return 0.0\n    freq = {}\n    for ch in s: freq[ch] = freq.get(ch, 0) + 1\n    H = 0.0\n    ln = len(s)\n    for c in freq.values():\n        p = c / ln\n        H -= p * math.log2(p)\n    return H\n\ndef looks_binary(b):\n    return (b.count(b\"\\x00\") > 0) or any(c < 9 for c in b[:64])\n\ndef read_limited(path, max_bytes):\n    with open(path, \"rb\") as f: return f.read(max_bytes)\n\ndef match_any_glob(path, globs):\n    return any(fnmatch.fnmatch(path, g) for g in globs)\n\ndef main():\n    root = os.environ.get(\"REPO_PATH\", \".\")\n    include_globs = env_json(\"INCLUDE_GLOBS_JSON\", [])\n    exclude_globs = env_json(\"EXCLUDE_GLOBS_JSON\", [])\n    skip_dirs = set(env_json(\"SKIP_DIRS_JSON\", []))\n    max_files = env_int(\"MAX_FILES\", 2000)\n    max_bytes = env_int(\"MAX_FILE_BYTES\", 200000)\n    thr = env_float(\"ENTROPY_THRESHOLD\", 5.2)\n    token_min = env_int(\"TOKEN_MINLEN\", 20)\n    key_res = [re.compile(p) for p in env_json(\"KEY_REGEXES_JSON\", [])]\n    token_re = re.compile(rf\"[A-Za-z0-9+/=_-]{{{token_min},}}\")\n\n    findings, scanned = [], 0\n\n    for cur, dirs, files in os.walk(root):\n        dirs[:] = [d for d in dirs if os.path.join(cur, d).split(os.sep)[-1] not in skip_dirs]\n        for name in files:\n            rel = os.path.relpath(os.path.join(cur, name), root)\n            if exclude_globs and match_any_glob(rel, exclude_globs): continue\n            if include_globs and not match_any_glob(rel, include_globs): continue\n\n            scanned += 1\n            if scanned > max_files:\n                findings.append({\"limit\": \"max_files_reached\", \"scanned\": scanned})\n                break\n\n            try: data = read_limited(os.path.join(root, rel), max_bytes)\n            except Exception: continue\n            if looks_binary(data): continue\n\n            try: text = data.decode(\"utf-8\", \"ignore\")\n            except Exception: continue\n\n            # Regex hits (keys/secrets style)\n            regex_hits = []\n            for rx in key_res:\n                if rx.search(text):\n                    regex_hits.append(rx.pattern)\n\n            # Token-level entropy (not whole file): find long base64/hex-ish substrings\n            token_hits = []\n            for tok in token_re.findall(text):\n                H = shannon_entropy(tok)\n                if H >= thr:\n                    token_hits.append({\"token_len\": len(tok), \"entropy\": round(H, 3)})\n\n            if regex_hits or token_hits:\n                findings.append({\n                    \"file\": rel,\n                    \"regex_hits\": regex_hits,\n                    \"token_hits\": token_hits[:5]\n                })\n\n        if scanned > max_files: break\n\n    ok = len([f for f in findings if \"file\" in f]) == 0\n    out = {\n        \"ok\": ok,\n        \"findings\": findings[:50],\n        \"scanned_files\": scanned,\n        \"root\": root,\n        \"limits\": {\n            \"max_files\": max_files,\n            \"max_file_bytes\": max_bytes,\n            \"entropy_threshold\": thr,\n            \"token_minlen\": token_min\n        },\n        \"skipped_dirs\": sorted(skip_dirs),\n        \"include_globs\": include_globs,\n        \"exclude_globs\": exclude_globs\n    }\n    print(json.dumps(out, indent=2))\n    sys.exit(0 if ok else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.secret_scan_baseline_v1.yaml",
      "_raw": "id: dev.secret_scan_baseline_v1\nversion: 1.0.0\ndomain: dev\ntitle: Secret Scan Baseline (No Keys, No High-Entropy Blobs)\nstatement: |-\n  Scan source tree for obvious secrets and high-entropy blobs. Skip vendor and binary paths.\n  Fail on suspected credentials or suspicious entropy across text files.\nwitnesses:\n  - name: no_high_entropy_or_keys\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      REPO_PATH: .\n      # Scan only code-ish files by default; you can widen with INCLUDE_GLOBS_JSON\n      INCLUDE_GLOBS_JSON: '[\"**/*.py\",\"**/*.js\",\"**/*.ts\",\"**/*.go\",\"**/*.rs\",\"**/*.java\",\"**/*.sh\",\"**/*.yaml\",\"**/*.yml\",\"**/*.toml\",\"**/*.ini\",\"**/*.cfg\",\"**/*.conf\"]'\n      # Skip heavy/noisy dirs/files\n      EXCLUDE_GLOBS_JSON: '[\"**/.env*\",\"**/out/**\",\"**/dist/**\",\"**/build/**\",\"**/node_modules/**\",\"**/.git/**\",\"**/__pycache__/**\",\"**/*.json\",\"**/*.ndjson\",\"**/*.ttl\",\"**/*.md\"]'\n      SKIP_DIRS_JSON: '[\".git\",\"node_modules\",\"venv\",\".venv\",\".cache\",\"dist\",\"build\",\"__pycache__\"]'\n      MAX_FILES: \"2000\"\n      MAX_FILE_BYTES: \"200000\"\n      ENTROPY_THRESHOLD: \"5.2\"             # higher to avoid ‚Äúnormal text‚Äù trips\n      # Candidate token pattern: long base64/hex-ish strings\n      TOKEN_MINLEN: \"20\"\n      KEY_REGEXES_JSON: |\n        [\n          \"(?i)aws[_-]?access[_-]?key[_-]?id\",\n          \"(?i)aws[_-]?secret[_-]?access[_-]?key\",\n          \"(?i)gh[_-]?token|github[_-]?token\",\n          \"(?i)slack[_-]?(token|webhook)\",\n          \"(?i)api[_-]?key|secret[_-]?key|private[_-]?key\",\n          \"-----BEGIN\\\\s+PRIVATE\\\\s+KEY-----\"\n        ]\n    timeout_ms: 8000\n    memory_mb: 256\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, sys, json, math, fnmatch, re\n\n      def env_json(name, default):\n          try: return json.loads(os.environ.get(name, json.dumps(default)))\n          except Exception: return default\n\n      def env_int(name, default):\n          try: return int(os.environ.get(name, str(default)))\n          except Exception: return default\n\n      def env_float(name, default):\n          try: return float(os.environ.get(name, str(default)))\n          except Exception: return default\n\n      def shannon_entropy(s):\n          if not s: return 0.0\n          freq = {}\n          for ch in s: freq[ch] = freq.get(ch, 0) + 1\n          H = 0.0\n          ln = len(s)\n          for c in freq.values():\n              p = c / ln\n              H -= p * math.log2(p)\n          return H\n\n      def looks_binary(b):\n          return (b.count(b\"\\x00\") > 0) or any(c < 9 for c in b[:64])\n\n      def read_limited(path, max_bytes):\n          with open(path, \"rb\") as f: return f.read(max_bytes)\n\n      def match_any_glob(path, globs):\n          return any(fnmatch.fnmatch(path, g) for g in globs)\n\n      def main():\n          root = os.environ.get(\"REPO_PATH\", \".\")\n          include_globs = env_json(\"INCLUDE_GLOBS_JSON\", [])\n          exclude_globs = env_json(\"EXCLUDE_GLOBS_JSON\", [])\n          skip_dirs = set(env_json(\"SKIP_DIRS_JSON\", []))\n          max_files = env_int(\"MAX_FILES\", 2000)\n          max_bytes = env_int(\"MAX_FILE_BYTES\", 200000)\n          thr = env_float(\"ENTROPY_THRESHOLD\", 5.2)\n          token_min = env_int(\"TOKEN_MINLEN\", 20)\n          key_res = [re.compile(p) for p in env_json(\"KEY_REGEXES_JSON\", [])]\n          token_re = re.compile(rf\"[A-Za-z0-9+/=_-]{{{token_min},}}\")\n\n          findings, scanned = [], 0\n\n          for cur, dirs, files in os.walk(root):\n              dirs[:] = [d for d in dirs if os.path.join(cur, d).split(os.sep)[-1] not in skip_dirs]\n              for name in files:\n                  rel = os.path.relpath(os.path.join(cur, name), root)\n                  if exclude_globs and match_any_glob(rel, exclude_globs): continue\n                  if include_globs and not match_any_glob(rel, include_globs): continue\n\n                  scanned += 1\n                  if scanned > max_files:\n                      findings.append({\"limit\": \"max_files_reached\", \"scanned\": scanned})\n                      break\n\n                  try: data = read_limited(os.path.join(root, rel), max_bytes)\n                  except Exception: continue\n                  if looks_binary(data): continue\n\n                  try: text = data.decode(\"utf-8\", \"ignore\")\n                  except Exception: continue\n\n                  # Regex hits (keys/secrets style)\n                  regex_hits = []\n                  for rx in key_res:\n                      if rx.search(text):\n                          regex_hits.append(rx.pattern)\n\n                  # Token-level entropy (not whole file): find long base64/hex-ish substrings\n                  token_hits = []\n                  for tok in token_re.findall(text):\n                      H = shannon_entropy(tok)\n                      if H >= thr:\n                          token_hits.append({\"token_len\": len(tok), \"entropy\": round(H, 3)})\n\n                  if regex_hits or token_hits:\n                      findings.append({\n                          \"file\": rel,\n                          \"regex_hits\": regex_hits,\n                          \"token_hits\": token_hits[:5]\n                      })\n\n              if scanned > max_files: break\n\n          ok = len([f for f in findings if \"file\" in f]) == 0\n          out = {\n              \"ok\": ok,\n              \"findings\": findings[:50],\n              \"scanned_files\": scanned,\n              \"root\": root,\n              \"limits\": {\n                  \"max_files\": max_files,\n                  \"max_file_bytes\": max_bytes,\n                  \"entropy_threshold\": thr,\n                  \"token_minlen\": token_min\n              },\n              \"skipped_dirs\": sorted(skip_dirs),\n              \"include_globs\": include_globs,\n              \"exclude_globs\": exclude_globs\n          }\n          print(json.dumps(out, indent=2))\n          sys.exit(0 if ok else 1)\n\n      if __name__ == \"__main__\":\n          main()\n\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "dev.commit_conventions_v1": {
      "id": "dev.commit_conventions_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Conventional Commits (with Examples)",
      "statement": "Consistent messages ‚Üí better changelogs, semantic versioning, and easier reviews.\n\nTypes\n  ‚Ä¢ feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert\n\nFormat\n  ‚Ä¢ type(scope): brief imperative summary\n  ‚Ä¢ Blank line, then optional body; footer for BREAKING CHANGE or issues.\n\nExamples\n  ‚Ä¢ feat(api): add pagination to listUsers\n  ‚Ä¢ fix(auth): handle expired refresh tokens\n  ‚Ä¢ docs(readme): add quickstart docker commands\n\nDiff etiquette\n  ‚Ä¢ Keep PRs small; isolate unrelated changes; include before/after snippets when helpful.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.commit_conventions_v1.yaml",
      "_raw": "id: dev.commit_conventions_v1\nversion: 1.0.0\ndomain: dev\ntitle: Conventional Commits (with Examples)\nstatement: |-\n  Consistent messages ‚Üí better changelogs, semantic versioning, and easier reviews.\n\n  Types\n    ‚Ä¢ feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert\n\n  Format\n    ‚Ä¢ type(scope): brief imperative summary\n    ‚Ä¢ Blank line, then optional body; footer for BREAKING CHANGE or issues.\n\n  Examples\n    ‚Ä¢ feat(api): add pagination to listUsers\n    ‚Ä¢ fix(auth): handle expired refresh tokens\n    ‚Ä¢ docs(readme): add quickstart docker commands\n\n  Diff etiquette\n    ‚Ä¢ Keep PRs small; isolate unrelated changes; include before/after snippets when helpful.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.prompt_safety_rules_v1": {
      "id": "dev.prompt_safety_rules_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Prompt Safety Rules (No Secrets, No PHI/PII, Scratchpad Discipline)",
      "statement": "Guardrails for safe, reproducible dev prompting.\n\nDo\n  ‚Ä¢ Redact or mask secrets/PHI/PII before pasting (tokens, keys, emails, phone numbers).\n  ‚Ä¢ Use a scratchpad file; summarize context; paste only minimal diffs, errors, and file paths.\n  ‚Ä¢ State desired output explicitly (patch/diff, function signature, CLI snippet).\n  ‚Ä¢ Declare toolchain versions and OS when relevant (python 3.11, node 20, ubuntu 22.04).\n  ‚Ä¢ Prefer small, testable changes; include tests or commands to verify.\n\nDon‚Äôt\n  ‚Ä¢ Paste .env, private keys, customer data, or production URLs.\n  ‚Ä¢ Demand sweeping refactors; avoid touching unrelated files.\n  ‚Ä¢ Bury the lede ‚Äî put the objective first; attach diagnostics after.\n\nScratchpad discipline\n  ‚Ä¢ Keep a running PLAN ‚Üí VERIFY ‚Üí ANSWER section.\n  ‚Ä¢ Use fenced code blocks for diffs/patches; keep commit-ready.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.prompt_safety_rules_v1.yaml",
      "_raw": "id: dev.prompt_safety_rules_v1\nversion: 1.0.0\ndomain: dev\ntitle: Prompt Safety Rules (No Secrets, No PHI/PII, Scratchpad Discipline)\nstatement: |-\n  Guardrails for safe, reproducible dev prompting.\n\n  Do\n    ‚Ä¢ Redact or mask secrets/PHI/PII before pasting (tokens, keys, emails, phone numbers).\n    ‚Ä¢ Use a scratchpad file; summarize context; paste only minimal diffs, errors, and file paths.\n    ‚Ä¢ State desired output explicitly (patch/diff, function signature, CLI snippet).\n    ‚Ä¢ Declare toolchain versions and OS when relevant (python 3.11, node 20, ubuntu 22.04).\n    ‚Ä¢ Prefer small, testable changes; include tests or commands to verify.\n\n  Don‚Äôt\n    ‚Ä¢ Paste .env, private keys, customer data, or production URLs.\n    ‚Ä¢ Demand sweeping refactors; avoid touching unrelated files.\n    ‚Ä¢ Bury the lede ‚Äî put the objective first; attach diagnostics after.\n\n  Scratchpad discipline\n    ‚Ä¢ Keep a running PLAN ‚Üí VERIFY ‚Üí ANSWER section.\n    ‚Ä¢ Use fenced code blocks for diffs/patches; keep commit-ready.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.style_guide_python_v1": {
      "id": "dev.style_guide_python_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Python Style Guide (Practical Defaults)",
      "statement": "Use boring, reliable defaults to keep diffs clean and onboarding fast.\n\nFormatter & Lint\n  ‚Ä¢ Black (line-length 88), isort (profile=black), Ruff (or flake8) with error-level lint.\n  ‚Ä¢ mypy: --strict for libraries, relaxed for apps; add types for new/changed code.\n\nDocstrings & Tests\n  ‚Ä¢ Google or NumPy style docstrings; include Args/Returns/Raises.\n  ‚Ä¢ pytest for tests; AAA pattern; prefer small, focused tests.\n\nExamples\n  ‚Ä¢ Function signature changes require typing + tests.\n  ‚Ä¢ IO code uses context managers; network calls have timeouts.\n  ‚Ä¢ Use pathlib, not os.path string munging; f-strings over format().",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.style_guide_python_v1.yaml",
      "_raw": "id: dev.style_guide_python_v1\nversion: 1.0.0\ndomain: dev\ntitle: Python Style Guide (Practical Defaults)\nstatement: |-\n  Use boring, reliable defaults to keep diffs clean and onboarding fast.\n\n  Formatter & Lint\n    ‚Ä¢ Black (line-length 88), isort (profile=black), Ruff (or flake8) with error-level lint.\n    ‚Ä¢ mypy: --strict for libraries, relaxed for apps; add types for new/changed code.\n\n  Docstrings & Tests\n    ‚Ä¢ Google or NumPy style docstrings; include Args/Returns/Raises.\n    ‚Ä¢ pytest for tests; AAA pattern; prefer small, focused tests.\n\n  Examples\n    ‚Ä¢ Function signature changes require typing + tests.\n    ‚Ä¢ IO code uses context managers; network calls have timeouts.\n    ‚Ä¢ Use pathlib, not os.path string munging; f-strings over format().\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.review_checklist_v1": {
      "id": "dev.review_checklist_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "PR Review Checklist (Security, Perf, i18n, Docs, Tests)",
      "statement": "Minimal checklist for actionable reviews.\n\nSecurity\n  ‚Ä¢ Inputs validated; authz checked; secrets not logged; dependencies sane.\nPerformance\n  ‚Ä¢ No accidental N^2; hot paths measured; allocations/retries bounded.\ni18n & UX\n  ‚Ä¢ Text externalized; RTL and accessibility considered for UI.\nDocs & Tests\n  ‚Ä¢ README/CHANGELOG touched if behavior changes; tests added/updated; coverage stable.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.review_checklist_v1.yaml",
      "_raw": "id: dev.review_checklist_v1\nversion: 1.0.0\ndomain: dev\ntitle: PR Review Checklist (Security, Perf, i18n, Docs, Tests)\nstatement: |-\n  Minimal checklist for actionable reviews.\n\n  Security\n    ‚Ä¢ Inputs validated; authz checked; secrets not logged; dependencies sane.\n  Performance\n    ‚Ä¢ No accidental N^2; hot paths measured; allocations/retries bounded.\n  i18n & UX\n    ‚Ä¢ Text externalized; RTL and accessibility considered for UI.\n  Docs & Tests\n    ‚Ä¢ README/CHANGELOG touched if behavior changes; tests added/updated; coverage stable.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.pii_redaction_smoke_v1": {
      "id": "support.pii_redaction_smoke_v1",
      "version": "1.0.0",
      "domain": "support",
      "title": "PII Redaction Smoke Test",
      "statement": "Ensure bundled examples contain no plaintext PII. This check scans example transcripts\n(default: artifacts/examples/support_agent/examples.txt) for emails, phone numbers,\ncredit card patterns, government ID keywords, street addresses, and IP addresses.",
      "witnesses": [
        {
          "name": "no_plaintext_pii_in_examples",
          "language": "python",
          "code": "import os, sys, re, json, glob\n\ndef find_files(path):\n    if os.path.isdir(path):\n        for ext in (\"*.txt\", \"*.md\", \"*.log\"):\n            for p in glob.glob(os.path.join(path, ext)):\n                yield p\n    else:\n        if os.path.exists(path):\n            yield path\n\nEMAIL = re.compile(r\"[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\", re.I)\nPHONE = re.compile(r\"(?:\\+?\\d{1,3}[\\s\\-\\.]?)?(?:\\(?\\d{3}\\)?[\\s\\-\\.]?\\d{3}[\\s\\-\\.]?\\d{4})\")\nCCARD = re.compile(r\"\\b(?:\\d[ -]*?){13,19}\\b\")\nGOVID = re.compile(r\"\\b(?:SSN|NIN|SIN|CPF|DNI|Aadhar)\\b\", re.I)\nADDRESS = re.compile(r\"\\b\\d{1,5}\\s+\\w+\\s+(?:St|Street|Ave|Avenue|Rd|Road|Blvd|Lane|Ln|Dr|Drive)\\b\", re.I)\nIPADDR = re.compile(r\"\\b(?:(?:\\d{1,3}\\.){3}\\d{1,3})\\b\")\n\nMASKED_TOKENS = re.compile(r\"\\*\\*\\*|\\[redacted\\]|\\[masked\\]\", re.I)\n\ndef main():\n    examples_path = os.environ.get(\"EXAMPLES_PATH\", \"\").strip()\n    fail_on_any = os.environ.get(\"FAIL_ON_ANY\", \"true\").lower() == \"true\"\n\n    if not examples_path:\n        print(json.dumps({\"ok\": False, \"error\": \"EXAMPLES_PATH not set\"}))\n        sys.exit(2)\n\n    patterns = {\n        \"email\": EMAIL,\n        \"phone\": PHONE,\n        \"credit_card\": CCARD,\n        \"government_id\": GOVID,\n        \"street_address\": ADDRESS,\n        \"ip_address\": IPADDR,\n    }\n\n    findings = []\n    total_lines = 0\n\n    for fp in find_files(examples_path):\n        with open(fp, \"r\", errors=\"ignore\") as f:\n            for ln, line in enumerate(f, 1):\n                total_lines += 1\n                if MASKED_TOKENS.search(line):\n                    continue\n                for tag, rx in patterns.items():\n                    for m in rx.finditer(line):\n                        findings.append({\"file\": fp, \"line\": ln, \"tag\": tag, \"match\": m.group(0)[:64]})\n\n    ok = len(findings) == 0\n    result = {\"ok\": ok, \"total_lines\": total_lines, \"violations\": findings}\n\n    print(json.dumps(result, indent=2))\n    sys.exit(0 if (ok or not fail_on_any) else 1)\n\nif __name__ == \"__main__\":\n    main()",
          "env": {
            "EXAMPLES_PATH": "artifacts/examples/support_agent/examples.txt",
            "FAIL_ON_ANY": "true"
          },
          "success_message": "No PII found in examples.",
          "failure_message": "PII detected in examples. Redact or mask before shipping."
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.pii_redaction_smoke_v1.yaml",
      "_raw": "id: support.pii_redaction_smoke_v1\nversion: 1.0.0\ndomain: support\ntitle: PII Redaction Smoke Test\nstatement: |-\n  Ensure bundled examples contain no plaintext PII. This check scans example transcripts\n  (default: artifacts/examples/support_agent/examples.txt) for emails, phone numbers,\n  credit card patterns, government ID keywords, street addresses, and IP addresses.\nwitnesses:\n  - name: no_plaintext_pii_in_examples\n    language: python\n    code: |-\n      import os, sys, re, json, glob\n\n      def find_files(path):\n          if os.path.isdir(path):\n              for ext in (\"*.txt\", \"*.md\", \"*.log\"):\n                  for p in glob.glob(os.path.join(path, ext)):\n                      yield p\n          else:\n              if os.path.exists(path):\n                  yield path\n\n      EMAIL = re.compile(r\"[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\", re.I)\n      PHONE = re.compile(r\"(?:\\+?\\d{1,3}[\\s\\-\\.]?)?(?:\\(?\\d{3}\\)?[\\s\\-\\.]?\\d{3}[\\s\\-\\.]?\\d{4})\")\n      CCARD = re.compile(r\"\\b(?:\\d[ -]*?){13,19}\\b\")\n      GOVID = re.compile(r\"\\b(?:SSN|NIN|SIN|CPF|DNI|Aadhar)\\b\", re.I)\n      ADDRESS = re.compile(r\"\\b\\d{1,5}\\s+\\w+\\s+(?:St|Street|Ave|Avenue|Rd|Road|Blvd|Lane|Ln|Dr|Drive)\\b\", re.I)\n      IPADDR = re.compile(r\"\\b(?:(?:\\d{1,3}\\.){3}\\d{1,3})\\b\")\n\n      MASKED_TOKENS = re.compile(r\"\\*\\*\\*|\\[redacted\\]|\\[masked\\]\", re.I)\n\n      def main():\n          examples_path = os.environ.get(\"EXAMPLES_PATH\", \"\").strip()\n          fail_on_any = os.environ.get(\"FAIL_ON_ANY\", \"true\").lower() == \"true\"\n\n          if not examples_path:\n              print(json.dumps({\"ok\": False, \"error\": \"EXAMPLES_PATH not set\"}))\n              sys.exit(2)\n\n          patterns = {\n              \"email\": EMAIL,\n              \"phone\": PHONE,\n              \"credit_card\": CCARD,\n              \"government_id\": GOVID,\n              \"street_address\": ADDRESS,\n              \"ip_address\": IPADDR,\n          }\n\n          findings = []\n          total_lines = 0\n\n          for fp in find_files(examples_path):\n              with open(fp, \"r\", errors=\"ignore\") as f:\n                  for ln, line in enumerate(f, 1):\n                      total_lines += 1\n                      if MASKED_TOKENS.search(line):\n                          continue\n                      for tag, rx in patterns.items():\n                          for m in rx.finditer(line):\n                              findings.append({\"file\": fp, \"line\": ln, \"tag\": tag, \"match\": m.group(0)[:64]})\n\n          ok = len(findings) == 0\n          result = {\"ok\": ok, \"total_lines\": total_lines, \"violations\": findings}\n\n          print(json.dumps(result, indent=2))\n          sys.exit(0 if (ok or not fail_on_any) else 1)\n\n      if __name__ == \"__main__\":\n          main()\n    env:\n      EXAMPLES_PATH: artifacts/examples/support_agent/examples.txt\n      FAIL_ON_ANY: \"true\"\n    success_message: \"No PII found in examples.\"\n    failure_message: \"PII detected in examples. Redact or mask before shipping.\"\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: ''\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "support.billing_basics_v1": {
      "id": "support.billing_basics_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Billing Playbooks (SaaS)",
      "statement": "Canonical flows for common billing issues without exposing PII or promising credits.\n\nPlaybook: Get invoice PDF\n  1) Ask for masked account identifier (e.g., ticket or org slug).\n  2) Guide to: Settings ‚Üí Billing ‚Üí Invoices ‚Üí \"Download PDF\".\n  3) If missing, create ticket for Billing with masked reference.\n\nPlaybook: Refund request (within policy)\n  1) Acknowledge and summarize the reason.\n  2) Link refunds policy (exact section) and timeframe.\n  3) Create Billing ticket; do not promise outcome; share reference ID.\n\nPlaybook: Plan downgrade / cancel\n  1) Confirm effective date and proration link.\n  2) Guide to: Settings ‚Üí Plan ‚Üí \"Change plan\".\n  3) If blocked by contract, route to Billing Supervisor.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.billing_basics_v1.yaml",
      "_raw": "id: support.billing_basics_v1\nversion: 1.1.0\ndomain: support\ntitle: Billing Playbooks (SaaS)\nstatement: |-\n  Canonical flows for common billing issues without exposing PII or promising credits.\n\n  Playbook: Get invoice PDF\n    1) Ask for masked account identifier (e.g., ticket or org slug).\n    2) Guide to: Settings ‚Üí Billing ‚Üí Invoices ‚Üí \"Download PDF\".\n    3) If missing, create ticket for Billing with masked reference.\n\n  Playbook: Refund request (within policy)\n    1) Acknowledge and summarize the reason.\n    2) Link refunds policy (exact section) and timeframe.\n    3) Create Billing ticket; do not promise outcome; share reference ID.\n\n  Playbook: Plan downgrade / cancel\n    1) Confirm effective date and proration link.\n    2) Guide to: Settings ‚Üí Plan ‚Üí \"Change plan\".\n    3) If blocked by contract, route to Billing Supervisor.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.knowledge_view_projection_v1": {
      "id": "support.knowledge_view_projection_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Knowledge View & Citation Policy",
      "statement": "Cite official docs with exact anchors; avoid paraphrasing policy-sensitive pages.\n\nSources policy:\n  ‚Ä¢ Prefer official docs, status pages, and signed announcements. Avoid blog posts for policy.\n\nCitation rules:\n  ‚Ä¢ Link the exact doc section and version (e.g., /docs/billing#refunds v3.1).\n  ‚Ä¢ Summarize in one sentence, then provide the link; do not copy large passages.\n  ‚Ä¢ If doc is gated, describe the path (Settings ‚Üí Billing ‚Üí Invoices).\n  ‚Ä¢ For outages, always include {status_url} and the last update time.\n\nLink policy:\n  ‚Ä¢ Never link to internal-only resources in public responses.\n  ‚Ä¢ If a page moves, provide both old and new paths during the transition.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.knowledge_view_projection_v1.yaml",
      "_raw": "id: support.knowledge_view_projection_v1\nversion: 1.1.0\ndomain: support\ntitle: Knowledge View & Citation Policy\nstatement: |-\n  Cite official docs with exact anchors; avoid paraphrasing policy-sensitive pages.\n\n  Sources policy:\n    ‚Ä¢ Prefer official docs, status pages, and signed announcements. Avoid blog posts for policy.\n\n  Citation rules:\n    ‚Ä¢ Link the exact doc section and version (e.g., /docs/billing#refunds v3.1).\n    ‚Ä¢ Summarize in one sentence, then provide the link; do not copy large passages.\n    ‚Ä¢ If doc is gated, describe the path (Settings ‚Üí Billing ‚Üí Invoices).\n    ‚Ä¢ For outages, always include {status_url} and the last update time.\n\n  Link policy:\n    ‚Ä¢ Never link to internal-only resources in public responses.\n    ‚Ä¢ If a page moves, provide both old and new paths during the transition.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.escalation_matrix_v1": {
      "id": "support.escalation_matrix_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Escalation Matrix & Handoffs",
      "statement": "Route high-risk or restricted requests to the correct queue with a crisp customer explanation.\n\nMatrix (placeholders in braces are filled by your system):\n  +------------------------+---------------------+----------------------+---------------------------+\n  | Scenario               | Tier / Owner        | SLA                  | Customer-Facing Message   |\n  +------------------------+---------------------+----------------------+---------------------------+\n  | Outage / Sev-1         | On-call SRE         | 15m ack / hourly upd | \"We're experiencing an    |\n  |                        |                     |                      | outage. Status: {status_url}\"    |\n  | Billing dispute >$500  | Billing Specialist  | 1 business day       | \"I've opened a ticket     |\n  |                        |                     |                      | with Billing. Ref: {ticket_id}\"  |\n  | Refund exceptions      | Billing Supervisor  | 2 business days      | \"I'll escalate your refund|\n  |                        |                     |                      | request for review.\"      |\n  | Security/Privacy       | Security Team       | 1 business day       | \"Escalated to security.   |\n  |                        |                     |                      | Ref: {ticket}\"          |\n  | Data deletion (GDPR)   | Data Protection Off | 72 hours             | \"Deletion in progress.    |\n  |                        |                     |                      | Ref: {ticket}\"          |\n  +------------------------+---------------------+----------------------+---------------------------+\n\nRules:\n  ‚Ä¢ If severity ‚â• Sev-2 or involves legal/privacy, escalate immediately and provide a reference ID.\n  ‚Ä¢ Never modify or promise billing credits; create a ticket and route to Billing.\n  ‚Ä¢ Provide the customer with what will happen next and a timeframe.\n  ‚Ä¢ Record all escalations with ticket references; avoid free-form DMs.\n  ‚Ä¢ Do not request or store PII; use masked references only.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.escalation_matrix_v1.yaml",
      "_raw": "id: support.escalation_matrix_v1\nversion: 1.1.0\ndomain: support\ntitle: Escalation Matrix & Handoffs\nstatement: |-\n  Route high-risk or restricted requests to the correct queue with a crisp customer explanation.\n\n  Matrix (placeholders in braces are filled by your system):\n    +------------------------+---------------------+----------------------+---------------------------+\n    | Scenario               | Tier / Owner        | SLA                  | Customer-Facing Message   |\n    +------------------------+---------------------+----------------------+---------------------------+\n    | Outage / Sev-1         | On-call SRE         | 15m ack / hourly upd | \"We're experiencing an    |\n    |                        |                     |                      | outage. Status: {status_url}\"    |\n    | Billing dispute >$500  | Billing Specialist  | 1 business day       | \"I've opened a ticket     |\n    |                        |                     |                      | with Billing. Ref: {ticket_id}\"  |\n    | Refund exceptions      | Billing Supervisor  | 2 business days      | \"I'll escalate your refund|\n    |                        |                     |                      | request for review.\"      |\n    | Security/Privacy       | Security Team       | 1 business day       | \"Escalated to security.   |\n    |                        |                     |                      | Ref: {ticket}\"          |\n    | Data deletion (GDPR)   | Data Protection Off | 72 hours             | \"Deletion in progress.    |\n    |                        |                     |                      | Ref: {ticket}\"          |\n    +------------------------+---------------------+----------------------+---------------------------+\n\n  Rules:\n    ‚Ä¢ If severity ‚â• Sev-2 or involves legal/privacy, escalate immediately and provide a reference ID.\n    ‚Ä¢ Never modify or promise billing credits; create a ticket and route to Billing.\n    ‚Ä¢ Provide the customer with what will happen next and a timeframe.\n    ‚Ä¢ Record all escalations with ticket references; avoid free-form DMs.\n    ‚Ä¢ Do not request or store PII; use masked references only.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.intent_router_sanity_v1": {
      "id": "support.intent_router_sanity_v1",
      "version": "1.0.0",
      "domain": "support",
      "title": "Intent Router Sanity Check",
      "statement": "Validate that baseline rules classify common support intents correctly. Defaults read\nfixtures under artifacts/examples/support_agent/. Accuracy must meet or exceed 0.8.",
      "assumptions": null,
      "pedagogy": null,
      "witnesses": [
        {
          "name": "routes_top_intents_correctly",
          "language": "python",
          "code": "import os, sys, json, re\n\ndef load_json(path):\n    with open(path, \"r\") as f:\n        return json.load(f)\n\ndef classify(text, rules):\n    text_l = text.lower()\n    for intent, pats in rules.items():\n        for pat in pats:\n            if re.search(pat, text_l):\n                return intent\n    return \"unknown\"\n\ndef main():\n    intents_path = os.environ.get(\"INTENTS_JSON\", \"\").strip()\n    rules_path = os.environ.get(\"RULES_JSON\", \"\").strip()\n    acc_threshold = float(os.environ.get(\"ACC_THRESHOLD\", \"0.8\"))\n\n    if not intents_path or not rules_path:\n        print(json.dumps({\"ok\": False, \"error\": \"INTENTS_JSON or RULES_JSON not set\"}))\n        sys.exit(2)\n\n    intents = load_json(intents_path)  # list of {text, expected}\n    rules = load_json(rules_path)      # {intent: [regex,...]}\n\n    total = len(intents)\n    correct = 0\n    details = []\n\n    for item in intents:\n        text = item[\"text\"]\n        expected = item[\"expected\"]\n        pred = classify(text, rules)\n        correct += 1 if pred == expected else 0\n        details.append({\"text\": text, \"expected\": expected, \"pred\": pred})\n\n    acc = (correct / total) if total else 0.0\n    ok = acc >= acc_threshold\n\n    print(json.dumps({\"ok\": ok, \"accuracy\": acc, \"threshold\": acc_threshold, \"total\": total, \"correct\": correct, \"details\": details}, indent=2))\n    sys.exit(0 if ok else 1)\n\nif __name__ == \"__main__\":\n    main()",
          "env": {
            "INTENTS_JSON": "artifacts/examples/support_agent/intents.json",
            "RULES_JSON": "artifacts/examples/support_agent/router_rules.json",
            "ACC_THRESHOLD": "0.8"
          },
          "success_message": "Intent router accuracy meets threshold.",
          "failure_message": "Intent router below threshold ‚Äî refine rules or examples."
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.intent_router_sanity_v1.yaml",
      "_raw": "id: support.intent_router_sanity_v1\nversion: 1.0.0\ndomain: support\ntitle: Intent Router Sanity Check\nstatement: |-\n  Validate that baseline rules classify common support intents correctly. Defaults read\n  fixtures under artifacts/examples/support_agent/. Accuracy must meet or exceed 0.8.\nassumptions:\npedagogy:\nwitnesses:\n  - name: routes_top_intents_correctly\n    language: python\n    code: |-\n      import os, sys, json, re\n\n      def load_json(path):\n          with open(path, \"r\") as f:\n              return json.load(f)\n\n      def classify(text, rules):\n          text_l = text.lower()\n          for intent, pats in rules.items():\n              for pat in pats:\n                  if re.search(pat, text_l):\n                      return intent\n          return \"unknown\"\n\n      def main():\n          intents_path = os.environ.get(\"INTENTS_JSON\", \"\").strip()\n          rules_path = os.environ.get(\"RULES_JSON\", \"\").strip()\n          acc_threshold = float(os.environ.get(\"ACC_THRESHOLD\", \"0.8\"))\n\n          if not intents_path or not rules_path:\n              print(json.dumps({\"ok\": False, \"error\": \"INTENTS_JSON or RULES_JSON not set\"}))\n              sys.exit(2)\n\n          intents = load_json(intents_path)  # list of {text, expected}\n          rules = load_json(rules_path)      # {intent: [regex,...]}\n\n          total = len(intents)\n          correct = 0\n          details = []\n\n          for item in intents:\n              text = item[\"text\"]\n              expected = item[\"expected\"]\n              pred = classify(text, rules)\n              correct += 1 if pred == expected else 0\n              details.append({\"text\": text, \"expected\": expected, \"pred\": pred})\n\n          acc = (correct / total) if total else 0.0\n          ok = acc >= acc_threshold\n\n          print(json.dumps({\"ok\": ok, \"accuracy\": acc, \"threshold\": acc_threshold, \"total\": total, \"correct\": correct, \"details\": details}, indent=2))\n          sys.exit(0 if ok else 1)\n\n      if __name__ == \"__main__\":\n          main()\n\n    env:\n      INTENTS_JSON: artifacts/examples/support_agent/intents.json\n      RULES_JSON: artifacts/examples/support_agent/router_rules.json\n      ACC_THRESHOLD: \"0.8\"\n    success_message: \"Intent router accuracy meets threshold.\"\n    failure_message: \"Intent router below threshold ‚Äî refine rules or examples.\"\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: ''\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "support.tone_style_guide_v1": {
      "id": "support.tone_style_guide_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Tone & Style Guide (Public-Facing)",
      "statement": "Be empathetic, concise, specific, and action-oriented; never echo or store PII.\nRules:\n  ‚Ä¢ Lead with empathy and a one-sentence summary of the customer‚Äôs goal.\n  ‚Ä¢ Offer one actionable next step; avoid overwhelming lists.\n  ‚Ä¢ Prefer links to official docs; include exact anchor and version if relevant.\n  ‚Ä¢ Never guess order/account details; ask for the minimal non-sensitive clarifier.\n  ‚Ä¢ Use plain language; avoid internal acronyms or engineering jargon.\n  ‚Ä¢ Avoid absolute promises; reference policy and expected timeframes.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.tone_style_guide_v1.yaml",
      "_raw": "id: support.tone_style_guide_v1\nversion: 1.1.0\ndomain: support\ntitle: Tone & Style Guide (Public-Facing)\nstatement: |-\n  Be empathetic, concise, specific, and action-oriented; never echo or store PII.\n  Rules:\n    ‚Ä¢ Lead with empathy and a one-sentence summary of the customer‚Äôs goal.\n    ‚Ä¢ Offer one actionable next step; avoid overwhelming lists.\n    ‚Ä¢ Prefer links to official docs; include exact anchor and version if relevant.\n    ‚Ä¢ Never guess order/account details; ask for the minimal non-sensitive clarifier.\n    ‚Ä¢ Use plain language; avoid internal acronyms or engineering jargon.\n    ‚Ä¢ Avoid absolute promises; reference policy and expected timeframes.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.legal_privacy_rules_v1": {
      "id": "support.legal_privacy_rules_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Legal & Privacy Rules (Public-Facing)",
      "statement": "Prevent PII leakage and ensure compliant disclosures.\n\nPII classes to avoid in public channels:\n  ‚Ä¢ email, phone, government_id, credit_card, street_address, ip_address\n\nStorage policy:\n  ‚Ä¢ Do not store PII in tickets or chat logs. Use masked IDs or internal references.\n\nCustomer-facing disclaimers (choose 1 as needed):\n  ‚Ä¢ \"For your security, please avoid sharing personal data (like email, phone, or payment info) here.\"\n  ‚Ä¢ \"We can continue after I‚Äôve created a secure ticket; I‚Äôll share a masked reference ID.\"\n  ‚Ä¢ \"I‚Äôm not able to provide legal or medical advice. I can link official resources instead.\"",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.legal_privacy_rules_v1.yaml",
      "_raw": "id: support.legal_privacy_rules_v1\nversion: 1.1.0\ndomain: support\ntitle: Legal & Privacy Rules (Public-Facing)\nstatement: |-\n  Prevent PII leakage and ensure compliant disclosures.\n\n  PII classes to avoid in public channels:\n    ‚Ä¢ email, phone, government_id, credit_card, street_address, ip_address\n\n  Storage policy:\n    ‚Ä¢ Do not store PII in tickets or chat logs. Use masked IDs or internal references.\n\n  Customer-facing disclaimers (choose 1 as needed):\n    ‚Ä¢ \"For your security, please avoid sharing personal data (like email, phone, or payment info) here.\"\n    ‚Ä¢ \"We can continue after I‚Äôve created a secure ticket; I‚Äôll share a masked reference ID.\"\n    ‚Ä¢ \"I‚Äôm not able to provide legal or medical advice. I can link official resources instead.\"\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    }
  },
  "bundles": {
    "bundle.ci_quality_gates_v1": {
      "name": "bundle.ci_quality_gates_v1",
      "version": "1.0.0",
      "description": "Release Integrity: SBOM presence, license allowlist, container hardening, reproducible artifact, and build-env secret checks.",
      "applies_to": [
        "ci",
        "release"
      ],
      "capsules": [
        "ci.sbom_present_v1",
        "ci.license_compliance_v1",
        "ci.container_hardening_v1",
        "ci.reproducible_artifact_hash_v1",
        "ci.secrets_in_build_env_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [
        "ci.sbom_present_v1",
        "ci.license_compliance_v1",
        "ci.container_hardening_v1",
        "ci.reproducible_artifact_hash_v1",
        "ci.secrets_in_build_env_v1"
      ],
      "projection": "",
      "tags": [
        "ci",
        "supply_chain",
        "release",
        "v1"
      ],
      "notes": "Witnessed-first: each capsule carries executable checks with JSON outputs. Defaults point at example fixtures in artifacts/examples/ci.\n",
      "env": {},
      "secrets": [],
      "_file": "./bundles/bundle.ci_quality_gates_v1.yaml"
    },
    "bundle.dev_code_assistant_v1": {
      "name": "bundle.dev_code_assistant_v1",
      "version": "1.0.0",
      "description": "Immediate utility for devs: safe prompts, language styles, commit conventions, review checklist + light witnesses.",
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "capsules": [
        "dev.prompt_safety_rules_v1",
        "dev.style_guide_python_v1",
        "dev.style_guide_js_v1",
        "dev.commit_conventions_v1",
        "dev.review_checklist_v1",
        "dev.diff_risk_tags_v1",
        "dev.enforce_todo_ticket_v1",
        "dev.secret_scan_baseline_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [
        "dev.prompt_safety_rules_v1",
        "dev.style_guide_python_v1",
        "dev.style_guide_js_v1",
        "dev.commit_conventions_v1",
        "dev.review_checklist_v1",
        "dev.diff_risk_tags_v1",
        "dev.enforce_todo_ticket_v1",
        "dev.secret_scan_baseline_v1"
      ],
      "projection": "",
      "tags": [
        "dev",
        "code",
        "review",
        "v1"
      ],
      "notes": "Info capsules render entirely from `statement`. Witnessed capsules use schema-v1 witness fields.\n",
      "env": {},
      "secrets": [],
      "_file": "./bundles/bundle.dev_code_assistant_v1.yaml"
    },
    "support_agent_v1_bundle": {
      "name": "support_agent_v1_bundle",
      "version": "1.1.0",
      "description": "Public-facing Support Copilot: tone/style, escalation, privacy, knowledge citation, and billing playbooks.",
      "applies_to": [
        "conversation",
        "support"
      ],
      "capsules": [
        "support.legal_privacy_rules_v1",
        "support.pii_redaction_smoke_v1",
        "support.escalation_matrix_v1",
        "support.tone_style_guide_v1",
        "support.knowledge_view_projection_v1",
        "support.billing_basics_v1",
        "support.intent_router_sanity_v1"
      ],
      "excludes": [],
      "priority_overrides": {
        "support.legal_privacy_rules_v1": 100,
        "support.pii_redaction_smoke_v1": 95,
        "support.escalation_matrix_v1": 90
      },
      "order": [
        "support.legal_privacy_rules_v1",
        "support.pii_redaction_smoke_v1",
        "support.escalation_matrix_v1",
        "support.tone_style_guide_v1",
        "support.knowledge_view_projection_v1",
        "support.billing_basics_v1",
        "support.intent_router_sanity_v1"
      ],
      "projection": "",
      "tags": [
        "support",
        "kit",
        "v1-schema"
      ],
      "notes": "Content-only capsules encode ALL customer-facing rules under the `statement` field per v1 schema.\n",
      "env": {},
      "secrets": [],
      "_file": "./bundles/support_agent_v1_bundle.yaml"
    },
    "macgyver_core_v1_bundle": {
      "name": "macgyver_core_v1_bundle",
      "version": "1.0.0",
      "description": "MacGyver problem-solving bundle: mindset rails, SOP, safety/ethics, and practice drills.",
      "applies_to": [
        "conversation",
        "planning",
        "prototyping",
        "training"
      ],
      "capsules": [
        "macgyver.five_rails_v1",
        "macgyver.affordances_over_objects_v1",
        "macgyver.property_matching_v1",
        "macgyver.functional_fixedness_avoidance_v1",
        "macgyver.environment_as_component_v1",
        "macgyver.low_tech_first_v1",
        "macgyver.transduction_chains_v1",
        "macgyver.chain_design_v1",
        "macgyver.problem_collapse_v1",
        "macgyver.sop_10min_loop_v1",
        "macgyver.inventory_thinking_v1",
        "macgyver.affordance_matrix_template_v1",
        "macgyver.stock_verbs_v1",
        "macgyver.parallel_options_v1",
        "macgyver.redundancy_chokepoints_v1",
        "macgyver.latency_control_v1",
        "macgyver.prompts_as_programs_v1",
        "macgyver.prompt_skeleton_v1",
        "macgyver.world_as_typed_graph_v1",
        "macgyver.deliberate_practice_v1",
        "macgyver.reflection_loop_v1",
        "macgyver.blast_radius_humility_v1",
        "macgyver.fail_safe_defaults_v1",
        "macgyver.reality_check_v1",
        "macgyver.legal_ethical_guardrails_v1",
        "macgyver.bias_checklist_v1",
        "macgyver.rails_ledgers_hub_mapping_v1"
      ],
      "excludes": [],
      "priority_overrides": {
        "macgyver.legal_ethical_guardrails_v1": 100,
        "macgyver.fail_safe_defaults_v1": 90,
        "macgyver.reality_check_v1": 80,
        "macgyver.bias_checklist_v1": 70,
        "macgyver.sop_10min_loop_v1": 60
      },
      "order": [
        "macgyver.legal_ethical_guardrails_v1",
        "macgyver.fail_safe_defaults_v1",
        "macgyver.reality_check_v1",
        "macgyver.bias_checklist_v1",
        "macgyver.sop_10min_loop_v1",
        "macgyver.five_rails_v1",
        "macgyver.affordances_over_objects_v1",
        "macgyver.property_matching_v1",
        "macgyver.functional_fixedness_avoidance_v1",
        "macgyver.environment_as_component_v1",
        "macgyver.low_tech_first_v1",
        "macgyver.transduction_chains_v1",
        "macgyver.chain_design_v1",
        "macgyver.problem_collapse_v1",
        "macgyver.inventory_thinking_v1",
        "macgyver.affordance_matrix_template_v1",
        "macgyver.stock_verbs_v1",
        "macgyver.parallel_options_v1",
        "macgyver.redundancy_chokepoints_v1",
        "macgyver.latency_control_v1",
        "macgyver.prompts_as_programs_v1",
        "macgyver.prompt_skeleton_v1",
        "macgyver.world_as_typed_graph_v1",
        "macgyver.deliberate_practice_v1",
        "macgyver.reflection_loop_v1",
        "macgyver.rails_ledgers_hub_mapping_v1"
      ],
      "projection": "",
      "tags": [
        "macgyver",
        "kit",
        "v1"
      ],
      "notes": "Core MacGyver kit:\n- Safety/ethics and fail-safe defaults come first.\n- SOP and mindset rails drive consistent, low-risk solutions.\n- Prompts/templates support LLM use with structure and guardrails.\n",
      "env": {},
      "secrets": [],
      "_file": "./bundles/macgyverisms_v1.yaml"
    }
  },
  "profiles": {
    "profile.ci.gates_v1": {
      "id": "profile.ci.gates_v1",
      "title": "CI Quality Gates ‚Äî Fail Fast",
      "version": "1.0.0",
      "description": "Strict, proof-carrying CI gates. Output GREEN/RED with concise JSON. Abort unless all mandatory witnesses pass.",
      "response": {
        "format": "natural",
        "policy": "Emit crisp GREEN/RED summary with JSON evidence. Fail fast unless all mandatory gates pass.\nDo not speculate; if evidence missing, mark RED with the minimal required next step.\n",
        "system_block": "SYSTEM: Profile=CIGates\nROLE: CI quality gate reporter (witnessed-first)\nSTYLE: terse; bullet verdicts; include JSON snippets for failures.\n",
        "projection": {
          "include": [
            "title",
            "statement"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "enforcement_footer": "ENFORCEMENT: All gates must be GREEN; otherwise mark RED and stop."
          }
        }
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/ci.gates.yaml",
      "_raw": "kind: profile\nid: profile.ci.gates_v1\ntitle: CI Quality Gates ‚Äî Fail Fast\nversion: 1.0.0\ndescription: Strict, proof-carrying CI gates. Output GREEN/RED with concise JSON. Abort unless all mandatory witnesses pass.\nresponse:\n  format: natural\n  policy: |\n    Emit crisp GREEN/RED summary with JSON evidence. Fail fast unless all mandatory gates pass.\n    Do not speculate; if evidence missing, mark RED with the minimal required next step.\n  system_block: |\n    SYSTEM: Profile=CIGates\n    ROLE: CI quality gate reporter (witnessed-first)\n    STYLE: terse; bullet verdicts; include JSON snippets for failures.\n  projection:\n    include:\n      - title\n      - statement\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      enforcement_footer: \"ENFORCEMENT: All gates must be GREEN; otherwise mark RED and stop.\"\ndownload:\n  suggested_ext: txt\n"
    },
    "profile.support_public_agent_v1": {
      "id": "profile.support_public_agent_v1",
      "title": "Customer Support Copilot (Public-Facing)",
      "version": "1.1.0",
      "description": "Guardrailed, empathetic public support agent with escalation and privacy compliance.",
      "response": {
        "format": "natural",
        "policy": "Cite or abstain; follow Plan‚ÜíVerify‚ÜíAnswer; never invent customer-specific facts.\nNever echo or store PII. Prefer linking to docs over paraphrasing.\nEscalate per the matrix; avoid promises of refunds/credits unless policy says so.\n",
        "system_block": "SYSTEM: Profile=SupportAgent\nROLE: Public-facing customer support\nALLOWED_ACTIONS: apologize, clarify, summarize, link_to_docs, suggest_next_step, create_ticket, escalate\nFORBIDDEN: legal_advice, medical_advice, store_or_echo_pii, discounts_without_policy, system_commands\nSECRETS: none\nSTYLE: empathetic, concise, specific, polite, plain-language, one actionable next step\n",
        "projection": {
          "include": [
            "title",
            "statement"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "enforcement_footer": "ENFORCEMENT: Follow the rules encoded in statement; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/support_public_agent.yaml",
      "_raw": "kind: profile\nid: profile.support_public_agent_v1\ntitle: Customer Support Copilot (Public-Facing)\nversion: 1.1.0\ndescription: Guardrailed, empathetic public support agent with escalation and privacy compliance.\nresponse:\n  format: natural\n  policy: |\n    Cite or abstain; follow Plan‚ÜíVerify‚ÜíAnswer; never invent customer-specific facts.\n    Never echo or store PII. Prefer linking to docs over paraphrasing.\n    Escalate per the matrix; avoid promises of refunds/credits unless policy says so.\n  system_block: |\n    SYSTEM: Profile=SupportAgent\n    ROLE: Public-facing customer support\n    ALLOWED_ACTIONS: apologize, clarify, summarize, link_to_docs, suggest_next_step, create_ticket, escalate\n    FORBIDDEN: legal_advice, medical_advice, store_or_echo_pii, discounts_without_policy, system_commands\n    SECRETS: none\n    STYLE: empathetic, concise, specific, polite, plain-language, one actionable next step\n  projection:\n    include:\n      - title\n      - statement\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      enforcement_footer: \"ENFORCEMENT: Follow the rules encoded in statement; otherwise abstain and request the minimal missing info.\"\ndownload:\n  suggested_ext: txt\n"
    },
    "profile.macgyver_v1": {
      "id": "profile.macgyver_v1",
      "title": "MacGyver Upgrade (Conversational)",
      "version": "1.2.2",
      "description": "Lean, declarative profile that primes the model with MacGyver-style problem solving. Profile controls fragments and capsule rendering; one crisp follow-up only; safety built-in.",
      "response": {
        "format": "natural",
        "override_compose_defaults": true,
        "force_pedagogy": true,
        "markdown_wrap_default": false,
        "fragments": [
          {
            "id": "system",
            "kind": "system",
            "include": true,
            "content": "SYSTEM: MacGyver Upgrade ‚Äî Problem-Solving Profile\nMODE: Natural language; concise and declarative.\nSTARTUP (do silently, do not echo):\n  ‚Ä¢ Read the capsule excerpts below.\n  ‚Ä¢ Build two internal lists:\n    ‚Äì SOCRATIC_PRIMES = all Socratic questions from capsules\n    ‚Äì APHORISM_GUARDS = all aphorisms from capsules\n  ‚Ä¢ Reflect internally so you‚Äôre primed for fast, safe, resourceful problem solving.\nOPERATING CYCLE:\n  1) GOAL; 2) INVENTORY (assets‚Üíproperties); 3) LAWS; 4) ROUTES (P/I/E);\n  5) CHOSEN ROUTE (Sense‚ÜíGate‚ÜíAmplify‚ÜíActuate); 6) PREMORTEM & SAFETY;\n  7) MICRO-TEST; 8) ANSWER.\nFOLLOW-UP: If a required fact is missing, ask exactly ONE crisp question first, then proceed.\nSTYLE: Verbs over nouns; properties over brands; prefer low-tech, observable, interruptible mechanisms.\nSCOPE: No hazardous/unlawful/security-bypass guidance‚Äîoffer safe legal analogues.\n"
          },
          {
            "id": "loader",
            "kind": "fragment",
            "include": true,
            "content": "SYSTEM: Truth Capsules Loader\nPURPOSE: Use capsule principles as prompts and guards; keep chains short; prefer reversible micro-tests.\n"
          },
          {
            "id": "discipline",
            "kind": "fragment",
            "include": true,
            "content": "SYSTEM: Bootstrap Discipline\n‚Ä¢ Prefer curated fixtures/evidence; abstain when unsure.\n‚Ä¢ Show your work when citing; else reason from first principles.\n‚Ä¢ Make failures explicit and reversible with tiny experiments.\n"
          }
        ],
        "capsules_heading": "SYSTEM: Principles (Selected)",
        "policy": "Ask at most ONE crisp follow-up only if a blocker exists. Prefer concrete, low-risk, reversible steps. Cite if you use sources; otherwise reason from first principles. Validate JSON before any tool call.\n",
        "system_block": "",
        "projection": {
          "include": [
            "pedagogy.socratic",
            "pedagogy.aphorisms"
          ],
          "force_pedagogy": true,
          "render": {
            "capsule_header": "PRINCIPLE ‚Äî {title}\nUSE: {statement}",
            "socratic_bullet": "  ? {text}",
            "aphorism_bullet": "  ‚ú± {text}",
            "enforcement_footer": ""
          }
        },
        "footer": "SYSTEM: Refresh\n‚Ä¢ Ask at most ONE crisp follow-up, then proceed.\n‚Ä¢ Prefer low-tech, reversible, observable steps; show the chain Sense‚ÜíGate‚ÜíAmplify‚ÜíActuate.\n‚Ä¢ Safety & legality first; offer benign analogues when needed.\n‚Ä¢ Output sections: GOAL / INVENTORY / LAWS / ROUTES (P/I/E) / CHOSEN ROUTE / PREMORTEM & SAFETY / MICRO-TEST / ANSWER.\n"
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/conversational_macgyver.yaml",
      "_raw": "kind: profile\nid: profile.macgyver_v1\ntitle: MacGyver Upgrade (Conversational)\nversion: 1.2.2\ndescription: Lean, declarative profile that primes the model with MacGyver-style problem solving. Profile controls fragments and capsule rendering; one crisp follow-up only; safety built-in.\n\nresponse:\n  format: natural\n  override_compose_defaults: true\n  force_pedagogy: true\n  markdown_wrap_default: false\n\n  fragments:\n    - id: system\n      kind: system\n      include: true\n      content: |\n        SYSTEM: MacGyver Upgrade ‚Äî Problem-Solving Profile\n        MODE: Natural language; concise and declarative.\n        STARTUP (do silently, do not echo):\n          ‚Ä¢ Read the capsule excerpts below.\n          ‚Ä¢ Build two internal lists:\n            ‚Äì SOCRATIC_PRIMES = all Socratic questions from capsules\n            ‚Äì APHORISM_GUARDS = all aphorisms from capsules\n          ‚Ä¢ Reflect internally so you‚Äôre primed for fast, safe, resourceful problem solving.\n        OPERATING CYCLE:\n          1) GOAL; 2) INVENTORY (assets‚Üíproperties); 3) LAWS; 4) ROUTES (P/I/E);\n          5) CHOSEN ROUTE (Sense‚ÜíGate‚ÜíAmplify‚ÜíActuate); 6) PREMORTEM & SAFETY;\n          7) MICRO-TEST; 8) ANSWER.\n        FOLLOW-UP: If a required fact is missing, ask exactly ONE crisp question first, then proceed.\n        STYLE: Verbs over nouns; properties over brands; prefer low-tech, observable, interruptible mechanisms.\n        SCOPE: No hazardous/unlawful/security-bypass guidance‚Äîoffer safe legal analogues.\n\n    - id: loader\n      kind: fragment\n      include: true\n      content: |\n        SYSTEM: Truth Capsules Loader\n        PURPOSE: Use capsule principles as prompts and guards; keep chains short; prefer reversible micro-tests.\n\n    - id: discipline\n      kind: fragment\n      include: true\n      content: |\n        SYSTEM: Bootstrap Discipline\n        ‚Ä¢ Prefer curated fixtures/evidence; abstain when unsure.\n        ‚Ä¢ Show your work when citing; else reason from first principles.\n        ‚Ä¢ Make failures explicit and reversible with tiny experiments.\n\n  capsules_heading: \"SYSTEM: Principles (Selected)\"\n\n  policy: |\n    Ask at most ONE crisp follow-up only if a blocker exists. Prefer concrete, low-risk, reversible steps. Cite if you use sources; otherwise reason from first principles. Validate JSON before any tool call.\n\n  system_block: \"\"\n\n  projection:\n    include:\n      - pedagogy.socratic\n      - pedagogy.aphorisms\n    force_pedagogy: true\n    render:\n      capsule_header: \"PRINCIPLE ‚Äî {title}\\nUSE: {statement}\"\n      socratic_bullet: \"  ? {text}\"\n      aphorism_bullet: \"  ‚ú± {text}\"\n      enforcement_footer: \"\"\n\n  # NEW: footer appended to the very end of the composed prompt\n  footer: |\n    SYSTEM: Refresh\n    ‚Ä¢ Ask at most ONE crisp follow-up, then proceed.\n    ‚Ä¢ Prefer low-tech, reversible, observable steps; show the chain Sense‚ÜíGate‚ÜíAmplify‚ÜíActuate.\n    ‚Ä¢ Safety & legality first; offer benign analogues when needed.\n    ‚Ä¢ Output sections: GOAL / INVENTORY / LAWS / ROUTES (P/I/E) / CHOSEN ROUTE / PREMORTEM & SAFETY / MICRO-TEST / ANSWER.\n\ndownload:\n  suggested_ext: txt\n"
    },
    "profile.dev.code_assistant_v1": {
      "id": "profile.dev.code_assistant_v1",
      "title": "Developer Velocity ‚Äî Code Assistant & Review Copilot",
      "version": "1.0.0",
      "description": "Concise, reproducible developer assistants that work with Cline/Claude/VSCode. Focus on safe prompts, consistent style, and practical reviews.",
      "response": {
        "format": "natural",
        "policy": "Cite or abstain; Plan‚ÜíVerify‚ÜíAnswer; never leak secrets or PHI/PII.\nPrefer diffs, tests, and minimal patches; avoid broad refactors unless asked.\n",
        "system_block": "SYSTEM: Profile=DevAssistant\nROLE: Code assistant & review copilot\nSTYLE: terse, specific, reproducible; show commands or patches, then explanation.\n",
        "projection": {
          "include": [
            "title",
            "statement"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "enforcement_footer": "ENFORCEMENT: Follow capsule statements; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/dev.code_assistant.yaml",
      "_raw": "kind: profile\nid: profile.dev.code_assistant_v1\ntitle: Developer Velocity ‚Äî Code Assistant & Review Copilot\nversion: 1.0.0\ndescription: Concise, reproducible developer assistants that work with Cline/Claude/VSCode. Focus on safe prompts, consistent style, and practical reviews.\nresponse:\n  format: natural\n  policy: |\n    Cite or abstain; Plan‚ÜíVerify‚ÜíAnswer; never leak secrets or PHI/PII.\n    Prefer diffs, tests, and minimal patches; avoid broad refactors unless asked.\n  system_block: |\n    SYSTEM: Profile=DevAssistant\n    ROLE: Code assistant & review copilot\n    STYLE: terse, specific, reproducible; show commands or patches, then explanation.\n  projection:\n    include:\n      - title\n      - statement\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      enforcement_footer: \"ENFORCEMENT: Follow capsule statements; otherwise abstain and request the minimal missing info.\"\ndownload:\n  suggested_ext: txt\n"
    }
  },
  "schemas": {},
  "llm_templates": [
    {
      "id": "anthropic_sonnet_chat",
      "label": "Anthropic: Claude 3.5 Sonnet (chat)",
      "model": "claude-3-5-sonnet",
      "description": "Chat completion; user input via stdin pipe.",
      "engine": "llm",
      "input_mode": "stdin",
      "extra_flags": [
        "--no-stream"
      ],
      "cmd_template": "{{SYS_HEREDOC}}\n{{STDIN_PIPE}} llm -m {{MODEL}} --system \"$TC_SYSTEM\" {{EXTRA_FLAGS}}\n"
    },
    {
      "id": "ollama_llama3_local",
      "label": "Ollama: llama3 (local)",
      "model": "llama3",
      "description": "Local model; file input.",
      "engine": "llm",
      "input_mode": "file",
      "extra_flags": [],
      "cmd_template": "{{SYS_HEREDOC}}\nllm -m {{MODEL}} --system \"$TC_SYSTEM\" {{EXTRA_FLAGS}} {{FILE_PATH}}\n"
    },
    {
      "id": "openai_gpt4o_chat",
      "label": "OpenAI: GPT-4o mini (chat)",
      "model": "gpt-4o-mini",
      "description": "Chat completion; user input as arg.",
      "engine": "llm",
      "input_mode": "arg",
      "extra_flags": [],
      "cmd_template": "{{SYS_HEREDOC}}\nllm -m {{MODEL}} --system \"$TC_SYSTEM\" {{EXTRA_FLAGS}} {{INPUT_FRAGMENT}}\n"
    }
  ]
}</script>

    <script>
      /* ------------ Data ------------ */
      const DATA = JSON.parse(document.getElementById('tc-data').textContent);



      // Derive posture/witness_count if missing; keep raw yaml if provided upstream
      (function hydrateCapsules() {
        const caps = DATA.capsules || {};
        for (const [id, c] of Object.entries(caps)) {
          c._id = id;
          c._witness_count = Array.isArray(c.witnesses) ? c.witnesses.length : (c._witness_count || 0);
          if (!c.posture) c.posture = c._witness_count > 0 ? 'witnessed' : 'informational';
          // keep any existing c._raw for modal; nothing to do if not present
        }
      })();

    </script>

    <script>
      /* ------------ State & helpers ------------ */
      const STATE = { selectedBundles: new Set(), selectedCaps: new Set(), order: [], manualCaps: new Set(), profile: null, filter: "" };
      const $ = id => document.getElementById(id);
      const esc = s => (s == null ? "" : String(s).replace(/[&<>]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[m])));



      // ---- Theme Controller ----
      (function themeController() {
        const STORAGE_KEY = 'tc_theme'; // 'light' | 'dark'
        const root = document.documentElement;

        function apply(theme) {
          if (theme === 'light') {
            root.setAttribute('data-theme', 'light');
            $('themeBtn').textContent = '‚òÄÔ∏è';
            $('themeBtn').setAttribute('aria-label', 'Switch to dark mode');
          } else {
            root.setAttribute('data-theme', 'dark');
            $('themeBtn').textContent = 'üåô';
            $('themeBtn').setAttribute('aria-label', 'Switch to light mode');
          }
        }

        // initial theme: saved ‚Üí system ‚Üí dark fallback
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved === 'light' || saved === 'dark') {
          apply(saved);
        } else {
          const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          apply(systemDark ? 'dark' : 'light');
        }

        // respond to future system changes if user hasn't chosen
        const mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        if (!saved && mql && mql.addEventListener) {
          mql.addEventListener('change', e => apply(e.matches ? 'dark' : 'light'));
        }

        // wire up button
        window.addEventListener('DOMContentLoaded', () => {
          const btn = document.getElementById('themeBtn');
          if (!btn) return;
          btn.addEventListener('click', () => {
            const next = (root.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
            localStorage.setItem(STORAGE_KEY, next);
            apply(next);
          });
        });
      })();

      // persist domain open/closed state across renders + reloads
      STATE.domainOpen = JSON.parse(localStorage.getItem('tc_domain_open') || '{}');
      const DOMAIN_DEFAULT_OPEN = true; // first render behavior

      function setDomainOpen(domain, open) {
        const key = String(domain || 'misc').toLowerCase();
        STATE.domainOpen[key] = !!open;
        localStorage.setItem('tc_domain_open', JSON.stringify(STATE.domainOpen));
      }

      function getDomainOpen(domain) {
        const key = String(domain || 'misc').toLowerCase();
        return Object.prototype.hasOwnProperty.call(STATE.domainOpen, key)
          ? !!STATE.domainOpen[key]
          : DOMAIN_DEFAULT_OPEN;
      }

      // Bundles panel open/closed state
      // Bundles open/closed state
      STATE.bundlesOpen = (localStorage.getItem('tc_bundles_open') !== '0'); // default open

      function setBundlesOpen(open) {
        STATE.bundlesOpen = !!open;
        localStorage.setItem('tc_bundles_open', STATE.bundlesOpen ? '1' : '0');
        const body = document.getElementById('bundlesBody');
        const btn = document.getElementById('bundlesToggle');
        if (!body || !btn) return;
        if (STATE.bundlesOpen) {
          body.hidden = false;
          btn.textContent = 'Hide';
          btn.setAttribute('aria-expanded', 'true');
        } else {
          body.hidden = true;
          btn.textContent = 'Show';
          btn.setAttribute('aria-expanded', 'false');
        }
      }

      function initBundlesCollapsibleSimple() {
        const btn = document.getElementById('bundlesToggle');
        if (!btn) return;
        setBundlesOpen(STATE.bundlesOpen);      // apply initial state
        btn.onclick = () => setBundlesOpen(!STATE.bundlesOpen);
      }


      /* Toast */
      function toast(msg) {
        const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t);
        setTimeout(() => t.remove(), 1800);
      }

      function initBundlesCollapsible() {
        const d = $('bundlesSection');
        if (!d) return;
        d.open = getBundlesOpen();
        d.addEventListener('toggle', () => setBundlesOpen(d.open));
      }

      /* Hashing for digest */
      const tenc = s => new TextEncoder().encode(s);
      async function sha256(s) { const buf = await crypto.subtle.digest('SHA-256', tenc(s)); return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(''); }
      function canonicalJSON(x) {
        if (Array.isArray(x)) return "[" + x.map(canonicalJSON).join(",") + "]";
        if (x && typeof x === "object") { const keys = Object.keys(x).sort(); return "{" + keys.map(k => JSON.stringify(k) + ":" + canonicalJSON(x[k])).join(",") + "}"; }
        return JSON.stringify(x);
      }
      function coreForDigest(c) {
        return {
          id: c.id, version: c.version, domain: c.domain, title: c.title, statement: c.statement,
          assumptions: Array.isArray(c.assumptions) ? c.assumptions : [],
          pedagogy: Array.isArray(c.pedagogy) ? c.pedagogy.map(p => ({ kind: p.kind, text: p.text })) : []
        };
      }
      function digestCore(c) { return canonicalJSON(coreForDigest(c)); }
      async function validateDigest(c) {
        const have = await sha256(digestCore(c));
        const want = (((c.provenance || {}).signing || {}).digest) || '';
        if (!want) return { ok: true, na: true, have, want };
        return { ok: (have === want), na: false, have, want };
      }
      function badgeDigest(c) {
        const b = document.createElement('span'); b.className = 'badge'; b.textContent = 'digest‚Ä¶';
        validateDigest(c).then(r => {
          if (r.na) { b.textContent = 'digest n/a'; b.title = 'No reference digest in capsule'; return; }
          b.textContent = r.ok ? 'digest‚úì' : 'digest‚úó'; b.className = 'badge ' + (r.ok ? 'ok' : 'err');
          b.title = r.ok ? 'Digest OK' : 'Have ' + r.have + ' want ' + r.want;
        });
        return b;
      }
      function badgeAuthor(c) {
        const p = c.provenance || {}; const b = document.createElement('span'); b.className = 'badge'; b.textContent = (p.author || '?'); return b;
      }

      function badgePosture(c) {
        const b = document.createElement('span');
        const isWitnessed = (c.posture === 'witnessed');
        b.className = 'badge' + (isWitnessed ? ' witnessed' : '');
        b.textContent = isWitnessed ? 'witnessed' : 'informational';
        const n = (typeof c._witness_count === 'number') ? c._witness_count : 0;
        b.title = isWitnessed ? `${n} witness${n === 1 ? '' : 'es'}` : 'No witnesses';
        return b;
      }


      /* ------------ Modal (upgraded: capsules + profiles + bundles) ------------ */
      let MODAL_CTX = null;
      // kind ‚àà {'capsule','profile','bundle'}
      // data = the object (capsule/profile/bundle)
      // raw  = preferred text to show (YAML if available; JSON pretty as fallback)
      function openModal(title, data, { kind = 'capsule' } = {}) {
        // Prefer YAML when provided as _raw; else pretty JSON
        let raw = (data && data._raw) ? String(data._raw) : null;
        let lang = 'yaml';
        if (!raw) {
          raw = JSON.stringify(data || {}, null, 2);
          lang = 'json';
        }

        MODAL_CTX = { kind, data, raw };

        $('m_title').textContent = title || (kind === 'bundle' ? 'Bundle' : kind === 'profile' ? 'Profile' : 'Capsule');

        // Toggle controls based on kind
        const showProv = (kind === 'capsule');
        const showValidate = (kind === 'capsule');
        $('m_copy_prov').style.display = showProv ? '' : 'none';
        $('m_validate').style.display = showValidate ? '' : 'none';

        // Set code block + highlight
        const code = $('m_body_code');
        code.className = 'language-' + lang;
        code.textContent = raw;
        if (window.Prism && Prism.highlightElement) Prism.highlightElement(code);

        $('m_result').textContent = 'idle';
        $('m_result').className = 'badge';
        $('modal').style.display = 'flex';
      }

      function closeModal() { $('modal').style.display = 'none'; MODAL_CTX = null; }

      $('m_close').addEventListener('click', closeModal);
      $('modal').addEventListener('click', e => { if (e.target && e.target.id === 'modal') closeModal(); });

      $('m_copy_yaml').addEventListener('click', () => {
        if (!MODAL_CTX) return;
        navigator.clipboard.writeText(MODAL_CTX.raw || '').then(() => toast('YAML/JSON copied'));
      });

      $('m_copy_prov').addEventListener('click', () => {
        if (!MODAL_CTX) return;
        if (MODAL_CTX.kind !== 'capsule') { toast('No provenance for this type'); return; }
        navigator.clipboard.writeText(JSON.stringify((MODAL_CTX.data && MODAL_CTX.data.provenance) || {}, null, 2))
          .then(() => toast('Provenance copied'));
      });

      $('m_validate').addEventListener('click', async () => {
        if (!MODAL_CTX) return;
        const tag = $('m_result');
        if (MODAL_CTX.kind !== 'capsule') {
          tag.textContent = 'n/a';
          tag.className = 'badge';
          tag.title = 'Validation only applies to capsules';
          return;
        }
        const r = await validateDigest(MODAL_CTX.data);
        tag.textContent = r.ok ? 'digest‚úì' : 'digest‚úó';
        tag.className = 'badge ' + (r.ok ? 'ok' : 'err');
        tag.title = r.ok ? 'OK' : ('have:' + r.have + ' want:' + r.want);
      });




      /* ------------ Renderers ------------ */
      function renderProfiles() {
        const sel = $('profiles');
        const descEl = $('profileDesc');
        const pmap = DATA.profiles || {};
        const keys = Object.keys(pmap).sort();

        // rebuild options
        sel.textContent = '';
        for (const k of keys) {
          const p = pmap[k] || {};
          const o = document.createElement('option');
          o.value = k;
          o.textContent = (p.title || k) + ' (' + (p.version || '1.0.0') + ')';
          o.dataset.desc = p.description || '';
          sel.appendChild(o);
        }

        // Choose target  -  IMPORTANT: prefer STATE.profile (e.g., set by importState)
        const saved = localStorage.getItem('tc_profile');
        let target =
          (STATE.profile && pmap[STATE.profile]) ? STATE.profile :
            (saved && pmap[saved]) ? saved :
              (sel.value && pmap[sel.value]) ? sel.value :
                (keys[0] || '');

        sel.value = target;
        STATE.profile = target;

        // description
        if (descEl) {
          const p0 = pmap[target] || {};
          descEl.textContent = p0.description ? (' -  ' + p0.description) : '';
        }

        // change handler (unchanged)
        sel.onchange = () => {
          STATE.profile = sel.value;
          const p = pmap[STATE.profile] || {};
          if (descEl) descEl.textContent = p.description ? (' -  ' + p.description) : '';
          if (typeof compose === 'function') compose();
        };

        // Fire one change event to initialize downstream (no fake toggle)
        sel.dispatchEvent(new Event('change', { bubbles: true }));
      }

      // Profile YAML/JSON modal
      (function wireProfileView() {
        const btn = $('profileView');
        if (!btn) return;
        btn.addEventListener('click', () => {
          const id = STATE.profile;
          const p = (DATA.profiles || {})[id];
          if (!p) { toast('No profile selected'); return; }
          openModal(p.title || id || 'Profile', p, { kind: 'profile' });
        });
      })();

      function capsuleRow(c, id, opts = {}) {
        const showDomainChip = !!opts.showDomainChip;

        const item = document.createElement('div');
        item.className = 'item';
        item.dataset.id = id;

        const top = document.createElement('div'); // title + controls row
        top.className = 'row';
        item.appendChild(top);

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = STATE.selectedCaps.has(id);
        cb.addEventListener('change', () => {
          if (cb.checked) {
            STATE.selectedCaps.add(id);
            STATE.manualCaps.add(id);
            if (!STATE.order.includes(id)) STATE.order.push(id);
          } else {
            STATE.selectedCaps.delete(id);
            STATE.manualCaps.delete(id);
            STATE.order = STATE.order.filter(x => x !== id);
          }
          renderCapsules();
          renderPreview();
          compose();
        });
        top.appendChild(cb);

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = (c.title || id);
        top.appendChild(title);

        if (showDomainChip) {
          const dchip = document.createElement('span');
          dchip.className = 'chip domain';
          dchip.textContent = c.domain || 'misc';
          dchip.title = 'domain';
          top.appendChild(dchip);
        }

        top.appendChild(badgeAuthor(c));
        top.appendChild(badgeDigest(c));
        top.appendChild(badgePosture(c));

        const btn = document.createElement('button');
        btn.className = 'btn small';
        btn.textContent = 'View';
        btn.onclick = () => openModal(c.title || id, c, { kind: 'capsule' });
        top.appendChild(btn);

        const stmt = document.createElement('div');
        stmt.className = 'small clamp-2';
        stmt.textContent = (c.statement || '');
        item.appendChild(stmt);

        // Optional applies_to chips (tiny, muted)
        if (Array.isArray(c.applies_to) && c.applies_to.length) {
          const chips = document.createElement('div');
          chips.className = 'row-chips';
          c.applies_to.forEach(tag => {
            const chip = document.createElement('span');
            chip.className = 'chip applies';
            chip.textContent = tag;
            chips.appendChild(chip);
          });
          item.appendChild(chips);
        }

        return item;
      }


      function renderCapsules() {
        const list = $('capsules');
        list.innerHTML = '';

        const f = (STATE.filter || '').toLowerCase();
        const byDomain = new Map(); // domain => [ids]

        const caps = DATA.capsules || {};
        for (const id of Object.keys(caps)) {
          const c = caps[id] || {};
          const hay = (id + ' ' + (c.title || '') + ' ' + (c.domain || '') + ' ' + (c.statement || '')).toLowerCase();
          if (hay.includes(f)) {
            const d = (c.domain || 'misc').toLowerCase();
            if (!byDomain.has(d)) byDomain.set(d, []);
            byDomain.get(d).push(id);
          }
        }

        // sort domains; and titles within domain
        const domains = Array.from(byDomain.keys()).sort();
        let total = 0;

        domains.forEach(domain => {
          const ids = byDomain.get(domain).sort((a, b) => {
            const A = (caps[a].title || a).toLowerCase();
            const B = (caps[b].title || b).toLowerCase();
            return A.localeCompare(B);
          });
          total += ids.length;

          // Group container
          const group = document.createElement('details');
          group.className = 'domain-group';
          group.open = getDomainOpen(domain);          // ‚Üê use saved state
          group.addEventListener('toggle', () => {     // ‚Üê save when user opens/closes
            setDomainOpen(domain, group.open);
          });

          // Summary header
          const sum = document.createElement('summary');
          const title = document.createElement('span');
          title.className = 'domain-title';
          title.textContent = domain;

          const count = document.createElement('span');
          count.className = 'badge';
          count.textContent = String(ids.length);

          const spacer = document.createElement('span');
          spacer.className = 'domain-spacer';

          const selAll = document.createElement('input');
          selAll.type = 'checkbox';
          selAll.addEventListener('click', e => e.stopPropagation());
          selAll.addEventListener('mousedown', e => e.stopPropagation());
          const allSelected = ids.every(cid => STATE.selectedCaps.has(cid));
          const someSelected = ids.some(cid => STATE.selectedCaps.has(cid));
          selAll.checked = allSelected;
          selAll.indeterminate = !allSelected && someSelected;
          selAll.title = 'Select all in domain';

          selAll.addEventListener('change', () => {
            if (selAll.checked) {
              ids.forEach(cid => {
                STATE.selectedCaps.add(cid);
                if (!STATE.order.includes(cid)) STATE.order.push(cid);
              });
            } else {
              ids.forEach(cid => {
                STATE.selectedCaps.delete(cid);
                STATE.manualCaps.delete(cid);
              });
              STATE.order = STATE.order.filter(x => STATE.selectedCaps.has(x));
            }
            renderCapsules();
            renderPreview();
            compose();
          });

          sum.appendChild(title);
          sum.appendChild(count);
          sum.appendChild(spacer);
          sum.appendChild(selAll);
          group.appendChild(sum);

          // Body
          const body = document.createElement('div');
          body.className = 'domain-body';
          ids.forEach(cid => {
            body.appendChild(capsuleRow(caps[cid], cid, { showDomainChip: false }));
          });
          group.appendChild(body);

          list.appendChild(group);
        });

        $('capsulesCount').textContent = total;
      }


      function renderBundles() {
        const list = $('bundles'); list.innerHTML = '';
        const keys = Object.keys(DATA.bundles || {}).sort((a, b) => (DATA.bundles[a].name || a).localeCompare(DATA.bundles[b].name || b));

        for (const k of keys) {
          const b = DATA.bundles[k] || {};
          const item = document.createElement('div'); item.className = 'item';
          const row = document.createElement('div'); row.className = 'row'; item.appendChild(row);

          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = STATE.selectedBundles.has(k);
          cb.addEventListener('change', () => {
            if (cb.checked) {
              STATE.selectedBundles.add(k);
              (b.capsules || []).forEach(cid => { STATE.selectedCaps.add(cid); if (!STATE.order.includes(cid)) STATE.order.push(cid); });
            } else {
              STATE.selectedBundles.delete(k);
              const others = [...STATE.selectedBundles];
              (b.capsules || []).forEach(cid => {
                const elsewhere = others.some(name => {
                  const b2 = DATA.bundles[name];
                  return b2 && Array.isArray(b2.capsules) && b2.capsules.includes(cid);
                });
                const manual = STATE.manualCaps.has(cid);
                if (!elsewhere && !manual) STATE.selectedCaps.delete(cid);
                STATE.order = STATE.order.filter(x => STATE.selectedCaps.has(x));
              });
            }
            renderCapsules(); renderPreview(); compose();
          });
          row.appendChild(cb);

          const ttl = document.createElement('div'); ttl.textContent = (b.name || k); row.appendChild(ttl);

          // NEW: "View" button for bundle YAML/JSON
          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn small';
          viewBtn.textContent = 'View';
          viewBtn.onclick = () => openModal(b.name || k || 'Bundle', b, { kind: 'bundle' });
          row.appendChild(viewBtn);

          // optional description
          if (b.description) {
            const desc = document.createElement('div'); desc.className = 'small'; desc.textContent = b.description; item.appendChild(desc);
          }

          list.appendChild(item);
        }
        $('bundlesCount').textContent = keys.length;
      }


      function renderPreview() {
        const list = $('preview'); list.innerHTML = '';
        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id));
        ids.forEach(id => {
          const c = DATA.capsules[id]; if (!c) return;
          const item = document.createElement('div'); item.className = 'item'; item.dataset.id = id;

          const row = document.createElement('div'); row.className = 'row'; item.appendChild(row);
          const handle = document.createElement('span'); handle.className = 'chip drag'; handle.textContent = '‚ò∞'; row.appendChild(handle);
          const ttl = document.createElement('div');
          ttl.className = 'title';
          ttl.innerHTML = esc(c.title || id) + ' <span class="muted"> -  ' + esc(c.domain || '') + '</span>';
          row.appendChild(ttl);

          const btn = document.createElement('button');
          btn.className = 'btn small';
          btn.textContent = 'View';
          btn.onclick = () => openModal(c.title || id, c, { kind: 'capsule' });
          row.appendChild(btn);


          list.appendChild(item);
        });

        // Sortable (drag to reorder)
        if (window.__sortable) window.__sortable.destroy();
        window.__sortable = new Sortable(list, {
          animation: 120,
          handle: '.drag',
          ghostClass: 'ghost',
          onEnd: (evt) => {
            const old = STATE.order.filter(id => STATE.selectedCaps.has(id));
            const moved = old.splice(evt.oldIndex, 1)[0];
            old.splice(evt.newIndex, 0, moved);
            STATE.order = old.concat(STATE.order.filter(x => !STATE.selectedCaps.has(x)));
            compose();
          }
        });
      }
      /* ------------ Composition (hardened) ------------ */

      /* Canonicalize ids so filenames/paths/exts match capsule ids/keys */
      function canonicalizeId(s) {
        return String(s || '')
          .trim()
          .replace(/^.*[\\/]/, '')              // strip any leading path
          .replace(/\.(yaml|yml|json)$/i, '');  // strip extension
      }

      /* Turn a Set or object-map of selections into a canonical Set of ids */
      function toIdSet(x) {
        if (x instanceof Set) return new Set([...x].map(canonicalizeId));
        if (x && typeof x === 'object') {
          return new Set(Object.keys(x).filter(k => x[k]).map(canonicalizeId));
        }
        return new Set();
      }

      /* Find a capsule by id, key, or filename-like string */
      function getCapsuleByAnyId(anyId) {
        const canon = canonicalizeId(anyId);
        const store = (DATA && DATA.capsules) || {};
        if (store[anyId]) return store[anyId]; // exact key hit
        for (const k in store) {
          const cap = store[k];
          const capIdCanon = canonicalizeId(cap.id || '');
          const keyCanon = canonicalizeId(k);
          if (capIdCanon === canon || keyCanon === canon) return cap;
        }
        return null;
      }

      /* Selection that survives order/selected mismatches */
      function getSelectedIdsSafe() {
        const order = Array.isArray(STATE.order) ? STATE.order.slice() : [];
        const sel = toIdSet(STATE.selectedCaps);
        const ordered = [];
        const seen = new Set();

        for (const raw of order) {
          const canon = canonicalizeId(raw);
          if (sel.has(canon) && !seen.has(canon)) {
            ordered.push(canon);
            seen.add(canon);
          }
        }
        for (const canon of sel) {
          if (!seen.has(canon)) ordered.push(canon);
        }
        return ordered;
      }

      /* Optional legacy helper (kept for completeness if you use it elsewhere) */
      function parseFieldSpec(spec) {
        const m = String(spec).match(/^([a-z_.]+)(?:\[:(\d+)\])?$/i);
        return {
          path: m ? m[1].toLowerCase() : String(spec).toLowerCase(),
          limit: m && m[2] ? parseInt(m[2], 10) : null
        };
      }

      /* ---------- Pedagogy normalization (supports both schemas) ---------- */
      function normalizePedagogy(capsule) {
        // A) pedagogy: [{kind:'Socratic'|'Aphorism', text:'...'}, ...]
        // B) pedagogy: { socratic:[...], aphorisms:[...] }
        const out = { socratic: [], aphorisms: [] };
        const p = capsule && capsule.pedagogy;
        if (!p) return out;

        if (Array.isArray(p)) {
          for (const item of p) {
            if (!item) continue;
            const kind = String(item.kind || '').toLowerCase();
            const text = (item.text == null) ? '' : String(item.text);
            if (!text) continue;
            if (kind === 'socratic') out.socratic.push(text);
            else if (kind === 'aphorism' || kind === 'aphorisms') out.aphorisms.push(text);
          }
        } else if (typeof p === 'object') {
          if (Array.isArray(p.socratic)) out.socratic.push(...p.socratic.map(String));
          if (Array.isArray(p.aphorisms)) out.aphorisms.push(...p.aphorisms.map(String));
        }
        return out;
      }

      /* ---------- Projection Renderer (profile-driven) ---------- */
      function applyProjection(capsule, projection, withPed) {
        const lines = [];

        // Header (supports {title}/{statement})
        const headerTpl = (projection.render && typeof projection.render.capsule_header === 'string')
          ? projection.render.capsule_header
          : null;

        if (headerTpl && headerTpl.length > 0) {
          lines.push(applyTemplate(headerTpl, {
            id: capsule.id || '',
            version: capsule.version || '',
            domain: capsule.domain || '',
            title: capsule.title || capsule.TITLE || '',
            statement: capsule.statement || capsule.STATEMENT || ''
          }).trim());
        }

        // Normalize pedagogy for consistent addressing
        const ped = normalizePedagogy(capsule);

        // Build include list; ensure pedagogy is present when forced
        let includes = Array.isArray(projection.include) ? projection.include.slice() : [];
        const forcePed = !!(projection && projection.force_pedagogy);
        const hasPedInList = includes.some(s => String(s).startsWith('pedagogy.'));
        if (forcePed && !hasPedInList) {
          includes.push('pedagogy.socratic', 'pedagogy.aphorisms');
        }

        for (const inc of includes) {
          const { path, sliceFrom, sliceTo } = parseInclude(inc);

          // Respect UI/profile gating
          if (!withPed && path.startsWith('pedagogy.')) continue;

          let val = null;
          if (path === 'pedagogy.socratic') val = ped.socratic;
          else if (path === 'pedagogy.aphorisms') val = ped.aphorisms;
          else val = getByPath(capsule, path);

          if (val == null) continue;

          if (Array.isArray(val)) {
            const sub = sliceArray(val, sliceFrom, sliceTo);
            const bulletKey = path.endsWith('socratic') ? 'socratic_bullet'
              : path.endsWith('aphorisms') ? 'aphorism_bullet'
                : null;
            const bulletTpl = (projection.render && projection.render[bulletKey]) || '  - {text}';
            for (const item of sub) lines.push(applyTemplate(bulletTpl, { text: String(item) }));
            continue;
          }

          if (typeof val === 'string') {
            const lineTpl = (projection.render && projection.render[`${path}_line`]) || null;
            lines.push(lineTpl ? applyTemplate(lineTpl, { text: val }) : val);
          }
        }

        // Footer (suppressed when empty string)
        const footer = projection.render ? projection.render.enforcement_footer : null;
        if (typeof footer === 'string' && footer.trim().length > 0) lines.push(footer.trim());

        return lines.join("\n").trim();
      }

      /* ---------- Legacy capsule composer (only used if no projection provided) ---------- */
      function composeLegacy(c, includePedagogy) {
        const lines = [];
        lines.push(
          "BEGIN CAPSULE id=" + (c.id || '') +
          " version=" + (c.version || '1.0.0') +
          " domain=" + (c.domain || '') +
          " posture=" + (c.posture || 'informational')
        );
        if (c.statement) lines.push("STATEMENT: " + c.statement);
        if (includePedagogy && c.pedagogy) {
          const ped = normalizePedagogy(c);
          const body = []
            .concat(ped.socratic.map(t => "Socratic: " + t))
            .concat(ped.aphorisms.map(t => "Aphorism: " + t))
            .join('\n');
          if (body) lines.push('PEDAGOGY:\n' + body);
        }
        lines.push('END CAPSULE');
        return lines.join("\n");
      }

      /* ---------- Main compose ---------- */
      function compose() {
        try {
          const prof = (DATA && DATA.profiles && STATE.profile && DATA.profiles[STATE.profile]) || {};
          const response = prof.response || {};
          const projection = response.projection || {};
          const blocks = [];

          // Fragments / system
          const overrideDefaults = !!response.override_compose_defaults;
          const fragments = Array.isArray(response.fragments) ? response.fragments : [];

          const sysFragments = fragments.filter(f => f && f.include !== false && f.kind === 'system');
          if (sysFragments.length) {
            for (const f of sysFragments) blocks.push(String(f.content || '').trim());
          } else {
            const policy = response.policy || 'Cite or abstain; follow Plan‚ÜíVerify‚ÜíAnswer; ask ONE crisp follow-up if required.';
            const format = response.format || 'natural';
            const system_block = response.system_block ||
              ("SYSTEM: Profile=" + (prof.title || 'unknown') + "\nPOLICY: " + policy + "\nFORMAT: " + format);
            blocks.push(system_block);
          }

          const auxFragments = fragments.filter(f => f && f.include !== false && f.kind !== 'system');
          if (auxFragments.length) {
            for (const f of auxFragments) blocks.push(String(f.content || '').trim());
          } else if (!overrideDefaults) {
            // Legacy defaults only if profile does not override
            blocks.push("SYSTEM: Truth Capsules Loader v1\nPURPOSE: Use curated capsules to scaffold reasoning and enforce acceptance rules.\nMETHOD:\n  1) Load capsule rules (below).\n  2) For each task, follow Plan ‚Üí Verify ‚Üí Answer.\n  3) If required fields are missing, ask ONE concise follow-up.\n  4) Cite sources or abstain. Redact PII. Validate tool JSON before calling.\n  5) Emit a JSON report when asked (see REPORT SCHEMA).\nFAILURE POLICY: If a capsule cannot be satisfied, abstain + explain what is missing.");
            blocks.push("SYSTEM: Bootstrap Discipline\n‚Ä¢ Curation is king - prefer curated fixtures/evidence; abstain when unsure.\n‚Ä¢ Show your work - reference evidence in answers.\n‚Ä¢ Make failures explicit and reversible - choose tiny experiments.");
          }

          // Heading + pedagogy policy
          const heading = response.capsules_heading || 'SYSTEM: Capsule Rules (Selected)';
          const wantsPedInProfile = Array.isArray(projection.include) && projection.include.some(s => String(s).startsWith('pedagogy.'));
          const forcePed = !!(projection && projection.force_pedagogy) || !!response.force_pedagogy;
          const withPedUI = !!($('includePed') && $('includePed').checked);
          const withPed = forcePed || withPedUI || wantsPedInProfile;

          // Robust selected ids
          const idsCanon = getSelectedIdsSafe();
          if (!idsCanon.length) {
            blocks.push(heading + "\n- (No capsules selected)");
          } else {
            blocks.push(heading);
            for (const canon of idsCanon) {
              const cap = getCapsuleByAnyId(canon);
              if (!cap) continue;
              if (projection && projection.include) blocks.push(applyProjection(cap, projection, withPed));
              else blocks.push(composeLegacy(cap, withPed));
            }
          }

          // --- footer (profile-controlled) ---
          if (typeof response.footer === 'string' && response.footer.trim().length) {
            blocks.push(response.footer.trim());
          }

          // Markdown wrap choice: UI wins; otherwise profile default (if provided)
          const wrapDefault = !!response.markdown_wrap_default;
          const wrapUI = !!($('markdown') && $('markdown').checked);
          const wrap = wrapUI || (wrapDefault && !$('markdown'));
          let out = blocks.filter(Boolean).join("\n\n").trim();
          if (wrap) out = "```\n" + out + "\n```";
          $('out').value = out;

        } catch (err) {
          console.error(err);
          $('out').value = "ERROR composing prompt: " + (err && err.message ? err.message : String(err));
        }
      }

      /* ---------- Small templating & structure helpers ---------- */
      function applyTemplate(tpl, dict) {
        return String(tpl).replace(/\{([\w.]+)\}/g, (_, k) => {
          const v = dict[k];
          return (v === undefined || v === null) ? '' : String(v);
        });
      }
      function parseInclude(spec) {
        // e.g., "pedagogy.socratic[:2]" or "pedagogy.aphorisms[1:3]"
        const s = String(spec);
        const m = s.match(/^([\w.]+)(\[(?::?\d*)?(?::\d*)?\])?$/);
        const path = m ? m[1] : s;
        let sliceFrom = null, sliceTo = null;
        const slice = m && m[2] ? m[2].slice(1, -1) : null;
        if (slice != null && slice.length) {
          const parts = slice.split(':');
          if (parts.length === 2) {
            sliceFrom = parts[0].length ? parseInt(parts[0], 10) : null;
            sliceTo = parts[1].length ? parseInt(parts[1], 10) : null;
          } else if (parts.length === 1 && parts[0].length) {
            const idx = parseInt(parts[0], 10);
            sliceFrom = isNaN(idx) ? null : idx;
            sliceTo = isNaN(idx) ? null : (idx + 1);
          }
        }
        return { path, sliceFrom, sliceTo };
      }
      function sliceArray(arr, from, to) {
        const n = Array.isArray(arr) ? arr.length : 0;
        const start = (from == null) ? 0 : Math.max(0, from);
        const end = (to == null) ? n : Math.max(start, Math.min(n, to));
        return arr.slice(start, end);
      }
      function getByPath(obj, path) {
        if (!obj || !path) return null;
        const parts = path.split('.');
        let cur = obj;
        for (const p of parts) {
          if (cur == null) return null;
          cur = cur[p];
        }
        return cur;
      }

      /* ------------ Manifest + share ------------ */

      /* Namespace for LocalStorage manifests */
      const MANIFEST_NS = 'tc_manifests_v1'; // value: { [name: string]: Manifest }

      /* Helpers */
      function readAllManifests() {
        try { return JSON.parse(localStorage.getItem(MANIFEST_NS) || '{}'); }
        catch { return {}; }
      }
      function writeAllManifests(obj) {
        localStorage.setItem(MANIFEST_NS, JSON.stringify(obj || {}));
      }
      function listManifestNames() {
        return Object.keys(readAllManifests()).sort((a, b) => a.localeCompare(b));
      }

      /* Filename-ish, human friendly */
      function tsCompact(d = new Date()) {
        const p2 = n => String(n).padStart(2, '0');
        return [
          d.getFullYear(),
          p2(d.getMonth() + 1),
          p2(d.getDate()),
          '_',
          p2(d.getHours()),
          p2(d.getMinutes()),
          p2(d.getSeconds())
        ].join('');
      }
      function suggestedManifestName() {
        const prof = STATE.profile || 'default';
        const nCaps = STATE.order.filter(id => STATE.selectedCaps.has(id)).length;
        return `${tsCompact()}__${prof}__n${nCaps}`;
      }

      /* Build a complete, safe-to-JSON manifest (includes the composed system prompt) */
      function buildManifest() {
        return {
          schema: 'tc.manifest.v1',
          ts: new Date().toISOString(),
          profile: STATE.profile,
          bundles: [...STATE.selectedBundles],
          order: STATE.order.filter(id => STATE.selectedCaps.has(id)),
          includePed: $('includePed').checked ? 1 : 0,
          markdown: $('markdown').checked ? 1 : 0,
          // Save the current composed system prompt WITHOUT markdown fences
          prompt: getCurrentSystemPrompt()
        };
      }

      /* Export-only (for URL deeplinks) */
      function exportState() {
        return {
          profile: STATE.profile,
          bundles: [...STATE.selectedBundles],
          order: STATE.order.filter(id => STATE.selectedCaps.has(id))
        };
      }

      /* Share-link (does not include prompt; keeps links light) */
      function encodeStateToUrl() {
        const s = btoa(unescape(encodeURIComponent(JSON.stringify(exportState()))));
        const url = new URL(window.location.href);
        url.searchParams.set('s', s);
        return url.toString();
      }

      /* Import state/manifest (from file or LocalStorage). Also applies prompt after render. */
      function importState(obj) {
        if (!obj) return;

        // Choose a valid profile (fallback to first available)
        const prof = (obj.profile && DATA.profiles[obj.profile]) ? obj.profile
          : (Object.keys(DATA.profiles || {})[0] || null);

        STATE.profile = prof;
        STATE.selectedBundles = new Set();
        STATE.selectedCaps = new Set();
        STATE.manualCaps = new Set();
        STATE.order = [];

        // Bundles ‚Üí selectedCaps/ORDER
        (obj.bundles || []).forEach(b => { if (DATA.bundles[b]) STATE.selectedBundles.add(b); });
        STATE.selectedBundles.forEach(b => {
          const caps = (DATA.bundles[b] && DATA.bundles[b].capsules) || [];
          caps.forEach(cid => {
            if (DATA.capsules[cid]) {
              STATE.selectedCaps.add(cid);
              if (!STATE.order.includes(cid)) STATE.order.push(cid);
            }
          });
        });

        // Manual order/caps (explicit)
        (obj.order || []).forEach(cid => {
          if (DATA.capsules[cid]) {
            if (!STATE.order.includes(cid)) STATE.order.push(cid);
            STATE.selectedCaps.add(cid);
          }
        });

        // Render everything (this will call compose(), which would normally overwrite #out)
        render();

        // Restore checkboxes from the manifest (optional, but nice to have)
        if (Object.prototype.hasOwnProperty.call(obj, 'includePed')) {
          $('includePed').checked = !!obj.includePed;
        }
        if (Object.prototype.hasOwnProperty.call(obj, 'markdown')) {
          $('markdown').checked = !!obj.markdown;
        }

        // Apply prompt AFTER render/compose so the loaded prompt wins on load
        if (typeof obj.prompt === 'string') {
          $('out').value = obj.prompt;
        }

        // Update the profile select‚Äôs remembered value for future sessions
        if (STATE.profile) localStorage.setItem('tc_profile', STATE.profile);
      }

      /* Hydrate state from ?s=... link */
      function tryHydrateFromUrl() {
        const url = new URL(window.location.href);
        const s = url.searchParams.get('s');
        if (!s) return;
        try {
          const json = decodeURIComponent(escape(atob(s)));
          importState(JSON.parse(json));
        } catch (e) {
          console.error('bad s param', e);
        }
      }

      /* LocalStorage manifests ‚Äì UI binding */
      function refreshManifestSelect() {
        const sel = $('manifestSelect');
        if (!sel) return;
        sel.innerHTML = '';
        const names = listManifestNames();
        if (names.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '(no saved manifests)';
          sel.appendChild(opt);
          sel.disabled = true;
        } else {
          sel.disabled = false;
          names.forEach(n => {
            const opt = document.createElement('option');
            opt.value = n;
            opt.textContent = n;
            sel.appendChild(opt);
          });
        }
      }

      function saveManifestToLocalStorage() {
        const manifest = buildManifest();
        const defaultName = suggestedManifestName();
        const name = prompt('Save manifest as:', defaultName);
        if (!name) return;

        const all = readAllManifests();
        const exists = Object.prototype.hasOwnProperty.call(all, name);
        if (exists) {
          const ok = confirm(`A manifest named "${name}" already exists. Overwrite?`);
          if (!ok) return;
        }

        all[name] = manifest;
        writeAllManifests(all);
        refreshManifestSelect();
        // Preselect the saved item
        const sel = $('manifestSelect');
        if (sel && !sel.disabled) sel.value = name;
        toast(`Saved manifest "${name}"`);
      }

      function loadSelectedManifestFromLocalStorage() {
        const sel = $('manifestSelect');
        if (!sel || sel.disabled || !sel.value) {
          toast('No saved manifest selected');
          return;
        }
        const all = readAllManifests();
        const m = all[sel.value];
        if (!m) { toast('Manifest not found'); return; }
        importState(m);
        toast(`Loaded "${sel.value}"`);
      }

      function deleteSelectedManifestFromLocalStorage() {
        const sel = $('manifestSelect');
        if (!sel || sel.disabled || !sel.value) {
          toast('No saved manifest selected');
          return;
        }
        const name = sel.value;
        const ok = confirm(`Delete saved manifest "${name}"? This cannot be undone.`);
        if (!ok) return;

        const all = readAllManifests();
        delete all[name];
        writeAllManifests(all);
        refreshManifestSelect();
        toast(`Deleted "${name}"`);
      }

      /* Wire buttons (file import already exists, we keep it) */
      $('dlJsonBtn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(buildManifest(), null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'system_prompt.manifest.json';
        a.click();
      });

      $('loadJsonBtn').addEventListener('click', () => {
        const inp = document.createElement('input');
        inp.type = 'file';
        inp.accept = 'application/json';
        inp.onchange = async () => {
          const f = inp.files[0];
          if (!f) return;
          try {
            const txt = await f.text();
            const obj = JSON.parse(txt);
            importState(obj);
            toast('Manifest loaded from file');
          } catch (e) {
            console.error(e);
            toast('Invalid JSON manifest');
          }
        };
        inp.click();
      });

      /* New LS controls */
      $('manifestSaveBtn').addEventListener('click', saveManifestToLocalStorage);
      $('manifestLoadBtn').addEventListener('click', loadSelectedManifestFromLocalStorage);
      $('manifestDeleteBtn').addEventListener('click', deleteSelectedManifestFromLocalStorage);

      /* Populate the manifest list on load */
      window.addEventListener('load', refreshManifestSelect);


      /* ------------ LLM Command Composition ------------ */
      function shQuoteLiteral(s) {
        // POSIX-safe single-quote wrapper: ' becomes '\''
        return "'" + String(s).replace(/'/g, "'\\''") + "'";
      }

      function buildSysHeredoc(promptText) {
        // Use single-quoted heredoc label to disable interpolation/globbing
        // Use TC_SYSTEM to avoid conflicts with user's shell variables
        const label = "__TC_SYSTEM__";
        return [
          `read -r -d '' TC_SYSTEM <<'${label}'`,
          promptText,
          label
        ].join("\n");
      }

      function buildInputFragment(tpl, userText, filePath) {
        const flags = (tpl.extra_flags || []).join(' ');

        if (tpl.input_mode === 'arg') {
          return {
            EXTRA_FLAGS: flags,
            INPUT_FRAGMENT: `<<< ${shQuoteLiteral(userText || "")}`
          };
        }

        if (tpl.input_mode === 'stdin') {
          return {
            EXTRA_FLAGS: flags,
            STDIN_PIPE: `printf %s ${shQuoteLiteral(userText || "")} |`,
            INPUT_FRAGMENT: ""
          };
        }

        if (tpl.input_mode === 'file') {
          return {
            EXTRA_FLAGS: flags,
            FILE_PATH: shQuoteLiteral(filePath || "input.txt"),
            INPUT_FRAGMENT: ""
          };
        }

        return { EXTRA_FLAGS: flags, INPUT_FRAGMENT: "" };
      }

      function composeLlmCommand(tpl, systemPrompt, userText, filePath, minify) {
        const sysText = minify ? systemPrompt.replace(/\s+/g, ' ').trim() : systemPrompt;
        const sysHeredoc = buildSysHeredoc(sysText);
        const frags = buildInputFragment(tpl, userText, filePath);

        // Build the command by replacing all placeholders
        let cmd = String(tpl.cmd_template || '');

        // Replace required placeholders
        cmd = cmd.replace(/\{\{SYS_HEREDOC\}\}/g, sysHeredoc);
        cmd = cmd.replace(/\{\{MODEL\}\}/g, tpl.model || '');
        cmd = cmd.replace(/\{\{INPUT_FRAGMENT\}\}/g, frags.INPUT_FRAGMENT || '');

        // Replace optional placeholders
        cmd = cmd.replace(/\{\{EXTRA_FLAGS\}\}/g, frags.EXTRA_FLAGS || '');
        cmd = cmd.replace(/\{\{STDIN_PIPE\}\}/g, frags.STDIN_PIPE || '');
        cmd = cmd.replace(/\{\{FILE_PATH\}\}/g, frags.FILE_PATH || '');

        // Clean up:
        // 1. Collapse multiple spaces into single space
        cmd = cmd.replace(/ {2,}/g, ' ');
        // 2. Remove trailing spaces on lines
        cmd = cmd.replace(/[ \t]+$/gm, '');
        // 3. Ensure final newline
        cmd = cmd.trim() + "\n";

        return cmd;
      }

      function getCurrentSystemPrompt() {
        // Get the current composed prompt, stripping markdown fences if present
        let prompt = $('out').value;
        if ($('markdown').checked) {
          // Remove leading ``` and trailing ```
          prompt = prompt.replace(/^```\n/, '').replace(/\n```$/, '');
        }
        return prompt;
      }

      function updateLlmPreview() {
        const templates = DATA.llm_templates || [];
        const selectedId = $('llm_template').value;
        const tpl = templates.find(t => t.id === selectedId);

        if (!tpl) {
          $('llm_preview').value = '';
          return;
        }

        const systemPrompt = getCurrentSystemPrompt();
        const userText = $('llm_user_input').value;
        const filePath = $('llm_file_path').value;
        const minify = $('llm_minify').checked;

        const command = composeLlmCommand(tpl, systemPrompt, userText, filePath, minify);
        $('llm_preview').value = command;
      }

      function openLlmModal() {
        const templates = DATA.llm_templates || [];

        if (templates.length === 0) {
          toast('No LLM templates found');
          return;
        }

        // Populate template selector
        const sel = $('llm_template');
        sel.innerHTML = '';
        templates.forEach(tpl => {
          const opt = document.createElement('option');
          opt.value = tpl.id;
          opt.textContent = tpl.label;
          sel.appendChild(opt);
        });

        // Restore last used template from localStorage
        const lastTemplate = localStorage.getItem('llm_last_template');
        if (lastTemplate && templates.find(t => t.id === lastTemplate)) {
          sel.value = lastTemplate;
        }

        // Update description and input mode on template change
        const updateTemplateUI = () => {
          const selectedId = sel.value;
          const tpl = templates.find(t => t.id === selectedId);
          if (!tpl) return;

          $('llm_template_desc').textContent = tpl.description || '';

          // Show/hide input fields based on input_mode
          if (tpl.input_mode === 'file') {
            $('llm_input_row').style.display = 'none';
            $('llm_file_row').style.display = 'flex';
          } else {
            $('llm_input_row').style.display = 'flex';
            $('llm_file_row').style.display = 'none';

            if (tpl.input_mode === 'stdin') {
              $('llm_input_hint').textContent = 'Will be piped to stdin';
            } else {
              $('llm_input_hint').textContent = 'Will be passed as bash here-string (<<<)';
            }
          }

          // Update preview whenever template changes
          updateLlmPreview();
        };

        sel.onchange = updateTemplateUI;

        // Update preview on input changes
        $('llm_user_input').oninput = updateLlmPreview;
        $('llm_file_path').oninput = updateLlmPreview;
        $('llm_minify').onchange = updateLlmPreview;

        updateTemplateUI();

        // Clear inputs (but preserve file path default)
        $('llm_user_input').value = '';
        $('llm_file_path').value = 'input.txt';
        $('llm_minify').checked = false;

        // Initial preview
        updateLlmPreview();

        $('llmModal').style.display = 'flex';
      }

      function closeLlmModal() {
        $('llmModal').style.display = 'none';
      }

      function copyLlmCommand() {
        const command = $('llm_preview').value;

        if (!command) {
          toast('No command to copy');
          return;
        }

        // Save the selected template to localStorage
        const selectedId = $('llm_template').value;
        if (selectedId) {
          localStorage.setItem('llm_last_template', selectedId);
        }

        navigator.clipboard.writeText(command).then(() => {
          toast('Command copied to clipboard!');
          // Don't close the modal - let user copy again or review
        }).catch(err => {
          console.error('Copy failed:', err);
          toast('Copy failed - see console');
        });
      }

      // Save the generated command as a runnable bash script
      function saveLlmScript() {
        const command = $('llm_preview').value;
        if (!command) {
          toast('No command to save');
          return;
        }

        const tplId = $('llm_template').value || 'cmd';
        const nowIso = new Date().toISOString();
        const filename = `llm_${tplId}_${nowIso.replace(/[:.]/g, '-')}.sh`;

        const header =
          `#!/usr/bin/env bash
# Generated by Truth Capsule Composer
# Template: ${tplId}
# Date: ${nowIso}
set -Eeuo pipefail
IFS=$'\\n\\t'

`;

        const blob = new Blob([header, command], { type: 'text/x-shellscript' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
        a.remove();
        toast(`Saved ${filename} (remember: chmod +x ${filename})`);
      }
      function copyLlmCommand() {
        const command = $('llm_preview').value;

        if (!command) {
          toast('No command to copy');
          return;
        }

        // Save the selected template to localStorage
        const selectedId = $('llm_template').value;
        if (selectedId) {
          localStorage.setItem('llm_last_template', selectedId);
        }

        navigator.clipboard.writeText(command).then(() => {
          toast('Command copied to clipboard!');
          // Don't close the modal - let user copy again or review
        }).catch(err => {
          console.error('Copy failed:', err);
          toast('Copy failed - see console');
        });
      }

      // Wire up LLM modal events
      $('copyLlmBtn').addEventListener('click', openLlmModal);
      $('llm_close').addEventListener('click', closeLlmModal);
      $('llm_cancel').addEventListener('click', closeLlmModal);
      $('llm_copy').addEventListener('click', copyLlmCommand);
      $('llm_save').addEventListener('click', saveLlmScript)
      $('llmModal').addEventListener('click', e => {
        if (e.target && e.target.id === 'llmModal') closeLlmModal();
      });

      /* ------------ Wire up UI ------------ */
      $('search').addEventListener('input', () => { STATE.filter = $('search').value; renderCapsules(); });
      $('clearBtn').addEventListener('click', () => { STATE.selectedBundles = new Set(); STATE.selectedCaps = new Set(); STATE.manualCaps = new Set(); STATE.order = []; render(); toast('Cleared'); });
      $('composeBtn').addEventListener('click', compose);
      $('copyBtn').addEventListener('click', () => { navigator.clipboard.writeText($('out').value); toast('Prompt copied'); });
      $('dlBtn').addEventListener('click', () => { const blob = new Blob([$('out').value], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'system_prompt.txt'; a.click(); });
      $('dlJsonBtn').addEventListener('click', () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(buildManifest(), null, 2)], { type: 'application/json' })); a.download = 'system_prompt.manifest.json'; a.click(); });
      $('shareLinkBtn').addEventListener('click', () => { const url = encodeStateToUrl(); navigator.clipboard.writeText(url).then(() => toast('Share link copied')).catch(() => { prompt('Copy link:', url); }); });
      $('loadJsonBtn').addEventListener('click', () => { const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json'; inp.onchange = async () => { const f = inp.files[0]; if (!f) return; const txt = await f.text(); importState(JSON.parse(txt)); toast('State loaded'); }; inp.click(); });
      $('validateAllBtn').addEventListener('click', async () => {
        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id)); const results = [];
        for (const id of ids) { const c = DATA.capsules[id]; if (!c) continue; const v = await validateDigest(c); results.push({ id, ok: v.ok }); }
        const ok = results.filter(r => r.ok).length; const fail = results.length - ok;
        toast(`Digests: ${ok} ok, ${fail} fail`); try { await navigator.clipboard.writeText(results.map(r => (r.ok ? '‚úì ' : '‚úó ') + r.id).join('\n')); } catch { }
      });
      $('includePed').addEventListener('change', compose);
      $('markdown').addEventListener('change', compose);

      /* Keyboard shortcuts */
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { compose(); }
        if (e.key === '/') { e.preventDefault(); $('search').focus(); }
        if (e.key === 'm') { $('markdown').checked = !$('markdown').checked; compose(); }
        if (e.key === 'p') { $('includePed').checked = !$('includePed').checked; compose(); }
      });

      function render() { renderProfiles(); renderBundles(); renderCapsules(); renderPreview(); compose(); }
      render();
      tryHydrateFromUrl();
      initBundlesCollapsibleSimple();

      // Remember splits
      const mainSizes = JSON.parse(localStorage.getItem('tc_split_main') || '[30,70]');
      Split(['#left', '#right'], { sizes: mainSizes, minSize: 240, gutterSize: 8, onDragEnd: s => localStorage.setItem('tc_split_main', JSON.stringify(s)) });

      const subSizes = JSON.parse(localStorage.getItem('tc_split_sub') || '[45,55]');
      Split(['#bundlesWrap', '#capsulesWrap'], { direction: 'vertical', sizes: subSizes, minSize: [80, 120], gutterSize: 8, onDragEnd: s => localStorage.setItem('tc_split_sub', JSON.stringify(s)) });

      // Remember profile + checkboxes
      $('profiles').addEventListener('change', () => localStorage.setItem('tc_profile', $('profiles').value));
      $('includePed').addEventListener('change', () => localStorage.setItem('tc_inc_ped', $('includePed').checked ? '1' : '0'));
      $('markdown').addEventListener('change', () => localStorage.setItem('tc_md', $('markdown').checked ? '1' : '0'));

      window.addEventListener('load', () => {
        const p = localStorage.getItem('tc_profile'); if (p && DATA.profiles[p]) $('profiles').value = p;
        $('includePed').checked = localStorage.getItem('tc_inc_ped') !== '0';
        $('markdown').checked = localStorage.getItem('tc_md') === '1';
      });

      (function profileHelp() {
        const sel = document.getElementById('profiles');
        const desc = document.getElementById('profileDesc');
        const help = document.getElementById('profileHelp');
        const btn = document.getElementById('profileInfo');

        // Always show the selected profile's description (from <option data-desc="...">)
        function renderDesc() {
          if (!sel || !desc) return;
          const opt = sel.options[sel.selectedIndex];
          const d = opt && opt.dataset ? (opt.dataset.desc || '').trim() : '';
          desc.textContent = d ? ` -  ${d}` : '';   // always visible, empty if none
        }

        // Wire events (guarded)
        if (sel) {
          sel.addEventListener('change', renderDesc);
          // Schedule initial render after options are populated by your code
          requestAnimationFrame(renderDesc);
        }

        // Help button toggles the explanatory panel (general concept of profiles)
        if (btn && help) {
          btn.addEventListener('click', () => {
            const hidden = help.hasAttribute('hidden');
            if (hidden) help.removeAttribute('hidden'); else help.setAttribute('hidden', '');
            btn.setAttribute('aria-expanded', String(hidden));
          });
        }
      })();

      /* Close <details.menu> when clicking elsewhere, Esc, or when another opens */
      (function menuCloser() {
        const menus = () => Array.from(document.querySelectorAll('details.menu'));

        function closeAll(except = null) {
          menus().forEach(d => { if (d !== except) d.removeAttribute('open'); });
        }

        // 1) Click anywhere: keep the menu under the click, close the rest
        document.addEventListener('click', (e) => {
          const keep = e.target.closest('details.menu');
          closeAll(keep || null);
        });

        // 2) When a menu toggles open, close the others
        // Use capture to be safe across browsers.
        document.addEventListener('toggle', (e) => {
          const el = e.target;
          if (el instanceof HTMLDetailsElement && el.classList.contains('menu') && el.open) {
            closeAll(el);
          }
        }, true);

        // 3) Esc closes all menus
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeAll();
        });

        // 4) After a menu-item is activated, close its menu (let handler run first)
        document.addEventListener('click', (e) => {
          const item = e.target.closest('.menu-item');
          if (!item) return;
          const d = item.closest('details.menu');
          if (d) setTimeout(() => d.removeAttribute('open'), 0);
        });
      })();


    </script>
</body>

</html>