<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Truth Capsule Viewer & Prompt Composer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- THEME + LAYOUT -->
<style>
  /* ============================
   MODERN THEME — PREMIUM CUT
   ============================ */

/* ---- Tokens (Dark default) ---- */
:root{
  /* Surfaces */
  --bg:            #0e1116;
  --panel:         #151a21;
  --panel-raise:   #171d24;   /* subtle elevated */
  --panel-alt:     #1a212b;
  --divider:       #232a36;   /* hairlines / separators */
  --border:        #232a36;

  /* Text & accents */
  --text:          #e8ecf2;
  --muted:         #a6b0c2;
  --accent:        #76a2ff;   /* link/brand */
  --accent-strong: #4b86ff;
  --ok:            #19e184;
  --danger:        #ff6b6b;
  --warn:          #ffae3a;

  /* UI */
  --chip:          #1f2632;
  --chip-border:   #2a3444;

  /* Controls */
  --input-bg:      #0f141d;
  --btn-bg:        #0f141d;
  --btn-fg:        var(--text);

  /* Textareas (default, non-terminal) */
  --textarea-bg:   var(--panel-alt);
  --textarea-fg:   var(--text);

  /* Terminal (syscode) */
  --code-bg:       #0f1117;
  --code-fg:       #a9ffb8;
  --code-border:   #1c2330;

  /* Shadows */
  --shadow-sm:     0 1px 0 rgba(0,0,0,.04);
  --shadow-md:     0 8px 24px rgba(0,0,0,.22);
  --shadow-lg:     0 16px 48px rgba(0,0,0,.28);

  /* Motion & radii */
  --radius:        12px;
  --radius-sm:     10px;
  --transition:    140ms cubic-bezier(.2,.8,.2,1);

  /* Scroll & gutters */
  --scroll-thumb:  #2a3546;
  --scroll-track:  var(--bg);
  --gutter-idle:   linear-gradient(to right, transparent, rgba(255,255,255,.08), transparent);
  --gutter-hover:  linear-gradient(to right, transparent, rgba(118,162,255,.35), transparent);
}

/* Explicit light theme: override ALL tokens */
html[data-theme="light"]{
  color-scheme: light;

  --bg:            #f6f8fc;
  --panel:         #ffffff;
  --panel-raise:   #ffffff;
  --panel-alt:     #f4f7fd;
  --divider:       #e8eef7;
  --border:        #175cb7;

  --text:          #0e1320;
  --muted:         #5b6680;
  --accent:        #265ff1;
  --accent-strong: #1f55e6;
  --ok:            #19e184;
  --danger:        #d83a3a;
  --warn:          #d48a14;

  --chip:          #eef2fb;
  --chip-border:   #d8e1f1;

  --input-bg:      #f1f5fb;
  --btn-bg:        #c5c5c5;
  --btn-fg:        var(--text);

  /* Keep terminals dark in light mode for contrast */
  --textarea-bg:   #f7f9ff;
  --textarea-fg:   #0e1320;

  --code-bg:       #0f1117;
  --code-fg:       #a9ffb8;
  --code-border:   #1c2330;

  --shadow-sm:     0 1px 0 rgba(0,0,0,.05);
  --shadow-md:     0 8px 28px rgba(12,26,54,.10);
  --shadow-lg:     0 16px 52px rgba(12,26,54,.14);

  --scroll-thumb:  #c9d4e8;
  --scroll-track:  var(--bg);
  --gutter-idle:   linear-gradient(to right, transparent, rgba(13,26,49,.10), transparent);
  --gutter-hover:  linear-gradient(to right, transparent, rgba(36,99,235,.35), transparent);
}

/* Optional: make an explicit dark theme switch also work */
html[data-theme="dark"]{
  color-scheme: dark;
  /* (No token overrides needed since :root is already dark) */
}


/* Follow OS if no explicit theme attribute is set */
@media (prefers-color-scheme: light){
  html:not([data-theme]){
    color-scheme: light;

    --bg:            #f6f8fc;
    --panel:         #ffffff;
    --panel-raise:   #ffffff;
    --panel-alt:     #f4f7fd;
    --divider:       #e8eef7;
    --border:        #dde6f2;

    --text:          #0e1320;
    --muted:         #5b6680;
    --accent:        #265ff1;
    --accent-strong: #1f55e6;

    --chip:          #eef2fb;
    --chip-border:   #d8e1f1;

    --input-bg:      #f1f5fb;
    --btn-bg:        #c5c5c5;
    --btn-fg:        var(--text);

    --textarea-bg:   #f7f9ff;
    --textarea-fg:   #0e1320;

    /* Keep terminal dark in light mode for contrast */
    --code-bg:       #0f1117;
    --code-fg:       #a9ffb8;
    --code-border:   #1c2330;

    --shadow-sm:     0 1px 0 rgba(0,0,0,.05);
    --shadow-md:     0 8px 28px rgba(12,26,54,.10);
    --shadow-lg:     0 16px 52px rgba(12,26,54,.14);

    --scroll-thumb:  #c9d4e8;
    --scroll-track:  var(--bg);
    --gutter-idle:   linear-gradient(to right, transparent, rgba(13,26,49,.10), transparent);
    --gutter-hover:  linear-gradient(to right, transparent, rgba(36,99,235,.35), transparent);
  }
}

/* Explicit theme overrides */
html[data-theme="dark"]{ color-scheme: dark; }
html[data-theme="light"]{ color-scheme: light; }

/* ---------- Light theme refinement ---------- */
html[data-theme="light"]{
  /* neutrals */
  --bg:#f8fafc;
  --panel:#ffffff;
  --panel-alt:#f7f9fc;          /* less blue than before */
  --text:#0f172a;
  --muted:#64748b;

  /* accents & structure */
  --accent:#2563eb;
  --border:#568fe0;             /* neutral, not saturated blue */
  --border-strong:#d6dde7;      /* for separators/hover */
  --chip:#f5f7fb;
  --chip-border:#e4eaf4;

  --input-bg:#f9fbfe;
  --btn-bg:#ced3df;
  --btn-fg:var(--text);

  /* code stays dark in light mode */
  --code-bg:#0f1117;
  --code-fg:#c7ffcf;
  --code-border:#1d2330;

  /* rings & elevation */
  --ring: color-mix(in oklab,var(--accent),white 70%);
  --ring-strong: color-mix(in oklab,var(--accent),white 55%);
  --shadow: 0 1px 2px rgba(17,24,39,.05), 0 2px 12px rgba(17,24,39,.08);
}

/* vertical separator between panes */
#left { border-right:1px solid var(--border-strong); }

/* cards/items: neutral frames, modern hover */
.card, .item, .chip { border:1px solid var(--border); box-shadow:var(--shadow); }
.item:hover, .card:hover { border-color:var(--border-strong);
  box-shadow:0 1px 2px rgba(17,24,39,.06), 0 8px 20px rgba(17,24,39,.08); }

.section-title { color:var(--muted); letter-spacing:.02em; font-weight:600; }

/* inputs/selects */
input[type="text"], select {
  background:var(--input-bg); border:1px solid var(--border); color:var(--text);
}
input[type="text"]:focus, select:focus {
  outline:none; border-color:var(--ring-strong); box-shadow:0 0 0 3px var(--ring);
}

/* text areas: use .code to get dark terminal treatment */
textarea:not(.code), pre:not(.code) {
  background:var(--panel-alt); color:var(--text); border-color:var(--border);
}
textarea.code, pre.code, .terminal {
  background:var(--code-bg); color:var(--code-fg); border-color:var(--code-border);
}

/* buttons */
.btn { background:var(--btn-bg); color:var(--btn-fg); border:1px solid var(--border); }
.btn:hover { border-color:var(--ring-strong);
  box-shadow:0 0 0 3px color-mix(in oklab,var(--accent),white 85%); }

/* chips / badges */
.chip { background:var(--chip); border-color:var(--chip-border); color:var(--muted); }
.badge { background:#eef2f8; color:#3b4a6b; border:1px solid #d7deea; }
.badge.ok { background:#eaf7f0; color:#166534; border-color:#cde8d9; }
.badge.err { background:#fdecec; color:#7f1d1d; border-color:#f6b4b4; }

/* softer, consistent focus across the app */
:focus-visible {
  outline:none; border-color:var(--ring-strong);
  box-shadow:0 0 0 3px var(--ring); border-radius:var(--radius);
}


/* ==============
   Base / Layout
   ============== */
*{ box-sizing: border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font: 16px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial, "Noto Sans";
  letter-spacing:.01em;
}

/* Typographic scale */
h1{ font-size:15px; font-weight:650; margin:0; letter-spacing:.02em; }
h2.section-title{ font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin:0 0 8px; }

/* Scrollbars (webkit) */
*::-webkit-scrollbar{ width:12px; height:12px; }
*::-webkit-scrollbar-thumb{ background:var(--scroll-thumb); border-radius:8px; border:2px solid var(--scroll-track); }
*::-webkit-scrollbar-track{ background:var(--scroll-track); }

/* Smooth theme transitions */
html, body, .card, .item, header, section, textarea, pre, input, select, .chip, .badge, details, .collapsible,
#gutter, .gutter { transition: background-color var(--transition), color var(--transition), border-color var(--transition), box-shadow var(--transition); }

/* Focus ring */
:focus-visible{
  outline: 2px solid color-mix(in oklab, var(--accent), transparent 30%);
  outline-offset: 2px;
  border-radius: calc(var(--radius-sm) - 2px);
}

/* Header / App bar */
header{
  display:flex; align-items:center; gap:12px;
  padding:12px 16px;
  background:var(--panel-raise);
  border-bottom:1px solid var(--divider);
  position:sticky; top:0; z-index:50;
  box-shadow: var(--shadow-sm);
}
header .small{ color:var(--muted); }

/* Split layout */
main{ height: calc(100vh - 54px); position:relative; }
#split{ display:flex; height:100%; width:100%; }
#left, #right{ overflow:hidden; }
#left{
  flex:0 0 auto; min-width:280px; max-width:42vw;
  display:flex; flex-direction:column;
  background:var(--panel);
  /* Always-visible hairline on left panel edge in case gutter collapses */
  box-shadow: inset -1px 0 0 var(--divider);
}
#right{ flex:1 1 auto; min-width:0; overflow:auto; background:var(--panel-raise); }

/* Visible vertical separator (Split.js gutter) */
.gutter{
  width:10px !important; cursor:col-resize;
  background: var(--gutter-idle);
}
.gutter:hover{ background: var(--gutter-hover); }
.gutter.gutter-vertical{
  height:8px; cursor:row-resize;
  width:100% !important;
  background: linear-gradient(to bottom, transparent, lightgray, transparent);
}
.gutter.gutter-vertical:hover{
  background: linear-gradient(to bottom, transparent, rgba(118,162,255,.35), transparent);
}

/* Left panel internals */
#leftTop{ padding:25px; border-bottom:1px solid var(--divider); background:var(--panel-raise); }
#leftSplit{ flex:1; display:flex; flex-direction:column; min-height:0; }
.section-block{ display:flex; flex-direction:column; padding:12px; min-height:0; gap:10px; }
.section-title{ font-weight:700; letter-spacing:.06em; text-transform:uppercase; color:var(--muted); }

/* Lists */
.list{ display:flex; flex-direction:column; gap:8px; overflow:auto; min-height:0; padding:2px; }
.item{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius: var(--radius-sm);
  padding:10px;
  box-shadow: var(--shadow-sm), var(--shadow-md);
}
.item:hover{ border-color: color-mix(in oklab, var(--accent), transparent 70%); }
.item.is-active{ border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 82%); }
.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

.small,.muted{ color:var(--muted) !important; }

/* Chips & badges */
.chip{
  background:var(--chip);
  border:1px solid var(--chip-border);
  color:var(--text);
  border-radius:12px;
  padding:4px 8px;
  display:inline-flex; align-items:center; gap:6px;
  font-size:12px; font-weight:550;
  letter-spacing:.02em;
}
.chip:hover{ border-color:var(--accent); box-shadow:0 0 0 2px color-mix(in oklab, var(--accent), transparent 82%); transform:translateY(-1px); }
.chip.domain{ background: color-mix(in oklab, var(--chip), var(--accent) 10%); }
.chip.applies{ background: color-mix(in oklab, var(--chip), var(--ok) 10%); }

.badge{
  display:inline-block; padding:3px 7px; border-radius:999px;
  background: color-mix(in oklab, var(--chip), #000 0%);
  color: color-mix(in oklab, var(--text), #fff 0%);
  font-size:12px; font-weight:600; letter-spacing:.02em;
  border:1px solid var(--chip-border);
}
.badge.ok{ background: var(--ok); color: #000;}
.badge.err{ background: color-mix(in oklab, var(--danger), #000 70%); color:#ffe0e0; border-color:#4a1b1b; }
.badge.witnessed{ background: var(--warn); color:#fff4dd; }

/* Cards */
section{ display:flex; flex-direction:column; gap:14px; padding:14px; }
.card{
  background: var(--panel);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding:12px;
  box-shadow: var(--shadow-sm), var(--shadow-md);
}

/* Buttons */
.btn{
  padding:7px 12px;
  border:1px solid var(--border);
  border-radius:10px;
  background:var(--btn-bg);
  color:var(--btn-fg);
  cursor:pointer;
  font-weight:600;
  letter-spacing:.02em;
  box-shadow: var(--shadow-sm);
}
.btn.small{ font-size:13px; padding:4px 9px; border-radius:9px; }
.btn:hover{ border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab, var(--accent), transparent 85%); transform: translateY(-1px); }
.btn:active{ transform: translateY(0); }
.btn.primary{ background: color-mix(in oklab, var(--accent), #000 80%); border-color: var(--accent); }
.btn.warn{ background: color-mix(in oklab, var(--danger), #571d1d 80%); color:#ffdcdc; }

/* Inputs */
select, input[type="text"]{
  background:var(--input-bg);
  border: 2px solid #444;
  color:var(--text);
  padding:8px 10px;
  border-radius:10px;
  font-size:14px;
}
input[type="checkbox"]{ accent-color: var(--accent); }

/* Textareas & pre */
textarea, pre{
  width:100%; min-height:240px;
  background:var(--textarea-bg);
  color:var(--textarea-fg);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding:12px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size:15.5px; line-height:1.55; tab-size:2;
  white-space:pre-wrap; word-break:break-word;
}

/* Terminal-style (prompt + LLM output) */
.syscode{
  background:var(--code-bg) !important;
  color:var(--code-fg) !important;
  border:1px solid var(--code-border) !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
  caret-color:var(--code-fg);
}
.syscode::selection{ background: rgba(122,162,255,.25); }
textarea.syscode{ min-height:240px; resize:vertical; white-space:pre; overflow:auto; }

/* Details / collapsibles */
details.domain-group{
  border:1px solid var(--border);
  border-radius:10px;
  background:var(--panel);
  box-shadow: var(--shadow-sm);
  padding:6px 6px 8px;
}
details.domain-group + details.domain-group{ margin-top:8px; }
details.domain-group > summary{
  list-style:none; display:flex; align-items:center; gap:10px;
  cursor:pointer; user-select:none;
  padding:8px 10px;
  border-radius:8px;
  background:var(--panel-raise);
  border:1px solid var(--border);
}
details.domain-group > summary::-webkit-details-marker{ display:none; }
.domain-title{ font-weight:700; letter-spacing:.02em; }
.domain-spacer{ flex:1; }
.domain-body{ margin-top:8px; display:flex; flex-direction:column; gap:8px; }

/* Collapsible content blocks (panels) */
details.panel-collapsible{
  display:flex; flex-direction:column; min-height:0; max-height:100%;
  border:1px solid var(--border); border-radius:10px;
  background:var(--panel);
  box-shadow: var(--shadow-sm);
}
details.panel-collapsible > summary{
  list-style:none; cursor:pointer; user-select:none;
  padding:10px 12px;
  border-bottom:1px solid var(--divider);
  border-radius:10px; background:var(--panel-raise);
  font-weight:650;
}
details.panel-collapsible > summary::-webkit-details-marker{ display:none; }
details.panel-collapsible > .list{
  flex:1 1 auto; min-height:0; overflow-y:auto; overflow-x:hidden; padding:8px;
}

/* Bundles wrap variants */
#bundlesWrap details.panel-collapsible{ flex:1 1 0; }
#bundlesWrap details.panel-collapsible > summary{ flex:0 0 auto; }
#bundlesWrap details.panel-collapsible > .list{ flex:1 1 0; }

/* Non-<details> collapsible */
#bundlesWrap .collapsible{
  display:flex; flex-direction:column; flex:1 1 0; min-height:0;
  border:1px solid var(--border);
  border-radius:10px;
  background:var(--panel);
  box-shadow: var(--shadow-sm);
}
#bundlesWrap .collapsible-header{
  display:flex; align-items:center; gap:8px;
  padding:10px 12px;
  background:var(--panel-raise);
  border-bottom:1px solid var(--divider);
  border-radius:10px 10px 0 0;
  font-weight:650;
}
#bundlesWrap .collapsible-body{
  display:flex; flex-direction:column; flex:1 1 0; min-height:0;
  border-radius:0 0 10px 10px;
}
#bundlesWrap .collapsible-body[hidden]{ display:none; }
#bundlesWrap #bundles.list{
  display:flex; flex-direction:column; gap:8px;
  flex:1 1 0; min-height:0; overflow-y:auto; overflow-x:hidden; padding:8px;
}

/* Utility */
.clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

/* Modal */
#modal, #llmModal{
  position:fixed; inset:0; background:rgba(0,0,0,.48);
  display:none; align-items:center; justify-content:center; z-index:100;
  backdrop-filter: blur(2px);
}
#modal .modal-inner, #llmModal .modal-inner{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  max-width:900px; width:92%;
  max-height:80vh; overflow:auto; padding:14px;
  box-shadow: var(--shadow-lg);
}
#llmModal .form-row{ display:flex; flex-direction:column; gap:8px; margin:12px 0; }
#llmModal label{ font-weight:600; font-size:12px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted); }
#llmModal textarea{ min-height:120px; }
#llmModal .hint{ font-size:12px; color:var(--muted); margin-top:4px; }

/* Toast */
.toast{
  position:fixed; bottom:20px; right:20px;
  background:var(--panel-raise);
  color:var(--text);
  padding:10px 14px; border-radius:10px;
  border:1px solid var(--border);
  z-index:99; box-shadow: var(--shadow-md);
}

/* Hover affordances */
.item:hover, .chip:hover, .btn:hover, details.panel-collapsible > summary:hover{
  transform: translateY(-1px);
}

/* Normalize radii on interactive blocks */
.item, .chip, .badge, .btn, .card, pre, textarea{
  border-radius: var(--radius);
}


.label-with-help{display:flex;align-items:center;gap:8px}
.icon-btn{
  border:1px solid var(--border);
  background:var(--btn-bg);
  color:var(--text);
  width:28px;height:28px;line-height:26px;
  border-radius:8px;text-align:center;cursor:pointer;
}
.icon-btn:hover{border-color:var(--accent);
  box-shadow:0 0 0 3px color-mix(in oklab,var(--accent),transparent 85%)}
#profileHelp .muted{color:var(--muted)}
#profileDesc{margin-left:.5ch}

.help-box{
  margin-top:6px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:8px 10px;
}
.help-box > summary{
  list-style:none;
  cursor:pointer;
  font-weight:600;
  color:var(--muted);
  margin:-2px 0 4px 0;
}
.help-box[open] > summary{ margin-bottom:6px; }

.icon-btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:8px; border:1px solid var(--border);
  background:var(--btn-bg); color:var(--text); font-weight:700;
  cursor:pointer; line-height:1; padding:0;
}
.icon-btn:hover{ border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab, var(--accent), transparent 85%); }

.help-box{
  margin-top:8px; background:var(--panel); border:1px solid var(--border);
  border-radius:var(--radius); padding:10px 12px;
}
.help-title{ font-weight:600; margin-bottom:6px; }
.muted{ color:var(--muted); }

/* Layout */
.toolbar {
  display:flex;
  align-items:center;
  gap:12px;
}
.toolbar .title-wrap { display:flex; flex-direction:column; }
.toolbar-actions {
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

/* Groups = compact button clusters */
.group {
  display:flex;
  align-items:center;
  gap:4px;
  padding:2px;
  border:1px solid var(--border, #3a3f55);
  border-radius:10px;
  background:var(--panel, rgba(127,127,127,0.08));
}

/* Icon-sized buttons */
.btn.icon { padding:6px 8px; min-width:auto; }

/* Dropdown menu built from <details> */
.menu { position:relative; }
.menu > summary { list-style:none; cursor:pointer; }
.menu > summary::-webkit-details-marker { display:none; }
.menu[open] .menu-list { display:block; }

.menu-list{
  display:none;
  position:absolute;
  top:100%;
  right:0;
  margin-top:6px;
  padding:6px;
  background:var(--bgElevated, var(--bg));
  border:1px solid var(--border, #3a3f55);
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.35);
  z-index:1000;
  min-width:220px;
}

.menu-item{
  display:block;
  width:100%;
  padding:8px 10px;
  text-align:left;
  background:none;
  border:0;
  font:inherit;
  color:inherit;
  cursor:pointer;
}
.menu-item:hover{ background:rgba(127,127,127,0.12); border-radius:8px; }
.menu-item.warn{ color:var(--danger, #e06c75); }

.menu-field{ padding:4px 6px 8px; }
.menu-row{ display:flex; gap:6px; padding:4px 6px; }
.menu-sep{
  border:0; height:1px; margin:6px 0;
  background:linear-gradient(to right, transparent, var(--border, #3a3f55), transparent);
}

/* Small muted label */
.small.muted{ opacity:0.7; font-size:12px; }


</style>


  <!-- Prism / Split / Sortable -->
  
  <!-- digests (supply-chain breadcrumbs) -->
  <!-- prism_css: sha256=1b15fe2971998a048aebb60f26f6eed76122071db9ef3b995abd003224f52a98 -->
  <!-- prism_core: sha256=4b9994fc5f441d4c4fff23dee2535c09010bf93b1d90c2c72b0430c3d3f1008e -->
  <!-- prism_yaml: sha256=719c8e8b8c344dc9de510c729f65ba840b1502a0a8e7e25e2ad19ee715f65c02 -->
  <!-- prism_json: sha256=956d86baa5ae7ec4106758f354ac2d140bdcd7fc103dece02f73ed12b8d663e4 -->
  <!-- split_js: sha256=c32bd277fed98cd8a04033d4eef37201d9b50886189b4bb4d099d133feaf16dc -->
  <!-- sortable_js: sha256=ca68430703c4f5960e90735867c6e94d29b5a3de37107d8100e5a301007e9e6e -->

  <style>
    code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}
  </style>
  <script>
/* **********************************************
     Begin prism-core.js
********************************************** */

/// <reference lib="WebWorker"/>

var _self = (typeof window !== 'undefined')
	? window   // if in browser
	: (
		(typeof WorkerGlobalScope !== 'undefined' && self instanceof WorkerGlobalScope)
			? self // if in worker
			: {}   // if in node js
	);

/**
 * Prism: Lightweight, robust, elegant syntax highlighting
 *
 * @license MIT <https://opensource.org/licenses/MIT>
 * @author Lea Verou <https://lea.verou.me>
 * @namespace
 * @public
 */
var Prism = (function (_self) {

	// Private helper vars
	var lang = /(?:^|\s)lang(?:uage)?-([\w-]+)(?=\s|$)/i;
	var uniqueId = 0;

	// The grammar object for plaintext
	var plainTextGrammar = {};


	var _ = {
		/**
		 * By default, Prism will attempt to highlight all code elements (by calling {@link Prism.highlightAll}) on the
		 * current page after the page finished loading. This might be a problem if e.g. you wanted to asynchronously load
		 * additional languages or plugins yourself.
		 *
		 * By setting this value to `true`, Prism will not automatically highlight all code elements on the page.
		 *
		 * You obviously have to change this value before the automatic highlighting started. To do this, you can add an
		 * empty Prism object into the global scope before loading the Prism script like this:
		 *
		 * ```js
		 * window.Prism = window.Prism || {};
		 * Prism.manual = true;
		 * // add a new <script> to load Prism's script
		 * ```
		 *
		 * @default false
		 * @type {boolean}
		 * @memberof Prism
		 * @public
		 */
		manual: _self.Prism && _self.Prism.manual,
		/**
		 * By default, if Prism is in a web worker, it assumes that it is in a worker it created itself, so it uses
		 * `addEventListener` to communicate with its parent instance. However, if you're using Prism manually in your
		 * own worker, you don't want it to do this.
		 *
		 * By setting this value to `true`, Prism will not add its own listeners to the worker.
		 *
		 * You obviously have to change this value before Prism executes. To do this, you can add an
		 * empty Prism object into the global scope before loading the Prism script like this:
		 *
		 * ```js
		 * window.Prism = window.Prism || {};
		 * Prism.disableWorkerMessageHandler = true;
		 * // Load Prism's script
		 * ```
		 *
		 * @default false
		 * @type {boolean}
		 * @memberof Prism
		 * @public
		 */
		disableWorkerMessageHandler: _self.Prism && _self.Prism.disableWorkerMessageHandler,

		/**
		 * A namespace for utility methods.
		 *
		 * All function in this namespace that are not explicitly marked as _public_ are for __internal use only__ and may
		 * change or disappear at any time.
		 *
		 * @namespace
		 * @memberof Prism
		 */
		util: {
			encode: function encode(tokens) {
				if (tokens instanceof Token) {
					return new Token(tokens.type, encode(tokens.content), tokens.alias);
				} else if (Array.isArray(tokens)) {
					return tokens.map(encode);
				} else {
					return tokens.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/\u00a0/g, ' ');
				}
			},

			/**
			 * Returns the name of the type of the given value.
			 *
			 * @param {any} o
			 * @returns {string}
			 * @example
			 * type(null)      === 'Null'
			 * type(undefined) === 'Undefined'
			 * type(123)       === 'Number'
			 * type('foo')     === 'String'
			 * type(true)      === 'Boolean'
			 * type([1, 2])    === 'Array'
			 * type({})        === 'Object'
			 * type(String)    === 'Function'
			 * type(/abc+/)    === 'RegExp'
			 */
			type: function (o) {
				return Object.prototype.toString.call(o).slice(8, -1);
			},

			/**
			 * Returns a unique number for the given object. Later calls will still return the same number.
			 *
			 * @param {Object} obj
			 * @returns {number}
			 */
			objId: function (obj) {
				if (!obj['__id']) {
					Object.defineProperty(obj, '__id', { value: ++uniqueId });
				}
				return obj['__id'];
			},

			/**
			 * Creates a deep clone of the given object.
			 *
			 * The main intended use of this function is to clone language definitions.
			 *
			 * @param {T} o
			 * @param {Record<number, any>} [visited]
			 * @returns {T}
			 * @template T
			 */
			clone: function deepClone(o, visited) {
				visited = visited || {};

				var clone; var id;
				switch (_.util.type(o)) {
					case 'Object':
						id = _.util.objId(o);
						if (visited[id]) {
							return visited[id];
						}
						clone = /** @type {Record<string, any>} */ ({});
						visited[id] = clone;

						for (var key in o) {
							if (o.hasOwnProperty(key)) {
								clone[key] = deepClone(o[key], visited);
							}
						}

						return /** @type {any} */ (clone);

					case 'Array':
						id = _.util.objId(o);
						if (visited[id]) {
							return visited[id];
						}
						clone = [];
						visited[id] = clone;

						(/** @type {Array} */(/** @type {any} */(o))).forEach(function (v, i) {
							clone[i] = deepClone(v, visited);
						});

						return /** @type {any} */ (clone);

					default:
						return o;
				}
			},

			/**
			 * Returns the Prism language of the given element set by a `language-xxxx` or `lang-xxxx` class.
			 *
			 * If no language is set for the element or the element is `null` or `undefined`, `none` will be returned.
			 *
			 * @param {Element} element
			 * @returns {string}
			 */
			getLanguage: function (element) {
				while (element) {
					var m = lang.exec(element.className);
					if (m) {
						return m[1].toLowerCase();
					}
					element = element.parentElement;
				}
				return 'none';
			},

			/**
			 * Sets the Prism `language-xxxx` class of the given element.
			 *
			 * @param {Element} element
			 * @param {string} language
			 * @returns {void}
			 */
			setLanguage: function (element, language) {
				// remove all `language-xxxx` classes
				// (this might leave behind a leading space)
				element.className = element.className.replace(RegExp(lang, 'gi'), '');

				// add the new `language-xxxx` class
				// (using `classList` will automatically clean up spaces for us)
				element.classList.add('language-' + language);
			},

			/**
			 * Returns the script element that is currently executing.
			 *
			 * This does __not__ work for line script element.
			 *
			 * @returns {HTMLScriptElement | null}
			 */
			currentScript: function () {
				if (typeof document === 'undefined') {
					return null;
				}
				if ('currentScript' in document && 1 < 2 /* hack to trip TS' flow analysis */) {
					return /** @type {any} */ (document.currentScript);
				}

				// IE11 workaround
				// we'll get the src of the current script by parsing IE11's error stack trace
				// this will not work for inline scripts

				try {
					throw new Error();
				} catch (err) {
					// Get file src url from stack. Specifically works with the format of stack traces in IE.
					// A stack will look like this:
					//
					// Error
					//    at _.util.currentScript (http://localhost/components/prism-core.js:119:5)
					//    at Global code (http://localhost/components/prism-core.js:606:1)

					var src = (/at [^(\r\n]*\((.*):[^:]+:[^:]+\)$/i.exec(err.stack) || [])[1];
					if (src) {
						var scripts = document.getElementsByTagName('script');
						for (var i in scripts) {
							if (scripts[i].src == src) {
								return scripts[i];
							}
						}
					}
					return null;
				}
			},

			/**
			 * Returns whether a given class is active for `element`.
			 *
			 * The class can be activated if `element` or one of its ancestors has the given class and it can be deactivated
			 * if `element` or one of its ancestors has the negated version of the given class. The _negated version_ of the
			 * given class is just the given class with a `no-` prefix.
			 *
			 * Whether the class is active is determined by the closest ancestor of `element` (where `element` itself is
			 * closest ancestor) that has the given class or the negated version of it. If neither `element` nor any of its
			 * ancestors have the given class or the negated version of it, then the default activation will be returned.
			 *
			 * In the paradoxical situation where the closest ancestor contains __both__ the given class and the negated
			 * version of it, the class is considered active.
			 *
			 * @param {Element} element
			 * @param {string} className
			 * @param {boolean} [defaultActivation=false]
			 * @returns {boolean}
			 */
			isActive: function (element, className, defaultActivation) {
				var no = 'no-' + className;

				while (element) {
					var classList = element.classList;
					if (classList.contains(className)) {
						return true;
					}
					if (classList.contains(no)) {
						return false;
					}
					element = element.parentElement;
				}
				return !!defaultActivation;
			}
		},

		/**
		 * This namespace contains all currently loaded languages and the some helper functions to create and modify languages.
		 *
		 * @namespace
		 * @memberof Prism
		 * @public
		 */
		languages: {
			/**
			 * The grammar for plain, unformatted text.
			 */
			plain: plainTextGrammar,
			plaintext: plainTextGrammar,
			text: plainTextGrammar,
			txt: plainTextGrammar,

			/**
			 * Creates a deep copy of the language with the given id and appends the given tokens.
			 *
			 * If a token in `redef` also appears in the copied language, then the existing token in the copied language
			 * will be overwritten at its original position.
			 *
			 * ## Best practices
			 *
			 * Since the position of overwriting tokens (token in `redef` that overwrite tokens in the copied language)
			 * doesn't matter, they can technically be in any order. However, this can be confusing to others that trying to
			 * understand the language definition because, normally, the order of tokens matters in Prism grammars.
			 *
			 * Therefore, it is encouraged to order overwriting tokens according to the positions of the overwritten tokens.
			 * Furthermore, all non-overwriting tokens should be placed after the overwriting ones.
			 *
			 * @param {string} id The id of the language to extend. This has to be a key in `Prism.languages`.
			 * @param {Grammar} redef The new tokens to append.
			 * @returns {Grammar} The new language created.
			 * @public
			 * @example
			 * Prism.languages['css-with-colors'] = Prism.languages.extend('css', {
			 *     // Prism.languages.css already has a 'comment' token, so this token will overwrite CSS' 'comment' token
			 *     // at its original position
			 *     'comment': { ... },
			 *     // CSS doesn't have a 'color' token, so this token will be appended
			 *     'color': /\b(?:red|green|blue)\b/
			 * });
			 */
			extend: function (id, redef) {
				var lang = _.util.clone(_.languages[id]);

				for (var key in redef) {
					lang[key] = redef[key];
				}

				return lang;
			},

			/**
			 * Inserts tokens _before_ another token in a language definition or any other grammar.
			 *
			 * ## Usage
			 *
			 * This helper method makes it easy to modify existing languages. For example, the CSS language definition
			 * not only defines CSS highlighting for CSS documents, but also needs to define highlighting for CSS embedded
			 * in HTML through `<style>` elements. To do this, it needs to modify `Prism.languages.markup` and add the
			 * appropriate tokens. However, `Prism.languages.markup` is a regular JavaScript object literal, so if you do
			 * this:
			 *
			 * ```js
			 * Prism.languages.markup.style = {
			 *     // token
			 * };
			 * ```
			 *
			 * then the `style` token will be added (and processed) at the end. `insertBefore` allows you to insert tokens
			 * before existing tokens. For the CSS example above, you would use it like this:
			 *
			 * ```js
			 * Prism.languages.insertBefore('markup', 'cdata', {
			 *     'style': {
			 *         // token
			 *     }
			 * });
			 * ```
			 *
			 * ## Special cases
			 *
			 * If the grammars of `inside` and `insert` have tokens with the same name, the tokens in `inside`'s grammar
			 * will be ignored.
			 *
			 * This behavior can be used to insert tokens after `before`:
			 *
			 * ```js
			 * Prism.languages.insertBefore('markup', 'comment', {
			 *     'comment': Prism.languages.markup.comment,
			 *     // tokens after 'comment'
			 * });
			 * ```
			 *
			 * ## Limitations
			 *
			 * The main problem `insertBefore` has to solve is iteration order. Since ES2015, the iteration order for object
			 * properties is guaranteed to be the insertion order (except for integer keys) but some browsers behave
			 * differently when keys are deleted and re-inserted. So `insertBefore` can't be implemented by temporarily
			 * deleting properties which is necessary to insert at arbitrary positions.
			 *
			 * To solve this problem, `insertBefore` doesn't actually insert the given tokens into the target object.
			 * Instead, it will create a new object and replace all references to the target object with the new one. This
			 * can be done without temporarily deleting properties, so the iteration order is well-defined.
			 *
			 * However, only references that can be reached from `Prism.languages` or `insert` will be replaced. I.e. if
			 * you hold the target object in a variable, then the value of the variable will not change.
			 *
			 * ```js
			 * var oldMarkup = Prism.languages.markup;
			 * var newMarkup = Prism.languages.insertBefore('markup', 'comment', { ... });
			 *
			 * assert(oldMarkup !== Prism.languages.markup);
			 * assert(newMarkup === Prism.languages.markup);
			 * ```
			 *
			 * @param {string} inside The property of `root` (e.g. a language id in `Prism.languages`) that contains the
			 * object to be modified.
			 * @param {string} before The key to insert before.
			 * @param {Grammar} insert An object containing the key-value pairs to be inserted.
			 * @param {Object<string, any>} [root] The object containing `inside`, i.e. the object that contains the
			 * object to be modified.
			 *
			 * Defaults to `Prism.languages`.
			 * @returns {Grammar} The new grammar object.
			 * @public
			 */
			insertBefore: function (inside, before, insert, root) {
				root = root || /** @type {any} */ (_.languages);
				var grammar = root[inside];
				/** @type {Grammar} */
				var ret = {};

				for (var token in grammar) {
					if (grammar.hasOwnProperty(token)) {

						if (token == before) {
							for (var newToken in insert) {
								if (insert.hasOwnProperty(newToken)) {
									ret[newToken] = insert[newToken];
								}
							}
						}

						// Do not insert token which also occur in insert. See #1525
						if (!insert.hasOwnProperty(token)) {
							ret[token] = grammar[token];
						}
					}
				}

				var old = root[inside];
				root[inside] = ret;

				// Update references in other language definitions
				_.languages.DFS(_.languages, function (key, value) {
					if (value === old && key != inside) {
						this[key] = ret;
					}
				});

				return ret;
			},

			// Traverse a language definition with Depth First Search
			DFS: function DFS(o, callback, type, visited) {
				visited = visited || {};

				var objId = _.util.objId;

				for (var i in o) {
					if (o.hasOwnProperty(i)) {
						callback.call(o, i, o[i], type || i);

						var property = o[i];
						var propertyType = _.util.type(property);

						if (propertyType === 'Object' && !visited[objId(property)]) {
							visited[objId(property)] = true;
							DFS(property, callback, null, visited);
						} else if (propertyType === 'Array' && !visited[objId(property)]) {
							visited[objId(property)] = true;
							DFS(property, callback, i, visited);
						}
					}
				}
			}
		},

		plugins: {},

		/**
		 * This is the most high-level function in Prism’s API.
		 * It fetches all the elements that have a `.language-xxxx` class and then calls {@link Prism.highlightElement} on
		 * each one of them.
		 *
		 * This is equivalent to `Prism.highlightAllUnder(document, async, callback)`.
		 *
		 * @param {boolean} [async=false] Same as in {@link Prism.highlightAllUnder}.
		 * @param {HighlightCallback} [callback] Same as in {@link Prism.highlightAllUnder}.
		 * @memberof Prism
		 * @public
		 */
		highlightAll: function (async, callback) {
			_.highlightAllUnder(document, async, callback);
		},

		/**
		 * Fetches all the descendants of `container` that have a `.language-xxxx` class and then calls
		 * {@link Prism.highlightElement} on each one of them.
		 *
		 * The following hooks will be run:
		 * 1. `before-highlightall`
		 * 2. `before-all-elements-highlight`
		 * 3. All hooks of {@link Prism.highlightElement} for each element.
		 *
		 * @param {ParentNode} container The root element, whose descendants that have a `.language-xxxx` class will be highlighted.
		 * @param {boolean} [async=false] Whether each element is to be highlighted asynchronously using Web Workers.
		 * @param {HighlightCallback} [callback] An optional callback to be invoked on each element after its highlighting is done.
		 * @memberof Prism
		 * @public
		 */
		highlightAllUnder: function (container, async, callback) {
			var env = {
				callback: callback,
				container: container,
				selector: 'code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'
			};

			_.hooks.run('before-highlightall', env);

			env.elements = Array.prototype.slice.apply(env.container.querySelectorAll(env.selector));

			_.hooks.run('before-all-elements-highlight', env);

			for (var i = 0, element; (element = env.elements[i++]);) {
				_.highlightElement(element, async === true, env.callback);
			}
		},

		/**
		 * Highlights the code inside a single element.
		 *
		 * The following hooks will be run:
		 * 1. `before-sanity-check`
		 * 2. `before-highlight`
		 * 3. All hooks of {@link Prism.highlight}. These hooks will be run by an asynchronous worker if `async` is `true`.
		 * 4. `before-insert`
		 * 5. `after-highlight`
		 * 6. `complete`
		 *
		 * Some the above hooks will be skipped if the element doesn't contain any text or there is no grammar loaded for
		 * the element's language.
		 *
		 * @param {Element} element The element containing the code.
		 * It must have a class of `language-xxxx` to be processed, where `xxxx` is a valid language identifier.
		 * @param {boolean} [async=false] Whether the element is to be highlighted asynchronously using Web Workers
		 * to improve performance and avoid blocking the UI when highlighting very large chunks of code. This option is
		 * [disabled by default](https://prismjs.com/faq.html#why-is-asynchronous-highlighting-disabled-by-default).
		 *
		 * Note: All language definitions required to highlight the code must be included in the main `prism.js` file for
		 * asynchronous highlighting to work. You can build your own bundle on the
		 * [Download page](https://prismjs.com/download.html).
		 * @param {HighlightCallback} [callback] An optional callback to be invoked after the highlighting is done.
		 * Mostly useful when `async` is `true`, since in that case, the highlighting is done asynchronously.
		 * @memberof Prism
		 * @public
		 */
		highlightElement: function (element, async, callback) {
			// Find language
			var language = _.util.getLanguage(element);
			var grammar = _.languages[language];

			// Set language on the element, if not present
			_.util.setLanguage(element, language);

			// Set language on the parent, for styling
			var parent = element.parentElement;
			if (parent && parent.nodeName.toLowerCase() === 'pre') {
				_.util.setLanguage(parent, language);
			}

			var code = element.textContent;

			var env = {
				element: element,
				language: language,
				grammar: grammar,
				code: code
			};

			function insertHighlightedCode(highlightedCode) {
				env.highlightedCode = highlightedCode;

				_.hooks.run('before-insert', env);

				env.element.innerHTML = env.highlightedCode;

				_.hooks.run('after-highlight', env);
				_.hooks.run('complete', env);
				callback && callback.call(env.element);
			}

			_.hooks.run('before-sanity-check', env);

			// plugins may change/add the parent/element
			parent = env.element.parentElement;
			if (parent && parent.nodeName.toLowerCase() === 'pre' && !parent.hasAttribute('tabindex')) {
				parent.setAttribute('tabindex', '0');
			}

			if (!env.code) {
				_.hooks.run('complete', env);
				callback && callback.call(env.element);
				return;
			}

			_.hooks.run('before-highlight', env);

			if (!env.grammar) {
				insertHighlightedCode(_.util.encode(env.code));
				return;
			}

			if (async && _self.Worker) {
				var worker = new Worker(_.filename);

				worker.onmessage = function (evt) {
					insertHighlightedCode(evt.data);
				};

				worker.postMessage(JSON.stringify({
					language: env.language,
					code: env.code,
					immediateClose: true
				}));
			} else {
				insertHighlightedCode(_.highlight(env.code, env.grammar, env.language));
			}
		},

		/**
		 * Low-level function, only use if you know what you’re doing. It accepts a string of text as input
		 * and the language definitions to use, and returns a string with the HTML produced.
		 *
		 * The following hooks will be run:
		 * 1. `before-tokenize`
		 * 2. `after-tokenize`
		 * 3. `wrap`: On each {@link Token}.
		 *
		 * @param {string} text A string with the code to be highlighted.
		 * @param {Grammar} grammar An object containing the tokens to use.
		 *
		 * Usually a language definition like `Prism.languages.markup`.
		 * @param {string} language The name of the language definition passed to `grammar`.
		 * @returns {string} The highlighted HTML.
		 * @memberof Prism
		 * @public
		 * @example
		 * Prism.highlight('var foo = true;', Prism.languages.javascript, 'javascript');
		 */
		highlight: function (text, grammar, language) {
			var env = {
				code: text,
				grammar: grammar,
				language: language
			};
			_.hooks.run('before-tokenize', env);
			if (!env.grammar) {
				throw new Error('The language "' + env.language + '" has no grammar.');
			}
			env.tokens = _.tokenize(env.code, env.grammar);
			_.hooks.run('after-tokenize', env);
			return Token.stringify(_.util.encode(env.tokens), env.language);
		},

		/**
		 * This is the heart of Prism, and the most low-level function you can use. It accepts a string of text as input
		 * and the language definitions to use, and returns an array with the tokenized code.
		 *
		 * When the language definition includes nested tokens, the function is called recursively on each of these tokens.
		 *
		 * This method could be useful in other contexts as well, as a very crude parser.
		 *
		 * @param {string} text A string with the code to be highlighted.
		 * @param {Grammar} grammar An object containing the tokens to use.
		 *
		 * Usually a language definition like `Prism.languages.markup`.
		 * @returns {TokenStream} An array of strings and tokens, a token stream.
		 * @memberof Prism
		 * @public
		 * @example
		 * let code = `var foo = 0;`;
		 * let tokens = Prism.tokenize(code, Prism.languages.javascript);
		 * tokens.forEach(token => {
		 *     if (token instanceof Prism.Token && token.type === 'number') {
		 *         console.log(`Found numeric literal: ${token.content}`);
		 *     }
		 * });
		 */
		tokenize: function (text, grammar) {
			var rest = grammar.rest;
			if (rest) {
				for (var token in rest) {
					grammar[token] = rest[token];
				}

				delete grammar.rest;
			}

			var tokenList = new LinkedList();
			addAfter(tokenList, tokenList.head, text);

			matchGrammar(text, tokenList, grammar, tokenList.head, 0);

			return toArray(tokenList);
		},

		/**
		 * @namespace
		 * @memberof Prism
		 * @public
		 */
		hooks: {
			all: {},

			/**
			 * Adds the given callback to the list of callbacks for the given hook.
			 *
			 * The callback will be invoked when the hook it is registered for is run.
			 * Hooks are usually directly run by a highlight function but you can also run hooks yourself.
			 *
			 * One callback function can be registered to multiple hooks and the same hook multiple times.
			 *
			 * @param {string} name The name of the hook.
			 * @param {HookCallback} callback The callback function which is given environment variables.
			 * @public
			 */
			add: function (name, callback) {
				var hooks = _.hooks.all;

				hooks[name] = hooks[name] || [];

				hooks[name].push(callback);
			},

			/**
			 * Runs a hook invoking all registered callbacks with the given environment variables.
			 *
			 * Callbacks will be invoked synchronously and in the order in which they were registered.
			 *
			 * @param {string} name The name of the hook.
			 * @param {Object<string, any>} env The environment variables of the hook passed to all callbacks registered.
			 * @public
			 */
			run: function (name, env) {
				var callbacks = _.hooks.all[name];

				if (!callbacks || !callbacks.length) {
					return;
				}

				for (var i = 0, callback; (callback = callbacks[i++]);) {
					callback(env);
				}
			}
		},

		Token: Token
	};
	_self.Prism = _;


	// Typescript note:
	// The following can be used to import the Token type in JSDoc:
	//
	//   @typedef {InstanceType<import("./prism-core")["Token"]>} Token

	/**
	 * Creates a new token.
	 *
	 * @param {string} type See {@link Token#type type}
	 * @param {string | TokenStream} content See {@link Token#content content}
	 * @param {string|string[]} [alias] The alias(es) of the token.
	 * @param {string} [matchedStr=""] A copy of the full string this token was created from.
	 * @class
	 * @global
	 * @public
	 */
	function Token(type, content, alias, matchedStr) {
		/**
		 * The type of the token.
		 *
		 * This is usually the key of a pattern in a {@link Grammar}.
		 *
		 * @type {string}
		 * @see GrammarToken
		 * @public
		 */
		this.type = type;
		/**
		 * The strings or tokens contained by this token.
		 *
		 * This will be a token stream if the pattern matched also defined an `inside` grammar.
		 *
		 * @type {string | TokenStream}
		 * @public
		 */
		this.content = content;
		/**
		 * The alias(es) of the token.
		 *
		 * @type {string|string[]}
		 * @see GrammarToken
		 * @public
		 */
		this.alias = alias;
		// Copy of the full string this token was created from
		this.length = (matchedStr || '').length | 0;
	}

	/**
	 * A token stream is an array of strings and {@link Token Token} objects.
	 *
	 * Token streams have to fulfill a few properties that are assumed by most functions (mostly internal ones) that process
	 * them.
	 *
	 * 1. No adjacent strings.
	 * 2. No empty strings.
	 *
	 *    The only exception here is the token stream that only contains the empty string and nothing else.
	 *
	 * @typedef {Array<string | Token>} TokenStream
	 * @global
	 * @public
	 */

	/**
	 * Converts the given token or token stream to an HTML representation.
	 *
	 * The following hooks will be run:
	 * 1. `wrap`: On each {@link Token}.
	 *
	 * @param {string | Token | TokenStream} o The token or token stream to be converted.
	 * @param {string} language The name of current language.
	 * @returns {string} The HTML representation of the token or token stream.
	 * @memberof Token
	 * @static
	 */
	Token.stringify = function stringify(o, language) {
		if (typeof o == 'string') {
			return o;
		}
		if (Array.isArray(o)) {
			var s = '';
			o.forEach(function (e) {
				s += stringify(e, language);
			});
			return s;
		}

		var env = {
			type: o.type,
			content: stringify(o.content, language),
			tag: 'span',
			classes: ['token', o.type],
			attributes: {},
			language: language
		};

		var aliases = o.alias;
		if (aliases) {
			if (Array.isArray(aliases)) {
				Array.prototype.push.apply(env.classes, aliases);
			} else {
				env.classes.push(aliases);
			}
		}

		_.hooks.run('wrap', env);

		var attributes = '';
		for (var name in env.attributes) {
			attributes += ' ' + name + '="' + (env.attributes[name] || '').replace(/"/g, '&quot;') + '"';
		}

		return '<' + env.tag + ' class="' + env.classes.join(' ') + '"' + attributes + '>' + env.content + '</' + env.tag + '>';
	};

	/**
	 * @param {RegExp} pattern
	 * @param {number} pos
	 * @param {string} text
	 * @param {boolean} lookbehind
	 * @returns {RegExpExecArray | null}
	 */
	function matchPattern(pattern, pos, text, lookbehind) {
		pattern.lastIndex = pos;
		var match = pattern.exec(text);
		if (match && lookbehind && match[1]) {
			// change the match to remove the text matched by the Prism lookbehind group
			var lookbehindLength = match[1].length;
			match.index += lookbehindLength;
			match[0] = match[0].slice(lookbehindLength);
		}
		return match;
	}

	/**
	 * @param {string} text
	 * @param {LinkedList<string | Token>} tokenList
	 * @param {any} grammar
	 * @param {LinkedListNode<string | Token>} startNode
	 * @param {number} startPos
	 * @param {RematchOptions} [rematch]
	 * @returns {void}
	 * @private
	 *
	 * @typedef RematchOptions
	 * @property {string} cause
	 * @property {number} reach
	 */
	function matchGrammar(text, tokenList, grammar, startNode, startPos, rematch) {
		for (var token in grammar) {
			if (!grammar.hasOwnProperty(token) || !grammar[token]) {
				continue;
			}

			var patterns = grammar[token];
			patterns = Array.isArray(patterns) ? patterns : [patterns];

			for (var j = 0; j < patterns.length; ++j) {
				if (rematch && rematch.cause == token + ',' + j) {
					return;
				}

				var patternObj = patterns[j];
				var inside = patternObj.inside;
				var lookbehind = !!patternObj.lookbehind;
				var greedy = !!patternObj.greedy;
				var alias = patternObj.alias;

				if (greedy && !patternObj.pattern.global) {
					// Without the global flag, lastIndex won't work
					var flags = patternObj.pattern.toString().match(/[imsuy]*$/)[0];
					patternObj.pattern = RegExp(patternObj.pattern.source, flags + 'g');
				}

				/** @type {RegExp} */
				var pattern = patternObj.pattern || patternObj;

				for ( // iterate the token list and keep track of the current token/string position
					var currentNode = startNode.next, pos = startPos;
					currentNode !== tokenList.tail;
					pos += currentNode.value.length, currentNode = currentNode.next
				) {

					if (rematch && pos >= rematch.reach) {
						break;
					}

					var str = currentNode.value;

					if (tokenList.length > text.length) {
						// Something went terribly wrong, ABORT, ABORT!
						return;
					}

					if (str instanceof Token) {
						continue;
					}

					var removeCount = 1; // this is the to parameter of removeBetween
					var match;

					if (greedy) {
						match = matchPattern(pattern, pos, text, lookbehind);
						if (!match || match.index >= text.length) {
							break;
						}

						var from = match.index;
						var to = match.index + match[0].length;
						var p = pos;

						// find the node that contains the match
						p += currentNode.value.length;
						while (from >= p) {
							currentNode = currentNode.next;
							p += currentNode.value.length;
						}
						// adjust pos (and p)
						p -= currentNode.value.length;
						pos = p;

						// the current node is a Token, then the match starts inside another Token, which is invalid
						if (currentNode.value instanceof Token) {
							continue;
						}

						// find the last node which is affected by this match
						for (
							var k = currentNode;
							k !== tokenList.tail && (p < to || typeof k.value === 'string');
							k = k.next
						) {
							removeCount++;
							p += k.value.length;
						}
						removeCount--;

						// replace with the new match
						str = text.slice(pos, p);
						match.index -= pos;
					} else {
						match = matchPattern(pattern, 0, str, lookbehind);
						if (!match) {
							continue;
						}
					}

					// eslint-disable-next-line no-redeclare
					var from = match.index;
					var matchStr = match[0];
					var before = str.slice(0, from);
					var after = str.slice(from + matchStr.length);

					var reach = pos + str.length;
					if (rematch && reach > rematch.reach) {
						rematch.reach = reach;
					}

					var removeFrom = currentNode.prev;

					if (before) {
						removeFrom = addAfter(tokenList, removeFrom, before);
						pos += before.length;
					}

					removeRange(tokenList, removeFrom, removeCount);

					var wrapped = new Token(token, inside ? _.tokenize(matchStr, inside) : matchStr, alias, matchStr);
					currentNode = addAfter(tokenList, removeFrom, wrapped);

					if (after) {
						addAfter(tokenList, currentNode, after);
					}

					if (removeCount > 1) {
						// at least one Token object was removed, so we have to do some rematching
						// this can only happen if the current pattern is greedy

						/** @type {RematchOptions} */
						var nestedRematch = {
							cause: token + ',' + j,
							reach: reach
						};
						matchGrammar(text, tokenList, grammar, currentNode.prev, pos, nestedRematch);

						// the reach might have been extended because of the rematching
						if (rematch && nestedRematch.reach > rematch.reach) {
							rematch.reach = nestedRematch.reach;
						}
					}
				}
			}
		}
	}

	/**
	 * @typedef LinkedListNode
	 * @property {T} value
	 * @property {LinkedListNode<T> | null} prev The previous node.
	 * @property {LinkedListNode<T> | null} next The next node.
	 * @template T
	 * @private
	 */

	/**
	 * @template T
	 * @private
	 */
	function LinkedList() {
		/** @type {LinkedListNode<T>} */
		var head = { value: null, prev: null, next: null };
		/** @type {LinkedListNode<T>} */
		var tail = { value: null, prev: head, next: null };
		head.next = tail;

		/** @type {LinkedListNode<T>} */
		this.head = head;
		/** @type {LinkedListNode<T>} */
		this.tail = tail;
		this.length = 0;
	}

	/**
	 * Adds a new node with the given value to the list.
	 *
	 * @param {LinkedList<T>} list
	 * @param {LinkedListNode<T>} node
	 * @param {T} value
	 * @returns {LinkedListNode<T>} The added node.
	 * @template T
	 */
	function addAfter(list, node, value) {
		// assumes that node != list.tail && values.length >= 0
		var next = node.next;

		var newNode = { value: value, prev: node, next: next };
		node.next = newNode;
		next.prev = newNode;
		list.length++;

		return newNode;
	}
	/**
	 * Removes `count` nodes after the given node. The given node will not be removed.
	 *
	 * @param {LinkedList<T>} list
	 * @param {LinkedListNode<T>} node
	 * @param {number} count
	 * @template T
	 */
	function removeRange(list, node, count) {
		var next = node.next;
		for (var i = 0; i < count && next !== list.tail; i++) {
			next = next.next;
		}
		node.next = next;
		next.prev = node;
		list.length -= i;
	}
	/**
	 * @param {LinkedList<T>} list
	 * @returns {T[]}
	 * @template T
	 */
	function toArray(list) {
		var array = [];
		var node = list.head.next;
		while (node !== list.tail) {
			array.push(node.value);
			node = node.next;
		}
		return array;
	}


	if (!_self.document) {
		if (!_self.addEventListener) {
			// in Node.js
			return _;
		}

		if (!_.disableWorkerMessageHandler) {
			// In worker
			_self.addEventListener('message', function (evt) {
				var message = JSON.parse(evt.data);
				var lang = message.language;
				var code = message.code;
				var immediateClose = message.immediateClose;

				_self.postMessage(_.highlight(code, _.languages[lang], lang));
				if (immediateClose) {
					_self.close();
				}
			}, false);
		}

		return _;
	}

	// Get current script and highlight
	var script = _.util.currentScript();

	if (script) {
		_.filename = script.src;

		if (script.hasAttribute('data-manual')) {
			_.manual = true;
		}
	}

	function highlightAutomaticallyCallback() {
		if (!_.manual) {
			_.highlightAll();
		}
	}

	if (!_.manual) {
		// If the document state is "loading", then we'll use DOMContentLoaded.
		// If the document state is "interactive" and the prism.js script is deferred, then we'll also use the
		// DOMContentLoaded event because there might be some plugins or languages which have also been deferred and they
		// might take longer one animation frame to execute which can create a race condition where only some plugins have
		// been loaded when Prism.highlightAll() is executed, depending on how fast resources are loaded.
		// See https://github.com/PrismJS/prism/issues/2102
		var readyState = document.readyState;
		if (readyState === 'loading' || readyState === 'interactive' && script && script.defer) {
			document.addEventListener('DOMContentLoaded', highlightAutomaticallyCallback);
		} else {
			if (window.requestAnimationFrame) {
				window.requestAnimationFrame(highlightAutomaticallyCallback);
			} else {
				window.setTimeout(highlightAutomaticallyCallback, 16);
			}
		}
	}

	return _;

}(_self));

if (typeof module !== 'undefined' && module.exports) {
	module.exports = Prism;
}

// hack for components to work correctly in node.js
if (typeof global !== 'undefined') {
	global.Prism = Prism;
}

// some additional documentation/types

/**
 * The expansion of a simple `RegExp` literal to support additional properties.
 *
 * @typedef GrammarToken
 * @property {RegExp} pattern The regular expression of the token.
 * @property {boolean} [lookbehind=false] If `true`, then the first capturing group of `pattern` will (effectively)
 * behave as a lookbehind group meaning that the captured text will not be part of the matched text of the new token.
 * @property {boolean} [greedy=false] Whether the token is greedy.
 * @property {string|string[]} [alias] An optional alias or list of aliases.
 * @property {Grammar} [inside] The nested grammar of this token.
 *
 * The `inside` grammar will be used to tokenize the text value of each token of this kind.
 *
 * This can be used to make nested and even recursive language definitions.
 *
 * Note: This can cause infinite recursion. Be careful when you embed different languages or even the same language into
 * each another.
 * @global
 * @public
 */

/**
 * @typedef Grammar
 * @type {Object<string, RegExp | GrammarToken | Array<RegExp | GrammarToken>>}
 * @property {Grammar} [rest] An optional grammar object that will be appended to this grammar.
 * @global
 * @public
 */

/**
 * A function which will invoked after an element was successfully highlighted.
 *
 * @callback HighlightCallback
 * @param {Element} element The element successfully highlighted.
 * @returns {void}
 * @global
 * @public
 */

/**
 * @callback HookCallback
 * @param {Object<string, any>} env The environment variables of the hook.
 * @returns {void}
 * @global
 * @public
 */


/* **********************************************
     Begin prism-markup.js
********************************************** */

Prism.languages.markup = {
	'comment': {
		pattern: /<!--(?:(?!<!--)[\s\S])*?-->/,
		greedy: true
	},
	'prolog': {
		pattern: /<\?[\s\S]+?\?>/,
		greedy: true
	},
	'doctype': {
		// https://www.w3.org/TR/xml/#NT-doctypedecl
		pattern: /<!DOCTYPE(?:[^>"'[\]]|"[^"]*"|'[^']*')+(?:\[(?:[^<"'\]]|"[^"]*"|'[^']*'|<(?!!--)|<!--(?:[^-]|-(?!->))*-->)*\]\s*)?>/i,
		greedy: true,
		inside: {
			'internal-subset': {
				pattern: /(^[^\[]*\[)[\s\S]+(?=\]>$)/,
				lookbehind: true,
				greedy: true,
				inside: null // see below
			},
			'string': {
				pattern: /"[^"]*"|'[^']*'/,
				greedy: true
			},
			'punctuation': /^<!|>$|[[\]]/,
			'doctype-tag': /^DOCTYPE/i,
			'name': /[^\s<>'"]+/
		}
	},
	'cdata': {
		pattern: /<!\[CDATA\[[\s\S]*?\]\]>/i,
		greedy: true
	},
	'tag': {
		pattern: /<\/?(?!\d)[^\s>\/=$<%]+(?:\s(?:\s*[^\s>\/=]+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s'">=]+(?=[\s>]))|(?=[\s/>])))+)?\s*\/?>/,
		greedy: true,
		inside: {
			'tag': {
				pattern: /^<\/?[^\s>\/]+/,
				inside: {
					'punctuation': /^<\/?/,
					'namespace': /^[^\s>\/:]+:/
				}
			},
			'special-attr': [],
			'attr-value': {
				pattern: /=\s*(?:"[^"]*"|'[^']*'|[^\s'">=]+)/,
				inside: {
					'punctuation': [
						{
							pattern: /^=/,
							alias: 'attr-equals'
						},
						{
							pattern: /^(\s*)["']|["']$/,
							lookbehind: true
						}
					]
				}
			},
			'punctuation': /\/?>/,
			'attr-name': {
				pattern: /[^\s>\/]+/,
				inside: {
					'namespace': /^[^\s>\/:]+:/
				}
			}

		}
	},
	'entity': [
		{
			pattern: /&[\da-z]{1,8};/i,
			alias: 'named-entity'
		},
		/&#x?[\da-f]{1,8};/i
	]
};

Prism.languages.markup['tag'].inside['attr-value'].inside['entity'] =
	Prism.languages.markup['entity'];
Prism.languages.markup['doctype'].inside['internal-subset'].inside = Prism.languages.markup;

// Plugin to make entity title show the real entity, idea by Roman Komarov
Prism.hooks.add('wrap', function (env) {

	if (env.type === 'entity') {
		env.attributes['title'] = env.content.replace(/&amp;/, '&');
	}
});

Object.defineProperty(Prism.languages.markup.tag, 'addInlined', {
	/**
	 * Adds an inlined language to markup.
	 *
	 * An example of an inlined language is CSS with `<style>` tags.
	 *
	 * @param {string} tagName The name of the tag that contains the inlined language. This name will be treated as
	 * case insensitive.
	 * @param {string} lang The language key.
	 * @example
	 * addInlined('style', 'css');
	 */
	value: function addInlined(tagName, lang) {
		var includedCdataInside = {};
		includedCdataInside['language-' + lang] = {
			pattern: /(^<!\[CDATA\[)[\s\S]+?(?=\]\]>$)/i,
			lookbehind: true,
			inside: Prism.languages[lang]
		};
		includedCdataInside['cdata'] = /^<!\[CDATA\[|\]\]>$/i;

		var inside = {
			'included-cdata': {
				pattern: /<!\[CDATA\[[\s\S]*?\]\]>/i,
				inside: includedCdataInside
			}
		};
		inside['language-' + lang] = {
			pattern: /[\s\S]+/,
			inside: Prism.languages[lang]
		};

		var def = {};
		def[tagName] = {
			pattern: RegExp(/(<__[^>]*>)(?:<!\[CDATA\[(?:[^\]]|\](?!\]>))*\]\]>|(?!<!\[CDATA\[)[\s\S])*?(?=<\/__>)/.source.replace(/__/g, function () { return tagName; }), 'i'),
			lookbehind: true,
			greedy: true,
			inside: inside
		};

		Prism.languages.insertBefore('markup', 'cdata', def);
	}
});
Object.defineProperty(Prism.languages.markup.tag, 'addAttribute', {
	/**
	 * Adds an pattern to highlight languages embedded in HTML attributes.
	 *
	 * An example of an inlined language is CSS with `style` attributes.
	 *
	 * @param {string} attrName The name of the tag that contains the inlined language. This name will be treated as
	 * case insensitive.
	 * @param {string} lang The language key.
	 * @example
	 * addAttribute('style', 'css');
	 */
	value: function (attrName, lang) {
		Prism.languages.markup.tag.inside['special-attr'].push({
			pattern: RegExp(
				/(^|["'\s])/.source + '(?:' + attrName + ')' + /\s*=\s*(?:"[^"]*"|'[^']*'|[^\s'">=]+(?=[\s>]))/.source,
				'i'
			),
			lookbehind: true,
			inside: {
				'attr-name': /^[^\s=]+/,
				'attr-value': {
					pattern: /=[\s\S]+/,
					inside: {
						'value': {
							pattern: /(^=\s*(["']|(?!["'])))\S[\s\S]*(?=\2$)/,
							lookbehind: true,
							alias: [lang, 'language-' + lang],
							inside: Prism.languages[lang]
						},
						'punctuation': [
							{
								pattern: /^=/,
								alias: 'attr-equals'
							},
							/"|'/
						]
					}
				}
			}
		});
	}
});

Prism.languages.html = Prism.languages.markup;
Prism.languages.mathml = Prism.languages.markup;
Prism.languages.svg = Prism.languages.markup;

Prism.languages.xml = Prism.languages.extend('markup', {});
Prism.languages.ssml = Prism.languages.xml;
Prism.languages.atom = Prism.languages.xml;
Prism.languages.rss = Prism.languages.xml;


/* **********************************************
     Begin prism-css.js
********************************************** */

(function (Prism) {

	var string = /(?:"(?:\\(?:\r\n|[\s\S])|[^"\\\r\n])*"|'(?:\\(?:\r\n|[\s\S])|[^'\\\r\n])*')/;

	Prism.languages.css = {
		'comment': /\/\*[\s\S]*?\*\//,
		'atrule': {
			pattern: RegExp('@[\\w-](?:' + /[^;{\s"']|\s+(?!\s)/.source + '|' + string.source + ')*?' + /(?:;|(?=\s*\{))/.source),
			inside: {
				'rule': /^@[\w-]+/,
				'selector-function-argument': {
					pattern: /(\bselector\s*\(\s*(?![\s)]))(?:[^()\s]|\s+(?![\s)])|\((?:[^()]|\([^()]*\))*\))+(?=\s*\))/,
					lookbehind: true,
					alias: 'selector'
				},
				'keyword': {
					pattern: /(^|[^\w-])(?:and|not|only|or)(?![\w-])/,
					lookbehind: true
				}
				// See rest below
			}
		},
		'url': {
			// https://drafts.csswg.org/css-values-3/#urls
			pattern: RegExp('\\burl\\((?:' + string.source + '|' + /(?:[^\\\r\n()"']|\\[\s\S])*/.source + ')\\)', 'i'),
			greedy: true,
			inside: {
				'function': /^url/i,
				'punctuation': /^\(|\)$/,
				'string': {
					pattern: RegExp('^' + string.source + '$'),
					alias: 'url'
				}
			}
		},
		'selector': {
			pattern: RegExp('(^|[{}\\s])[^{}\\s](?:[^{};"\'\\s]|\\s+(?![\\s{])|' + string.source + ')*(?=\\s*\\{)'),
			lookbehind: true
		},
		'string': {
			pattern: string,
			greedy: true
		},
		'property': {
			pattern: /(^|[^-\w\xA0-\uFFFF])(?!\s)[-_a-z\xA0-\uFFFF](?:(?!\s)[-\w\xA0-\uFFFF])*(?=\s*:)/i,
			lookbehind: true
		},
		'important': /!important\b/i,
		'function': {
			pattern: /(^|[^-a-z0-9])[-a-z0-9]+(?=\()/i,
			lookbehind: true
		},
		'punctuation': /[(){};:,]/
	};

	Prism.languages.css['atrule'].inside.rest = Prism.languages.css;

	var markup = Prism.languages.markup;
	if (markup) {
		markup.tag.addInlined('style', 'css');
		markup.tag.addAttribute('style', 'css');
	}

}(Prism));


/* **********************************************
     Begin prism-clike.js
********************************************** */

Prism.languages.clike = {
	'comment': [
		{
			pattern: /(^|[^\\])\/\*[\s\S]*?(?:\*\/|$)/,
			lookbehind: true,
			greedy: true
		},
		{
			pattern: /(^|[^\\:])\/\/.*/,
			lookbehind: true,
			greedy: true
		}
	],
	'string': {
		pattern: /(["'])(?:\\(?:\r\n|[\s\S])|(?!\1)[^\\\r\n])*\1/,
		greedy: true
	},
	'class-name': {
		pattern: /(\b(?:class|extends|implements|instanceof|interface|new|trait)\s+|\bcatch\s+\()[\w.\\]+/i,
		lookbehind: true,
		inside: {
			'punctuation': /[.\\]/
		}
	},
	'keyword': /\b(?:break|catch|continue|do|else|finally|for|function|if|in|instanceof|new|null|return|throw|try|while)\b/,
	'boolean': /\b(?:false|true)\b/,
	'function': /\b\w+(?=\()/,
	'number': /\b0x[\da-f]+\b|(?:\b\d+(?:\.\d*)?|\B\.\d+)(?:e[+-]?\d+)?/i,
	'operator': /[<>]=?|[!=]=?=?|--?|\+\+?|&&?|\|\|?|[?*/~^%]/,
	'punctuation': /[{}[\];(),.:]/
};


/* **********************************************
     Begin prism-javascript.js
********************************************** */

Prism.languages.javascript = Prism.languages.extend('clike', {
	'class-name': [
		Prism.languages.clike['class-name'],
		{
			pattern: /(^|[^$\w\xA0-\uFFFF])(?!\s)[_$A-Z\xA0-\uFFFF](?:(?!\s)[$\w\xA0-\uFFFF])*(?=\.(?:constructor|prototype))/,
			lookbehind: true
		}
	],
	'keyword': [
		{
			pattern: /((?:^|\})\s*)catch\b/,
			lookbehind: true
		},
		{
			pattern: /(^|[^.]|\.\.\.\s*)\b(?:as|assert(?=\s*\{)|async(?=\s*(?:function\b|\(|[$\w\xA0-\uFFFF]|$))|await|break|case|class|const|continue|debugger|default|delete|do|else|enum|export|extends|finally(?=\s*(?:\{|$))|for|from(?=\s*(?:['"]|$))|function|(?:get|set)(?=\s*(?:[#\[$\w\xA0-\uFFFF]|$))|if|implements|import|in|instanceof|interface|let|new|null|of|package|private|protected|public|return|static|super|switch|this|throw|try|typeof|undefined|var|void|while|with|yield)\b/,
			lookbehind: true
		},
	],
	// Allow for all non-ASCII characters (See http://stackoverflow.com/a/2008444)
	'function': /#?(?!\s)[_$a-zA-Z\xA0-\uFFFF](?:(?!\s)[$\w\xA0-\uFFFF])*(?=\s*(?:\.\s*(?:apply|bind|call)\s*)?\()/,
	'number': {
		pattern: RegExp(
			/(^|[^\w$])/.source +
			'(?:' +
			(
				// constant
				/NaN|Infinity/.source +
				'|' +
				// binary integer
				/0[bB][01]+(?:_[01]+)*n?/.source +
				'|' +
				// octal integer
				/0[oO][0-7]+(?:_[0-7]+)*n?/.source +
				'|' +
				// hexadecimal integer
				/0[xX][\dA-Fa-f]+(?:_[\dA-Fa-f]+)*n?/.source +
				'|' +
				// decimal bigint
				/\d+(?:_\d+)*n/.source +
				'|' +
				// decimal number (integer or float) but no bigint
				/(?:\d+(?:_\d+)*(?:\.(?:\d+(?:_\d+)*)?)?|\.\d+(?:_\d+)*)(?:[Ee][+-]?\d+(?:_\d+)*)?/.source
			) +
			')' +
			/(?![\w$])/.source
		),
		lookbehind: true
	},
	'operator': /--|\+\+|\*\*=?|=>|&&=?|\|\|=?|[!=]==|<<=?|>>>?=?|[-+*/%&|^!=<>]=?|\.{3}|\?\?=?|\?\.?|[~:]/
});

Prism.languages.javascript['class-name'][0].pattern = /(\b(?:class|extends|implements|instanceof|interface|new)\s+)[\w.\\]+/;

Prism.languages.insertBefore('javascript', 'keyword', {
	'regex': {
		pattern: RegExp(
			// lookbehind
			// eslint-disable-next-line regexp/no-dupe-characters-character-class
			/((?:^|[^$\w\xA0-\uFFFF."'\])\s]|\b(?:return|yield))\s*)/.source +
			// Regex pattern:
			// There are 2 regex patterns here. The RegExp set notation proposal added support for nested character
			// classes if the `v` flag is present. Unfortunately, nested CCs are both context-free and incompatible
			// with the only syntax, so we have to define 2 different regex patterns.
			/\//.source +
			'(?:' +
			/(?:\[(?:[^\]\\\r\n]|\\.)*\]|\\.|[^/\\\[\r\n])+\/[dgimyus]{0,7}/.source +
			'|' +
			// `v` flag syntax. This supports 3 levels of nested character classes.
			/(?:\[(?:[^[\]\\\r\n]|\\.|\[(?:[^[\]\\\r\n]|\\.|\[(?:[^[\]\\\r\n]|\\.)*\])*\])*\]|\\.|[^/\\\[\r\n])+\/[dgimyus]{0,7}v[dgimyus]{0,7}/.source +
			')' +
			// lookahead
			/(?=(?:\s|\/\*(?:[^*]|\*(?!\/))*\*\/)*(?:$|[\r\n,.;:})\]]|\/\/))/.source
		),
		lookbehind: true,
		greedy: true,
		inside: {
			'regex-source': {
				pattern: /^(\/)[\s\S]+(?=\/[a-z]*$)/,
				lookbehind: true,
				alias: 'language-regex',
				inside: Prism.languages.regex
			},
			'regex-delimiter': /^\/|\/$/,
			'regex-flags': /^[a-z]+$/,
		}
	},
	// This must be declared before keyword because we use "function" inside the look-forward
	'function-variable': {
		pattern: /#?(?!\s)[_$a-zA-Z\xA0-\uFFFF](?:(?!\s)[$\w\xA0-\uFFFF])*(?=\s*[=:]\s*(?:async\s*)?(?:\bfunction\b|(?:\((?:[^()]|\([^()]*\))*\)|(?!\s)[_$a-zA-Z\xA0-\uFFFF](?:(?!\s)[$\w\xA0-\uFFFF])*)\s*=>))/,
		alias: 'function'
	},
	'parameter': [
		{
			pattern: /(function(?:\s+(?!\s)[_$a-zA-Z\xA0-\uFFFF](?:(?!\s)[$\w\xA0-\uFFFF])*)?\s*\(\s*)(?!\s)(?:[^()\s]|\s+(?![\s)])|\([^()]*\))+(?=\s*\))/,
			lookbehind: true,
			inside: Prism.languages.javascript
		},
		{
			pattern: /(^|[^$\w\xA0-\uFFFF])(?!\s)[_$a-z\xA0-\uFFFF](?:(?!\s)[$\w\xA0-\uFFFF])*(?=\s*=>)/i,
			lookbehind: true,
			inside: Prism.languages.javascript
		},
		{
			pattern: /(\(\s*)(?!\s)(?:[^()\s]|\s+(?![\s)])|\([^()]*\))+(?=\s*\)\s*=>)/,
			lookbehind: true,
			inside: Prism.languages.javascript
		},
		{
			pattern: /((?:\b|\s|^)(?!(?:as|async|await|break|case|catch|class|const|continue|debugger|default|delete|do|else|enum|export|extends|finally|for|from|function|get|if|implements|import|in|instanceof|interface|let|new|null|of|package|private|protected|public|return|set|static|super|switch|this|throw|try|typeof|undefined|var|void|while|with|yield)(?![$\w\xA0-\uFFFF]))(?:(?!\s)[_$a-zA-Z\xA0-\uFFFF](?:(?!\s)[$\w\xA0-\uFFFF])*\s*)\(\s*|\]\s*\(\s*)(?!\s)(?:[^()\s]|\s+(?![\s)])|\([^()]*\))+(?=\s*\)\s*\{)/,
			lookbehind: true,
			inside: Prism.languages.javascript
		}
	],
	'constant': /\b[A-Z](?:[A-Z_]|\dx?)*\b/
});

Prism.languages.insertBefore('javascript', 'string', {
	'hashbang': {
		pattern: /^#!.*/,
		greedy: true,
		alias: 'comment'
	},
	'template-string': {
		pattern: /`(?:\\[\s\S]|\$\{(?:[^{}]|\{(?:[^{}]|\{[^}]*\})*\})+\}|(?!\$\{)[^\\`])*`/,
		greedy: true,
		inside: {
			'template-punctuation': {
				pattern: /^`|`$/,
				alias: 'string'
			},
			'interpolation': {
				pattern: /((?:^|[^\\])(?:\\{2})*)\$\{(?:[^{}]|\{(?:[^{}]|\{[^}]*\})*\})+\}/,
				lookbehind: true,
				inside: {
					'interpolation-punctuation': {
						pattern: /^\$\{|\}$/,
						alias: 'punctuation'
					},
					rest: Prism.languages.javascript
				}
			},
			'string': /[\s\S]+/
		}
	},
	'string-property': {
		pattern: /((?:^|[,{])[ \t]*)(["'])(?:\\(?:\r\n|[\s\S])|(?!\2)[^\\\r\n])*\2(?=\s*:)/m,
		lookbehind: true,
		greedy: true,
		alias: 'property'
	}
});

Prism.languages.insertBefore('javascript', 'operator', {
	'literal-property': {
		pattern: /((?:^|[,{])[ \t]*)(?!\s)[_$a-zA-Z\xA0-\uFFFF](?:(?!\s)[$\w\xA0-\uFFFF])*(?=\s*:)/m,
		lookbehind: true,
		alias: 'property'
	},
});

if (Prism.languages.markup) {
	Prism.languages.markup.tag.addInlined('script', 'javascript');

	// add attribute support for all DOM events.
	// https://developer.mozilla.org/en-US/docs/Web/Events#Standard_events
	Prism.languages.markup.tag.addAttribute(
		/on(?:abort|blur|change|click|composition(?:end|start|update)|dblclick|error|focus(?:in|out)?|key(?:down|up)|load|mouse(?:down|enter|leave|move|out|over|up)|reset|resize|scroll|select|slotchange|submit|unload|wheel)/.source,
		'javascript'
	);
}

Prism.languages.js = Prism.languages.javascript;


/* **********************************************
     Begin prism-file-highlight.js
********************************************** */

(function () {

	if (typeof Prism === 'undefined' || typeof document === 'undefined') {
		return;
	}

	// https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#Polyfill
	if (!Element.prototype.matches) {
		Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
	}

	var LOADING_MESSAGE = 'Loading…';
	var FAILURE_MESSAGE = function (status, message) {
		return '✖ Error ' + status + ' while fetching file: ' + message;
	};
	var FAILURE_EMPTY_MESSAGE = '✖ Error: File does not exist or is empty';

	var EXTENSIONS = {
		'js': 'javascript',
		'py': 'python',
		'rb': 'ruby',
		'ps1': 'powershell',
		'psm1': 'powershell',
		'sh': 'bash',
		'bat': 'batch',
		'h': 'c',
		'tex': 'latex'
	};

	var STATUS_ATTR = 'data-src-status';
	var STATUS_LOADING = 'loading';
	var STATUS_LOADED = 'loaded';
	var STATUS_FAILED = 'failed';

	var SELECTOR = 'pre[data-src]:not([' + STATUS_ATTR + '="' + STATUS_LOADED + '"])'
		+ ':not([' + STATUS_ATTR + '="' + STATUS_LOADING + '"])';

	/**
	 * Loads the given file.
	 *
	 * @param {string} src The URL or path of the source file to load.
	 * @param {(result: string) => void} success
	 * @param {(reason: string) => void} error
	 */
	function loadFile(src, success, error) {
		var xhr = new XMLHttpRequest();
		xhr.open('GET', src, true);
		xhr.onreadystatechange = function () {
			if (xhr.readyState == 4) {
				if (xhr.status < 400 && xhr.responseText) {
					success(xhr.responseText);
				} else {
					if (xhr.status >= 400) {
						error(FAILURE_MESSAGE(xhr.status, xhr.statusText));
					} else {
						error(FAILURE_EMPTY_MESSAGE);
					}
				}
			}
		};
		xhr.send(null);
	}

	/**
	 * Parses the given range.
	 *
	 * This returns a range with inclusive ends.
	 *
	 * @param {string | null | undefined} range
	 * @returns {[number, number | undefined] | undefined}
	 */
	function parseRange(range) {
		var m = /^\s*(\d+)\s*(?:(,)\s*(?:(\d+)\s*)?)?$/.exec(range || '');
		if (m) {
			var start = Number(m[1]);
			var comma = m[2];
			var end = m[3];

			if (!comma) {
				return [start, start];
			}
			if (!end) {
				return [start, undefined];
			}
			return [start, Number(end)];
		}
		return undefined;
	}

	Prism.hooks.add('before-highlightall', function (env) {
		env.selector += ', ' + SELECTOR;
	});

	Prism.hooks.add('before-sanity-check', function (env) {
		var pre = /** @type {HTMLPreElement} */ (env.element);
		if (pre.matches(SELECTOR)) {
			env.code = ''; // fast-path the whole thing and go to complete

			pre.setAttribute(STATUS_ATTR, STATUS_LOADING); // mark as loading

			// add code element with loading message
			var code = pre.appendChild(document.createElement('CODE'));
			code.textContent = LOADING_MESSAGE;

			var src = pre.getAttribute('data-src');

			var language = env.language;
			if (language === 'none') {
				// the language might be 'none' because there is no language set;
				// in this case, we want to use the extension as the language
				var extension = (/\.(\w+)$/.exec(src) || [, 'none'])[1];
				language = EXTENSIONS[extension] || extension;
			}

			// set language classes
			Prism.util.setLanguage(code, language);
			Prism.util.setLanguage(pre, language);

			// preload the language
			var autoloader = Prism.plugins.autoloader;
			if (autoloader) {
				autoloader.loadLanguages(language);
			}

			// load file
			loadFile(
				src,
				function (text) {
					// mark as loaded
					pre.setAttribute(STATUS_ATTR, STATUS_LOADED);

					// handle data-range
					var range = parseRange(pre.getAttribute('data-range'));
					if (range) {
						var lines = text.split(/\r\n?|\n/g);

						// the range is one-based and inclusive on both ends
						var start = range[0];
						var end = range[1] == null ? lines.length : range[1];

						if (start < 0) { start += lines.length; }
						start = Math.max(0, Math.min(start - 1, lines.length));
						if (end < 0) { end += lines.length; }
						end = Math.max(0, Math.min(end, lines.length));

						text = lines.slice(start, end).join('\n');

						// add data-start for line numbers
						if (!pre.hasAttribute('data-start')) {
							pre.setAttribute('data-start', String(start + 1));
						}
					}

					// highlight code
					code.textContent = text;
					Prism.highlightElement(code);
				},
				function (error) {
					// mark as failed
					pre.setAttribute(STATUS_ATTR, STATUS_FAILED);

					code.textContent = error;
				}
			);
		}
	});

	Prism.plugins.fileHighlight = {
		/**
		 * Executes the File Highlight plugin for all matching `pre` elements under the given container.
		 *
		 * Note: Elements which are already loaded or currently loading will not be touched by this method.
		 *
		 * @param {ParentNode} [container=document]
		 */
		highlight: function highlight(container) {
			var elements = (container || document).querySelectorAll(SELECTOR);

			for (var i = 0, element; (element = elements[i++]);) {
				Prism.highlightElement(element);
			}
		}
	};

	var logged = false;
	/** @deprecated Use `Prism.plugins.fileHighlight.highlight` instead. */
	Prism.fileHighlight = function () {
		if (!logged) {
			console.warn('Prism.fileHighlight is deprecated. Use `Prism.plugins.fileHighlight.highlight` instead.');
			logged = true;
		}
		Prism.plugins.fileHighlight.highlight.apply(this, arguments);
	};

}());
</script>
  <script>!function(e){var n=/[*&][^\s[\]{},]+/,r=/!(?:<[\w\-%#;/?:@&=+$,.!~*'()[\]]+>|(?:[a-zA-Z\d-]*!)?[\w\-%#;/?:@&=+$.~*'()]+)?/,t="(?:"+r.source+"(?:[ \t]+"+n.source+")?|"+n.source+"(?:[ \t]+"+r.source+")?)",a="(?:[^\\s\\x00-\\x08\\x0e-\\x1f!\"#%&'*,\\-:>?@[\\]`{|}\\x7f-\\x84\\x86-\\x9f\\ud800-\\udfff\\ufffe\\uffff]|[?:-]<PLAIN>)(?:[ \t]*(?:(?![#:])<PLAIN>|:<PLAIN>))*".replace(/<PLAIN>/g,(function(){return"[^\\s\\x00-\\x08\\x0e-\\x1f,[\\]{}\\x7f-\\x84\\x86-\\x9f\\ud800-\\udfff\\ufffe\\uffff]"})),d="\"(?:[^\"\\\\\r\n]|\\\\.)*\"|'(?:[^'\\\\\r\n]|\\\\.)*'";function o(e,n){n=(n||"").replace(/m/g,"")+"m";var r="([:\\-,[{]\\s*(?:\\s<<prop>>[ \t]+)?)(?:<<value>>)(?=[ \t]*(?:$|,|\\]|\\}|(?:[\r\n]\\s*)?#))".replace(/<<prop>>/g,(function(){return t})).replace(/<<value>>/g,(function(){return e}));return RegExp(r,n)}e.languages.yaml={scalar:{pattern:RegExp("([\\-:]\\s*(?:\\s<<prop>>[ \t]+)?[|>])[ \t]*(?:((?:\r?\n|\r)[ \t]+)\\S[^\r\n]*(?:\\2[^\r\n]+)*)".replace(/<<prop>>/g,(function(){return t}))),lookbehind:!0,alias:"string"},comment:/#.*/,key:{pattern:RegExp("((?:^|[:\\-,[{\r\n?])[ \t]*(?:<<prop>>[ \t]+)?)<<key>>(?=\\s*:\\s)".replace(/<<prop>>/g,(function(){return t})).replace(/<<key>>/g,(function(){return"(?:"+a+"|"+d+")"}))),lookbehind:!0,greedy:!0,alias:"atrule"},directive:{pattern:/(^[ \t]*)%.+/m,lookbehind:!0,alias:"important"},datetime:{pattern:o("\\d{4}-\\d\\d?-\\d\\d?(?:[tT]|[ \t]+)\\d\\d?:\\d{2}:\\d{2}(?:\\.\\d*)?(?:[ \t]*(?:Z|[-+]\\d\\d?(?::\\d{2})?))?|\\d{4}-\\d{2}-\\d{2}|\\d\\d?:\\d{2}(?::\\d{2}(?:\\.\\d*)?)?"),lookbehind:!0,alias:"number"},boolean:{pattern:o("false|true","i"),lookbehind:!0,alias:"important"},null:{pattern:o("null|~","i"),lookbehind:!0,alias:"important"},string:{pattern:o(d),lookbehind:!0,greedy:!0},number:{pattern:o("[+-]?(?:0x[\\da-f]+|0o[0-7]+|(?:\\d+(?:\\.\\d*)?|\\.\\d+)(?:e[+-]?\\d+)?|\\.inf|\\.nan)","i"),lookbehind:!0},tag:r,important:n,punctuation:/---|[:[\]{}\-,|>?]|\.\.\./},e.languages.yml=e.languages.yaml}(Prism);</script>
  <script>Prism.languages.json={property:{pattern:/(^|[^\\])"(?:\\.|[^\\"\r\n])*"(?=\s*:)/,lookbehind:!0,greedy:!0},string:{pattern:/(^|[^\\])"(?:\\.|[^\\"\r\n])*"(?!\s*:)/,lookbehind:!0,greedy:!0},comment:{pattern:/\/\/.*|\/\*[\s\S]*?(?:\*\/|$)/,greedy:!0},number:/-?\b\d+(?:\.\d+)?(?:e[+-]?\d+)?\b/i,punctuation:/[{}[\],]/,operator:/:/,boolean:/\b(?:false|true)\b/,null:{pattern:/\bnull\b/,alias:"keyword"}},Prism.languages.webmanifest=Prism.languages.json;</script>
  <script>/*! Split.js - v1.6.5 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Split=t()}(this,(function(){"use strict";var e="undefined"!=typeof window?window:null,t=null===e,n=t?void 0:e.document,i=function(){return!1},r=t?"calc":["","-webkit-","-moz-","-o-"].filter((function(e){var t=n.createElement("div");return t.style.cssText="width:"+e+"calc(9px)",!!t.style.length})).shift()+"calc",s=function(e){return"string"==typeof e||e instanceof String},o=function(e){if(s(e)){var t=n.querySelector(e);if(!t)throw new Error("Selector "+e+" did not match a DOM element");return t}return e},a=function(e,t,n){var i=e[t];return void 0!==i?i:n},u=function(e,t,n,i){if(t){if("end"===i)return 0;if("center"===i)return e/2}else if(n){if("start"===i)return 0;if("center"===i)return e/2}return e},l=function(e,t){var i=n.createElement("div");return i.className="gutter gutter-"+t,i},c=function(e,t,n){var i={};return s(t)?i[e]=t:i[e]=r+"("+t+"% - "+n+"px)",i},h=function(e,t){var n;return(n={})[e]=t+"px",n};return function(r,s){if(void 0===s&&(s={}),t)return{};var f,d,v,m,g,p,y=r;Array.from&&(y=Array.from(y));var z=o(y[0]).parentNode,S=getComputedStyle?getComputedStyle(z):null,b=S?S.flexDirection:null,E=a(s,"sizes")||y.map((function(){return 100/y.length})),_=a(s,"minSize",100),L=Array.isArray(_)?_:y.map((function(){return _})),w=a(s,"maxSize",1/0),x=Array.isArray(w)?w:y.map((function(){return w})),O=a(s,"expandToMin",!1),A=a(s,"gutterSize",10),k=a(s,"gutterAlign","center"),C=a(s,"snapOffset",30),M=Array.isArray(C)?C:y.map((function(){return C})),U=a(s,"dragInterval",1),D=a(s,"direction","horizontal"),B=a(s,"cursor","horizontal"===D?"col-resize":"row-resize"),T=a(s,"gutter",l),j=a(s,"elementStyle",c),F=a(s,"gutterStyle",h);function R(e,t,n,i){var r=j(f,t,n,i);Object.keys(r).forEach((function(t){e.style[t]=r[t]}))}function N(){return p.map((function(e){return e.size}))}function q(e){return"touches"in e?e.touches[0][d]:e[d]}function H(e){var t=p[this.a],n=p[this.b],i=t.size+n.size;t.size=e/this.size*i,n.size=i-e/this.size*i,R(t.element,t.size,this._b,t.i),R(n.element,n.size,this._c,n.i)}function I(e){var t,n=p[this.a],r=p[this.b];this.dragging&&(t=q(e)-this.start+(this._b-this.dragOffset),U>1&&(t=Math.round(t/U)*U),t<=n.minSize+n.snapOffset+this._b?t=n.minSize+this._b:t>=this.size-(r.minSize+r.snapOffset+this._c)&&(t=this.size-(r.minSize+this._c)),t>=n.maxSize-n.snapOffset+this._b?t=n.maxSize+this._b:t<=this.size-(r.maxSize-r.snapOffset+this._c)&&(t=this.size-(r.maxSize+this._c)),H.call(this,t),a(s,"onDrag",i)(N()))}function W(){var e=p[this.a].element,t=p[this.b].element,n=e.getBoundingClientRect(),i=t.getBoundingClientRect();this.size=n[f]+i[f]+this._b+this._c,this.start=n[v],this.end=n[m]}function X(e){var t=function(e){if(!getComputedStyle)return null;var t=getComputedStyle(e);if(!t)return null;var n=e[g];return 0===n?null:n-="horizontal"===D?parseFloat(t.paddingLeft)+parseFloat(t.paddingRight):parseFloat(t.paddingTop)+parseFloat(t.paddingBottom)}(z);if(null===t)return e;if(L.reduce((function(e,t){return e+t}),0)>t)return e;var n=0,i=[],r=e.map((function(r,s){var o=t*r/100,a=u(A,0===s,s===e.length-1,k),l=L[s]+a;return o<l?(n+=l-o,i.push(0),l):(i.push(o-l),o)}));return 0===n?e:r.map((function(e,r){var s=e;if(n>0&&i[r]-n>0){var o=Math.min(n,i[r]-n);n-=o,s=e-o}return s/t*100}))}function Y(){var t=p[this.a].element,r=p[this.b].element;this.dragging&&a(s,"onDragEnd",i)(N()),this.dragging=!1,e.removeEventListener("mouseup",this.stop),e.removeEventListener("touchend",this.stop),e.removeEventListener("touchcancel",this.stop),e.removeEventListener("mousemove",this.move),e.removeEventListener("touchmove",this.move),this.stop=null,this.move=null,t.removeEventListener("selectstart",i),t.removeEventListener("dragstart",i),r.removeEventListener("selectstart",i),r.removeEventListener("dragstart",i),t.style.userSelect="",t.style.webkitUserSelect="",t.style.MozUserSelect="",t.style.pointerEvents="",r.style.userSelect="",r.style.webkitUserSelect="",r.style.MozUserSelect="",r.style.pointerEvents="",this.gutter.style.cursor="",this.parent.style.cursor="",n.body.style.cursor=""}function G(t){if(!("button"in t)||0===t.button){var r=p[this.a].element,o=p[this.b].element;this.dragging||a(s,"onDragStart",i)(N()),t.preventDefault(),this.dragging=!0,this.move=I.bind(this),this.stop=Y.bind(this),e.addEventListener("mouseup",this.stop),e.addEventListener("touchend",this.stop),e.addEventListener("touchcancel",this.stop),e.addEventListener("mousemove",this.move),e.addEventListener("touchmove",this.move),r.addEventListener("selectstart",i),r.addEventListener("dragstart",i),o.addEventListener("selectstart",i),o.addEventListener("dragstart",i),r.style.userSelect="none",r.style.webkitUserSelect="none",r.style.MozUserSelect="none",r.style.pointerEvents="none",o.style.userSelect="none",o.style.webkitUserSelect="none",o.style.MozUserSelect="none",o.style.pointerEvents="none",this.gutter.style.cursor=B,this.parent.style.cursor=B,n.body.style.cursor=B,W.call(this),this.dragOffset=q(t)-this.end}}"horizontal"===D?(f="width",d="clientX",v="left",m="right",g="clientWidth"):"vertical"===D&&(f="height",d="clientY",v="top",m="bottom",g="clientHeight"),E=X(E);var J=[];function K(e){var t=e.i===J.length,n=t?J[e.i-1]:J[e.i];W.call(n);var i=t?n.size-e.minSize-n._c:e.minSize+n._b;H.call(n,i)}return(p=y.map((function(e,t){var n,i={element:o(e),size:E[t],minSize:L[t],maxSize:x[t],snapOffset:M[t],i:t};if(t>0&&((n={a:t-1,b:t,dragging:!1,direction:D,parent:z})._b=u(A,t-1==0,!1,k),n._c=u(A,!1,t===y.length-1,k),"row-reverse"===b||"column-reverse"===b)){var r=n.a;n.a=n.b,n.b=r}if(t>0){var s=T(t,D,i.element);!function(e,t,n){var i=F(f,t,n);Object.keys(i).forEach((function(t){e.style[t]=i[t]}))}(s,A,t),n._a=G.bind(n),s.addEventListener("mousedown",n._a),s.addEventListener("touchstart",n._a),z.insertBefore(s,i.element),n.gutter=s}return R(i.element,i.size,u(A,0===t,t===y.length-1,k),t),t>0&&J.push(n),i}))).forEach((function(e){var t=e.element.getBoundingClientRect()[f];t<e.minSize&&(O?K(e):e.minSize=t)})),{setSizes:function(e){var t=X(e);t.forEach((function(e,n){if(n>0){var i=J[n-1],r=p[i.a],s=p[i.b];r.size=t[n-1],s.size=e,R(r.element,r.size,i._b,r.i),R(s.element,s.size,i._c,s.i)}}))},getSizes:N,collapse:function(e){K(p[e])},destroy:function(e,t){J.forEach((function(n){if(!0!==t?n.parent.removeChild(n.gutter):(n.gutter.removeEventListener("mousedown",n._a),n.gutter.removeEventListener("touchstart",n._a)),!0!==e){var i=j(f,n.a.size,n._b);Object.keys(i).forEach((function(e){p[n.a].element.style[e]="",p[n.b].element.style[e]=""}))}}))},parent:z,pairs:J}}}));
//# sourceMappingURL=split.min.js.map
</script>
  <script>/*! Sortable 1.15.2 - MIT | git://github.com/SortableJS/Sortable.git */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Sortable=e()}(this,function(){"use strict";function e(e,t){var n,o=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)),o}function I(o){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?e(Object(i),!0).forEach(function(t){var e,n;e=o,t=i[n=t],n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach(function(t){Object.defineProperty(o,t,Object.getOwnPropertyDescriptor(i,t))})}return o}function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function a(){return(a=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n,o=arguments[e];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(t[n]=o[n])}return t}).apply(this,arguments)}function i(t,e){if(null==t)return{};var n,o=function(t,e){if(null==t)return{};for(var n,o={},i=Object.keys(t),r=0;r<i.length;r++)n=i[r],0<=e.indexOf(n)||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols)for(var i=Object.getOwnPropertySymbols(t),r=0;r<i.length;r++)n=i[r],0<=e.indexOf(n)||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n]);return o}function r(t){return function(t){if(Array.isArray(t))return l(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return l(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}function t(t){if("undefined"!=typeof window&&window.navigator)return!!navigator.userAgent.match(t)}var y=t(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),w=t(/Edge/i),s=t(/firefox/i),u=t(/safari/i)&&!t(/chrome/i)&&!t(/android/i),n=t(/iP(ad|od|hone)/i),c=t(/chrome/i)&&t(/android/i),d={capture:!1,passive:!1};function h(t,e,n){t.addEventListener(e,n,!y&&d)}function f(t,e,n){t.removeEventListener(e,n,!y&&d)}function p(t,e){if(e&&(">"===e[0]&&(e=e.substring(1)),t))try{if(t.matches)return t.matches(e);if(t.msMatchesSelector)return t.msMatchesSelector(e);if(t.webkitMatchesSelector)return t.webkitMatchesSelector(e)}catch(t){return}}function P(t,e,n,o){if(t){n=n||document;do{if(null!=e&&(">"!==e[0]||t.parentNode===n)&&p(t,e)||o&&t===n)return t}while(t!==n&&(t=(i=t).host&&i!==document&&i.host.nodeType?i.host:i.parentNode))}var i;return null}var g,m=/\s+/g;function k(t,e,n){var o;t&&e&&(t.classList?t.classList[n?"add":"remove"](e):(o=(" "+t.className+" ").replace(m," ").replace(" "+e+" "," "),t.className=(o+(n?" "+e:"")).replace(m," ")))}function R(t,e,n){var o=t&&t.style;if(o){if(void 0===n)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(t,""):t.currentStyle&&(n=t.currentStyle),void 0===e?n:n[e];o[e=!(e in o||-1!==e.indexOf("webkit"))?"-webkit-"+e:e]=n+("string"==typeof n?"":"px")}}function v(t,e){var n="";if("string"==typeof t)n=t;else do{var o=R(t,"transform")}while(o&&"none"!==o&&(n=o+" "+n),!e&&(t=t.parentNode));var i=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return i&&new i(n)}function b(t,e,n){if(t){var o=t.getElementsByTagName(e),i=0,r=o.length;if(n)for(;i<r;i++)n(o[i],i);return o}return[]}function O(){var t=document.scrollingElement;return t||document.documentElement}function X(t,e,n,o,i){if(t.getBoundingClientRect||t===window){var r,a,l,s,c,u,d=t!==window&&t.parentNode&&t!==O()?(a=(r=t.getBoundingClientRect()).top,l=r.left,s=r.bottom,c=r.right,u=r.height,r.width):(l=a=0,s=window.innerHeight,c=window.innerWidth,u=window.innerHeight,window.innerWidth);if((e||n)&&t!==window&&(i=i||t.parentNode,!y))do{if(i&&i.getBoundingClientRect&&("none"!==R(i,"transform")||n&&"static"!==R(i,"position"))){var h=i.getBoundingClientRect();a-=h.top+parseInt(R(i,"border-top-width")),l-=h.left+parseInt(R(i,"border-left-width")),s=a+r.height,c=l+r.width;break}}while(i=i.parentNode);return o&&t!==window&&(o=(e=v(i||t))&&e.a,t=e&&e.d,e&&(s=(a/=t)+(u/=t),c=(l/=o)+(d/=o))),{top:a,left:l,bottom:s,right:c,width:d,height:u}}}function Y(t,e,n){for(var o=M(t,!0),i=X(t)[e];o;){var r=X(o)[n];if(!("top"===n||"left"===n?r<=i:i<=r))return o;if(o===O())break;o=M(o,!1)}return!1}function B(t,e,n,o){for(var i=0,r=0,a=t.children;r<a.length;){if("none"!==a[r].style.display&&a[r]!==Ft.ghost&&(o||a[r]!==Ft.dragged)&&P(a[r],n.draggable,t,!1)){if(i===e)return a[r];i++}r++}return null}function F(t,e){for(var n=t.lastElementChild;n&&(n===Ft.ghost||"none"===R(n,"display")||e&&!p(n,e));)n=n.previousElementSibling;return n||null}function j(t,e){var n=0;if(!t||!t.parentNode)return-1;for(;t=t.previousElementSibling;)"TEMPLATE"===t.nodeName.toUpperCase()||t===Ft.clone||e&&!p(t,e)||n++;return n}function E(t){var e=0,n=0,o=O();if(t)do{var i=v(t),r=i.a,i=i.d}while(e+=t.scrollLeft*r,n+=t.scrollTop*i,t!==o&&(t=t.parentNode));return[e,n]}function M(t,e){if(!t||!t.getBoundingClientRect)return O();var n=t,o=!1;do{if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var i=R(n);if(n.clientWidth<n.scrollWidth&&("auto"==i.overflowX||"scroll"==i.overflowX)||n.clientHeight<n.scrollHeight&&("auto"==i.overflowY||"scroll"==i.overflowY)){if(!n.getBoundingClientRect||n===document.body)return O();if(o||e)return n;o=!0}}}while(n=n.parentNode);return O()}function D(t,e){return Math.round(t.top)===Math.round(e.top)&&Math.round(t.left)===Math.round(e.left)&&Math.round(t.height)===Math.round(e.height)&&Math.round(t.width)===Math.round(e.width)}function S(e,n){return function(){var t;g||(1===(t=arguments).length?e.call(this,t[0]):e.apply(this,t),g=setTimeout(function(){g=void 0},n))}}function H(t,e,n){t.scrollLeft+=e,t.scrollTop+=n}function _(t){var e=window.Polymer,n=window.jQuery||window.Zepto;return e&&e.dom?e.dom(t).cloneNode(!0):n?n(t).clone(!0)[0]:t.cloneNode(!0)}function C(t,e){R(t,"position","absolute"),R(t,"top",e.top),R(t,"left",e.left),R(t,"width",e.width),R(t,"height",e.height)}function T(t){R(t,"position",""),R(t,"top",""),R(t,"left",""),R(t,"width",""),R(t,"height","")}function L(n,o,i){var r={};return Array.from(n.children).forEach(function(t){var e;P(t,o.draggable,n,!1)&&!t.animated&&t!==i&&(e=X(t),r.left=Math.min(null!==(t=r.left)&&void 0!==t?t:1/0,e.left),r.top=Math.min(null!==(t=r.top)&&void 0!==t?t:1/0,e.top),r.right=Math.max(null!==(t=r.right)&&void 0!==t?t:-1/0,e.right),r.bottom=Math.max(null!==(t=r.bottom)&&void 0!==t?t:-1/0,e.bottom))}),r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}var K="Sortable"+(new Date).getTime();function x(){var e,o=[];return{captureAnimationState:function(){o=[],this.options.animation&&[].slice.call(this.el.children).forEach(function(t){var e,n;"none"!==R(t,"display")&&t!==Ft.ghost&&(o.push({target:t,rect:X(t)}),e=I({},o[o.length-1].rect),!t.thisAnimationDuration||(n=v(t,!0))&&(e.top-=n.f,e.left-=n.e),t.fromRect=e)})},addAnimationState:function(t){o.push(t)},removeAnimationState:function(t){o.splice(function(t,e){for(var n in t)if(t.hasOwnProperty(n))for(var o in e)if(e.hasOwnProperty(o)&&e[o]===t[n][o])return Number(n);return-1}(o,{target:t}),1)},animateAll:function(t){var c=this;if(!this.options.animation)return clearTimeout(e),void("function"==typeof t&&t());var u=!1,d=0;o.forEach(function(t){var e=0,n=t.target,o=n.fromRect,i=X(n),r=n.prevFromRect,a=n.prevToRect,l=t.rect,s=v(n,!0);s&&(i.top-=s.f,i.left-=s.e),n.toRect=i,n.thisAnimationDuration&&D(r,i)&&!D(o,i)&&(l.top-i.top)/(l.left-i.left)==(o.top-i.top)/(o.left-i.left)&&(t=l,s=r,r=a,a=c.options,e=Math.sqrt(Math.pow(s.top-t.top,2)+Math.pow(s.left-t.left,2))/Math.sqrt(Math.pow(s.top-r.top,2)+Math.pow(s.left-r.left,2))*a.animation),D(i,o)||(n.prevFromRect=o,n.prevToRect=i,e=e||c.options.animation,c.animate(n,l,i,e)),e&&(u=!0,d=Math.max(d,e),clearTimeout(n.animationResetTimer),n.animationResetTimer=setTimeout(function(){n.animationTime=0,n.prevFromRect=null,n.fromRect=null,n.prevToRect=null,n.thisAnimationDuration=null},e),n.thisAnimationDuration=e)}),clearTimeout(e),u?e=setTimeout(function(){"function"==typeof t&&t()},d):"function"==typeof t&&t(),o=[]},animate:function(t,e,n,o){var i,r;o&&(R(t,"transition",""),R(t,"transform",""),i=(r=v(this.el))&&r.a,r=r&&r.d,i=(e.left-n.left)/(i||1),r=(e.top-n.top)/(r||1),t.animatingX=!!i,t.animatingY=!!r,R(t,"transform","translate3d("+i+"px,"+r+"px,0)"),this.forRepaintDummy=t.offsetWidth,R(t,"transition","transform "+o+"ms"+(this.options.easing?" "+this.options.easing:"")),R(t,"transform","translate3d(0,0,0)"),"number"==typeof t.animated&&clearTimeout(t.animated),t.animated=setTimeout(function(){R(t,"transition",""),R(t,"transform",""),t.animated=!1,t.animatingX=!1,t.animatingY=!1},o))}}}var A=[],N={initializeByDefault:!0},W={mount:function(e){for(var t in N)!N.hasOwnProperty(t)||t in e||(e[t]=N[t]);A.forEach(function(t){if(t.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")}),A.push(e)},pluginEvent:function(e,n,o){var t=this;this.eventCanceled=!1,o.cancel=function(){t.eventCanceled=!0};var i=e+"Global";A.forEach(function(t){n[t.pluginName]&&(n[t.pluginName][i]&&n[t.pluginName][i](I({sortable:n},o)),n.options[t.pluginName]&&n[t.pluginName][e]&&n[t.pluginName][e](I({sortable:n},o)))})},initializePlugins:function(n,o,i,t){for(var e in A.forEach(function(t){var e=t.pluginName;(n.options[e]||t.initializeByDefault)&&((t=new t(n,o,n.options)).sortable=n,t.options=n.options,n[e]=t,a(i,t.defaults))}),n.options){var r;n.options.hasOwnProperty(e)&&(void 0!==(r=this.modifyOption(n,e,n.options[e]))&&(n.options[e]=r))}},getEventProperties:function(e,n){var o={};return A.forEach(function(t){"function"==typeof t.eventProperties&&a(o,t.eventProperties.call(n[t.pluginName],e))}),o},modifyOption:function(e,n,o){var i;return A.forEach(function(t){e[t.pluginName]&&t.optionListeners&&"function"==typeof t.optionListeners[n]&&(i=t.optionListeners[n].call(e[t.pluginName],o))}),i}};function z(t){var e=t.sortable,n=t.rootEl,o=t.name,i=t.targetEl,r=t.cloneEl,a=t.toEl,l=t.fromEl,s=t.oldIndex,c=t.newIndex,u=t.oldDraggableIndex,d=t.newDraggableIndex,h=t.originalEvent,f=t.putSortable,p=t.extraEventProperties;if(e=e||n&&n[K]){var g,m=e.options,t="on"+o.charAt(0).toUpperCase()+o.substr(1);!window.CustomEvent||y||w?(g=document.createEvent("Event")).initEvent(o,!0,!0):g=new CustomEvent(o,{bubbles:!0,cancelable:!0}),g.to=a||n,g.from=l||n,g.item=i||n,g.clone=r,g.oldIndex=s,g.newIndex=c,g.oldDraggableIndex=u,g.newDraggableIndex=d,g.originalEvent=h,g.pullMode=f?f.lastPutMode:void 0;var v,b=I(I({},p),W.getEventProperties(o,e));for(v in b)g[v]=b[v];n&&n.dispatchEvent(g),m[t]&&m[t].call(e,g)}}function G(t,e){var n=(o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{}).evt,o=i(o,U);W.pluginEvent.bind(Ft)(t,e,I({dragEl:V,parentEl:Z,ghostEl:$,rootEl:Q,nextEl:J,lastDownEl:tt,cloneEl:et,cloneHidden:nt,dragStarted:gt,putSortable:st,activeSortable:Ft.active,originalEvent:n,oldIndex:ot,oldDraggableIndex:rt,newIndex:it,newDraggableIndex:at,hideGhostForTarget:Rt,unhideGhostForTarget:Xt,cloneNowHidden:function(){nt=!0},cloneNowShown:function(){nt=!1},dispatchSortableEvent:function(t){q({sortable:e,name:t,originalEvent:n})}},o))}var U=["evt"];function q(t){z(I({putSortable:st,cloneEl:et,targetEl:V,rootEl:Q,oldIndex:ot,oldDraggableIndex:rt,newIndex:it,newDraggableIndex:at},t))}var V,Z,$,Q,J,tt,et,nt,ot,it,rt,at,lt,st,ct,ut,dt,ht,ft,pt,gt,mt,vt,bt,yt,wt=!1,Et=!1,Dt=[],St=!1,_t=!1,Ct=[],Tt=!1,xt=[],Ot="undefined"!=typeof document,Mt=n,At=w||y?"cssFloat":"float",Nt=Ot&&!c&&!n&&"draggable"in document.createElement("div"),It=function(){if(Ot){if(y)return!1;var t=document.createElement("x");return t.style.cssText="pointer-events:auto","auto"===t.style.pointerEvents}}(),Pt=function(t,e){var n=R(t),o=parseInt(n.width)-parseInt(n.paddingLeft)-parseInt(n.paddingRight)-parseInt(n.borderLeftWidth)-parseInt(n.borderRightWidth),i=B(t,0,e),r=B(t,1,e),a=i&&R(i),l=r&&R(r),s=a&&parseInt(a.marginLeft)+parseInt(a.marginRight)+X(i).width,t=l&&parseInt(l.marginLeft)+parseInt(l.marginRight)+X(r).width;if("flex"===n.display)return"column"===n.flexDirection||"column-reverse"===n.flexDirection?"vertical":"horizontal";if("grid"===n.display)return n.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(i&&a.float&&"none"!==a.float){e="left"===a.float?"left":"right";return!r||"both"!==l.clear&&l.clear!==e?"horizontal":"vertical"}return i&&("block"===a.display||"flex"===a.display||"table"===a.display||"grid"===a.display||o<=s&&"none"===n[At]||r&&"none"===n[At]&&o<s+t)?"vertical":"horizontal"},kt=function(t){function l(r,a){return function(t,e,n,o){var i=t.options.group.name&&e.options.group.name&&t.options.group.name===e.options.group.name;if(null==r&&(a||i))return!0;if(null==r||!1===r)return!1;if(a&&"clone"===r)return r;if("function"==typeof r)return l(r(t,e,n,o),a)(t,e,n,o);e=(a?t:e).options.group.name;return!0===r||"string"==typeof r&&r===e||r.join&&-1<r.indexOf(e)}}var e={},n=t.group;n&&"object"==o(n)||(n={name:n}),e.name=n.name,e.checkPull=l(n.pull,!0),e.checkPut=l(n.put),e.revertClone=n.revertClone,t.group=e},Rt=function(){!It&&$&&R($,"display","none")},Xt=function(){!It&&$&&R($,"display","")};Ot&&!c&&document.addEventListener("click",function(t){if(Et)return t.preventDefault(),t.stopPropagation&&t.stopPropagation(),t.stopImmediatePropagation&&t.stopImmediatePropagation(),Et=!1},!0);function Yt(t){if(V){t=t.touches?t.touches[0]:t;var e=(i=t.clientX,r=t.clientY,Dt.some(function(t){var e=t[K].options.emptyInsertThreshold;if(e&&!F(t)){var n=X(t),o=i>=n.left-e&&i<=n.right+e,e=r>=n.top-e&&r<=n.bottom+e;return o&&e?a=t:void 0}}),a);if(e){var n,o={};for(n in t)t.hasOwnProperty(n)&&(o[n]=t[n]);o.target=o.rootEl=e,o.preventDefault=void 0,o.stopPropagation=void 0,e[K]._onDragOver(o)}}var i,r,a}function Bt(t){V&&V.parentNode[K]._isOutsideThisEl(t.target)}function Ft(t,e){if(!t||!t.nodeType||1!==t.nodeType)throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(t));this.el=t,this.options=e=a({},e),t[K]=this;var n,o,i={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(t.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return Pt(t,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(t,e){t.setData("Text",e.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:!1!==Ft.supportPointer&&"PointerEvent"in window&&!u,emptyInsertThreshold:5};for(n in W.initializePlugins(this,t,i),i)n in e||(e[n]=i[n]);for(o in kt(e),this)"_"===o.charAt(0)&&"function"==typeof this[o]&&(this[o]=this[o].bind(this));this.nativeDraggable=!e.forceFallback&&Nt,this.nativeDraggable&&(this.options.touchStartThreshold=1),e.supportPointer?h(t,"pointerdown",this._onTapStart):(h(t,"mousedown",this._onTapStart),h(t,"touchstart",this._onTapStart)),this.nativeDraggable&&(h(t,"dragover",this),h(t,"dragenter",this)),Dt.push(this.el),e.store&&e.store.get&&this.sort(e.store.get(this)||[]),a(this,x())}function jt(t,e,n,o,i,r,a,l){var s,c,u=t[K],d=u.options.onMove;return!window.CustomEvent||y||w?(s=document.createEvent("Event")).initEvent("move",!0,!0):s=new CustomEvent("move",{bubbles:!0,cancelable:!0}),s.to=e,s.from=t,s.dragged=n,s.draggedRect=o,s.related=i||e,s.relatedRect=r||X(e),s.willInsertAfter=l,s.originalEvent=a,t.dispatchEvent(s),c=d?d.call(u,s,a):c}function Ht(t){t.draggable=!1}function Lt(){Tt=!1}function Kt(t){return setTimeout(t,0)}function Wt(t){return clearTimeout(t)}Ft.prototype={constructor:Ft,_isOutsideThisEl:function(t){this.el.contains(t)||t===this.el||(mt=null)},_getDirection:function(t,e){return"function"==typeof this.options.direction?this.options.direction.call(this,t,e,V):this.options.direction},_onTapStart:function(e){if(e.cancelable){var n=this,o=this.el,t=this.options,i=t.preventOnFilter,r=e.type,a=e.touches&&e.touches[0]||e.pointerType&&"touch"===e.pointerType&&e,l=(a||e).target,s=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||l,c=t.filter;if(!function(t){xt.length=0;var e=t.getElementsByTagName("input"),n=e.length;for(;n--;){var o=e[n];o.checked&&xt.push(o)}}(o),!V&&!(/mousedown|pointerdown/.test(r)&&0!==e.button||t.disabled)&&!s.isContentEditable&&(this.nativeDraggable||!u||!l||"SELECT"!==l.tagName.toUpperCase())&&!((l=P(l,t.draggable,o,!1))&&l.animated||tt===l)){if(ot=j(l),rt=j(l,t.draggable),"function"==typeof c){if(c.call(this,e,l,this))return q({sortable:n,rootEl:s,name:"filter",targetEl:l,toEl:o,fromEl:o}),G("filter",n,{evt:e}),void(i&&e.cancelable&&e.preventDefault())}else if(c=c&&c.split(",").some(function(t){if(t=P(s,t.trim(),o,!1))return q({sortable:n,rootEl:t,name:"filter",targetEl:l,fromEl:o,toEl:o}),G("filter",n,{evt:e}),!0}))return void(i&&e.cancelable&&e.preventDefault());t.handle&&!P(s,t.handle,o,!1)||this._prepareDragStart(e,a,l)}}},_prepareDragStart:function(t,e,n){var o,i=this,r=i.el,a=i.options,l=r.ownerDocument;n&&!V&&n.parentNode===r&&(o=X(n),Q=r,Z=(V=n).parentNode,J=V.nextSibling,tt=n,lt=a.group,ct={target:Ft.dragged=V,clientX:(e||t).clientX,clientY:(e||t).clientY},ft=ct.clientX-o.left,pt=ct.clientY-o.top,this._lastX=(e||t).clientX,this._lastY=(e||t).clientY,V.style["will-change"]="all",o=function(){G("delayEnded",i,{evt:t}),Ft.eventCanceled?i._onDrop():(i._disableDelayedDragEvents(),!s&&i.nativeDraggable&&(V.draggable=!0),i._triggerDragStart(t,e),q({sortable:i,name:"choose",originalEvent:t}),k(V,a.chosenClass,!0))},a.ignore.split(",").forEach(function(t){b(V,t.trim(),Ht)}),h(l,"dragover",Yt),h(l,"mousemove",Yt),h(l,"touchmove",Yt),h(l,"mouseup",i._onDrop),h(l,"touchend",i._onDrop),h(l,"touchcancel",i._onDrop),s&&this.nativeDraggable&&(this.options.touchStartThreshold=4,V.draggable=!0),G("delayStart",this,{evt:t}),!a.delay||a.delayOnTouchOnly&&!e||this.nativeDraggable&&(w||y)?o():Ft.eventCanceled?this._onDrop():(h(l,"mouseup",i._disableDelayedDrag),h(l,"touchend",i._disableDelayedDrag),h(l,"touchcancel",i._disableDelayedDrag),h(l,"mousemove",i._delayedDragTouchMoveHandler),h(l,"touchmove",i._delayedDragTouchMoveHandler),a.supportPointer&&h(l,"pointermove",i._delayedDragTouchMoveHandler),i._dragStartTimer=setTimeout(o,a.delay)))},_delayedDragTouchMoveHandler:function(t){t=t.touches?t.touches[0]:t;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){V&&Ht(V),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var t=this.el.ownerDocument;f(t,"mouseup",this._disableDelayedDrag),f(t,"touchend",this._disableDelayedDrag),f(t,"touchcancel",this._disableDelayedDrag),f(t,"mousemove",this._delayedDragTouchMoveHandler),f(t,"touchmove",this._delayedDragTouchMoveHandler),f(t,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(t,e){e=e||"touch"==t.pointerType&&t,!this.nativeDraggable||e?this.options.supportPointer?h(document,"pointermove",this._onTouchMove):h(document,e?"touchmove":"mousemove",this._onTouchMove):(h(V,"dragend",this),h(Q,"dragstart",this._onDragStart));try{document.selection?Kt(function(){document.selection.empty()}):window.getSelection().removeAllRanges()}catch(t){}},_dragStarted:function(t,e){var n;wt=!1,Q&&V?(G("dragStarted",this,{evt:e}),this.nativeDraggable&&h(document,"dragover",Bt),n=this.options,t||k(V,n.dragClass,!1),k(V,n.ghostClass,!0),Ft.active=this,t&&this._appendGhost(),q({sortable:this,name:"start",originalEvent:e})):this._nulling()},_emulateDragOver:function(){if(ut){this._lastX=ut.clientX,this._lastY=ut.clientY,Rt();for(var t=document.elementFromPoint(ut.clientX,ut.clientY),e=t;t&&t.shadowRoot&&(t=t.shadowRoot.elementFromPoint(ut.clientX,ut.clientY))!==e;)e=t;if(V.parentNode[K]._isOutsideThisEl(t),e)do{if(e[K])if(e[K]._onDragOver({clientX:ut.clientX,clientY:ut.clientY,target:t,rootEl:e})&&!this.options.dragoverBubble)break}while(e=(t=e).parentNode);Xt()}},_onTouchMove:function(t){if(ct){var e=this.options,n=e.fallbackTolerance,o=e.fallbackOffset,i=t.touches?t.touches[0]:t,r=$&&v($,!0),a=$&&r&&r.a,l=$&&r&&r.d,e=Mt&&yt&&E(yt),a=(i.clientX-ct.clientX+o.x)/(a||1)+(e?e[0]-Ct[0]:0)/(a||1),l=(i.clientY-ct.clientY+o.y)/(l||1)+(e?e[1]-Ct[1]:0)/(l||1);if(!Ft.active&&!wt){if(n&&Math.max(Math.abs(i.clientX-this._lastX),Math.abs(i.clientY-this._lastY))<n)return;this._onDragStart(t,!0)}$&&(r?(r.e+=a-(dt||0),r.f+=l-(ht||0)):r={a:1,b:0,c:0,d:1,e:a,f:l},r="matrix(".concat(r.a,",").concat(r.b,",").concat(r.c,",").concat(r.d,",").concat(r.e,",").concat(r.f,")"),R($,"webkitTransform",r),R($,"mozTransform",r),R($,"msTransform",r),R($,"transform",r),dt=a,ht=l,ut=i),t.cancelable&&t.preventDefault()}},_appendGhost:function(){if(!$){var t=this.options.fallbackOnBody?document.body:Q,e=X(V,!0,Mt,!0,t),n=this.options;if(Mt){for(yt=t;"static"===R(yt,"position")&&"none"===R(yt,"transform")&&yt!==document;)yt=yt.parentNode;yt!==document.body&&yt!==document.documentElement?(yt===document&&(yt=O()),e.top+=yt.scrollTop,e.left+=yt.scrollLeft):yt=O(),Ct=E(yt)}k($=V.cloneNode(!0),n.ghostClass,!1),k($,n.fallbackClass,!0),k($,n.dragClass,!0),R($,"transition",""),R($,"transform",""),R($,"box-sizing","border-box"),R($,"margin",0),R($,"top",e.top),R($,"left",e.left),R($,"width",e.width),R($,"height",e.height),R($,"opacity","0.8"),R($,"position",Mt?"absolute":"fixed"),R($,"zIndex","100000"),R($,"pointerEvents","none"),Ft.ghost=$,t.appendChild($),R($,"transform-origin",ft/parseInt($.style.width)*100+"% "+pt/parseInt($.style.height)*100+"%")}},_onDragStart:function(t,e){var n=this,o=t.dataTransfer,i=n.options;G("dragStart",this,{evt:t}),Ft.eventCanceled?this._onDrop():(G("setupClone",this),Ft.eventCanceled||((et=_(V)).removeAttribute("id"),et.draggable=!1,et.style["will-change"]="",this._hideClone(),k(et,this.options.chosenClass,!1),Ft.clone=et),n.cloneId=Kt(function(){G("clone",n),Ft.eventCanceled||(n.options.removeCloneOnHide||Q.insertBefore(et,V),n._hideClone(),q({sortable:n,name:"clone"}))}),e||k(V,i.dragClass,!0),e?(Et=!0,n._loopId=setInterval(n._emulateDragOver,50)):(f(document,"mouseup",n._onDrop),f(document,"touchend",n._onDrop),f(document,"touchcancel",n._onDrop),o&&(o.effectAllowed="move",i.setData&&i.setData.call(n,o,V)),h(document,"drop",n),R(V,"transform","translateZ(0)")),wt=!0,n._dragStartId=Kt(n._dragStarted.bind(n,e,t)),h(document,"selectstart",n),gt=!0,u&&R(document.body,"user-select","none"))},_onDragOver:function(n){var o,i,r,t,e,a=this.el,l=n.target,s=this.options,c=s.group,u=Ft.active,d=lt===c,h=s.sort,f=st||u,p=this,g=!1;if(!Tt){if(void 0!==n.preventDefault&&n.cancelable&&n.preventDefault(),l=P(l,s.draggable,a,!0),O("dragOver"),Ft.eventCanceled)return g;if(V.contains(n.target)||l.animated&&l.animatingX&&l.animatingY||p._ignoreWhileAnimating===l)return A(!1);if(Et=!1,u&&!s.disabled&&(d?h||(i=Z!==Q):st===this||(this.lastPutMode=lt.checkPull(this,u,V,n))&&c.checkPut(this,u,V,n))){if(r="vertical"===this._getDirection(n,l),o=X(V),O("dragOverValid"),Ft.eventCanceled)return g;if(i)return Z=Q,M(),this._hideClone(),O("revert"),Ft.eventCanceled||(J?Q.insertBefore(V,J):Q.appendChild(V)),A(!0);var m=F(a,s.draggable);if(m&&(S=n,c=r,x=X(F((D=this).el,D.options.draggable)),D=L(D.el,D.options,$),!(c?S.clientX>D.right+10||S.clientY>x.bottom&&S.clientX>x.left:S.clientY>D.bottom+10||S.clientX>x.right&&S.clientY>x.top)||m.animated)){if(m&&(t=n,e=r,C=X(B((_=this).el,0,_.options,!0)),_=L(_.el,_.options,$),e?t.clientX<_.left-10||t.clientY<C.top&&t.clientX<C.right:t.clientY<_.top-10||t.clientY<C.bottom&&t.clientX<C.left)){var v=B(a,0,s,!0);if(v===V)return A(!1);if(E=X(l=v),!1!==jt(Q,a,V,o,l,E,n,!1))return M(),a.insertBefore(V,v),Z=a,N(),A(!0)}else if(l.parentNode===a){var b,y,w,E=X(l),D=V.parentNode!==a,S=(S=V.animated&&V.toRect||o,x=l.animated&&l.toRect||E,_=(e=r)?S.left:S.top,t=e?S.right:S.bottom,C=e?S.width:S.height,v=e?x.left:x.top,S=e?x.right:x.bottom,x=e?x.width:x.height,!(_===v||t===S||_+C/2===v+x/2)),_=r?"top":"left",C=Y(l,"top","top")||Y(V,"top","top"),v=C?C.scrollTop:void 0;if(mt!==l&&(y=E[_],St=!1,_t=!S&&s.invertSwap||D),0!==(b=function(t,e,n,o,i,r,a,l){var s=o?t.clientY:t.clientX,c=o?n.height:n.width,t=o?n.top:n.left,o=o?n.bottom:n.right,n=!1;if(!a)if(l&&bt<c*i){if(St=!St&&(1===vt?t+c*r/2<s:s<o-c*r/2)?!0:St)n=!0;else if(1===vt?s<t+bt:o-bt<s)return-vt}else if(t+c*(1-i)/2<s&&s<o-c*(1-i)/2)return function(t){return j(V)<j(t)?1:-1}(e);if((n=n||a)&&(s<t+c*r/2||o-c*r/2<s))return t+c/2<s?1:-1;return 0}(n,l,E,r,S?1:s.swapThreshold,null==s.invertedSwapThreshold?s.swapThreshold:s.invertedSwapThreshold,_t,mt===l)))for(var T=j(V);(w=Z.children[T-=b])&&("none"===R(w,"display")||w===$););if(0===b||w===l)return A(!1);vt=b;var x=(mt=l).nextElementSibling,D=!1,S=jt(Q,a,V,o,l,E,n,D=1===b);if(!1!==S)return 1!==S&&-1!==S||(D=1===S),Tt=!0,setTimeout(Lt,30),M(),D&&!x?a.appendChild(V):l.parentNode.insertBefore(V,D?x:l),C&&H(C,0,v-C.scrollTop),Z=V.parentNode,void 0===y||_t||(bt=Math.abs(y-X(l)[_])),N(),A(!0)}}else{if(m===V)return A(!1);if((l=m&&a===n.target?m:l)&&(E=X(l)),!1!==jt(Q,a,V,o,l,E,n,!!l))return M(),m&&m.nextSibling?a.insertBefore(V,m.nextSibling):a.appendChild(V),Z=a,N(),A(!0)}if(a.contains(V))return A(!1)}return!1}function O(t,e){G(t,p,I({evt:n,isOwner:d,axis:r?"vertical":"horizontal",revert:i,dragRect:o,targetRect:E,canSort:h,fromSortable:f,target:l,completed:A,onMove:function(t,e){return jt(Q,a,V,o,t,X(t),n,e)},changed:N},e))}function M(){O("dragOverAnimationCapture"),p.captureAnimationState(),p!==f&&f.captureAnimationState()}function A(t){return O("dragOverCompleted",{insertion:t}),t&&(d?u._hideClone():u._showClone(p),p!==f&&(k(V,(st||u).options.ghostClass,!1),k(V,s.ghostClass,!0)),st!==p&&p!==Ft.active?st=p:p===Ft.active&&st&&(st=null),f===p&&(p._ignoreWhileAnimating=l),p.animateAll(function(){O("dragOverAnimationComplete"),p._ignoreWhileAnimating=null}),p!==f&&(f.animateAll(),f._ignoreWhileAnimating=null)),(l===V&&!V.animated||l===a&&!l.animated)&&(mt=null),s.dragoverBubble||n.rootEl||l===document||(V.parentNode[K]._isOutsideThisEl(n.target),t||Yt(n)),!s.dragoverBubble&&n.stopPropagation&&n.stopPropagation(),g=!0}function N(){it=j(V),at=j(V,s.draggable),q({sortable:p,name:"change",toEl:a,newIndex:it,newDraggableIndex:at,originalEvent:n})}},_ignoreWhileAnimating:null,_offMoveEvents:function(){f(document,"mousemove",this._onTouchMove),f(document,"touchmove",this._onTouchMove),f(document,"pointermove",this._onTouchMove),f(document,"dragover",Yt),f(document,"mousemove",Yt),f(document,"touchmove",Yt)},_offUpEvents:function(){var t=this.el.ownerDocument;f(t,"mouseup",this._onDrop),f(t,"touchend",this._onDrop),f(t,"pointerup",this._onDrop),f(t,"touchcancel",this._onDrop),f(document,"selectstart",this)},_onDrop:function(t){var e=this.el,n=this.options;it=j(V),at=j(V,n.draggable),G("drop",this,{evt:t}),Z=V&&V.parentNode,it=j(V),at=j(V,n.draggable),Ft.eventCanceled||(St=_t=wt=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),Wt(this.cloneId),Wt(this._dragStartId),this.nativeDraggable&&(f(document,"drop",this),f(e,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),u&&R(document.body,"user-select",""),R(V,"transform",""),t&&(gt&&(t.cancelable&&t.preventDefault(),n.dropBubble||t.stopPropagation()),$&&$.parentNode&&$.parentNode.removeChild($),(Q===Z||st&&"clone"!==st.lastPutMode)&&et&&et.parentNode&&et.parentNode.removeChild(et),V&&(this.nativeDraggable&&f(V,"dragend",this),Ht(V),V.style["will-change"]="",gt&&!wt&&k(V,(st||this).options.ghostClass,!1),k(V,this.options.chosenClass,!1),q({sortable:this,name:"unchoose",toEl:Z,newIndex:null,newDraggableIndex:null,originalEvent:t}),Q!==Z?(0<=it&&(q({rootEl:Z,name:"add",toEl:Z,fromEl:Q,originalEvent:t}),q({sortable:this,name:"remove",toEl:Z,originalEvent:t}),q({rootEl:Z,name:"sort",toEl:Z,fromEl:Q,originalEvent:t}),q({sortable:this,name:"sort",toEl:Z,originalEvent:t})),st&&st.save()):it!==ot&&0<=it&&(q({sortable:this,name:"update",toEl:Z,originalEvent:t}),q({sortable:this,name:"sort",toEl:Z,originalEvent:t})),Ft.active&&(null!=it&&-1!==it||(it=ot,at=rt),q({sortable:this,name:"end",toEl:Z,originalEvent:t}),this.save())))),this._nulling()},_nulling:function(){G("nulling",this),Q=V=Z=$=J=et=tt=nt=ct=ut=gt=it=at=ot=rt=mt=vt=st=lt=Ft.dragged=Ft.ghost=Ft.clone=Ft.active=null,xt.forEach(function(t){t.checked=!0}),xt.length=dt=ht=0},handleEvent:function(t){switch(t.type){case"drop":case"dragend":this._onDrop(t);break;case"dragenter":case"dragover":V&&(this._onDragOver(t),function(t){t.dataTransfer&&(t.dataTransfer.dropEffect="move");t.cancelable&&t.preventDefault()}(t));break;case"selectstart":t.preventDefault()}},toArray:function(){for(var t,e=[],n=this.el.children,o=0,i=n.length,r=this.options;o<i;o++)P(t=n[o],r.draggable,this.el,!1)&&e.push(t.getAttribute(r.dataIdAttr)||function(t){var e=t.tagName+t.className+t.src+t.href+t.textContent,n=e.length,o=0;for(;n--;)o+=e.charCodeAt(n);return o.toString(36)}(t));return e},sort:function(t,e){var n={},o=this.el;this.toArray().forEach(function(t,e){e=o.children[e];P(e,this.options.draggable,o,!1)&&(n[t]=e)},this),e&&this.captureAnimationState(),t.forEach(function(t){n[t]&&(o.removeChild(n[t]),o.appendChild(n[t]))}),e&&this.animateAll()},save:function(){var t=this.options.store;t&&t.set&&t.set(this)},closest:function(t,e){return P(t,e||this.options.draggable,this.el,!1)},option:function(t,e){var n=this.options;if(void 0===e)return n[t];var o=W.modifyOption(this,t,e);n[t]=void 0!==o?o:e,"group"===t&&kt(n)},destroy:function(){G("destroy",this);var t=this.el;t[K]=null,f(t,"mousedown",this._onTapStart),f(t,"touchstart",this._onTapStart),f(t,"pointerdown",this._onTapStart),this.nativeDraggable&&(f(t,"dragover",this),f(t,"dragenter",this)),Array.prototype.forEach.call(t.querySelectorAll("[draggable]"),function(t){t.removeAttribute("draggable")}),this._onDrop(),this._disableDelayedDragEvents(),Dt.splice(Dt.indexOf(this.el),1),this.el=t=null},_hideClone:function(){nt||(G("hideClone",this),Ft.eventCanceled||(R(et,"display","none"),this.options.removeCloneOnHide&&et.parentNode&&et.parentNode.removeChild(et),nt=!0))},_showClone:function(t){"clone"===t.lastPutMode?nt&&(G("showClone",this),Ft.eventCanceled||(V.parentNode!=Q||this.options.group.revertClone?J?Q.insertBefore(et,J):Q.appendChild(et):Q.insertBefore(et,V),this.options.group.revertClone&&this.animate(V,et),R(et,"display",""),nt=!1)):this._hideClone()}},Ot&&h(document,"touchmove",function(t){(Ft.active||wt)&&t.cancelable&&t.preventDefault()}),Ft.utils={on:h,off:f,css:R,find:b,is:function(t,e){return!!P(t,e,t,!1)},extend:function(t,e){if(t&&e)for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},throttle:S,closest:P,toggleClass:k,clone:_,index:j,nextTick:Kt,cancelNextTick:Wt,detectDirection:Pt,getChild:B},Ft.get=function(t){return t[K]},Ft.mount=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];(e=e[0].constructor===Array?e[0]:e).forEach(function(t){if(!t.prototype||!t.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(t));t.utils&&(Ft.utils=I(I({},Ft.utils),t.utils)),W.mount(t)})},Ft.create=function(t,e){return new Ft(t,e)};var zt,Gt,Ut,qt,Vt,Zt,$t=[],Qt=!(Ft.version="1.15.2");function Jt(){$t.forEach(function(t){clearInterval(t.pid)}),$t=[]}function te(){clearInterval(Zt)}var ee,ne=S(function(n,t,e,o){if(t.scroll){var i,r=(n.touches?n.touches[0]:n).clientX,a=(n.touches?n.touches[0]:n).clientY,l=t.scrollSensitivity,s=t.scrollSpeed,c=O(),u=!1;Gt!==e&&(Gt=e,Jt(),zt=t.scroll,i=t.scrollFn,!0===zt&&(zt=M(e,!0)));var d=0,h=zt;do{var f=h,p=X(f),g=p.top,m=p.bottom,v=p.left,b=p.right,y=p.width,w=p.height,E=void 0,D=void 0,S=f.scrollWidth,_=f.scrollHeight,C=R(f),T=f.scrollLeft,p=f.scrollTop,D=f===c?(E=y<S&&("auto"===C.overflowX||"scroll"===C.overflowX||"visible"===C.overflowX),w<_&&("auto"===C.overflowY||"scroll"===C.overflowY||"visible"===C.overflowY)):(E=y<S&&("auto"===C.overflowX||"scroll"===C.overflowX),w<_&&("auto"===C.overflowY||"scroll"===C.overflowY)),T=E&&(Math.abs(b-r)<=l&&T+y<S)-(Math.abs(v-r)<=l&&!!T),p=D&&(Math.abs(m-a)<=l&&p+w<_)-(Math.abs(g-a)<=l&&!!p);if(!$t[d])for(var x=0;x<=d;x++)$t[x]||($t[x]={});$t[d].vx==T&&$t[d].vy==p&&$t[d].el===f||($t[d].el=f,$t[d].vx=T,$t[d].vy=p,clearInterval($t[d].pid),0==T&&0==p||(u=!0,$t[d].pid=setInterval(function(){o&&0===this.layer&&Ft.active._onTouchMove(Vt);var t=$t[this.layer].vy?$t[this.layer].vy*s:0,e=$t[this.layer].vx?$t[this.layer].vx*s:0;"function"==typeof i&&"continue"!==i.call(Ft.dragged.parentNode[K],e,t,n,Vt,$t[this.layer].el)||H($t[this.layer].el,e,t)}.bind({layer:d}),24))),d++}while(t.bubbleScroll&&h!==c&&(h=M(h,!1)));Qt=u}},30),c=function(t){var e=t.originalEvent,n=t.putSortable,o=t.dragEl,i=t.activeSortable,r=t.dispatchSortableEvent,a=t.hideGhostForTarget,t=t.unhideGhostForTarget;e&&(i=n||i,a(),e=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:e,e=document.elementFromPoint(e.clientX,e.clientY),t(),i&&!i.el.contains(e)&&(r("spill"),this.onSpill({dragEl:o,putSortable:n})))};function oe(){}function ie(){}oe.prototype={startIndex:null,dragStart:function(t){t=t.oldDraggableIndex;this.startIndex=t},onSpill:function(t){var e=t.dragEl,n=t.putSortable;this.sortable.captureAnimationState(),n&&n.captureAnimationState();t=B(this.sortable.el,this.startIndex,this.options);t?this.sortable.el.insertBefore(e,t):this.sortable.el.appendChild(e),this.sortable.animateAll(),n&&n.animateAll()},drop:c},a(oe,{pluginName:"revertOnSpill"}),ie.prototype={onSpill:function(t){var e=t.dragEl,t=t.putSortable||this.sortable;t.captureAnimationState(),e.parentNode&&e.parentNode.removeChild(e),t.animateAll()},drop:c},a(ie,{pluginName:"removeOnSpill"});var re,ae,le,se,ce,ue=[],de=[],he=!1,fe=!1,pe=!1;function ge(n,o){de.forEach(function(t,e){e=o.children[t.sortableIndex+(n?Number(e):0)];e?o.insertBefore(t,e):o.appendChild(t)})}function me(){ue.forEach(function(t){t!==le&&t.parentNode&&t.parentNode.removeChild(t)})}return Ft.mount(new function(){function t(){for(var t in this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0},this)"_"===t.charAt(0)&&"function"==typeof this[t]&&(this[t]=this[t].bind(this))}return t.prototype={dragStarted:function(t){t=t.originalEvent;this.sortable.nativeDraggable?h(document,"dragover",this._handleAutoScroll):this.options.supportPointer?h(document,"pointermove",this._handleFallbackAutoScroll):t.touches?h(document,"touchmove",this._handleFallbackAutoScroll):h(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(t){t=t.originalEvent;this.options.dragOverBubble||t.rootEl||this._handleAutoScroll(t)},drop:function(){this.sortable.nativeDraggable?f(document,"dragover",this._handleAutoScroll):(f(document,"pointermove",this._handleFallbackAutoScroll),f(document,"touchmove",this._handleFallbackAutoScroll),f(document,"mousemove",this._handleFallbackAutoScroll)),te(),Jt(),clearTimeout(g),g=void 0},nulling:function(){Vt=Gt=zt=Qt=Zt=Ut=qt=null,$t.length=0},_handleFallbackAutoScroll:function(t){this._handleAutoScroll(t,!0)},_handleAutoScroll:function(e,n){var o,i=this,r=(e.touches?e.touches[0]:e).clientX,a=(e.touches?e.touches[0]:e).clientY,t=document.elementFromPoint(r,a);Vt=e,n||this.options.forceAutoScrollFallback||w||y||u?(ne(e,this.options,t,n),o=M(t,!0),!Qt||Zt&&r===Ut&&a===qt||(Zt&&te(),Zt=setInterval(function(){var t=M(document.elementFromPoint(r,a),!0);t!==o&&(o=t,Jt()),ne(e,i.options,t,n)},10),Ut=r,qt=a)):this.options.bubbleScroll&&M(t,!0)!==O()?ne(e,this.options,M(t,!1),!1):Jt()}},a(t,{pluginName:"scroll",initializeByDefault:!0})}),Ft.mount(ie,oe),Ft.mount(new function(){function t(){this.defaults={swapClass:"sortable-swap-highlight"}}return t.prototype={dragStart:function(t){t=t.dragEl;ee=t},dragOverValid:function(t){var e=t.completed,n=t.target,o=t.onMove,i=t.activeSortable,r=t.changed,a=t.cancel;i.options.swap&&(t=this.sortable.el,i=this.options,n&&n!==t&&(t=ee,ee=!1!==o(n)?(k(n,i.swapClass,!0),n):null,t&&t!==ee&&k(t,i.swapClass,!1)),r(),e(!0),a())},drop:function(t){var e,n,o=t.activeSortable,i=t.putSortable,r=t.dragEl,a=i||this.sortable,l=this.options;ee&&k(ee,l.swapClass,!1),ee&&(l.swap||i&&i.options.swap)&&r!==ee&&(a.captureAnimationState(),a!==o&&o.captureAnimationState(),n=ee,t=(e=r).parentNode,l=n.parentNode,t&&l&&!t.isEqualNode(n)&&!l.isEqualNode(e)&&(i=j(e),r=j(n),t.isEqualNode(l)&&i<r&&r++,t.insertBefore(n,t.children[i]),l.insertBefore(e,l.children[r])),a.animateAll(),a!==o&&o.animateAll())},nulling:function(){ee=null}},a(t,{pluginName:"swap",eventProperties:function(){return{swapItem:ee}}})}),Ft.mount(new function(){function t(o){for(var t in this)"_"===t.charAt(0)&&"function"==typeof this[t]&&(this[t]=this[t].bind(this));o.options.avoidImplicitDeselect||(o.options.supportPointer?h(document,"pointerup",this._deselectMultiDrag):(h(document,"mouseup",this._deselectMultiDrag),h(document,"touchend",this._deselectMultiDrag))),h(document,"keydown",this._checkKeyDown),h(document,"keyup",this._checkKeyUp),this.defaults={selectedClass:"sortable-selected",multiDragKey:null,avoidImplicitDeselect:!1,setData:function(t,e){var n="";ue.length&&ae===o?ue.forEach(function(t,e){n+=(e?", ":"")+t.textContent}):n=e.textContent,t.setData("Text",n)}}}return t.prototype={multiDragKeyDown:!1,isMultiDrag:!1,delayStartGlobal:function(t){t=t.dragEl;le=t},delayEnded:function(){this.isMultiDrag=~ue.indexOf(le)},setupClone:function(t){var e=t.sortable,t=t.cancel;if(this.isMultiDrag){for(var n=0;n<ue.length;n++)de.push(_(ue[n])),de[n].sortableIndex=ue[n].sortableIndex,de[n].draggable=!1,de[n].style["will-change"]="",k(de[n],this.options.selectedClass,!1),ue[n]===le&&k(de[n],this.options.chosenClass,!1);e._hideClone(),t()}},clone:function(t){var e=t.sortable,n=t.rootEl,o=t.dispatchSortableEvent,t=t.cancel;this.isMultiDrag&&(this.options.removeCloneOnHide||ue.length&&ae===e&&(ge(!0,n),o("clone"),t()))},showClone:function(t){var e=t.cloneNowShown,n=t.rootEl,t=t.cancel;this.isMultiDrag&&(ge(!1,n),de.forEach(function(t){R(t,"display","")}),e(),ce=!1,t())},hideClone:function(t){var e=this,n=(t.sortable,t.cloneNowHidden),t=t.cancel;this.isMultiDrag&&(de.forEach(function(t){R(t,"display","none"),e.options.removeCloneOnHide&&t.parentNode&&t.parentNode.removeChild(t)}),n(),ce=!0,t())},dragStartGlobal:function(t){t.sortable;!this.isMultiDrag&&ae&&ae.multiDrag._deselectMultiDrag(),ue.forEach(function(t){t.sortableIndex=j(t)}),ue=ue.sort(function(t,e){return t.sortableIndex-e.sortableIndex}),pe=!0},dragStarted:function(t){var e,n=this,t=t.sortable;this.isMultiDrag&&(this.options.sort&&(t.captureAnimationState(),this.options.animation&&(ue.forEach(function(t){t!==le&&R(t,"position","absolute")}),e=X(le,!1,!0,!0),ue.forEach(function(t){t!==le&&C(t,e)}),he=fe=!0)),t.animateAll(function(){he=fe=!1,n.options.animation&&ue.forEach(function(t){T(t)}),n.options.sort&&me()}))},dragOver:function(t){var e=t.target,n=t.completed,t=t.cancel;fe&&~ue.indexOf(e)&&(n(!1),t())},revert:function(t){var n,o,e=t.fromSortable,i=t.rootEl,r=t.sortable,a=t.dragRect;1<ue.length&&(ue.forEach(function(t){r.addAnimationState({target:t,rect:fe?X(t):a}),T(t),t.fromRect=a,e.removeAnimationState(t)}),fe=!1,n=!this.options.removeCloneOnHide,o=i,ue.forEach(function(t,e){e=o.children[t.sortableIndex+(n?Number(e):0)];e?o.insertBefore(t,e):o.appendChild(t)}))},dragOverCompleted:function(t){var e,n=t.sortable,o=t.isOwner,i=t.insertion,r=t.activeSortable,a=t.parentEl,l=t.putSortable,t=this.options;i&&(o&&r._hideClone(),he=!1,t.animation&&1<ue.length&&(fe||!o&&!r.options.sort&&!l)&&(e=X(le,!1,!0,!0),ue.forEach(function(t){t!==le&&(C(t,e),a.appendChild(t))}),fe=!0),o||(fe||me(),1<ue.length?(o=ce,r._showClone(n),r.options.animation&&!ce&&o&&de.forEach(function(t){r.addAnimationState({target:t,rect:se}),t.fromRect=se,t.thisAnimationDuration=null})):r._showClone(n)))},dragOverAnimationCapture:function(t){var e=t.dragRect,n=t.isOwner,t=t.activeSortable;ue.forEach(function(t){t.thisAnimationDuration=null}),t.options.animation&&!n&&t.multiDrag.isMultiDrag&&(se=a({},e),e=v(le,!0),se.top-=e.f,se.left-=e.e)},dragOverAnimationComplete:function(){fe&&(fe=!1,me())},drop:function(t){var e=t.originalEvent,n=t.rootEl,o=t.parentEl,i=t.sortable,r=t.dispatchSortableEvent,a=t.oldIndex,l=t.putSortable,s=l||this.sortable;if(e){var c,u,d,h=this.options,f=o.children;if(!pe)if(h.multiDragKey&&!this.multiDragKeyDown&&this._deselectMultiDrag(),k(le,h.selectedClass,!~ue.indexOf(le)),~ue.indexOf(le))ue.splice(ue.indexOf(le),1),re=null,z({sortable:i,rootEl:n,name:"deselect",targetEl:le,originalEvent:e});else{if(ue.push(le),z({sortable:i,rootEl:n,name:"select",targetEl:le,originalEvent:e}),e.shiftKey&&re&&i.el.contains(re)){var p=j(re),t=j(le);if(~p&&~t&&p!==t)for(var g,m=p<t?(g=p,t):(g=t,p+1);g<m;g++)~ue.indexOf(f[g])||(k(f[g],h.selectedClass,!0),ue.push(f[g]),z({sortable:i,rootEl:n,name:"select",targetEl:f[g],originalEvent:e}))}else re=le;ae=s}pe&&this.isMultiDrag&&(fe=!1,(o[K].options.sort||o!==n)&&1<ue.length&&(c=X(le),u=j(le,":not(."+this.options.selectedClass+")"),!he&&h.animation&&(le.thisAnimationDuration=null),s.captureAnimationState(),he||(h.animation&&(le.fromRect=c,ue.forEach(function(t){var e;t.thisAnimationDuration=null,t!==le&&(e=fe?X(t):c,t.fromRect=e,s.addAnimationState({target:t,rect:e}))})),me(),ue.forEach(function(t){f[u]?o.insertBefore(t,f[u]):o.appendChild(t),u++}),a===j(le)&&(d=!1,ue.forEach(function(t){t.sortableIndex!==j(t)&&(d=!0)}),d&&(r("update"),r("sort")))),ue.forEach(function(t){T(t)}),s.animateAll()),ae=s),(n===o||l&&"clone"!==l.lastPutMode)&&de.forEach(function(t){t.parentNode&&t.parentNode.removeChild(t)})}},nullingGlobal:function(){this.isMultiDrag=pe=!1,de.length=0},destroyGlobal:function(){this._deselectMultiDrag(),f(document,"pointerup",this._deselectMultiDrag),f(document,"mouseup",this._deselectMultiDrag),f(document,"touchend",this._deselectMultiDrag),f(document,"keydown",this._checkKeyDown),f(document,"keyup",this._checkKeyUp)},_deselectMultiDrag:function(t){if(!(void 0!==pe&&pe||ae!==this.sortable||t&&P(t.target,this.options.draggable,this.sortable.el,!1)||t&&0!==t.button))for(;ue.length;){var e=ue[0];k(e,this.options.selectedClass,!1),ue.shift(),z({sortable:this.sortable,rootEl:this.sortable.el,name:"deselect",targetEl:e,originalEvent:t})}},_checkKeyDown:function(t){t.key===this.options.multiDragKey&&(this.multiDragKeyDown=!0)},_checkKeyUp:function(t){t.key===this.options.multiDragKey&&(this.multiDragKeyDown=!1)}},a(t,{pluginName:"multiDrag",utils:{select:function(t){var e=t.parentNode[K];e&&e.options.multiDrag&&!~ue.indexOf(t)&&(ae&&ae!==e&&(ae.multiDrag._deselectMultiDrag(),ae=e),k(t,e.options.selectedClass,!0),ue.push(t))},deselect:function(t){var e=t.parentNode[K],n=ue.indexOf(t);e&&e.options.multiDrag&&~n&&(k(t,e.options.selectedClass,!1),ue.splice(n,1))}},eventProperties:function(){var n=this,o=[],i=[];return ue.forEach(function(t){var e;o.push({multiDragElement:t,index:t.sortableIndex}),e=fe&&t!==le?-1:fe?j(t,":not(."+n.options.selectedClass+")"):j(t),i.push({multiDragElement:t,index:e})}),{items:r(ue),clones:[].concat(de),oldIndicies:o,newIndicies:i}},optionListeners:{multiDragKey:function(t){return"ctrl"===(t=t.toLowerCase())?t="Control":1<t.length&&(t=t.charAt(0).toUpperCase()+t.substr(1)),t}}})}),Ft});</script>
  

</head>

<body>
<header class="toolbar">
  <div class="title-wrap">
    <h1>Truth Capsule Viewer & Prompt Composer</h1>
    <div class="small" style="font-size:12px;margin-top:4px;">Generated 2025-11-10T21:47:02.287613Z</div>
  </div>

  <nav class="toolbar-actions">

    <!-- Group 1: Prompt (primary = Copy; extras in dropdown) -->
    <div class="group">
      <button style="display:none;" class="btn" id="composeBtn" title="Compose (Ctrl/Cmd+Enter)">🟢 Compose</button>
      <button class="btn" id="copyBtn" title="Copy prompt">📋 Copy</button>
      <details class="menu">
        <summary class="btn icon" title="More prompt actions">▾</summary>
        <div class="menu-list">
          <button class="menu-item" id="dlBtn" title="Download prompt">⬇️ Download Prompt</button>
          <button class="menu-item" id="copyLlmBtn" title="Copy LLM command">💻 Copy LLM Bash</button>
          <button class="menu-item" id="shareLinkBtn" title="Copy shareable link">🔗 Share Deeplink</button>
        </div>
      </details>
    </div>

    <!-- Group 2: Manifests (primary = Save; dropdown holds Select, Load, Delete, JSON I/O) -->
    <div class="group">
      <button class="btn" id="manifestSaveBtn" title="Save manifest to this browser">💾 Save</button>
      <details class="menu">
        <summary class="btn icon" title="More manifest actions">▾</summary>
        <div class="menu-list" style="min-width:280px">
          <div class="menu-field">
            <label class="small muted" for="manifestSelect" style="display:block;margin-bottom:4px;">Saved manifests</label>
            <select id="manifestSelect" title="Saved manifests" style="width:100%"></select>
          </div>
          <div class="menu-row">
            <button class="menu-item" id="manifestLoadBtn" title="Load selected manifest">📂 Load</button>
            <button class="menu-item warn" id="manifestDeleteBtn" title="Delete selected manifest">🗑️ Delete</button>
          </div>
          <hr class="menu-sep">
          <button class="menu-item" id="dlJsonBtn" title="Download manifest JSON">⬇️ Download JSON Manifest</button>
          <button class="menu-item" id="loadJsonBtn" title="Load manifest JSON">⬆️ Load JSON Manifest</button>
        </div>
      </details>
    </div>

    <!-- Group 3: Tools (quick actions) -->
    <div class="group">
      <button class="btn icon" id="validateAllBtn" title="Validate digests for selected">🔐</button>
      <button class="btn icon warn" id="clearBtn" title="Clear selection">🧹</button>
    </div>

    <!-- Theme -->
    <button class="btn icon" id="themeBtn" title="Toggle theme" aria-label="Toggle color theme">🌙</button>
  </nav>
</header>


  <main>
    <div id="split">
      <!-- LEFT COLUMN -->
      <aside id="left">
        <div id="leftTop">
  <input id="search" type="text" placeholder="Filter by id/title/domain/statement…" style="width:100%">

<div class="row" style="margin-top:10px; align-items:center; gap:8px">
  <label for="profiles" class="section-title">PROFILES</label>
  <button id="profileInfo" class="icon-btn" type="button" aria-haspopup="dialog" aria-expanded="false" title="What are Profiles?">?</button>
  <select id="profiles"></select>
</div>

<div id="profileDesc" class="small muted" style="margin-top:4px"></div>

<div id="profileHelp" class="help-box" hidden>
  <div class="help-title">What are Profiles?</div>
  <p class="small">
    Profiles are presets for a specific use-case (e.g., CI Judge, Code Patch, PR Review).
    A profile sets the basic <em>system prompt</em> and which <em>capsule properties/policies</em> are applied (visible).
    Switching profiles does not modify your capsule library; it only changes the composed rules for this run.
  </p>
</div>

</div>




        <!-- RESIZABLE HORIZONTAL SPLIT: Bundles ⟷ Capsules -->
        <div id="leftSplit">
          <div id="bundlesWrap" class="section-block">
            <div id="bundlesPanel" class="collapsible">
              <div class="collapsible-header">
                <span class="section-title">BUNDLES (<span id="bundlesCount">0</span>)</span>
                <span class="domain-spacer"></span>
                <button id="bundlesToggle" class="btn small" type="button" aria-expanded="true">Hide</button>
              </div>
              <div id="bundlesBody" class="collapsible-body">
                <div id="bundles" class="list"></div>
              </div>
            </div>
          </div>



          <div id="capsulesWrap" class="section-block">
            <div style="padding-left:12px; padding-right:12px;" class="section-title">
              CAPSULES (<span id="capsulesCount">0</span>)
              <span style="float:right; display:flex; gap:6px;">
                <button class="btn small" id="expandAllBtn">Expand all</button>
                <button class="btn small" id="collapseAllBtn">Collapse all</button>
              </span>
            </div>
            <div id="capsules" class="list"></div>
          </div>
        </div>
      </aside>

      <!-- RIGHT COLUMN -->
      <section id="right">
        <div class="card">
          <div class="row">
            <label><input type="checkbox" id="includePed" checked> include pedagogy</label>
            <label><input type="checkbox" id="markdown"> markdown preview</label>
            <span class="small">Drag to reorder in Preview</span>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>COMPOSED SYSTEM PROMPT</strong>
          </div>
          <textarea id="out" style="margin-top:5px;"></textarea>
        </div>

        <div class="card">
          <strong>PREVIEW – SELECTED CAPSULES (DRAG TO REORDER)</strong>
          <div id="preview" style="margin-top:5px;" class="list"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Capsule modal (YAML highlighted) -->
  <div id="modal">
    <div class="modal-inner">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="m_title">Capsule</strong>
        <button class="btn small" id="m_close">Close</button>
      </div>
      <div class="row" style="margin:6px 0">
        <button class="btn small" id="m_copy_yaml">Copy YAML</button>
        <button class="btn small" id="m_copy_prov">Copy Provenance</button>
        <button class="btn small" id="m_validate">Validate Digest</button>
        <span id="m_result" class="badge">idle</span>
      </div>
      <pre><code id="m_body_code" class="language-yaml"></code></pre>
    </div>
  </div>

  <!-- LLM Command modal -->
  <div id="llmModal">
    <div class="modal-inner">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Copy LLM Command</strong>
        <div style="margin-top:-3px; font-weight:bolder;">⚠️ bash only - requires the awesome <a style="color:#7aa2ff"
            target="_blank" href="https://llm.datasette.io/en/stable/">llm</a> python package</div>
        <button class="btn small" id="llm_close">Close</button>
      </div>

      <div class="form-row">
        <label for="llm_template">Template:</label>
        <select id="llm_template"></select>
        <div class="hint" id="llm_template_desc"></div>
      </div>

      <div class="form-row" id="llm_input_row">
        <label for="llm_user_input">User input:</label>
        <textarea id="llm_user_input" placeholder="Enter your prompt/question here..."></textarea>
        <div class="hint" id="llm_input_hint"></div>
      </div>

      <div class="form-row" id="llm_file_row" style="display:none">
        <label for="llm_file_path">File path:</label>
        <input type="text" id="llm_file_path" placeholder="/path/to/input.txt" value="input.txt">
      </div>

      <div class="form-row">
        <label>
          <input type="checkbox" id="llm_minify">
          Minify system prompt (collapse whitespace to single line)
        </label>
        <div class="hint">Minification removes newlines and extra spaces. May affect formatting.</div>
      </div>

      <div class="form-row">
        <label for="llm_preview">Generated shell command: (⚠️ <u>always sanity check what you execute in your shell!</u>)</label>
        <textarea id="llm_preview" readonly
          style="min-height:200px;font-family:monospace;font-size:12px;background:var(--bg);color:var(--text)"></textarea>
        <div class="hint">This is what will be copied to your clipboard</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="llm_copy">📋 Copy Command</button>
        <button class="btn" id="llm_save">💾 Save Script</button>
        <button class="btn" id="llm_cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script id="tc-data" type="application/json">{
  "capsules": {
    "llm.citation_required_v1": {
      "id": "llm.citation_required_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Citations required",
      "statement": "Answers must include at least one citation or abstain.",
      "assumptions": [
        "Operating in a general context"
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What evidence supports this claim?"
        },
        {
          "kind": "Aphorism",
          "text": "Cite or abstain."
        }
      ],
      "witnesses": [
        {
          "name": "citations_cover_claims",
          "language": "python",
          "env": {
            "ANSWER_PATH": "artifacts/examples/answer_with_citation.json",
            "COVERAGE_MIN": "0.6",
            "DIVERSITY_MAX": "0.7",
            "ALLOWLIST": "doi.org,arxiv.org,acm.org,ieee.org,nature.com,sciencemag.org,gov,edu",
            "DOC_CLASS": ""
          },
          "code": "import os, re, json, sys, pathlib\nfrom urllib.parse import urlparse\n\nap = pathlib.Path(os.getenv(\"ANSWER_PATH\",\"\")).resolve()\nif not ap.exists():\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"file-not-found\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\n# Opinion content can SKIP (policy-controlled)\nif os.getenv(\"DOC_CLASS\",\"\").lower() == \"opinion\":\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"SKIP\",\"reason\":\"opinion-doc\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(0)\n\ndata = json.loads(ap.read_text(encoding=\"utf-8\"))\nanswer = (data.get(\"answer\") or \"\").strip()\nrefs = data.get(\"references\") or []\n\n# Very light sentence segmentation (declarative-ish)\nsentences = [s.strip() for s in re.split(r'(?<=[.!?])\\s+', answer) if s.strip()]\n# Extract [n] citations\ncite_pat = re.compile(r'\\[(\\d+)\\]')\ncited_flags = [bool(cite_pat.search(s)) for s in sentences]\ntotal = len(sentences)\ncited = sum(cited_flags)\n\n# Build ref index and domains\nref_by_id = {int(r.get(\"id\")): r for r in refs if isinstance(r.get(\"id\"), int) and r.get(\"url\")}\ndomains = []\nfor r in refs:\n    try:\n        host = urlparse(r.get(\"url\",\"\")).netloc.lower()\n        if host: domains.append(host)\n    except Exception:\n        pass\n\n# Policies\nCOVERAGE_MIN = float(os.getenv(\"COVERAGE_MIN\",\"0.6\"))\nDIVERSITY_MAX = float(os.getenv(\"DIVERSITY_MAX\",\"0.7\"))\nALLOWLIST = [d.strip().lower() for d in os.getenv(\"ALLOWLIST\",\"\").split(\",\") if d.strip()]\n\ndef domain_class(host):\n    if host.endswith(\".gov\") or host.endswith(\".edu\") or host in ALLOWLIST or any(host.endswith(d) for d in ALLOWLIST):\n        return \"preferred\"\n    return \"other\"\n\n# Reference integrity checks\n# 1) No citations at all → FAIL (unless no declaratives → SKIP)\nif total == 0:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"SKIP\",\"reason\":\"no-declaratives\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(0)\n\nfound_cites = [int(n) for n in cite_pat.findall(answer)]\nif not found_cites:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"no-citations\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\n# 2) Every [n] must exist in references\nmissing_map = sorted({n for n in set(found_cites) if n not in ref_by_id})\nif missing_map:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"missing-refs\",\"missing_ids\":missing_map,\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\n# 3) Sequential numbering starting at 1 (soft check)\nif ref_by_id and (min(ref_by_id) != 1 or max(ref_by_id) != len(ref_by_id)):\n    # Not fatal, but record as warning in output payload\n    numbering_warn = True\nelse:\n    numbering_warn = False\n\n# 4) Coverage threshold\ncoverage = cited/total if total else 0.0\nif coverage < COVERAGE_MIN:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"coverage-too-low\",\"coverage\":coverage,\"min\":COVERAGE_MIN,\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\n# 5) Diversity (prevent single-domain echo chamber)\nfrom collections import Counter\ndom_counts = Counter(domains)\nif dom_counts:\n    top_dom, top_cnt = dom_counts.most_common(1)[0]\n    if top_cnt/len(domains) > DIVERSITY_MAX:\n        print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"source-too-concentrated\",\"top_domain\":top_dom,\"share\":top_cnt/len(domains),\"max\":DIVERSITY_MAX,\"inputs\":{\"answer\":str(ap)}}))\n        sys.exit(1)\n\n    # Disallow all-wikipedia (or single non-preferred domain) cases\n    if len(dom_counts) == 1 and (\"wikipedia.org\" in dom_counts):\n        print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"all-wikipedia\",\"inputs\":{\"answer\":str(ap)}}))\n        sys.exit(1)\n\n# 6) Allowlist presence (at least one preferred or academic/governmental source)\nhas_pref = any(domain_class(h)==\"preferred\" for h in domains)\nif not has_pref and refs:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"no-preferred-sources\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\nout = {\n    \"witness\":\"citations_cover_claims\",\n    \"status\":\"PASS\",\n    \"coverage\": coverage,\n    \"sequential_numbering_warn\": numbering_warn,\n    \"totals\":{\"sentences\": total, \"cited\": cited, \"refs\": len(refs)},\n    \"inputs\":{\"answer\": str(ap)}\n}\nprint(json.dumps(out, indent=2))\nsys.exit(0)"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:53:50.511776Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "0a51607ced8bd646d4a3bcaf8fa3c8ef4c5519afe87615669c6ad389d725cb39",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.citation_required_v1.yaml",
      "_raw": "id: llm.citation_required_v1\nversion: 1.0.0\ndomain: llm\ntitle: Citations required\nstatement: Answers must include at least one citation or abstain.\nassumptions:\n- Operating in a general context\npedagogy:\n- kind: Socratic\n  text: What evidence supports this claim?\n- kind: Aphorism\n  text: Cite or abstain.\nwitnesses:\n  - name: citations_cover_claims\n    language: python\n    env:\n      ANSWER_PATH: artifacts/examples/answer_with_citation.json\n      COVERAGE_MIN: \"0.6\"         # ≥60% declarative sentences must be cited\n      DIVERSITY_MAX: \"0.7\"         # ≤70% of refs may come from one domain\n      ALLOWLIST: \"doi.org,arxiv.org,acm.org,ieee.org,nature.com,sciencemag.org,gov,edu\"\n      DOC_CLASS: \"\"                # set to \"opinion\" to SKIP\n    code: |-\n      import os, re, json, sys, pathlib\n      from urllib.parse import urlparse\n\n      ap = pathlib.Path(os.getenv(\"ANSWER_PATH\",\"\")).resolve()\n      if not ap.exists():\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"file-not-found\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      # Opinion content can SKIP (policy-controlled)\n      if os.getenv(\"DOC_CLASS\",\"\").lower() == \"opinion\":\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"SKIP\",\"reason\":\"opinion-doc\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(0)\n\n      data = json.loads(ap.read_text(encoding=\"utf-8\"))\n      answer = (data.get(\"answer\") or \"\").strip()\n      refs = data.get(\"references\") or []\n\n      # Very light sentence segmentation (declarative-ish)\n      sentences = [s.strip() for s in re.split(r'(?<=[.!?])\\s+', answer) if s.strip()]\n      # Extract [n] citations\n      cite_pat = re.compile(r'\\[(\\d+)\\]')\n      cited_flags = [bool(cite_pat.search(s)) for s in sentences]\n      total = len(sentences)\n      cited = sum(cited_flags)\n\n      # Build ref index and domains\n      ref_by_id = {int(r.get(\"id\")): r for r in refs if isinstance(r.get(\"id\"), int) and r.get(\"url\")}\n      domains = []\n      for r in refs:\n          try:\n              host = urlparse(r.get(\"url\",\"\")).netloc.lower()\n              if host: domains.append(host)\n          except Exception:\n              pass\n\n      # Policies\n      COVERAGE_MIN = float(os.getenv(\"COVERAGE_MIN\",\"0.6\"))\n      DIVERSITY_MAX = float(os.getenv(\"DIVERSITY_MAX\",\"0.7\"))\n      ALLOWLIST = [d.strip().lower() for d in os.getenv(\"ALLOWLIST\",\"\").split(\",\") if d.strip()]\n\n      def domain_class(host):\n          if host.endswith(\".gov\") or host.endswith(\".edu\") or host in ALLOWLIST or any(host.endswith(d) for d in ALLOWLIST):\n              return \"preferred\"\n          return \"other\"\n\n      # Reference integrity checks\n      # 1) No citations at all → FAIL (unless no declaratives → SKIP)\n      if total == 0:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"SKIP\",\"reason\":\"no-declaratives\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(0)\n\n      found_cites = [int(n) for n in cite_pat.findall(answer)]\n      if not found_cites:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"no-citations\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      # 2) Every [n] must exist in references\n      missing_map = sorted({n for n in set(found_cites) if n not in ref_by_id})\n      if missing_map:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"missing-refs\",\"missing_ids\":missing_map,\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      # 3) Sequential numbering starting at 1 (soft check)\n      if ref_by_id and (min(ref_by_id) != 1 or max(ref_by_id) != len(ref_by_id)):\n          # Not fatal, but record as warning in output payload\n          numbering_warn = True\n      else:\n          numbering_warn = False\n\n      # 4) Coverage threshold\n      coverage = cited/total if total else 0.0\n      if coverage < COVERAGE_MIN:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"coverage-too-low\",\"coverage\":coverage,\"min\":COVERAGE_MIN,\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      # 5) Diversity (prevent single-domain echo chamber)\n      from collections import Counter\n      dom_counts = Counter(domains)\n      if dom_counts:\n          top_dom, top_cnt = dom_counts.most_common(1)[0]\n          if top_cnt/len(domains) > DIVERSITY_MAX:\n              print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"source-too-concentrated\",\"top_domain\":top_dom,\"share\":top_cnt/len(domains),\"max\":DIVERSITY_MAX,\"inputs\":{\"answer\":str(ap)}}))\n              sys.exit(1)\n\n          # Disallow all-wikipedia (or single non-preferred domain) cases\n          if len(dom_counts) == 1 and (\"wikipedia.org\" in dom_counts):\n              print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"all-wikipedia\",\"inputs\":{\"answer\":str(ap)}}))\n              sys.exit(1)\n\n      # 6) Allowlist presence (at least one preferred or academic/governmental source)\n      has_pref = any(domain_class(h)==\"preferred\" for h in domains)\n      if not has_pref and refs:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"no-preferred-sources\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      out = {\n          \"witness\":\"citations_cover_claims\",\n          \"status\":\"PASS\",\n          \"coverage\": coverage,\n          \"sequential_numbering_warn\": numbering_warn,\n          \"totals\":{\"sentences\": total, \"cited\": cited, \"refs\": len(refs)},\n          \"inputs\":{\"answer\": str(ap)}\n      }\n      print(json.dumps(out, indent=2))\n      sys.exit(0)\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:53:50.511776Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 0a51607ced8bd646d4a3bcaf8fa3c8ef4c5519afe87615669c6ad389d725cb39\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "pedagogy.problem_solving_v1": {
      "id": "pedagogy.problem_solving_v1",
      "version": "1.0.0",
      "title": "Five-step problem-solving discipline",
      "domain": "pedagogy",
      "statement": "A valid solution includes: (1) objective, (2) assumptions, (3) plan, (4) evidence, (5) summary with trade-offs and next step.",
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What is the concrete objective and success criteria?"
        },
        {
          "kind": "Aphorism",
          "text": "One small experiment beats a thousand meetings."
        }
      ],
      "witnesses": [
        {
          "name": "five_step_gate",
          "language": "python",
          "code": "import json, os\n\np = os.getenv(\"PS_REPORT\", \"artifacts/examples/problem_solving_ok.json\")\n\nr = json.load(open(p))\n\nneed = [\"objective\",\"assumptions\",\"plan\",\"evidence\",\"summary\"]\n\nmissing = [k for k in need if not r.get(k)]\n\nassert not missing, f\"Missing fields: {missing}\"\n\nassert isinstance(r[\"assumptions\"], list) and len(r[\"assumptions\"])>=1\n\nassert isinstance(r[\"evidence\"], list) and any(len(str(e))>=10 for e in r[\"evidence\"])"
        }
      ],
      "provenance": {
        "author": "Truth Capsules",
        "license": "MIT",
        "schema": "provenance.v1",
        "org": "Truth Capsules Demo",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:53:50.511776Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "b797a413841b047de9564e761934526f7b6b22d98b284aa418d4f2775e099a8a",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/pedagogy.problem_solving_v1.yaml",
      "_raw": "id: pedagogy.problem_solving_v1\nversion: 1.0.0\ntitle: Five-step problem-solving discipline\ndomain: pedagogy\nstatement: 'A valid solution includes: (1) objective, (2) assumptions, (3) plan, (4)\n  evidence, (5) summary with trade-offs and next step.'\npedagogy:\n- kind: Socratic\n  text: What is the concrete objective and success criteria?\n- kind: Aphorism\n  text: One small experiment beats a thousand meetings.\nwitnesses:\n- name: five_step_gate\n  language: python\n  code: 'import json, os\n\n\n    p = os.getenv(\"PS_REPORT\", \"artifacts/examples/problem_solving_ok.json\")\n\n\n    r = json.load(open(p))\n\n\n    need = [\"objective\",\"assumptions\",\"plan\",\"evidence\",\"summary\"]\n\n\n    missing = [k for k in need if not r.get(k)]\n\n\n    assert not missing, f\"Missing fields: {missing}\"\n\n\n    assert isinstance(r[\"assumptions\"], list) and len(r[\"assumptions\"])>=1\n\n\n    assert isinstance(r[\"evidence\"], list) and any(len(str(e))>=10 for e in r[\"evidence\"])'\nprovenance:\n  author: Truth Capsules\n  license: MIT\n  schema: provenance.v1\n  org: Truth Capsules Demo\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:53:50.511776Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: b797a413841b047de9564e761934526f7b6b22d98b284aa418d4f2775e099a8a\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.container_hardening_v1": {
      "id": "ci.container_hardening_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "Container Hardening — Non-Root + No-Cache + Version Pins",
      "statement": "The Dockerfile must:\n  1) drop privileges with a non-root USER,\n  2) avoid build-time caches for package managers (e.g., pip --no-cache-dir or apt lists cleanup),\n  3) pin versions for installed packages (e.g., pip ==, apt package=version).",
      "witnesses": [
        {
          "name": "dockerfile_has_nonroot_nocache_pins",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "DOCKERFILE_PATH": "artifacts/examples/ci/Dockerfile"
          },
          "timeout_ms": 5000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, sys, json, re\n\ndef read(path):\n    with open(path, \"r\", errors=\"ignore\") as f:\n        return f.read()\n\ndef has_nonroot_user(text):\n    for m in re.finditer(r\"^\\s*USER\\s+(.+)$\", text, flags=re.M|re.I):\n        val = m.group(1).strip()\n        if re.match(r\"(?i)root\\b|0\\b\", val):\n            return False\n        return True\n    return False\n\ndef has_no_cache(text):\n    patterns = [\n        r\"pip\\s+install[^\\n]*--no-cache-dir\",\n        r\"apt-get\\s+update[^\\n]*\\n[^\\n]*apt-get\\s+install[^\\n]*\\n[^\\n]*rm\\s+-rf\\s+/var/lib/apt/lists/\"\n    ]\n    return any(re.search(p, text, flags=re.I|re.S) for p in patterns)\n\ndef has_version_pins(text):\n    return bool(re.search(r\"==\\d+\\.\\d+|=\\d+\\.\\d+\", text))\n\ndef main():\n    path = os.environ.get(\"DOCKERFILE_PATH\", \"artifacts/examples/ci/Dockerfile\")\n    content = read(path)\n\n    res = {\n        \"nonroot_user\": has_nonroot_user(content),\n        \"no_cache\": has_no_cache(content),\n        \"version_pins\": has_version_pins(content),\n        \"path\": path\n    }\n    res[\"ok\"] = res[\"nonroot_user\"] and res[\"no_cache\"] and res[\"version_pins\"]\n    print(json.dumps(res, indent=2))\n    sys.exit(0 if res[\"ok\"] else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.container_hardening_v1.yaml",
      "_raw": "id: ci.container_hardening_v1\nversion: 1.0.0\ndomain: ci\ntitle: Container Hardening — Non-Root + No-Cache + Version Pins\nstatement: |-\n  The Dockerfile must:\n    1) drop privileges with a non-root USER,\n    2) avoid build-time caches for package managers (e.g., pip --no-cache-dir or apt lists cleanup),\n    3) pin versions for installed packages (e.g., pip ==, apt package=version).\n\nwitnesses:\n  - name: dockerfile_has_nonroot_nocache_pins\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      DOCKERFILE_PATH: artifacts/examples/ci/Dockerfile\n    timeout_ms: 5000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, sys, json, re\n\n      def read(path):\n          with open(path, \"r\", errors=\"ignore\") as f:\n              return f.read()\n\n      def has_nonroot_user(text):\n          for m in re.finditer(r\"^\\s*USER\\s+(.+)$\", text, flags=re.M|re.I):\n              val = m.group(1).strip()\n              if re.match(r\"(?i)root\\b|0\\b\", val):\n                  return False\n              return True\n          return False\n\n      def has_no_cache(text):\n          patterns = [\n              r\"pip\\s+install[^\\n]*--no-cache-dir\",\n              r\"apt-get\\s+update[^\\n]*\\n[^\\n]*apt-get\\s+install[^\\n]*\\n[^\\n]*rm\\s+-rf\\s+/var/lib/apt/lists/\"\n          ]\n          return any(re.search(p, text, flags=re.I|re.S) for p in patterns)\n\n      def has_version_pins(text):\n          return bool(re.search(r\"==\\d+\\.\\d+|=\\d+\\.\\d+\", text))\n\n      def main():\n          path = os.environ.get(\"DOCKERFILE_PATH\", \"artifacts/examples/ci/Dockerfile\")\n          content = read(path)\n\n          res = {\n              \"nonroot_user\": has_nonroot_user(content),\n              \"no_cache\": has_no_cache(content),\n              \"version_pins\": has_version_pins(content),\n              \"path\": path\n          }\n          res[\"ok\"] = res[\"nonroot_user\"] and res[\"no_cache\"] and res[\"version_pins\"]\n          print(json.dumps(res, indent=2))\n          sys.exit(0 if res[\"ok\"] else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.license_compliance_v1": {
      "id": "ci.license_compliance_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "License Compliance — Allowlist Only",
      "statement": "All package licenses in the SBOM must be on an allowlist. Fail on any package with a disallowed or unknown license.",
      "witnesses": [
        {
          "name": "spdx_allowlist_only",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "SBOM_PATH": "artifacts/examples/ci/sbom.json",
            "ALLOWED_LICENSES_JSON": "[\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"]"
          },
          "timeout_ms": 5000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, json, sys, re\n\ndef load_json(path):\n    with open(path, \"r\", errors=\"ignore\") as f:\n        return json.load(f)\n\ndef collect_licenses(sbom):\n    found = []\n\n    comps = sbom.get(\"components\") or []\n    for c in comps:\n        if \"licenses\" in c and isinstance(c[\"licenses\"], list):\n            for it in c[\"licenses\"]:\n                lic = it.get(\"license\") if isinstance(it, dict) else None\n                if isinstance(lic, dict):\n                    if \"id\" in lic:\n                        found.append(lic[\"id\"])\n                    elif \"name\" in lic:\n                        found.append(lic[\"name\"])\n        if \"license\" in c and isinstance(c[\"license\"], (str, dict)):\n            if isinstance(c[\"license\"], str):\n                found.append(c[\"license\"])\n            else:\n                found.append(c[\"license\"].get(\"id\") or c[\"license\"].get(\"name\"))\n\n    pkgs = sbom.get(\"packages\") or []\n    for p in pkgs:\n        for key in (\"licenseConcluded\", \"licenseDeclared\", \"license\"):\n            if key in p and p[key]:\n                found.append(p[key])\n\n    text = json.dumps(sbom, ensure_ascii=False)\n    for m in re.findall(r'\\b([A-Za-z0-9\\-\\.\\+]+-?(License)?)\\b', text):\n        token = m[0]\n        if any(ch.isdigit() for ch in token) or \"-\" in token:\n            found.append(token)\n\n    return [s for s in { (s or \"\").strip() for s in found } if s]\n\ndef main():\n    sbom_path = os.environ.get(\"SBOM_PATH\", \"artifacts/examples/ci/sbom.json\")\n    allow_json = os.environ.get(\"ALLOWED_LICENSES_JSON\", '[\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"]')\n    try:\n        allow = set(json.loads(allow_json))\n    except Exception:\n        allow = set([\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"])\n\n    try:\n        sbom = load_json(sbom_path)\n        licenses = collect_licenses(sbom)\n    except Exception as e:\n        print(json.dumps({\"ok\": False, \"error\": str(e), \"sbom_path\": sbom_path}, indent=2))\n        sys.exit(1)\n\n    unknown = [lic for lic in licenses if lic not in allow]\n    result = {\"ok\": len(unknown) == 0, \"licenses\": sorted(set(licenses)), \"disallowed\": sorted(set(unknown)), \"allowlist\": sorted(allow)}\n    print(json.dumps(result, indent=2))\n    sys.exit(0 if result[\"ok\"] else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.license_compliance_v1.yaml",
      "_raw": "id: ci.license_compliance_v1\nversion: 1.0.0\ndomain: ci\ntitle: License Compliance — Allowlist Only\nstatement: |-\n  All package licenses in the SBOM must be on an allowlist. Fail on any package with a disallowed or unknown license.\n\nwitnesses:\n  - name: spdx_allowlist_only\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      SBOM_PATH: artifacts/examples/ci/sbom.json\n      ALLOWED_LICENSES_JSON: '[\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"]'\n    timeout_ms: 5000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, json, sys, re\n\n      def load_json(path):\n          with open(path, \"r\", errors=\"ignore\") as f:\n              return json.load(f)\n\n      def collect_licenses(sbom):\n          found = []\n\n          comps = sbom.get(\"components\") or []\n          for c in comps:\n              if \"licenses\" in c and isinstance(c[\"licenses\"], list):\n                  for it in c[\"licenses\"]:\n                      lic = it.get(\"license\") if isinstance(it, dict) else None\n                      if isinstance(lic, dict):\n                          if \"id\" in lic:\n                              found.append(lic[\"id\"])\n                          elif \"name\" in lic:\n                              found.append(lic[\"name\"])\n              if \"license\" in c and isinstance(c[\"license\"], (str, dict)):\n                  if isinstance(c[\"license\"], str):\n                      found.append(c[\"license\"])\n                  else:\n                      found.append(c[\"license\"].get(\"id\") or c[\"license\"].get(\"name\"))\n\n          pkgs = sbom.get(\"packages\") or []\n          for p in pkgs:\n              for key in (\"licenseConcluded\", \"licenseDeclared\", \"license\"):\n                  if key in p and p[key]:\n                      found.append(p[key])\n\n          text = json.dumps(sbom, ensure_ascii=False)\n          for m in re.findall(r'\\b([A-Za-z0-9\\-\\.\\+]+-?(License)?)\\b', text):\n              token = m[0]\n              if any(ch.isdigit() for ch in token) or \"-\" in token:\n                  found.append(token)\n\n          return [s for s in { (s or \"\").strip() for s in found } if s]\n\n      def main():\n          sbom_path = os.environ.get(\"SBOM_PATH\", \"artifacts/examples/ci/sbom.json\")\n          allow_json = os.environ.get(\"ALLOWED_LICENSES_JSON\", '[\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"]')\n          try:\n              allow = set(json.loads(allow_json))\n          except Exception:\n              allow = set([\"MIT\",\"Apache-2.0\",\"BSD-3-Clause\",\"BSD-2-Clause\",\"ISC\",\"Python-2.0\"])\n\n          try:\n              sbom = load_json(sbom_path)\n              licenses = collect_licenses(sbom)\n          except Exception as e:\n              print(json.dumps({\"ok\": False, \"error\": str(e), \"sbom_path\": sbom_path}, indent=2))\n              sys.exit(1)\n\n          unknown = [lic for lic in licenses if lic not in allow]\n          result = {\"ok\": len(unknown) == 0, \"licenses\": sorted(set(licenses)), \"disallowed\": sorted(set(unknown)), \"allowlist\": sorted(allow)}\n          print(json.dumps(result, indent=2))\n          sys.exit(0 if result[\"ok\"] else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.secrets_in_build_env_v1": {
      "id": "ci.secrets_in_build_env_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "Build Environment — No Secrets in Env Dump",
      "statement": "The build environment dump must not contain forbidden keys. Fail if any env var key matches a forbidden prefix or exact name.",
      "witnesses": [
        {
          "name": "no_forbidden_env_keys",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "ENV_DUMP_PATH": "artifacts/examples/ci/env_dump.txt",
            "FORBIDDEN_PREFIXES_JSON": "[\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]"
          },
          "timeout_ms": 4000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, sys, json\n\ndef parse_env_dump(path):\n    env = {}\n    with open(path, \"r\", errors=\"ignore\") as f:\n        for line in f:\n            line = line.strip()\n            if not line or line.startswith(\"#\"):\n                continue\n            if \"=\" in line:\n                k, v = line.split(\"=\", 1)\n                env[k.strip()] = v.strip()\n    return env\n\ndef main():\n    dump = os.environ.get(\"ENV_DUMP_PATH\", \"artifacts/examples/ci/env_dump.txt\")\n    pref_json = os.environ.get(\"FORBIDDEN_PREFIXES_JSON\", '[\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]')\n    try:\n        prefixes = json.loads(pref_json)\n    except Exception:\n        prefixes = [\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]\n\n    env = parse_env_dump(dump)\n    bad = []\n    for k in env.keys():\n        for p in prefixes:\n            if k == p or k.startswith(p):\n                bad.append(k)\n                break\n\n    result = {\"ok\": len(bad) == 0, \"forbidden_matches\": sorted(set(bad)), \"scanned\": len(env), \"path\": dump}\n    print(json.dumps(result, indent=2))\n    sys.exit(0 if result[\"ok\"] else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.secrets_in_build_env_v1.yaml",
      "_raw": "id: ci.secrets_in_build_env_v1\nversion: 1.0.0\ndomain: ci\ntitle: Build Environment — No Secrets in Env Dump\nstatement: |-\n  The build environment dump must not contain forbidden keys. Fail if any env var key matches a forbidden prefix or exact name.\n\nwitnesses:\n  - name: no_forbidden_env_keys\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      ENV_DUMP_PATH: artifacts/examples/ci/env_dump.txt\n      FORBIDDEN_PREFIXES_JSON: '[\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]'\n    timeout_ms: 4000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, sys, json\n\n      def parse_env_dump(path):\n          env = {}\n          with open(path, \"r\", errors=\"ignore\") as f:\n              for line in f:\n                  line = line.strip()\n                  if not line or line.startswith(\"#\"):\n                      continue\n                  if \"=\" in line:\n                      k, v = line.split(\"=\", 1)\n                      env[k.strip()] = v.strip()\n          return env\n\n      def main():\n          dump = os.environ.get(\"ENV_DUMP_PATH\", \"artifacts/examples/ci/env_dump.txt\")\n          pref_json = os.environ.get(\"FORBIDDEN_PREFIXES_JSON\", '[\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]')\n          try:\n              prefixes = json.loads(pref_json)\n          except Exception:\n              prefixes = [\"AWS_\",\"GCP_\",\"AZURE_\",\"GH_TOKEN\",\"SLACK_\",\"PRIVATE_KEY\",\"OPENAI_API_KEY\",\"SECRET\",\"TOKEN\"]\n\n          env = parse_env_dump(dump)\n          bad = []\n          for k in env.keys():\n              for p in prefixes:\n                  if k == p or k.startswith(p):\n                      bad.append(k)\n                      break\n\n          result = {\"ok\": len(bad) == 0, \"forbidden_matches\": sorted(set(bad)), \"scanned\": len(env), \"path\": dump}\n          print(json.dumps(result, indent=2))\n          sys.exit(0 if result[\"ok\"] else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.reproducible_artifact_hash_v1": {
      "id": "ci.reproducible_artifact_hash_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "Reproducible Build — Repeatable Artifact Hash",
      "statement": "Running the build command twice in a clean workspace should produce byte-identical artifacts (same SHA-256).",
      "witnesses": [
        {
          "name": "repeatable_hash_check",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "BUILD_CMD": "bash artifacts/examples/ci/build_demo.sh",
            "ARTIFACT_PATH": "artifacts/examples/ci/build/out/demo-artifact.txt"
          },
          "timeout_ms": 10000,
          "memory_mb": 256,
          "net": false,
          "fs_mode": "rw",
          "code": "import os, sys, json, hashlib, subprocess, time\n\ndef sha256(path):\n    h = hashlib.sha256()\n    with open(path, \"rb\") as f:\n        for chunk in iter(lambda: f.read(65536), b\"\"):\n            h.update(chunk)\n    return h.hexdigest()\n\ndef run_cmd(cmd):\n    completed = subprocess.run(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)\n    return completed.returncode, completed.stdout, completed.stderr\n\ndef main():\n    cmd = os.environ.get(\"BUILD_CMD\", \"\")\n    artifact = os.environ.get(\"ARTIFACT_PATH\", \"\")\n\n    if cmd:\n        rc1, out1, err1 = run_cmd(cmd)\n        rc2, out2, err2 = run_cmd(cmd)\n        build_ok = (rc1 == 0 and rc2 == 0)\n    else:\n        build_ok = True\n        out1 = out2 = err1 = err2 = \"\"\n\n    if not os.path.isfile(artifact):\n        print(json.dumps({\"ok\": False, \"error\": \"artifact missing\", \"artifact\": artifact, \"build_ok\": build_ok, \"stdout\": out2, \"stderr\": err2}, indent=2))\n        sys.exit(1)\n\n    h1 = sha256(artifact)\n    time.sleep(0.1)\n    h2 = sha256(artifact)\n\n    ok = build_ok and (h1 == h2)\n    print(json.dumps({\"ok\": ok, \"artifact\": artifact, \"sha256_first\": h1, \"sha256_second\": h2, \"build_ok\": build_ok}, indent=2))\n    sys.exit(0 if ok else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.reproducible_artifact_hash_v1.yaml",
      "_raw": "id: ci.reproducible_artifact_hash_v1\nversion: 1.0.0\ndomain: ci\ntitle: Reproducible Build — Repeatable Artifact Hash\nstatement: |-\n  Running the build command twice in a clean workspace should produce byte-identical artifacts (same SHA-256).\n\nwitnesses:\n  - name: repeatable_hash_check\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      BUILD_CMD: \"bash artifacts/examples/ci/build_demo.sh\"\n      ARTIFACT_PATH: artifacts/examples/ci/build/out/demo-artifact.txt\n    timeout_ms: 10000\n    memory_mb: 256\n    net: false\n    fs_mode: rw\n    code: |-\n      import os, sys, json, hashlib, subprocess, time\n\n      def sha256(path):\n          h = hashlib.sha256()\n          with open(path, \"rb\") as f:\n              for chunk in iter(lambda: f.read(65536), b\"\"):\n                  h.update(chunk)\n          return h.hexdigest()\n\n      def run_cmd(cmd):\n          completed = subprocess.run(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)\n          return completed.returncode, completed.stdout, completed.stderr\n\n      def main():\n          cmd = os.environ.get(\"BUILD_CMD\", \"\")\n          artifact = os.environ.get(\"ARTIFACT_PATH\", \"\")\n\n          if cmd:\n              rc1, out1, err1 = run_cmd(cmd)\n              rc2, out2, err2 = run_cmd(cmd)\n              build_ok = (rc1 == 0 and rc2 == 0)\n          else:\n              build_ok = True\n              out1 = out2 = err1 = err2 = \"\"\n\n          if not os.path.isfile(artifact):\n              print(json.dumps({\"ok\": False, \"error\": \"artifact missing\", \"artifact\": artifact, \"build_ok\": build_ok, \"stdout\": out2, \"stderr\": err2}, indent=2))\n              sys.exit(1)\n\n          h1 = sha256(artifact)\n          time.sleep(0.1)\n          h2 = sha256(artifact)\n\n          ok = build_ok and (h1 == h2)\n          print(json.dumps({\"ok\": ok, \"artifact\": artifact, \"sha256_first\": h1, \"sha256_second\": h2, \"build_ok\": build_ok}, indent=2))\n          sys.exit(0 if ok else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ci.sbom_present_v1": {
      "id": "ci.sbom_present_v1",
      "version": "1.0.0",
      "domain": "ci",
      "title": "SBOM Present for the Release",
      "statement": "A Software Bill of Materials (SBOM) must be attached to every release artifact.\nThe SBOM file must exist, be non-empty, and parse as JSON or SPDX tag-value text.",
      "witnesses": [
        {
          "name": "sbom_file_exists",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "ARTIFACTS_DIR": "artifacts/examples/ci",
            "SBOM_NAME": "sbom.json"
          },
          "timeout_ms": 4000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, json, sys\n\ndef is_nonempty_file(path):\n    try:\n        return os.path.isfile(path) and os.path.getsize(path) > 0\n    except Exception:\n        return False\n\ndef try_parse_json(path):\n    try:\n        with open(path, \"r\", errors=\"ignore\") as f:\n            json.load(f)\n        return True, \"json\"\n    except Exception:\n        return False, None\n\ndef try_spdx_tagvalue(path):\n    try:\n        with open(path, \"r\", errors=\"ignore\") as f:\n            head = f.read(2048)\n        return \"SPDXVersion:\" in head or \"PackageName:\" in head\n    except Exception:\n        return False\n\ndef main():\n    artifacts = os.environ.get(\"ARTIFACTS_DIR\", \"artifacts/examples/ci\")\n    name = os.environ.get(\"SBOM_NAME\", \"sbom.json\")\n    path = os.path.join(artifacts, name)\n\n    exists = is_nonempty_file(path)\n    parsed = False\n    fmt = None\n    if exists:\n        ok, fmt = try_parse_json(path)\n        if not ok:\n            if try_spdx_tagvalue(path):\n                parsed = True\n                fmt = \"spdx-tagvalue\"\n            else:\n                parsed = False\n        else:\n            parsed = True\n\n    result = {\"ok\": exists and parsed, \"path\": path, \"exists\": exists, \"parsed\": parsed, \"format\": fmt}\n    print(json.dumps(result, indent=2))\n    sys.exit(0 if result[\"ok\"] else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/ci",
        "created": "2025-11-10T21:10:00Z",
        "updated": "2025-11-10T21:10:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "ci",
        "release"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": "Runs in restricted CI; no network by default; read-only FS recommended."
      },
      "_file": "./capsules/ci/ci.sbom_present_v1.yaml",
      "_raw": "id: ci.sbom_present_v1\nversion: 1.0.0\ndomain: ci\ntitle: SBOM Present for the Release\nstatement: |-\n  A Software Bill of Materials (SBOM) must be attached to every release artifact.\n  The SBOM file must exist, be non-empty, and parse as JSON or SPDX tag-value text.\n\nwitnesses:\n  - name: sbom_file_exists\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      ARTIFACTS_DIR: artifacts/examples/ci\n      SBOM_NAME: sbom.json\n    timeout_ms: 4000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, json, sys\n\n      def is_nonempty_file(path):\n          try:\n              return os.path.isfile(path) and os.path.getsize(path) > 0\n          except Exception:\n              return False\n\n      def try_parse_json(path):\n          try:\n              with open(path, \"r\", errors=\"ignore\") as f:\n                  json.load(f)\n              return True, \"json\"\n          except Exception:\n              return False, None\n\n      def try_spdx_tagvalue(path):\n          try:\n              with open(path, \"r\", errors=\"ignore\") as f:\n                  head = f.read(2048)\n              return \"SPDXVersion:\" in head or \"PackageName:\" in head\n          except Exception:\n              return False\n\n      def main():\n          artifacts = os.environ.get(\"ARTIFACTS_DIR\", \"artifacts/examples/ci\")\n          name = os.environ.get(\"SBOM_NAME\", \"sbom.json\")\n          path = os.path.join(artifacts, name)\n\n          exists = is_nonempty_file(path)\n          parsed = False\n          fmt = None\n          if exists:\n              ok, fmt = try_parse_json(path)\n              if not ok:\n                  if try_spdx_tagvalue(path):\n                      parsed = True\n                      fmt = \"spdx-tagvalue\"\n                  else:\n                      parsed = False\n              else:\n                  parsed = True\n\n          result = {\"ok\": exists and parsed, \"path\": path, \"exists\": exists, \"parsed\": parsed, \"format\": fmt}\n          print(json.dumps(result, indent=2))\n          sys.exit(0 if result[\"ok\"] else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/ci\n  created: '2025-11-10T21:10:00Z'\n  updated: '2025-11-10T21:10:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- ci\n- release\nsecurity:\n  sensitivity: medium\n  notes: \"Runs in restricted CI; no network by default; read-only FS recommended.\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "macgyver.world_as_typed_graph_v1": {
      "id": "macgyver.world_as_typed_graph_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "World as a Typed Graph",
      "statement": "Model materials and energies as nodes with typed edges for conversions; plan paths with minimal risk and cost.",
      "assumptions": [
        "Graph mindset helps enumerate options and constraints."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What is the next low‑risk edge from here to the goal?"
        },
        {
          "kind": "Aphorism",
          "text": "Map the edges; choose the gentlest path."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.world_as_typed_graph_v1.yaml",
      "_raw": "id: macgyver.world_as_typed_graph_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: World as a Typed Graph\nstatement: Model materials and energies as nodes with typed edges for conversions;\n  plan paths with minimal risk and cost.\nassumptions:\n- Graph mindset helps enumerate options and constraints.\npedagogy:\n- kind: Socratic\n  text: What is the next low‑risk edge from here to the goal?\n- kind: Aphorism\n  text: Map the edges; choose the gentlest path.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.reality_check_v1": {
      "id": "macgyver.reality_check_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Reality Check vs Fiction",
      "statement": "Use TV scenarios only as metaphors for safe, legal, non‑hazard practice. Substitute benign analogues.",
      "assumptions": [
        "No hazardous chemistry/electrics or bypassing of security systems."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What benign analogue teaches the same principle?"
        },
        {
          "kind": "Aphorism",
          "text": "Learn the law; keep the lesson."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": "Explicitly rejects hazardous replication."
      },
      "_file": "./capsules/macgyver/macgyver.reality_check_v1.yaml",
      "_raw": "id: macgyver.reality_check_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Reality Check vs Fiction\nstatement: Use TV scenarios only as metaphors for safe, legal, non‑hazard practice.\n  Substitute benign analogues.\nassumptions:\n- No hazardous chemistry/electrics or bypassing of security systems.\npedagogy:\n- kind: Socratic\n  text: What benign analogue teaches the same principle?\n- kind: Aphorism\n  text: Learn the law; keep the lesson.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: Explicitly rejects hazardous replication.\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.functional_fixedness_avoidance_v1": {
      "id": "macgyver.functional_fixedness_avoidance_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Avoid Functional Fixedness",
      "statement": "Intentionally re-label objects by their properties and verbs to unlock alternative roles.",
      "assumptions": [
        "User practices re-framing and is open to substitution."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What else can this become if I ignore its default name?"
        },
        {
          "kind": "Socratic",
          "text": "Which property, not present in this item, can be paired to create a new role?"
        },
        {
          "kind": "Aphorism",
          "text": "Every object hides a verb."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.functional_fixedness_avoidance_v1.yaml",
      "_raw": "id: macgyver.functional_fixedness_avoidance_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Avoid Functional Fixedness\nstatement: Intentionally re-label objects by their properties and verbs to unlock\n  alternative roles.\nassumptions:\n- User practices re-framing and is open to substitution.\npedagogy:\n- kind: Socratic\n  text: What else can this become if I ignore its default name?\n- kind: Socratic\n  text: Which property, not present in this item, can be paired to create a new role?\n- kind: Aphorism\n  text: Every object hides a verb.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.fail_safe_defaults_v1": {
      "id": "macgyver.fail_safe_defaults_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Fail‑Safe Defaults",
      "statement": "Design so that interruptions and errors do not cause harm; plan graceful aborts.",
      "assumptions": [
        "Interruption is likely; failure must be safe."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What happens if we stop at Step 2? Make that harmless."
        },
        {
          "kind": "Aphorism",
          "text": "If it must fail, let it fail safe."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.fail_safe_defaults_v1.yaml",
      "_raw": "id: macgyver.fail_safe_defaults_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Fail‑Safe Defaults\nstatement: Design so that interruptions and errors do not cause harm; plan graceful\n  aborts.\nassumptions:\n- Interruption is likely; failure must be safe.\npedagogy:\n- kind: Socratic\n  text: What happens if we stop at Step 2? Make that harmless.\n- kind: Aphorism\n  text: If it must fail, let it fail safe.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.affordance_matrix_template_v1": {
      "id": "macgyver.affordance_matrix_template_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Affordance Matrix Template",
      "statement": "Tabulate assets→properties→law→role→risk to externalize options and surface safer substitutions.",
      "assumptions": [
        "Externalizing information reduces oversight."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Fill three rows: what role can each asset play safely?"
        },
        {
          "kind": "Aphorism",
          "text": "What you table, you can reason about."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.affordance_matrix_template_v1.yaml",
      "_raw": "id: macgyver.affordance_matrix_template_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Affordance Matrix Template\nstatement: Tabulate assets→properties→law→role→risk to externalize options and surface\n  safer substitutions.\nassumptions:\n- Externalizing information reduces oversight.\npedagogy:\n- kind: Socratic\n  text: 'Fill three rows: what role can each asset play safely?'\n- kind: Aphorism\n  text: What you table, you can reason about.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.legal_ethical_guardrails_v1": {
      "id": "macgyver.legal_ethical_guardrails_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Legal & Ethical Guardrails",
      "statement": "Operate with consent, legality, and non‑maleficence; solutions are for safety, rescue, education, prototyping.",
      "assumptions": [
        "User agrees to legal and ethical constraints."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Whose consent or safety is implicated? Stop if unclear."
        },
        {
          "kind": "Aphorism",
          "text": "Better a delayed win than a wrongful one."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.legal_ethical_guardrails_v1.yaml",
      "_raw": "id: macgyver.legal_ethical_guardrails_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Legal & Ethical Guardrails\nstatement: Operate with consent, legality, and non‑maleficence; solutions are for\n  safety, rescue, education, prototyping.\nassumptions:\n- User agrees to legal and ethical constraints.\npedagogy:\n- kind: Socratic\n  text: Whose consent or safety is implicated? Stop if unclear.\n- kind: Aphorism\n  text: Better a delayed win than a wrongful one.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.property_matching_v1": {
      "id": "macgyver.property_matching_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Property-to-Law Matching",
      "statement": "Map constraints to physical laws (pressure, torque, optics, buoyancy, friction) and then to available properties and parts.",
      "assumptions": [
        "Basic physics are more portable than specific tools."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which law satisfies the need with the fewest steps?"
        },
        {
          "kind": "Socratic",
          "text": "What property‑set makes that law easy to apply here?"
        },
        {
          "kind": "Aphorism",
          "text": "Name the energy, not the object."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.property_matching_v1.yaml",
      "_raw": "id: macgyver.property_matching_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Property-to-Law Matching\nstatement: Map constraints to physical laws (pressure, torque, optics, buoyancy, friction)\n  and then to available properties and parts.\nassumptions:\n- Basic physics are more portable than specific tools.\npedagogy:\n- kind: Socratic\n  text: Which law satisfies the need with the fewest steps?\n- kind: Socratic\n  text: What property‑set makes that law easy to apply here?\n- kind: Aphorism\n  text: Name the energy, not the object.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.affordances_over_objects_v1": {
      "id": "macgyver.affordances_over_objects_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Affordances Over Objects",
      "statement": "Prioritize material properties (conducts, insulates, reflects, absorbs, seals, flexes, burns, reacts) over brand-form labels to unlock repurposing.",
      "assumptions": [
        "Scene contains everyday materials with varied properties."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "For each nearby object, list three properties that could serve your goal."
        },
        {
          "kind": "Socratic",
          "text": "Which property is missing—and what simple substitute adds it?"
        },
        {
          "kind": "Aphorism",
          "text": "Every object hides a verb."
        },
        {
          "kind": "Aphorism",
          "text": "Properties beat brand names."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.affordances_over_objects_v1.yaml",
      "_raw": "id: macgyver.affordances_over_objects_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Affordances Over Objects\nstatement: Prioritize material properties (conducts, insulates, reflects, absorbs,\n  seals, flexes, burns, reacts) over brand-form labels to unlock repurposing.\nassumptions:\n- Scene contains everyday materials with varied properties.\npedagogy:\n- kind: Socratic\n  text: For each nearby object, list three properties that could serve your goal.\n- kind: Socratic\n  text: Which property is missing—and what simple substitute adds it?\n- kind: Aphorism\n  text: Every object hides a verb.\n- kind: Aphorism\n  text: Properties beat brand names.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.transduction_chains_v1": {
      "id": "macgyver.transduction_chains_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Transduction Chains",
      "statement": "Route one energy into the effect you need: chemical→thermal→mechanical, optical→thermal, electrical→magnetic, pneumatic/hydraulic→force.",
      "assumptions": [
        "Safer energy conversions exist than direct brute force."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which energy form is easiest to start from in your scene?"
        },
        {
          "kind": "Socratic",
          "text": "What two-stage conversion achieves the effect with lower risk?"
        },
        {
          "kind": "Aphorism",
          "text": "Route energy; don’t brute energy."
        },
        {
          "kind": "Aphorism",
          "text": "Two cheap stages outrun one clever stage."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.transduction_chains_v1.yaml",
      "_raw": "id: macgyver.transduction_chains_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Transduction Chains\nstatement: 'Route one energy into the effect you need: chemical→thermal→mechanical,\n  optical→thermal, electrical→magnetic, pneumatic/hydraulic→force.'\nassumptions:\n- Safer energy conversions exist than direct brute force.\npedagogy:\n- kind: Socratic\n  text: Which energy form is easiest to start from in your scene?\n- kind: Socratic\n  text: What two-stage conversion achieves the effect with lower risk?\n- kind: Aphorism\n  text: Route energy; don’t brute energy.\n- kind: Aphorism\n  text: Two cheap stages outrun one clever stage.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.prompt_skeleton_v1": {
      "id": "macgyver.prompt_skeleton_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "LLM Prompt Skeleton",
      "statement": "A structured prompt to force safe, legal, non‑destructive chain synthesis for a defined goal and setting.",
      "assumptions": [
        "LLMs need structure and guardrails for reliable outputs."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Does the prompt enforce assets, laws, three chains, premortem, and micro‑test?"
        },
        {
          "kind": "Aphorism",
          "text": "Prompts are levers for minds."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "training"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.prompt_skeleton_v1.yaml",
      "_raw": "id: macgyver.prompt_skeleton_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: LLM Prompt Skeleton\nstatement: A structured prompt to force safe, legal, non‑destructive chain synthesis\n  for a defined goal and setting.\nassumptions:\n- LLMs need structure and guardrails for reliable outputs.\npedagogy:\n- kind: Socratic\n  text: Does the prompt enforce assets, laws, three chains, premortem, and micro‑test?\n- kind: Aphorism\n  text: Prompts are levers for minds.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- training\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.chain_design_v1": {
      "id": "macgyver.chain_design_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Chain Design: Sense→Gate→Amplify→Actuate",
      "statement": "Build solutions as short chains with a clear trigger and amplification before actuation.",
      "assumptions": [
        "Multi‑stage steps increase control and predictability."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Where is the gate/trigger? How is the effect amplified?"
        },
        {
          "kind": "Socratic",
          "text": "Can sensing/illusion replace force?"
        },
        {
          "kind": "Aphorism",
          "text": "Think chains: sense→gate→amplify→actuate."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.chain_design_v1.yaml",
      "_raw": "id: macgyver.chain_design_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: 'Chain Design: Sense→Gate→Amplify→Actuate'\nstatement: Build solutions as short chains with a clear trigger and amplification\n  before actuation.\nassumptions:\n- Multi‑stage steps increase control and predictability.\npedagogy:\n- kind: Socratic\n  text: Where is the gate/trigger? How is the effect amplified?\n- kind: Socratic\n  text: Can sensing/illusion replace force?\n- kind: Aphorism\n  text: 'Think chains: sense→gate→amplify→actuate.'\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.parallel_options_v1": {
      "id": "macgyver.parallel_options_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Parallel Optioning",
      "statement": "Always generate three routes: Physical, Informational, Environmental.",
      "assumptions": [
        "Time allows at least brief divergent ideation."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "List one Physical, one Informational, one Environmental route."
        },
        {
          "kind": "Aphorism",
          "text": "Don’t hunt with one arrow."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.parallel_options_v1.yaml",
      "_raw": "id: macgyver.parallel_options_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Parallel Optioning\nstatement: 'Always generate three routes: Physical, Informational, Environmental.'\nassumptions:\n- Time allows at least brief divergent ideation.\npedagogy:\n- kind: Socratic\n  text: List one Physical, one Informational, one Environmental route.\n- kind: Aphorism\n  text: Don’t hunt with one arrow.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.redundancy_chokepoints_v1": {
      "id": "macgyver.redundancy_chokepoints_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Redundancy & Choke Points",
      "statement": "Protect your own single points of failure while removing the opponent’s options.",
      "assumptions": [
        "System thinking improves robustness and containment."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Where is the single point of failure—and how do we cushion it?"
        },
        {
          "kind": "Aphorism",
          "text": "Add a backup or remove a choke."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.redundancy_chokepoints_v1.yaml",
      "_raw": "id: macgyver.redundancy_chokepoints_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Redundancy & Choke Points\nstatement: Protect your own single points of failure while removing the opponent’s\n  options.\nassumptions:\n- System thinking improves robustness and containment.\npedagogy:\n- kind: Socratic\n  text: Where is the single point of failure—and how do we cushion it?\n- kind: Aphorism\n  text: Add a backup or remove a choke.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.mvp_mechanism_bias_v1": {
      "id": "macgyver.mvp_mechanism_bias_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "MVP Mechanism Bias",
      "statement": "Prefer the smallest reversible mechanism that might work; escalate complexity only as needed.",
      "assumptions": [
        "Reversible steps reduce risk and damage."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What is the least‑effort, reversible move that could work?"
        },
        {
          "kind": "Aphorism",
          "text": "Use reversibility as a brake."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.mvp_mechanism_bias_v1.yaml",
      "_raw": "id: macgyver.mvp_mechanism_bias_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: MVP Mechanism Bias\nstatement: Prefer the smallest reversible mechanism that might work; escalate complexity\n  only as needed.\nassumptions:\n- Reversible steps reduce risk and damage.\npedagogy:\n- kind: Socratic\n  text: What is the least‑effort, reversible move that could work?\n- kind: Aphorism\n  text: Use reversibility as a brake.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.prompts_as_programs_v1": {
      "id": "macgyver.prompts_as_programs_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Prompts as Programs",
      "statement": "Use structured prompts/checklists to force enumeration, comparison, and premortems.",
      "assumptions": [
        "Structure improves breadth and reduces blind spots."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Have we enumerated three routes and a premortem yet?"
        },
        {
          "kind": "Aphorism",
          "text": "Prompt the mind you want."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.prompts_as_programs_v1.yaml",
      "_raw": "id: macgyver.prompts_as_programs_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Prompts as Programs\nstatement: Use structured prompts/checklists to force enumeration, comparison, and\n  premortems.\nassumptions:\n- Structure improves breadth and reduces blind spots.\npedagogy:\n- kind: Socratic\n  text: Have we enumerated three routes and a premortem yet?\n- kind: Aphorism\n  text: Prompt the mind you want.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.low_tech_first_v1": {
      "id": "macgyver.low_tech_first_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Low-Tech First",
      "statement": "Prefer simple mechanisms (rope, wedge, lever, mirror) before powered or chemical routes.",
      "assumptions": [
        "Simple tools are present; powered tools are risky/unavailable."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What non‑powered mechanism could replace this powered step?"
        },
        {
          "kind": "Aphorism",
          "text": "Small forces win with leverage, pressure, and time."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.low_tech_first_v1.yaml",
      "_raw": "id: macgyver.low_tech_first_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Low-Tech First\nstatement: Prefer simple mechanisms (rope, wedge, lever, mirror) before powered or\n  chemical routes.\nassumptions:\n- Simple tools are present; powered tools are risky/unavailable.\npedagogy:\n- kind: Socratic\n  text: What non‑powered mechanism could replace this powered step?\n- kind: Aphorism\n  text: Small forces win with leverage, pressure, and time.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.five_rails_v1": {
      "id": "macgyver.five_rails_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "The Five Rails of Action",
      "statement": "Operate along five rails: Sensing, Shaping, Timing, Power, Signaling. Compose minimally sufficient sets to achieve the goal.",
      "assumptions": [
        "Any solution can be decomposed across the five rails."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which rails are absolutely necessary for this problem?"
        },
        {
          "kind": "Socratic",
          "text": "Can sensing replace force (e.g., bypass over break)?"
        },
        {
          "kind": "Aphorism",
          "text": "If you can’t make it stronger, make it smarter."
        },
        {
          "kind": "Aphorism",
          "text": "Reduce the problem, not the world."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.five_rails_v1.yaml",
      "_raw": "id: macgyver.five_rails_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: The Five Rails of Action\nstatement: 'Operate along five rails: Sensing, Shaping, Timing, Power, Signaling.\n  Compose minimally sufficient sets to achieve the goal.'\nassumptions:\n- Any solution can be decomposed across the five rails.\npedagogy:\n- kind: Socratic\n  text: Which rails are absolutely necessary for this problem?\n- kind: Socratic\n  text: Can sensing replace force (e.g., bypass over break)?\n- kind: Aphorism\n  text: If you can’t make it stronger, make it smarter.\n- kind: Aphorism\n  text: Reduce the problem, not the world.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.bias_checklist_v1": {
      "id": "macgyver.bias_checklist_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Bias & Mode Collapse Check",
      "statement": "Before finalizing, scan for confirmation bias, selection bias, overconfidence, and mode collapse.",
      "assumptions": [
        "Brief self‑audit improves reliability."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which plausible alternative did we ignore?"
        },
        {
          "kind": "Aphorism",
          "text": "Doubt is a feature."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.bias_checklist_v1.yaml",
      "_raw": "id: macgyver.bias_checklist_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Bias & Mode Collapse Check\nstatement: Before finalizing, scan for confirmation bias, selection bias, overconfidence,\n  and mode collapse.\nassumptions:\n- Brief self‑audit improves reliability.\npedagogy:\n- kind: Socratic\n  text: Which plausible alternative did we ignore?\n- kind: Aphorism\n  text: Doubt is a feature.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.latency_control_v1": {
      "id": "macgyver.latency_control_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Latency Control",
      "statement": "Design predictable timing via burn, dissolve, flow, charging, cooling; prefer slow, observable delays.",
      "assumptions": [
        "Delays can be made visible and interruptible."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What delay is safest and most observable here?"
        },
        {
          "kind": "Aphorism",
          "text": "Delay is a component."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.latency_control_v1.yaml",
      "_raw": "id: macgyver.latency_control_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Latency Control\nstatement: Design predictable timing via burn, dissolve, flow, charging, cooling;\n  prefer slow, observable delays.\nassumptions:\n- Delays can be made visible and interruptible.\npedagogy:\n- kind: Socratic\n  text: What delay is safest and most observable here?\n- kind: Aphorism\n  text: Delay is a component.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.deliberate_practice_v1": {
      "id": "macgyver.deliberate_practice_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Deliberate Practice Drills",
      "statement": "Short, repeatable drills: 2‑minute affordance scans; law‑matching flashcards; chain sketches from household scenes.",
      "assumptions": [
        "Skill improves with frequent, safe micro‑reps."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What 2‑minute drill can you run right now in this room?"
        },
        {
          "kind": "Aphorism",
          "text": "Small drills make big instincts."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.deliberate_practice_v1.yaml",
      "_raw": "id: macgyver.deliberate_practice_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Deliberate Practice Drills\nstatement: 'Short, repeatable drills: 2‑minute affordance scans; law‑matching flashcards;\n  chain sketches from household scenes.'\nassumptions:\n- Skill improves with frequent, safe micro‑reps.\npedagogy:\n- kind: Socratic\n  text: What 2‑minute drill can you run right now in this room?\n- kind: Aphorism\n  text: Small drills make big instincts.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.inventory_thinking_v1": {
      "id": "macgyver.inventory_thinking_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Inventory Thinking",
      "statement": "Represent the scene as {assets, properties, converters, storers, triggers, constraints}.",
      "assumptions": [
        "A fast written inventory improves plan quality."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "List assets→properties in 60 seconds. What’s missing?"
        },
        {
          "kind": "Aphorism",
          "text": "What you write down exists for strategy."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.inventory_thinking_v1.yaml",
      "_raw": "id: macgyver.inventory_thinking_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Inventory Thinking\nstatement: Represent the scene as {assets, properties, converters, storers, triggers,\n  constraints}.\nassumptions:\n- A fast written inventory improves plan quality.\npedagogy:\n- kind: Socratic\n  text: List assets→properties in 60 seconds. What’s missing?\n- kind: Aphorism\n  text: What you write down exists for strategy.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.reflection_loop_v1": {
      "id": "macgyver.reflection_loop_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Reflection Loop",
      "statement": "After action: identify the governing law, the choke point, and one substitution that would lower risk next time.",
      "assumptions": [
        "Retrospective improves future plan quality."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which law actually did the work? What will you change next time?"
        },
        {
          "kind": "Aphorism",
          "text": "Name the win mechanism or you won’t keep it."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.reflection_loop_v1.yaml",
      "_raw": "id: macgyver.reflection_loop_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Reflection Loop\nstatement: 'After action: identify the governing law, the choke point, and one substitution\n  that would lower risk next time.'\nassumptions:\n- Retrospective improves future plan quality.\npedagogy:\n- kind: Socratic\n  text: Which law actually did the work? What will you change next time?\n- kind: Aphorism\n  text: Name the win mechanism or you won’t keep it.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.deception_force_multiplier_v1": {
      "id": "macgyver.deception_force_multiplier_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Deception as Force Multiplier",
      "statement": "Use diversions and illusions to buy time and reduce the need for force.",
      "assumptions": [
        "Solutions should avoid harm and de-escalate."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What harmless diversion buys a safe minute?"
        },
        {
          "kind": "Aphorism",
          "text": "A signal that buys a minute beats a force that breaks a wall."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.deception_force_multiplier_v1.yaml",
      "_raw": "id: macgyver.deception_force_multiplier_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Deception as Force Multiplier\nstatement: Use diversions and illusions to buy time and reduce the need for force.\nassumptions:\n- Solutions should avoid harm and de-escalate.\npedagogy:\n- kind: Socratic\n  text: What harmless diversion buys a safe minute?\n- kind: Aphorism\n  text: A signal that buys a minute beats a force that breaks a wall.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.sop_10min_loop_v1": {
      "id": "macgyver.sop_10min_loop_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "SOP: The 10‑Minute MacGyver Loop",
      "statement": "A 10‑step loop: clarify target, map layout, inventory properties, pick a law, sketch three chains, choose low‑risk, add timing control, premortem, micro‑test, execute & observe.",
      "assumptions": [
        "Timeboxed planning increases safety and success."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which step can you perform in under 60 seconds right now?"
        },
        {
          "kind": "Aphorism",
          "text": "Process is the parachute."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping",
        "training"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.sop_10min_loop_v1.yaml",
      "_raw": "id: macgyver.sop_10min_loop_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: 'SOP: The 10‑Minute MacGyver Loop'\nstatement: 'A 10‑step loop: clarify target, map layout, inventory properties, pick\n  a law, sketch three chains, choose low‑risk, add timing control, premortem, micro‑test,\n  execute & observe.'\nassumptions:\n- Timeboxed planning increases safety and success.\npedagogy:\n- kind: Socratic\n  text: Which step can you perform in under 60 seconds right now?\n- kind: Aphorism\n  text: Process is the parachute.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\n- training\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver_problem_collapse_v1": {
      "id": "macgyver_problem_collapse_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Problem Space Collapse → New Solutions",
      "statement": "Collapse a problem like macgyver.",
      "assumptions": [
        "Assumptions are enumerated or can be elicited with one question."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which single assumption, if wrong, invalidates the plan?"
        },
        {
          "kind": "Aphorism",
          "text": "Make failure explicit and reversible."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": null,
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "life"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.problem_collapse_v1.yaml",
      "_raw": "id: macgyver_problem_collapse_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Problem Space Collapse → New Solutions\nstatement: Collapse a problem like macgyver.\nassumptions:\n- Assumptions are enumerated or can be elicited with one question.\npedagogy:\n- kind: Socratic\n  text: Which single assumption, if wrong, invalidates the plan?\n- kind: Aphorism\n  text: Make failure explicit and reversible.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: null\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- life\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.stock_verbs_v1": {
      "id": "macgyver.stock_verbs_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Stock Verbs",
      "statement": "Memorize a small verb lexicon: tie, wedge, knot, jam, twist, short, bridge, reflect, refract, siphon, vent, pack, wick, damp, shim, lash.",
      "assumptions": [
        "Motor skills and basic materials available."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which two verbs change the state with least effort?"
        },
        {
          "kind": "Aphorism",
          "text": "Verbs, not nouns, move worlds."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.stock_verbs_v1.yaml",
      "_raw": "id: macgyver.stock_verbs_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Stock Verbs\nstatement: 'Memorize a small verb lexicon: tie, wedge, knot, jam, twist, short, bridge,\n  reflect, refract, siphon, vent, pack, wick, damp, shim, lash.'\nassumptions:\n- Motor skills and basic materials available.\npedagogy:\n- kind: Socratic\n  text: Which two verbs change the state with least effort?\n- kind: Aphorism\n  text: Verbs, not nouns, move worlds.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.rails_ledgers_hub_mapping_v1": {
      "id": "macgyver.rails_ledgers_hub_mapping_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Rails/Ledgers/Hub Mapping",
      "statement": "Map solutions to rails (Sensing, Shaping, Timing, Power, Signaling), bundle minimal commuting rails as a ledger, schedule steps via the hub (ordered gates/delays).",
      "assumptions": [
        "A shared vocabulary improves collaboration and auditability."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which minimal set of rails forms the ledger here?"
        },
        {
          "kind": "Aphorism",
          "text": "Gate→Gear→Hub keeps projects clean."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.rails_ledgers_hub_mapping_v1.yaml",
      "_raw": "id: macgyver.rails_ledgers_hub_mapping_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Rails/Ledgers/Hub Mapping\nstatement: Map solutions to rails (Sensing, Shaping, Timing, Power, Signaling), bundle\n  minimal commuting rails as a ledger, schedule steps via the hub (ordered gates/delays).\nassumptions:\n- A shared vocabulary improves collaboration and auditability.\npedagogy:\n- kind: Socratic\n  text: Which minimal set of rails forms the ledger here?\n- kind: Aphorism\n  text: Gate→Gear→Hub keeps projects clean.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.blast_radius_humility_v1": {
      "id": "macgyver.blast_radius_humility_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Blast-Radius Humility",
      "statement": "Prefer diversion, disablement, and exit over destructive outcomes; minimize the space of unintended effects.",
      "assumptions": [
        "Safety and ethics are paramount; bystanders matter."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "If this misfires, who is at risk? How do we shrink that radius?"
        },
        {
          "kind": "Aphorism",
          "text": "Build exits before entries."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": "Discourages hazardous actions; focuses on reduction of harm."
      },
      "_file": "./capsules/macgyver/macgyver.blast_radius_humility_v1.yaml",
      "_raw": "id: macgyver.blast_radius_humility_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Blast-Radius Humility\nstatement: Prefer diversion, disablement, and exit over destructive outcomes; minimize\n  the space of unintended effects.\nassumptions:\n- Safety and ethics are paramount; bystanders matter.\npedagogy:\n- kind: Socratic\n  text: If this misfires, who is at risk? How do we shrink that radius?\n- kind: Aphorism\n  text: Build exits before entries.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: Discourages hazardous actions; focuses on reduction of harm.\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "macgyver.environment_as_component_v1": {
      "id": "macgyver.environment_as_component_v1",
      "version": "1.0.0",
      "domain": "macgyver",
      "title": "Environment as a Component",
      "statement": "Treat gravity, sunlight, water, wind, terrain, and architecture as active parts of the design.",
      "assumptions": [
        "The environment can safely contribute force, flow, or information."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which environmental asset can replace a bought part?"
        },
        {
          "kind": "Socratic",
          "text": "How can layout (doors, shafts, slopes) create or remove options?"
        },
        {
          "kind": "Aphorism",
          "text": "The floorplan is your toolkit."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/macgyver",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "planning",
        "prototyping"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/macgyver/macgyver.environment_as_component_v1.yaml",
      "_raw": "id: macgyver.environment_as_component_v1\nversion: 1.0.0\ndomain: macgyver\ntitle: Environment as a Component\nstatement: Treat gravity, sunlight, water, wind, terrain, and architecture as active\n  parts of the design.\nassumptions:\n- The environment can safely contribute force, flow, or information.\npedagogy:\n- kind: Socratic\n  text: Which environmental asset can replace a bought part?\n- kind: Socratic\n  text: How can layout (doors, shafts, slopes) create or remove options?\n- kind: Aphorism\n  text: The floorplan is your toolkit.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/macgyver\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- planning\n- prototyping\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.style_guide_js_v1": {
      "id": "dev.style_guide_js_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "JS/TS Style Guide (Practical Defaults)",
      "statement": "Keep the surface consistent; let tools fight bikeshedding.\n\nFormatter & Lint\n  • Prettier; ESLint with recommended + security (eslint-plugin-security) + import/order.\n  • TypeScript strict for libraries; app code minimally typed but typed at boundaries.\n\nTesting & UI\n  • Jest/Vitest + Testing Library; prefer role-based queries; avoid brittle snapshots.\n  • Keep components pure; derive state; lift state when two consumers need it.\n\nExamples\n  • API calls have abort controllers and sane timeouts.\n  • Avoid implicit any; prefer union types to magic strings.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.style_guide_js_v1.yaml",
      "_raw": "id: dev.style_guide_js_v1\nversion: 1.0.0\ndomain: dev\ntitle: JS/TS Style Guide (Practical Defaults)\nstatement: |-\n  Keep the surface consistent; let tools fight bikeshedding.\n\n  Formatter & Lint\n    • Prettier; ESLint with recommended + security (eslint-plugin-security) + import/order.\n    • TypeScript strict for libraries; app code minimally typed but typed at boundaries.\n\n  Testing & UI\n    • Jest/Vitest + Testing Library; prefer role-based queries; avoid brittle snapshots.\n    • Keep components pure; derive state; lift state when two consumers need it.\n\n  Examples\n    • API calls have abort controllers and sane timeouts.\n    • Avoid implicit any; prefer union types to magic strings.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.diff_risk_tags_v1": {
      "id": "dev.diff_risk_tags_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Diff-Derived Risk Tags are Addressed in Review",
      "statement": "Compute risk tags from the diff and require the review to explicitly address each tag.\nTags include (non-exhaustive): security, performance, migration, breaking, dependency,\ninfrastructure, tests, docs. Review must mention each inferred tag.",
      "witnesses": [
        {
          "name": "pr_review_covers_risks",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "REVIEW_PATH": "artifacts/examples/dev/pr_review_good.md",
            "DIFF_PATH": "artifacts/examples/dev/pr_diff.patch"
          },
          "timeout_ms": 5000,
          "memory_mb": 128,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, re, json, sys\n\ndef read(path):\n    with open(path, \"r\", errors=\"ignore\") as f:\n        return f.read()\n\nTAG_PATTERNS = {\n    \"security\": [r\"\\bauth\\b\", r\"\\bjwt\\b\", r\"\\bxss\\b\", r\"\\bcsrf\\b\", r\"\\bencrypt\", r\"\\bsecret\\b\", r\"\\btoken\\b\", r\"\\bhash\\b\", r\"\\baes\\b\", r\"\\brsa\\b\"],\n    \"performance\": [r\"\\bO\\([Nn]\\)\", r\"\\bhot path\\b\", r\"\\blatency\\b\", r\"\\bthroughput\\b\", r\"\\bcach\", r\"\\balloc\"],\n    # Migration: require SQL-ish context or migration frameworks/paths (NO plain 'index')\n    \"migration\": [\n        r\"\\bmigrations?/\", r\"\\b(alembic|flyway|liquibase)\\b\",\n        r\"\\bcreate\\s+(table|index)\\b\", r\"\\bdrop\\s+(column|table|index)\\b\",\n        r\"\\balter\\s+table\\b\", r\"\\bddl\\b\", r\"\\bschema\\b\"\n    ],\n    \"breaking\": [r\"BREAKING CHANGE\", r\"\\brename\\b\", r\"\\bremove public\\b\", r\"\\bsignature\\b\", r\"\\bsemver[- ]?major\\b\"],\n    \"dependency\": [r\"package\\.json\", r\"requirements\\.txt\", r\"poetry\\.lock\", r\"yarn\\.lock\", r\"pnpm-lock\", r\"go\\.mod\", r\"Cargo\\.toml\"],\n    \"infrastructure\": [r\"Dockerfile\", r\"\\bk8s\\b\", r\"helm\", r\"terraform\", r\"ansible\", r\"systemd\"],\n    \"tests\": [r\"\\btests?/\", r\"\\btest\", r\"\\bspec\\b\", r\"\\bfixture\\b\", r\"\\bcoverage\\b\"],\n    \"docs\": [r\"README\", r\"\\bdocs?/\", r\"\\.md\\b\"]\n}\n\ndef infer_tags_from_diff(diff_text):\n    tags = set()\n    lowered = diff_text.lower()\n    for tag, pats in TAG_PATTERNS.items():\n        for pat in pats:\n            if re.search(pat, lowered):\n                tags.add(tag); break\n    return sorted(tags)\n\ndef tags_in_text(text):\n    found = set()\n    for tag in TAG_PATTERNS.keys():\n        if re.search(rf\"\\b{tag}\\b\", text, flags=re.I):\n            found.add(tag)\n    m = re.search(r\"tags?\\s*:\\s*([a-z, ]+)\", text, flags=re.I)\n    if m:\n        for t in re.split(r\"[, ]+\", m.group(1).strip()):\n            if t.lower() in TAG_PATTERNS.keys():\n                found.add(t.lower())\n    return sorted(found)\n\ndef main():\n    review_path = os.environ.get(\"REVIEW_PATH\", \"artifacts/examples/dev/pr_review_good.md\")\n    diff_path = os.environ.get(\"DIFF_PATH\", \"artifacts/examples/dev/pr_diff.patch\")\n    if os.path.isdir(review_path): review_path = os.path.join(review_path, \"pr_review_good.md\")\n    if os.path.isdir(diff_path):   diff_path   = os.path.join(diff_path, \"pr_diff.patch\")\n\n    diff_text = read(diff_path)\n    review_text = read(review_path)\n\n    needed  = infer_tags_from_diff(diff_text)\n    present = tags_in_text(review_text)\n    missing = [t for t in needed if t not in present]\n\n    print(json.dumps({\n        \"ok\": len(missing) == 0,\n        \"needed\": needed, \"present\": present, \"missing\": missing,\n        \"review\": review_path, \"diff\": diff_path\n    }, indent=2))\n    sys.exit(0 if not missing else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.diff_risk_tags_v1.yaml",
      "_raw": "id: dev.diff_risk_tags_v1\nversion: 1.0.0\ndomain: dev\ntitle: Diff-Derived Risk Tags are Addressed in Review\nstatement: |-\n  Compute risk tags from the diff and require the review to explicitly address each tag.\n  Tags include (non-exhaustive): security, performance, migration, breaking, dependency,\n  infrastructure, tests, docs. Review must mention each inferred tag.\n\nwitnesses:\n  - name: pr_review_covers_risks\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      REVIEW_PATH: artifacts/examples/dev/pr_review_good.md\n      DIFF_PATH: artifacts/examples/dev/pr_diff.patch\n    timeout_ms: 5000\n    memory_mb: 128\n    net: false\n    fs_mode: ro\n    code: |-\n        import os, re, json, sys\n\n        def read(path):\n            with open(path, \"r\", errors=\"ignore\") as f:\n                return f.read()\n\n        TAG_PATTERNS = {\n            \"security\": [r\"\\bauth\\b\", r\"\\bjwt\\b\", r\"\\bxss\\b\", r\"\\bcsrf\\b\", r\"\\bencrypt\", r\"\\bsecret\\b\", r\"\\btoken\\b\", r\"\\bhash\\b\", r\"\\baes\\b\", r\"\\brsa\\b\"],\n            \"performance\": [r\"\\bO\\([Nn]\\)\", r\"\\bhot path\\b\", r\"\\blatency\\b\", r\"\\bthroughput\\b\", r\"\\bcach\", r\"\\balloc\"],\n            # Migration: require SQL-ish context or migration frameworks/paths (NO plain 'index')\n            \"migration\": [\n                r\"\\bmigrations?/\", r\"\\b(alembic|flyway|liquibase)\\b\",\n                r\"\\bcreate\\s+(table|index)\\b\", r\"\\bdrop\\s+(column|table|index)\\b\",\n                r\"\\balter\\s+table\\b\", r\"\\bddl\\b\", r\"\\bschema\\b\"\n            ],\n            \"breaking\": [r\"BREAKING CHANGE\", r\"\\brename\\b\", r\"\\bremove public\\b\", r\"\\bsignature\\b\", r\"\\bsemver[- ]?major\\b\"],\n            \"dependency\": [r\"package\\.json\", r\"requirements\\.txt\", r\"poetry\\.lock\", r\"yarn\\.lock\", r\"pnpm-lock\", r\"go\\.mod\", r\"Cargo\\.toml\"],\n            \"infrastructure\": [r\"Dockerfile\", r\"\\bk8s\\b\", r\"helm\", r\"terraform\", r\"ansible\", r\"systemd\"],\n            \"tests\": [r\"\\btests?/\", r\"\\btest\", r\"\\bspec\\b\", r\"\\bfixture\\b\", r\"\\bcoverage\\b\"],\n            \"docs\": [r\"README\", r\"\\bdocs?/\", r\"\\.md\\b\"]\n        }\n\n        def infer_tags_from_diff(diff_text):\n            tags = set()\n            lowered = diff_text.lower()\n            for tag, pats in TAG_PATTERNS.items():\n                for pat in pats:\n                    if re.search(pat, lowered):\n                        tags.add(tag); break\n            return sorted(tags)\n\n        def tags_in_text(text):\n            found = set()\n            for tag in TAG_PATTERNS.keys():\n                if re.search(rf\"\\b{tag}\\b\", text, flags=re.I):\n                    found.add(tag)\n            m = re.search(r\"tags?\\s*:\\s*([a-z, ]+)\", text, flags=re.I)\n            if m:\n                for t in re.split(r\"[, ]+\", m.group(1).strip()):\n                    if t.lower() in TAG_PATTERNS.keys():\n                        found.add(t.lower())\n            return sorted(found)\n\n        def main():\n            review_path = os.environ.get(\"REVIEW_PATH\", \"artifacts/examples/dev/pr_review_good.md\")\n            diff_path = os.environ.get(\"DIFF_PATH\", \"artifacts/examples/dev/pr_diff.patch\")\n            if os.path.isdir(review_path): review_path = os.path.join(review_path, \"pr_review_good.md\")\n            if os.path.isdir(diff_path):   diff_path   = os.path.join(diff_path, \"pr_diff.patch\")\n\n            diff_text = read(diff_path)\n            review_text = read(review_path)\n\n            needed  = infer_tags_from_diff(diff_text)\n            present = tags_in_text(review_text)\n            missing = [t for t in needed if t not in present]\n\n            print(json.dumps({\n                \"ok\": len(missing) == 0,\n                \"needed\": needed, \"present\": present, \"missing\": missing,\n                \"review\": review_path, \"diff\": diff_path\n            }, indent=2))\n            sys.exit(0 if not missing else 1)\n\n        if __name__ == \"__main__\":\n            main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "dev.secret_scan_baseline_v1": {
      "id": "dev.secret_scan_baseline_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Secret Scan Baseline (No Keys, No High-Entropy Blobs)",
      "statement": "Scan source tree for obvious secrets and high-entropy blobs. Skip vendor and binary paths.\nFail on suspected credentials or suspicious entropy across text files.",
      "witnesses": [
        {
          "name": "no_high_entropy_or_keys",
          "language": "python",
          "entrypoint": "python3",
          "args": [],
          "env": {
            "REPO_PATH": "artifacts/examples/dev/repo_demo"
          },
          "timeout_ms": 8000,
          "memory_mb": 256,
          "net": false,
          "fs_mode": "ro",
          "code": "import os, re, sys, json, math\n\nSKIP_DIRS = {\".git\", \"node_modules\", \"dist\", \"build\", \"vendor\", \"__pycache__\", \".venv\", \"venv\", \".idea\", \".vscode\", \".cache\", \".next\"}\nSKIP_FILE_EXT = {\".png\", \".jpg\", \".jpeg\", \".gif\", \".webp\", \".pdf\", \".ico\", \".lockb\", \".woff\", \".woff2\", \".ttf\", \".otf\", \".zip\", \".gz\", \".bz2\", \".7z\", \".jar\", \".min.js\"}\nALLOWLIST_NAMES = {\".env.example\", \"config.sample\", \"secrets.example\", \"example.env\"}\n\nKEY_PATTERNS = {\n    \"aws_access_key\": re.compile(r\"AKIA[0-9A-Z]{16}\"),\n    \"aws_secret_key\": re.compile(r\"(?i)aws(.{0,20})?(secret|access).{0,20}?[:=]\\s*['\\\"]?[A-Za-z0-9/+=]{40}\"),\n    \"gh_token\": re.compile(r\"ghp_[A-Za-z0-9]{36,}\"),\n    \"slack_token\": re.compile(r\"xox[baprs]-[A-Za-z0-9-]{10,48}\"),\n    \"gcp_json_key\": re.compile(r'\"private_key\":\\s*\"-----BEGIN PRIVATE KEY-----'),\n    \"private_key_block\": re.compile(r\"-----BEGIN (?:RSA|EC|DSA|OPENSSH) PRIVATE KEY-----\"),\n}\n\ndef shannon_entropy(s):\n    if not s:\n        return 0.0\n    freq = { }\n    for ch in s:\n        freq[ch] = freq.get(ch, 0) + 1\n    ent = 0.0\n    n = len(s)\n    for c in freq.values():\n        p = c / n\n        ent -= p * math.log2(p)\n    return ent\n\ndef scan_file(path):\n    findings = []\n    try:\n        with open(path, \"r\", errors=\"ignore\") as f:\n            for ln, line in enumerate(f, 1):\n                for name, rx in KEY_PATTERNS.items():\n                    if rx.search(line):\n                        if os.path.basename(path) in ALLOWLIST_NAMES:\n                            continue\n                        findings.append({\"file\": path, \"line\": ln, \"kind\": name, \"value\": line.strip(), \"severity\": \"high\"})\n                tokens = re.findall(r\"[A-Za-z0-9_\\-/+=]{20,}\", line)\n                for tok in tokens:\n                    ent = shannon_entropy(tok)\n                    if ent >= 4.5 and not tok.islower() and not tok.isupper():\n                        if \"/\" in tok and \":\" in tok:\n                            continue\n                        findings.append({\"file\": path, \"line\": ln, \"kind\": \"high_entropy\", \"value\": tok[:64], \"entropy\": ent, \"severity\": \"high\"})\n    except Exception as e:\n        findings.append({\"file\": path, \"error\": str(e), \"severity\": \"info\"})\n    return findings\n\ndef main():\n    root = os.environ.get(\"REPO_PATH\", \"artifacts/examples/dev/repo_demo\")\n    if os.path.isfile(root):\n        root = os.path.dirname(root)\n\n    results = []\n    for dirpath, dirnames, filenames in os.walk(root):\n        dirnames[:] = [d for d in dirnames if d not in SKIP_DIRS]\n        for fn in filenames:\n            if os.path.splitext(fn)[1].lower() in SKIP_FILE_EXT:\n                continue\n            if fn in ALLOWLIST_NAMES:\n                continue\n            path = os.path.join(dirpath, fn)\n            results.extend(scan_file(path))\n\n    fail = any(f.get(\"severity\") == \"high\" for f in results)\n    print(json.dumps({\"ok\": not fail, \"findings\": results, \"scanned_root\": root}, indent=2))\n    sys.exit(0 if not fail else 1)\n\nif __name__ == \"__main__\":\n    main()"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.secret_scan_baseline_v1.yaml",
      "_raw": "id: dev.secret_scan_baseline_v1\nversion: 1.0.0\ndomain: dev\ntitle: Secret Scan Baseline (No Keys, No High-Entropy Blobs)\nstatement: |-\n  Scan source tree for obvious secrets and high-entropy blobs. Skip vendor and binary paths.\n  Fail on suspected credentials or suspicious entropy across text files.\n\nwitnesses:\n  - name: no_high_entropy_or_keys\n    language: python\n    entrypoint: python3\n    args: []\n    env:\n      REPO_PATH: artifacts/examples/dev/repo_demo\n    timeout_ms: 8000\n    memory_mb: 256\n    net: false\n    fs_mode: ro\n    code: |-\n      import os, re, sys, json, math\n\n      SKIP_DIRS = {\".git\", \"node_modules\", \"dist\", \"build\", \"vendor\", \"__pycache__\", \".venv\", \"venv\", \".idea\", \".vscode\", \".cache\", \".next\"}\n      SKIP_FILE_EXT = {\".png\", \".jpg\", \".jpeg\", \".gif\", \".webp\", \".pdf\", \".ico\", \".lockb\", \".woff\", \".woff2\", \".ttf\", \".otf\", \".zip\", \".gz\", \".bz2\", \".7z\", \".jar\", \".min.js\"}\n      ALLOWLIST_NAMES = {\".env.example\", \"config.sample\", \"secrets.example\", \"example.env\"}\n\n      KEY_PATTERNS = {\n          \"aws_access_key\": re.compile(r\"AKIA[0-9A-Z]{16}\"),\n          \"aws_secret_key\": re.compile(r\"(?i)aws(.{0,20})?(secret|access).{0,20}?[:=]\\s*['\\\"]?[A-Za-z0-9/+=]{40}\"),\n          \"gh_token\": re.compile(r\"ghp_[A-Za-z0-9]{36,}\"),\n          \"slack_token\": re.compile(r\"xox[baprs]-[A-Za-z0-9-]{10,48}\"),\n          \"gcp_json_key\": re.compile(r'\"private_key\":\\s*\"-----BEGIN PRIVATE KEY-----'),\n          \"private_key_block\": re.compile(r\"-----BEGIN (?:RSA|EC|DSA|OPENSSH) PRIVATE KEY-----\"),\n      }\n\n      def shannon_entropy(s):\n          if not s:\n              return 0.0\n          freq = { }\n          for ch in s:\n              freq[ch] = freq.get(ch, 0) + 1\n          ent = 0.0\n          n = len(s)\n          for c in freq.values():\n              p = c / n\n              ent -= p * math.log2(p)\n          return ent\n\n      def scan_file(path):\n          findings = []\n          try:\n              with open(path, \"r\", errors=\"ignore\") as f:\n                  for ln, line in enumerate(f, 1):\n                      for name, rx in KEY_PATTERNS.items():\n                          if rx.search(line):\n                              if os.path.basename(path) in ALLOWLIST_NAMES:\n                                  continue\n                              findings.append({\"file\": path, \"line\": ln, \"kind\": name, \"value\": line.strip(), \"severity\": \"high\"})\n                      tokens = re.findall(r\"[A-Za-z0-9_\\-/+=]{20,}\", line)\n                      for tok in tokens:\n                          ent = shannon_entropy(tok)\n                          if ent >= 4.5 and not tok.islower() and not tok.isupper():\n                              if \"/\" in tok and \":\" in tok:\n                                  continue\n                              findings.append({\"file\": path, \"line\": ln, \"kind\": \"high_entropy\", \"value\": tok[:64], \"entropy\": ent, \"severity\": \"high\"})\n          except Exception as e:\n              findings.append({\"file\": path, \"error\": str(e), \"severity\": \"info\"})\n          return findings\n\n      def main():\n          root = os.environ.get(\"REPO_PATH\", \"artifacts/examples/dev/repo_demo\")\n          if os.path.isfile(root):\n              root = os.path.dirname(root)\n\n          results = []\n          for dirpath, dirnames, filenames in os.walk(root):\n              dirnames[:] = [d for d in dirnames if d not in SKIP_DIRS]\n              for fn in filenames:\n                  if os.path.splitext(fn)[1].lower() in SKIP_FILE_EXT:\n                      continue\n                  if fn in ALLOWLIST_NAMES:\n                      continue\n                  path = os.path.join(dirpath, fn)\n                  results.extend(scan_file(path))\n\n          fail = any(f.get(\"severity\") == \"high\" for f in results)\n          print(json.dumps({\"ok\": not fail, \"findings\": results, \"scanned_root\": root}, indent=2))\n          sys.exit(0 if not fail else 1)\n\n      if __name__ == \"__main__\":\n          main()\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "dev.commit_conventions_v1": {
      "id": "dev.commit_conventions_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Conventional Commits (with Examples)",
      "statement": "Consistent messages → better changelogs, semantic versioning, and easier reviews.\n\nTypes\n  • feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert\n\nFormat\n  • type(scope): brief imperative summary\n  • Blank line, then optional body; footer for BREAKING CHANGE or issues.\n\nExamples\n  • feat(api): add pagination to listUsers\n  • fix(auth): handle expired refresh tokens\n  • docs(readme): add quickstart docker commands\n\nDiff etiquette\n  • Keep PRs small; isolate unrelated changes; include before/after snippets when helpful.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.commit_conventions_v1.yaml",
      "_raw": "id: dev.commit_conventions_v1\nversion: 1.0.0\ndomain: dev\ntitle: Conventional Commits (with Examples)\nstatement: |-\n  Consistent messages → better changelogs, semantic versioning, and easier reviews.\n\n  Types\n    • feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert\n\n  Format\n    • type(scope): brief imperative summary\n    • Blank line, then optional body; footer for BREAKING CHANGE or issues.\n\n  Examples\n    • feat(api): add pagination to listUsers\n    • fix(auth): handle expired refresh tokens\n    • docs(readme): add quickstart docker commands\n\n  Diff etiquette\n    • Keep PRs small; isolate unrelated changes; include before/after snippets when helpful.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.prompt_safety_rules_v1": {
      "id": "dev.prompt_safety_rules_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Prompt Safety Rules (No Secrets, No PHI/PII, Scratchpad Discipline)",
      "statement": "Guardrails for safe, reproducible dev prompting.\n\nDo\n  • Redact or mask secrets/PHI/PII before pasting (tokens, keys, emails, phone numbers).\n  • Use a scratchpad file; summarize context; paste only minimal diffs, errors, and file paths.\n  • State desired output explicitly (patch/diff, function signature, CLI snippet).\n  • Declare toolchain versions and OS when relevant (python 3.11, node 20, ubuntu 22.04).\n  • Prefer small, testable changes; include tests or commands to verify.\n\nDon’t\n  • Paste .env, private keys, customer data, or production URLs.\n  • Demand sweeping refactors; avoid touching unrelated files.\n  • Bury the lede — put the objective first; attach diagnostics after.\n\nScratchpad discipline\n  • Keep a running PLAN → VERIFY → ANSWER section.\n  • Use fenced code blocks for diffs/patches; keep commit-ready.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.prompt_safety_rules_v1.yaml",
      "_raw": "id: dev.prompt_safety_rules_v1\nversion: 1.0.0\ndomain: dev\ntitle: Prompt Safety Rules (No Secrets, No PHI/PII, Scratchpad Discipline)\nstatement: |-\n  Guardrails for safe, reproducible dev prompting.\n\n  Do\n    • Redact or mask secrets/PHI/PII before pasting (tokens, keys, emails, phone numbers).\n    • Use a scratchpad file; summarize context; paste only minimal diffs, errors, and file paths.\n    • State desired output explicitly (patch/diff, function signature, CLI snippet).\n    • Declare toolchain versions and OS when relevant (python 3.11, node 20, ubuntu 22.04).\n    • Prefer small, testable changes; include tests or commands to verify.\n\n  Don’t\n    • Paste .env, private keys, customer data, or production URLs.\n    • Demand sweeping refactors; avoid touching unrelated files.\n    • Bury the lede — put the objective first; attach diagnostics after.\n\n  Scratchpad discipline\n    • Keep a running PLAN → VERIFY → ANSWER section.\n    • Use fenced code blocks for diffs/patches; keep commit-ready.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.style_guide_python_v1": {
      "id": "dev.style_guide_python_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "Python Style Guide (Practical Defaults)",
      "statement": "Use boring, reliable defaults to keep diffs clean and onboarding fast.\n\nFormatter & Lint\n  • Black (line-length 88), isort (profile=black), Ruff (or flake8) with error-level lint.\n  • mypy: --strict for libraries, relaxed for apps; add types for new/changed code.\n\nDocstrings & Tests\n  • Google or NumPy style docstrings; include Args/Returns/Raises.\n  • pytest for tests; AAA pattern; prefer small, focused tests.\n\nExamples\n  • Function signature changes require typing + tests.\n  • IO code uses context managers; network calls have timeouts.\n  • Use pathlib, not os.path string munging; f-strings over format().",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.style_guide_python_v1.yaml",
      "_raw": "id: dev.style_guide_python_v1\nversion: 1.0.0\ndomain: dev\ntitle: Python Style Guide (Practical Defaults)\nstatement: |-\n  Use boring, reliable defaults to keep diffs clean and onboarding fast.\n\n  Formatter & Lint\n    • Black (line-length 88), isort (profile=black), Ruff (or flake8) with error-level lint.\n    • mypy: --strict for libraries, relaxed for apps; add types for new/changed code.\n\n  Docstrings & Tests\n    • Google or NumPy style docstrings; include Args/Returns/Raises.\n    • pytest for tests; AAA pattern; prefer small, focused tests.\n\n  Examples\n    • Function signature changes require typing + tests.\n    • IO code uses context managers; network calls have timeouts.\n    • Use pathlib, not os.path string munging; f-strings over format().\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "dev.review_checklist_v1": {
      "id": "dev.review_checklist_v1",
      "version": "1.0.0",
      "domain": "dev",
      "title": "PR Review Checklist (Security, Perf, i18n, Docs, Tests)",
      "statement": "Minimal checklist for actionable reviews.\n\nSecurity\n  • Inputs validated; authz checked; secrets not logged; dependencies sane.\nPerformance\n  • No accidental N^2; hot paths measured; allocations/retries bounded.\ni18n & UX\n  • Text externalized; RTL and accessibility considered for UI.\nDocs & Tests\n  • README/CHANGELOG touched if behavior changes; tests added/updated; coverage stable.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/dev",
        "created": "2025-11-10T20:25:00Z",
        "updated": "2025-11-10T20:25:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/dev/dev.review_checklist_v1.yaml",
      "_raw": "id: dev.review_checklist_v1\nversion: 1.0.0\ndomain: dev\ntitle: PR Review Checklist (Security, Perf, i18n, Docs, Tests)\nstatement: |-\n  Minimal checklist for actionable reviews.\n\n  Security\n    • Inputs validated; authz checked; secrets not logged; dependencies sane.\n  Performance\n    • No accidental N^2; hot paths measured; allocations/retries bounded.\n  i18n & UX\n    • Text externalized; RTL and accessibility considered for UI.\n  Docs & Tests\n    • README/CHANGELOG touched if behavior changes; tests added/updated; coverage stable.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/dev\n  created: '2025-11-10T20:25:00Z'\n  updated: '2025-11-10T20:25:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- review\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.pii_redaction_smoke_v1": {
      "id": "support.pii_redaction_smoke_v1",
      "version": "1.0.0",
      "domain": "support",
      "title": "PII Redaction Smoke Test",
      "statement": "Ensure bundled examples contain no plaintext PII. This check scans example transcripts\n(default: artifacts/examples/support_agent/examples.txt) for emails, phone numbers,\ncredit card patterns, government ID keywords, street addresses, and IP addresses.",
      "witnesses": [
        {
          "name": "no_plaintext_pii_in_examples",
          "language": "python",
          "code": "import os, sys, re, json, glob\n\ndef find_files(path):\n    if os.path.isdir(path):\n        for ext in (\"*.txt\", \"*.md\", \"*.log\"):\n            for p in glob.glob(os.path.join(path, ext)):\n                yield p\n    else:\n        if os.path.exists(path):\n            yield path\n\nEMAIL = re.compile(r\"[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\", re.I)\nPHONE = re.compile(r\"(?:\\+?\\d{1,3}[\\s\\-\\.]?)?(?:\\(?\\d{3}\\)?[\\s\\-\\.]?\\d{3}[\\s\\-\\.]?\\d{4})\")\nCCARD = re.compile(r\"\\b(?:\\d[ -]*?){13,19}\\b\")\nGOVID = re.compile(r\"\\b(?:SSN|NIN|SIN|CPF|DNI|Aadhar)\\b\", re.I)\nADDRESS = re.compile(r\"\\b\\d{1,5}\\s+\\w+\\s+(?:St|Street|Ave|Avenue|Rd|Road|Blvd|Lane|Ln|Dr|Drive)\\b\", re.I)\nIPADDR = re.compile(r\"\\b(?:(?:\\d{1,3}\\.){3}\\d{1,3})\\b\")\n\nMASKED_TOKENS = re.compile(r\"\\*\\*\\*|\\[redacted\\]|\\[masked\\]\", re.I)\n\ndef main():\n    examples_path = os.environ.get(\"EXAMPLES_PATH\", \"\").strip()\n    fail_on_any = os.environ.get(\"FAIL_ON_ANY\", \"true\").lower() == \"true\"\n\n    if not examples_path:\n        print(json.dumps({\"ok\": False, \"error\": \"EXAMPLES_PATH not set\"}))\n        sys.exit(2)\n\n    patterns = {\n        \"email\": EMAIL,\n        \"phone\": PHONE,\n        \"credit_card\": CCARD,\n        \"government_id\": GOVID,\n        \"street_address\": ADDRESS,\n        \"ip_address\": IPADDR,\n    }\n\n    findings = []\n    total_lines = 0\n\n    for fp in find_files(examples_path):\n        with open(fp, \"r\", errors=\"ignore\") as f:\n            for ln, line in enumerate(f, 1):\n                total_lines += 1\n                if MASKED_TOKENS.search(line):\n                    continue\n                for tag, rx in patterns.items():\n                    for m in rx.finditer(line):\n                        findings.append({\"file\": fp, \"line\": ln, \"tag\": tag, \"match\": m.group(0)[:64]})\n\n    ok = len(findings) == 0\n    result = {\"ok\": ok, \"total_lines\": total_lines, \"violations\": findings}\n\n    print(json.dumps(result, indent=2))\n    sys.exit(0 if (ok or not fail_on_any) else 1)\n\nif __name__ == \"__main__\":\n    main()",
          "env": {
            "EXAMPLES_PATH": "artifacts/examples/support_agent/examples.txt",
            "FAIL_ON_ANY": "true"
          },
          "success_message": "No PII found in examples.",
          "failure_message": "PII detected in examples. Redact or mask before shipping."
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.pii_redaction_smoke_v1.yaml",
      "_raw": "id: support.pii_redaction_smoke_v1\nversion: 1.0.0\ndomain: support\ntitle: PII Redaction Smoke Test\nstatement: |-\n  Ensure bundled examples contain no plaintext PII. This check scans example transcripts\n  (default: artifacts/examples/support_agent/examples.txt) for emails, phone numbers,\n  credit card patterns, government ID keywords, street addresses, and IP addresses.\nwitnesses:\n  - name: no_plaintext_pii_in_examples\n    language: python\n    code: |-\n      import os, sys, re, json, glob\n\n      def find_files(path):\n          if os.path.isdir(path):\n              for ext in (\"*.txt\", \"*.md\", \"*.log\"):\n                  for p in glob.glob(os.path.join(path, ext)):\n                      yield p\n          else:\n              if os.path.exists(path):\n                  yield path\n\n      EMAIL = re.compile(r\"[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\", re.I)\n      PHONE = re.compile(r\"(?:\\+?\\d{1,3}[\\s\\-\\.]?)?(?:\\(?\\d{3}\\)?[\\s\\-\\.]?\\d{3}[\\s\\-\\.]?\\d{4})\")\n      CCARD = re.compile(r\"\\b(?:\\d[ -]*?){13,19}\\b\")\n      GOVID = re.compile(r\"\\b(?:SSN|NIN|SIN|CPF|DNI|Aadhar)\\b\", re.I)\n      ADDRESS = re.compile(r\"\\b\\d{1,5}\\s+\\w+\\s+(?:St|Street|Ave|Avenue|Rd|Road|Blvd|Lane|Ln|Dr|Drive)\\b\", re.I)\n      IPADDR = re.compile(r\"\\b(?:(?:\\d{1,3}\\.){3}\\d{1,3})\\b\")\n\n      MASKED_TOKENS = re.compile(r\"\\*\\*\\*|\\[redacted\\]|\\[masked\\]\", re.I)\n\n      def main():\n          examples_path = os.environ.get(\"EXAMPLES_PATH\", \"\").strip()\n          fail_on_any = os.environ.get(\"FAIL_ON_ANY\", \"true\").lower() == \"true\"\n\n          if not examples_path:\n              print(json.dumps({\"ok\": False, \"error\": \"EXAMPLES_PATH not set\"}))\n              sys.exit(2)\n\n          patterns = {\n              \"email\": EMAIL,\n              \"phone\": PHONE,\n              \"credit_card\": CCARD,\n              \"government_id\": GOVID,\n              \"street_address\": ADDRESS,\n              \"ip_address\": IPADDR,\n          }\n\n          findings = []\n          total_lines = 0\n\n          for fp in find_files(examples_path):\n              with open(fp, \"r\", errors=\"ignore\") as f:\n                  for ln, line in enumerate(f, 1):\n                      total_lines += 1\n                      if MASKED_TOKENS.search(line):\n                          continue\n                      for tag, rx in patterns.items():\n                          for m in rx.finditer(line):\n                              findings.append({\"file\": fp, \"line\": ln, \"tag\": tag, \"match\": m.group(0)[:64]})\n\n          ok = len(findings) == 0\n          result = {\"ok\": ok, \"total_lines\": total_lines, \"violations\": findings}\n\n          print(json.dumps(result, indent=2))\n          sys.exit(0 if (ok or not fail_on_any) else 1)\n\n      if __name__ == \"__main__\":\n          main()\n    env:\n      EXAMPLES_PATH: artifacts/examples/support_agent/examples.txt\n      FAIL_ON_ANY: \"true\"\n    success_message: \"No PII found in examples.\"\n    failure_message: \"PII detected in examples. Redact or mask before shipping.\"\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: ''\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "support.billing_basics_v1": {
      "id": "support.billing_basics_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Billing Playbooks (SaaS)",
      "statement": "Canonical flows for common billing issues without exposing PII or promising credits.\n\nPlaybook: Get invoice PDF\n  1) Ask for masked account identifier (e.g., ticket or org slug).\n  2) Guide to: Settings → Billing → Invoices → \"Download PDF\".\n  3) If missing, create ticket for Billing with masked reference.\n\nPlaybook: Refund request (within policy)\n  1) Acknowledge and summarize the reason.\n  2) Link refunds policy (exact section) and timeframe.\n  3) Create Billing ticket; do not promise outcome; share reference ID.\n\nPlaybook: Plan downgrade / cancel\n  1) Confirm effective date and proration link.\n  2) Guide to: Settings → Plan → \"Change plan\".\n  3) If blocked by contract, route to Billing Supervisor.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.billing_basics_v1.yaml",
      "_raw": "id: support.billing_basics_v1\nversion: 1.1.0\ndomain: support\ntitle: Billing Playbooks (SaaS)\nstatement: |-\n  Canonical flows for common billing issues without exposing PII or promising credits.\n\n  Playbook: Get invoice PDF\n    1) Ask for masked account identifier (e.g., ticket or org slug).\n    2) Guide to: Settings → Billing → Invoices → \"Download PDF\".\n    3) If missing, create ticket for Billing with masked reference.\n\n  Playbook: Refund request (within policy)\n    1) Acknowledge and summarize the reason.\n    2) Link refunds policy (exact section) and timeframe.\n    3) Create Billing ticket; do not promise outcome; share reference ID.\n\n  Playbook: Plan downgrade / cancel\n    1) Confirm effective date and proration link.\n    2) Guide to: Settings → Plan → \"Change plan\".\n    3) If blocked by contract, route to Billing Supervisor.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.knowledge_view_projection_v1": {
      "id": "support.knowledge_view_projection_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Knowledge View & Citation Policy",
      "statement": "Cite official docs with exact anchors; avoid paraphrasing policy-sensitive pages.\n\nSources policy:\n  • Prefer official docs, status pages, and signed announcements. Avoid blog posts for policy.\n\nCitation rules:\n  • Link the exact doc section and version (e.g., /docs/billing#refunds v3.1).\n  • Summarize in one sentence, then provide the link; do not copy large passages.\n  • If doc is gated, describe the path (Settings → Billing → Invoices).\n  • For outages, always include {status_url} and the last update time.\n\nLink policy:\n  • Never link to internal-only resources in public responses.\n  • If a page moves, provide both old and new paths during the transition.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.knowledge_view_projection_v1.yaml",
      "_raw": "id: support.knowledge_view_projection_v1\nversion: 1.1.0\ndomain: support\ntitle: Knowledge View & Citation Policy\nstatement: |-\n  Cite official docs with exact anchors; avoid paraphrasing policy-sensitive pages.\n\n  Sources policy:\n    • Prefer official docs, status pages, and signed announcements. Avoid blog posts for policy.\n\n  Citation rules:\n    • Link the exact doc section and version (e.g., /docs/billing#refunds v3.1).\n    • Summarize in one sentence, then provide the link; do not copy large passages.\n    • If doc is gated, describe the path (Settings → Billing → Invoices).\n    • For outages, always include {status_url} and the last update time.\n\n  Link policy:\n    • Never link to internal-only resources in public responses.\n    • If a page moves, provide both old and new paths during the transition.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.escalation_matrix_v1": {
      "id": "support.escalation_matrix_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Escalation Matrix & Handoffs",
      "statement": "Route high-risk or restricted requests to the correct queue with a crisp customer explanation.\n\nMatrix (placeholders in braces are filled by your system):\n  +------------------------+---------------------+----------------------+---------------------------+\n  | Scenario               | Tier / Owner        | SLA                  | Customer-Facing Message   |\n  +------------------------+---------------------+----------------------+---------------------------+\n  | Outage / Sev-1         | On-call SRE         | 15m ack / hourly upd | \"We're experiencing an    |\n  |                        |                     |                      | outage. Status: {status_url}\"    |\n  | Billing dispute >$500  | Billing Specialist  | 1 business day       | \"I've opened a ticket     |\n  |                        |                     |                      | with Billing. Ref: {ticket_id}\"  |\n  | Refund exceptions      | Billing Supervisor  | 2 business days      | \"I'll escalate your refund|\n  |                        |                     |                      | request for review.\"      |\n  | Security/Privacy       | Security Team       | 1 business day       | \"Escalated to security.   |\n  |                        |                     |                      | Ref: {ticket}\"          |\n  | Data deletion (GDPR)   | Data Protection Off | 72 hours             | \"Deletion in progress.    |\n  |                        |                     |                      | Ref: {ticket}\"          |\n  +------------------------+---------------------+----------------------+---------------------------+\n\nRules:\n  • If severity ≥ Sev-2 or involves legal/privacy, escalate immediately and provide a reference ID.\n  • Never modify or promise billing credits; create a ticket and route to Billing.\n  • Provide the customer with what will happen next and a timeframe.\n  • Record all escalations with ticket references; avoid free-form DMs.\n  • Do not request or store PII; use masked references only.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.escalation_matrix_v1.yaml",
      "_raw": "id: support.escalation_matrix_v1\nversion: 1.1.0\ndomain: support\ntitle: Escalation Matrix & Handoffs\nstatement: |-\n  Route high-risk or restricted requests to the correct queue with a crisp customer explanation.\n\n  Matrix (placeholders in braces are filled by your system):\n    +------------------------+---------------------+----------------------+---------------------------+\n    | Scenario               | Tier / Owner        | SLA                  | Customer-Facing Message   |\n    +------------------------+---------------------+----------------------+---------------------------+\n    | Outage / Sev-1         | On-call SRE         | 15m ack / hourly upd | \"We're experiencing an    |\n    |                        |                     |                      | outage. Status: {status_url}\"    |\n    | Billing dispute >$500  | Billing Specialist  | 1 business day       | \"I've opened a ticket     |\n    |                        |                     |                      | with Billing. Ref: {ticket_id}\"  |\n    | Refund exceptions      | Billing Supervisor  | 2 business days      | \"I'll escalate your refund|\n    |                        |                     |                      | request for review.\"      |\n    | Security/Privacy       | Security Team       | 1 business day       | \"Escalated to security.   |\n    |                        |                     |                      | Ref: {ticket}\"          |\n    | Data deletion (GDPR)   | Data Protection Off | 72 hours             | \"Deletion in progress.    |\n    |                        |                     |                      | Ref: {ticket}\"          |\n    +------------------------+---------------------+----------------------+---------------------------+\n\n  Rules:\n    • If severity ≥ Sev-2 or involves legal/privacy, escalate immediately and provide a reference ID.\n    • Never modify or promise billing credits; create a ticket and route to Billing.\n    • Provide the customer with what will happen next and a timeframe.\n    • Record all escalations with ticket references; avoid free-form DMs.\n    • Do not request or store PII; use masked references only.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.intent_router_sanity_v1": {
      "id": "support.intent_router_sanity_v1",
      "version": "1.0.0",
      "domain": "support",
      "title": "Intent Router Sanity Check",
      "statement": "Validate that baseline rules classify common support intents correctly. Defaults read\nfixtures under artifacts/examples/support_agent/. Accuracy must meet or exceed 0.8.",
      "assumptions": null,
      "pedagogy": null,
      "witnesses": [
        {
          "name": "routes_top_intents_correctly",
          "language": "python",
          "code": "import os, sys, json, re\n\ndef load_json(path):\n    with open(path, \"r\") as f:\n        return json.load(f)\n\ndef classify(text, rules):\n    text_l = text.lower()\n    for intent, pats in rules.items():\n        for pat in pats:\n            if re.search(pat, text_l):\n                return intent\n    return \"unknown\"\n\ndef main():\n    intents_path = os.environ.get(\"INTENTS_JSON\", \"\").strip()\n    rules_path = os.environ.get(\"RULES_JSON\", \"\").strip()\n    acc_threshold = float(os.environ.get(\"ACC_THRESHOLD\", \"0.8\"))\n\n    if not intents_path or not rules_path:\n        print(json.dumps({\"ok\": False, \"error\": \"INTENTS_JSON or RULES_JSON not set\"}))\n        sys.exit(2)\n\n    intents = load_json(intents_path)  # list of {text, expected}\n    rules = load_json(rules_path)      # {intent: [regex,...]}\n\n    total = len(intents)\n    correct = 0\n    details = []\n\n    for item in intents:\n        text = item[\"text\"]\n        expected = item[\"expected\"]\n        pred = classify(text, rules)\n        correct += 1 if pred == expected else 0\n        details.append({\"text\": text, \"expected\": expected, \"pred\": pred})\n\n    acc = (correct / total) if total else 0.0\n    ok = acc >= acc_threshold\n\n    print(json.dumps({\"ok\": ok, \"accuracy\": acc, \"threshold\": acc_threshold, \"total\": total, \"correct\": correct, \"details\": details}, indent=2))\n    sys.exit(0 if ok else 1)\n\nif __name__ == \"__main__\":\n    main()",
          "env": {
            "INTENTS_JSON": "artifacts/examples/support_agent/intents.json",
            "RULES_JSON": "artifacts/examples/support_agent/router_rules.json",
            "ACC_THRESHOLD": "0.8"
          },
          "success_message": "Intent router accuracy meets threshold.",
          "failure_message": "Intent router below threshold — refine rules or examples."
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T18:12:37Z",
        "updated": "2025-11-10T18:12:37Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.intent_router_sanity_v1.yaml",
      "_raw": "id: support.intent_router_sanity_v1\nversion: 1.0.0\ndomain: support\ntitle: Intent Router Sanity Check\nstatement: |-\n  Validate that baseline rules classify common support intents correctly. Defaults read\n  fixtures under artifacts/examples/support_agent/. Accuracy must meet or exceed 0.8.\nassumptions:\npedagogy:\nwitnesses:\n  - name: routes_top_intents_correctly\n    language: python\n    code: |-\n      import os, sys, json, re\n\n      def load_json(path):\n          with open(path, \"r\") as f:\n              return json.load(f)\n\n      def classify(text, rules):\n          text_l = text.lower()\n          for intent, pats in rules.items():\n              for pat in pats:\n                  if re.search(pat, text_l):\n                      return intent\n          return \"unknown\"\n\n      def main():\n          intents_path = os.environ.get(\"INTENTS_JSON\", \"\").strip()\n          rules_path = os.environ.get(\"RULES_JSON\", \"\").strip()\n          acc_threshold = float(os.environ.get(\"ACC_THRESHOLD\", \"0.8\"))\n\n          if not intents_path or not rules_path:\n              print(json.dumps({\"ok\": False, \"error\": \"INTENTS_JSON or RULES_JSON not set\"}))\n              sys.exit(2)\n\n          intents = load_json(intents_path)  # list of {text, expected}\n          rules = load_json(rules_path)      # {intent: [regex,...]}\n\n          total = len(intents)\n          correct = 0\n          details = []\n\n          for item in intents:\n              text = item[\"text\"]\n              expected = item[\"expected\"]\n              pred = classify(text, rules)\n              correct += 1 if pred == expected else 0\n              details.append({\"text\": text, \"expected\": expected, \"pred\": pred})\n\n          acc = (correct / total) if total else 0.0\n          ok = acc >= acc_threshold\n\n          print(json.dumps({\"ok\": ok, \"accuracy\": acc, \"threshold\": acc_threshold, \"total\": total, \"correct\": correct, \"details\": details}, indent=2))\n          sys.exit(0 if ok else 1)\n\n      if __name__ == \"__main__\":\n          main()\n\n    env:\n      INTENTS_JSON: artifacts/examples/support_agent/intents.json\n      RULES_JSON: artifacts/examples/support_agent/router_rules.json\n      ACC_THRESHOLD: \"0.8\"\n    success_message: \"Intent router accuracy meets threshold.\"\n    failure_message: \"Intent router below threshold — refine rules or examples.\"\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T18:12:37Z'\n  updated: '2025-11-10T18:12:37Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: ''\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "support.tone_style_guide_v1": {
      "id": "support.tone_style_guide_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Tone & Style Guide (Public-Facing)",
      "statement": "Be empathetic, concise, specific, and action-oriented; never echo or store PII.\nRules:\n  • Lead with empathy and a one-sentence summary of the customer’s goal.\n  • Offer one actionable next step; avoid overwhelming lists.\n  • Prefer links to official docs; include exact anchor and version if relevant.\n  • Never guess order/account details; ask for the minimal non-sensitive clarifier.\n  • Use plain language; avoid internal acronyms or engineering jargon.\n  • Avoid absolute promises; reference policy and expected timeframes.",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.tone_style_guide_v1.yaml",
      "_raw": "id: support.tone_style_guide_v1\nversion: 1.1.0\ndomain: support\ntitle: Tone & Style Guide (Public-Facing)\nstatement: |-\n  Be empathetic, concise, specific, and action-oriented; never echo or store PII.\n  Rules:\n    • Lead with empathy and a one-sentence summary of the customer’s goal.\n    • Offer one actionable next step; avoid overwhelming lists.\n    • Prefer links to official docs; include exact anchor and version if relevant.\n    • Never guess order/account details; ask for the minimal non-sensitive clarifier.\n    • Use plain language; avoid internal acronyms or engineering jargon.\n    • Avoid absolute promises; reference policy and expected timeframes.\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "support.legal_privacy_rules_v1": {
      "id": "support.legal_privacy_rules_v1",
      "version": "1.1.0",
      "domain": "support",
      "title": "Legal & Privacy Rules (Public-Facing)",
      "statement": "Prevent PII leakage and ensure compliant disclosures.\n\nPII classes to avoid in public channels:\n  • email, phone, government_id, credit_card, street_address, ip_address\n\nStorage policy:\n  • Do not store PII in tickets or chat logs. Use masked IDs or internal references.\n\nCustomer-facing disclaimers (choose 1 as needed):\n  • \"For your security, please avoid sharing personal data (like email, phone, or payment info) here.\"\n  • \"We can continue after I’ve created a secure ticket; I’ll share a masked reference ID.\"\n  • \"I’m not able to provide legal or medical advice. I can link official resources instead.\"",
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules/support",
        "created": "2025-11-10T19:05:00Z",
        "updated": "2025-11-10T19:05:00Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": null,
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "support"
      ],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/support/support.legal_privacy_rules_v1.yaml",
      "_raw": "id: support.legal_privacy_rules_v1\nversion: 1.1.0\ndomain: support\ntitle: Legal & Privacy Rules (Public-Facing)\nstatement: |-\n  Prevent PII leakage and ensure compliant disclosures.\n\n  PII classes to avoid in public channels:\n    • email, phone, government_id, credit_card, street_address, ip_address\n\n  Storage policy:\n    • Do not store PII in tickets or chat logs. Use masked IDs or internal references.\n\n  Customer-facing disclaimers (choose 1 as needed):\n    • \"For your security, please avoid sharing personal data (like email, phone, or payment info) here.\"\n    • \"We can continue after I’ve created a secure ticket; I’ll share a masked reference ID.\"\n    • \"I’m not able to provide legal or medical advice. I can link official resources instead.\"\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules/support\n  created: '2025-11-10T19:05:00Z'\n  updated: '2025-11-10T19:05:00Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: null\n    signature: null\napplies_to:\n- conversation\n- support\nsecurity:\n  sensitivity: medium\n  notes: \"\"\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.citation_required_v1_signed": {
      "id": "llm.citation_required_v1_signed",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Citations required (signed demo)",
      "statement": "Answers must include at least one citation or abstain.",
      "assumptions": [],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What source supports your key claim?"
        },
        {
          "kind": "Aphorism",
          "text": "Cite or abstain."
        }
      ],
      "witnesses": [
        {
          "name": "citations_cover_claims",
          "language": "python",
          "env": {
            "ANSWER_PATH": "artifacts/examples/answer_with_citation.json",
            "COVERAGE_MIN": "0.6",
            "DIVERSITY_MAX": "0.7",
            "ALLOWLIST": "doi.org,arxiv.org,acm.org,ieee.org,nature.com,sciencemag.org,gov,edu",
            "DOC_CLASS": ""
          },
          "code": "import os, re, json, sys, pathlib\nfrom urllib.parse import urlparse\n\nap = pathlib.Path(os.getenv(\"ANSWER_PATH\",\"\")).resolve()\nif not ap.exists():\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"file-not-found\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\n# Opinion content can SKIP (policy-controlled)\nif os.getenv(\"DOC_CLASS\",\"\").lower() == \"opinion\":\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"SKIP\",\"reason\":\"opinion-doc\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(0)\n\ndata = json.loads(ap.read_text(encoding=\"utf-8\"))\nanswer = (data.get(\"answer\") or \"\").strip()\nrefs = data.get(\"references\") or []\n\n# Very light sentence segmentation (declarative-ish)\nsentences = [s.strip() for s in re.split(r'(?<=[.!?])\\s+', answer) if s.strip()]\n# Extract [n] citations\ncite_pat = re.compile(r'\\[(\\d+)\\]')\ncited_flags = [bool(cite_pat.search(s)) for s in sentences]\ntotal = len(sentences)\ncited = sum(cited_flags)\n\n# Build ref index and domains\nref_by_id = {int(r.get(\"id\")): r for r in refs if isinstance(r.get(\"id\"), int) and r.get(\"url\")}\ndomains = []\nfor r in refs:\n    try:\n        host = urlparse(r.get(\"url\",\"\")).netloc.lower()\n        if host: domains.append(host)\n    except Exception:\n        pass\n\n# Policies\nCOVERAGE_MIN = float(os.getenv(\"COVERAGE_MIN\",\"0.6\"))\nDIVERSITY_MAX = float(os.getenv(\"DIVERSITY_MAX\",\"0.7\"))\nALLOWLIST = [d.strip().lower() for d in os.getenv(\"ALLOWLIST\",\"\").split(\",\") if d.strip()]\n\ndef domain_class(host):\n    if host.endswith(\".gov\") or host.endswith(\".edu\") or host in ALLOWLIST or any(host.endswith(d) for d in ALLOWLIST):\n        return \"preferred\"\n    return \"other\"\n\n# Reference integrity checks\n# 1) No citations at all → FAIL (unless no declaratives → SKIP)\nif total == 0:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"SKIP\",\"reason\":\"no-declaratives\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(0)\n\nfound_cites = [int(n) for n in cite_pat.findall(answer)]\nif not found_cites:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"no-citations\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\n# 2) Every [n] must exist in references\nmissing_map = sorted({n for n in set(found_cites) if n not in ref_by_id})\nif missing_map:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"missing-refs\",\"missing_ids\":missing_map,\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\n# 3) Sequential numbering starting at 1 (soft check)\nif ref_by_id and (min(ref_by_id) != 1 or max(ref_by_id) != len(ref_by_id)):\n    # Not fatal, but record as warning in output payload\n    numbering_warn = True\nelse:\n    numbering_warn = False\n\n# 4) Coverage threshold\ncoverage = cited/total if total else 0.0\nif coverage < COVERAGE_MIN:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"coverage-too-low\",\"coverage\":coverage,\"min\":COVERAGE_MIN,\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\n# 5) Diversity (prevent single-domain echo chamber)\nfrom collections import Counter\ndom_counts = Counter(domains)\nif dom_counts:\n    top_dom, top_cnt = dom_counts.most_common(1)[0]\n    if top_cnt/len(domains) > DIVERSITY_MAX:\n        print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"source-too-concentrated\",\"top_domain\":top_dom,\"share\":top_cnt/len(domains),\"max\":DIVERSITY_MAX,\"inputs\":{\"answer\":str(ap)}}))\n        sys.exit(1)\n\n    # Disallow all-wikipedia (or single non-preferred domain) cases\n    if len(dom_counts) == 1 and (\"wikipedia.org\" in dom_counts):\n        print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"all-wikipedia\",\"inputs\":{\"answer\":str(ap)}}))\n        sys.exit(1)\n\n# 6) Allowlist presence (at least one preferred or academic/governmental source)\nhas_pref = any(domain_class(h)==\"preferred\" for h in domains)\nif not has_pref and refs:\n    print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"no-preferred-sources\",\"inputs\":{\"answer\":str(ap)}}))\n    sys.exit(1)\n\nout = {\n    \"witness\":\"citations_cover_claims\",\n    \"status\":\"PASS\",\n    \"coverage\": coverage,\n    \"sequential_numbering_warn\": numbering_warn,\n    \"totals\":{\"sentences\": total, \"cited\": cited, \"refs\": len(refs)},\n    \"inputs\":{\"answer\": str(ap)}\n}\nprint(json.dumps(out, indent=2))\nsys.exit(0)"
        }
      ],
      "provenance": {
        "author": "Truth Capsules Demo",
        "license": "MIT",
        "schema": "provenance.v1",
        "org": "Truth Capsules",
        "created": "2025-11-07T04:51:20.658919Z",
        "signing": {
          "algorithm": "ed25519",
          "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAdkKe+ZblRkk/8oGtvid7tisLS8L3j12LjGHLC05vnDs=\n-----END PUBLIC KEY-----\n",
          "digest": "b7862aabe696451c37f4e870ece9ae18b37344ef14cf48561dbadf40a5bd5d42",
          "signature_b64": "VJ8i2ZLMIER3ITahlPQZ435w/ZxRAwyGRnPqboVQG78+GUe2alcBd5BS/1KzjtzMxi+B32TvaSbu7tYf3rNSBg==",
          "status": "approved"
        }
      },
      "_file": "./capsules/legacy_capsules/llm/llm.citation_required_v1_signed.yaml",
      "_raw": "id: llm.citation_required_v1_signed\nversion: 1.0.0\ndomain: llm\ntitle: Citations required (signed demo)\nstatement: Answers must include at least one citation or abstain.\nassumptions: []\npedagogy:\n- kind: Socratic\n  text: What source supports your key claim?\n- kind: Aphorism\n  text: Cite or abstain.\nwitnesses:\n  - name: citations_cover_claims\n    language: python\n    env:\n      ANSWER_PATH: artifacts/examples/answer_with_citation.json\n      COVERAGE_MIN: \"0.6\"         # ≥60% declarative sentences must be cited\n      DIVERSITY_MAX: \"0.7\"         # ≤70% of refs may come from one domain\n      ALLOWLIST: \"doi.org,arxiv.org,acm.org,ieee.org,nature.com,sciencemag.org,gov,edu\"\n      DOC_CLASS: \"\"                # set to \"opinion\" to SKIP\n    code: |-\n      import os, re, json, sys, pathlib\n      from urllib.parse import urlparse\n\n      ap = pathlib.Path(os.getenv(\"ANSWER_PATH\",\"\")).resolve()\n      if not ap.exists():\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"file-not-found\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      # Opinion content can SKIP (policy-controlled)\n      if os.getenv(\"DOC_CLASS\",\"\").lower() == \"opinion\":\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"SKIP\",\"reason\":\"opinion-doc\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(0)\n\n      data = json.loads(ap.read_text(encoding=\"utf-8\"))\n      answer = (data.get(\"answer\") or \"\").strip()\n      refs = data.get(\"references\") or []\n\n      # Very light sentence segmentation (declarative-ish)\n      sentences = [s.strip() for s in re.split(r'(?<=[.!?])\\s+', answer) if s.strip()]\n      # Extract [n] citations\n      cite_pat = re.compile(r'\\[(\\d+)\\]')\n      cited_flags = [bool(cite_pat.search(s)) for s in sentences]\n      total = len(sentences)\n      cited = sum(cited_flags)\n\n      # Build ref index and domains\n      ref_by_id = {int(r.get(\"id\")): r for r in refs if isinstance(r.get(\"id\"), int) and r.get(\"url\")}\n      domains = []\n      for r in refs:\n          try:\n              host = urlparse(r.get(\"url\",\"\")).netloc.lower()\n              if host: domains.append(host)\n          except Exception:\n              pass\n\n      # Policies\n      COVERAGE_MIN = float(os.getenv(\"COVERAGE_MIN\",\"0.6\"))\n      DIVERSITY_MAX = float(os.getenv(\"DIVERSITY_MAX\",\"0.7\"))\n      ALLOWLIST = [d.strip().lower() for d in os.getenv(\"ALLOWLIST\",\"\").split(\",\") if d.strip()]\n\n      def domain_class(host):\n          if host.endswith(\".gov\") or host.endswith(\".edu\") or host in ALLOWLIST or any(host.endswith(d) for d in ALLOWLIST):\n              return \"preferred\"\n          return \"other\"\n\n      # Reference integrity checks\n      # 1) No citations at all → FAIL (unless no declaratives → SKIP)\n      if total == 0:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"SKIP\",\"reason\":\"no-declaratives\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(0)\n\n      found_cites = [int(n) for n in cite_pat.findall(answer)]\n      if not found_cites:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"no-citations\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      # 2) Every [n] must exist in references\n      missing_map = sorted({n for n in set(found_cites) if n not in ref_by_id})\n      if missing_map:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"missing-refs\",\"missing_ids\":missing_map,\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      # 3) Sequential numbering starting at 1 (soft check)\n      if ref_by_id and (min(ref_by_id) != 1 or max(ref_by_id) != len(ref_by_id)):\n          # Not fatal, but record as warning in output payload\n          numbering_warn = True\n      else:\n          numbering_warn = False\n\n      # 4) Coverage threshold\n      coverage = cited/total if total else 0.0\n      if coverage < COVERAGE_MIN:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"coverage-too-low\",\"coverage\":coverage,\"min\":COVERAGE_MIN,\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      # 5) Diversity (prevent single-domain echo chamber)\n      from collections import Counter\n      dom_counts = Counter(domains)\n      if dom_counts:\n          top_dom, top_cnt = dom_counts.most_common(1)[0]\n          if top_cnt/len(domains) > DIVERSITY_MAX:\n              print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"source-too-concentrated\",\"top_domain\":top_dom,\"share\":top_cnt/len(domains),\"max\":DIVERSITY_MAX,\"inputs\":{\"answer\":str(ap)}}))\n              sys.exit(1)\n\n          # Disallow all-wikipedia (or single non-preferred domain) cases\n          if len(dom_counts) == 1 and (\"wikipedia.org\" in dom_counts):\n              print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"all-wikipedia\",\"inputs\":{\"answer\":str(ap)}}))\n              sys.exit(1)\n\n      # 6) Allowlist presence (at least one preferred or academic/governmental source)\n      has_pref = any(domain_class(h)==\"preferred\" for h in domains)\n      if not has_pref and refs:\n          print(json.dumps({\"witness\":\"citations_cover_claims\",\"status\":\"FAIL\",\"reason\":\"no-preferred-sources\",\"inputs\":{\"answer\":str(ap)}}))\n          sys.exit(1)\n\n      out = {\n          \"witness\":\"citations_cover_claims\",\n          \"status\":\"PASS\",\n          \"coverage\": coverage,\n          \"sequential_numbering_warn\": numbering_warn,\n          \"totals\":{\"sentences\": total, \"cited\": cited, \"refs\": len(refs)},\n          \"inputs\":{\"answer\": str(ap)}\n      }\n      print(json.dumps(out, indent=2))\n      sys.exit(0)\nprovenance:\n  author: Truth Capsules Demo\n  license: MIT\n  schema: provenance.v1\n  org: Truth Capsules\n  created: '2025-11-07T04:51:20.658919Z'\n  signing:\n    algorithm: ed25519\n    public_key_pem: '-----BEGIN PUBLIC KEY-----\n\n      MCowBQYDK2VwAyEAdkKe+ZblRkk/8oGtvid7tisLS8L3j12LjGHLC05vnDs=\n\n      -----END PUBLIC KEY-----\n\n      '\n    digest: b7862aabe696451c37f4e870ece9ae18b37344ef14cf48561dbadf40a5bd5d42\n    signature_b64: VJ8i2ZLMIER3ITahlPQZ435w/ZxRAwyGRnPqboVQG78+GUe2alcBd5BS/1KzjtzMxi+B32TvaSbu7tYf3rNSBg==\n    status: approved\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "llm.plan_backtest_v1": {
      "id": "llm.plan_backtest_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Plan Backtest",
      "statement": "Backtest the plan on a prior similar case; report differences and whether the plan would have succeeded.",
      "assumptions": [
        "We can reference at least one analogous case (internal or public)."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What happened last time we tried something like this?"
        },
        {
          "kind": "Aphorism",
          "text": "Yesterday is a cheap simulator."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "ca48eef684d2815426664bd7beb2a8a785586c1c169f991a4e64252a99c4155b",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.plan_backtest_v1.yaml",
      "_raw": "id: llm.plan_backtest_v1\nversion: 1.0.0\ndomain: llm\ntitle: Plan Backtest\nstatement: Backtest the plan on a prior similar case; report differences and whether\n  the plan would have succeeded.\nassumptions:\n- We can reference at least one analogous case (internal or public).\npedagogy:\n- kind: Socratic\n  text: What happened last time we tried something like this?\n- kind: Aphorism\n  text: Yesterday is a cheap simulator.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: ca48eef684d2815426664bd7beb2a8a785586c1c169f991a4e64252a99c4155b\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.pr_deploy_checklist_v1": {
      "id": "llm.pr_deploy_checklist_v1",
      "version": "1.0.0",
      "domain": "pr_review",
      "title": "PR Review - Deploy Checklist",
      "statement": "Gate deploy on: feature flag (if risky), migration plan + rollback, observability hooks, on-call acknowledgement.",
      "assumptions": [
        "You can defer large refactors; ship safely first."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "If we had to roll back in 5 minutes, how?"
        },
        {
          "kind": "Aphorism",
          "text": "Plan the rollback before the rollout."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "10679b47e25ea1c981f846f04fc1866994737d7dcc52f8d5888e6774d9debf5f",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.pr_deploy_checklist_v1.yaml",
      "_raw": "id: llm.pr_deploy_checklist_v1\nversion: 1.0.0\ndomain: pr_review\ntitle: PR Review - Deploy Checklist\nstatement: 'Gate deploy on: feature flag (if risky), migration plan + rollback, observability\n  hooks, on-call acknowledgement.'\nassumptions:\n- You can defer large refactors; ship safely first.\npedagogy:\n- kind: Socratic\n  text: If we had to roll back in 5 minutes, how?\n- kind: Aphorism\n  text: Plan the rollback before the rollout.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 10679b47e25ea1c981f846f04fc1866994737d7dcc52f8d5888e6774d9debf5f\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.pr_test_hints_v1": {
      "id": "llm.pr_test_hints_v1",
      "version": "1.0.0",
      "domain": "pr_review",
      "title": "PR Review - Minimal Tests",
      "statement": "Propose 2–4 smallest tests that would catch a regression introduced by this diff (include inputs/edges).",
      "assumptions": [
        "Some testing harness exists (unit/integration)."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What’s the cheapest test that would fail if you’re wrong?"
        },
        {
          "kind": "Aphorism",
          "text": "One failing test beats ten opinions."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "9a9f2f0b564e7630e4fec39fbe9762f65a5e68eae959ff9038a4a0f014399641",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.pr_test_hints_v1.yaml",
      "_raw": "id: llm.pr_test_hints_v1\nversion: 1.0.0\ndomain: pr_review\ntitle: PR Review - Minimal Tests\nstatement: Propose 2–4 smallest tests that would catch a regression introduced by\n  this diff (include inputs/edges).\nassumptions:\n- Some testing harness exists (unit/integration).\npedagogy:\n- kind: Socratic\n  text: What’s the cheapest test that would fail if you’re wrong?\n- kind: Aphorism\n  text: One failing test beats ten opinions.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 9a9f2f0b564e7630e4fec39fbe9762f65a5e68eae959ff9038a4a0f014399641\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.pii_redaction_guard_v1": {
      "id": "llm.pii_redaction_guard_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "PII redaction",
      "statement": "Output must not contain raw PII (emails/phones). Use placeholders or abstain.",
      "assumptions": [
        "Operating in a general context"
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What evidence supports this claim?"
        },
        {
          "kind": "Aphorism",
          "text": "Cite or abstain."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:53:50.511776Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "87d8414f424427fac995afd8b04e8f7e2ec47d8520c13067cb2117bb40928c60",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.pii_redaction_guard_v1.yaml",
      "_raw": "id: llm.pii_redaction_guard_v1\nversion: 1.0.0\ndomain: llm\ntitle: PII redaction\nstatement: Output must not contain raw PII (emails/phones). Use placeholders or abstain.\nassumptions:\n- Operating in a general context\npedagogy:\n- kind: Socratic\n  text: What evidence supports this claim?\n- kind: Aphorism\n  text: Cite or abstain.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:53:50.511776Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 87d8414f424427fac995afd8b04e8f7e2ec47d8520c13067cb2117bb40928c60\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.pr_risk_tags_v1": {
      "id": "llm.pr_risk_tags_v1",
      "version": "1.0.0",
      "domain": "pr_review",
      "title": "PR Review - Risk Tags",
      "statement": "Assign risk tags {security, performance, availability, migration, breaking_change, data_loss} with 0–1 severity and 1–2 line rationale.",
      "assumptions": [
        "Risk framing helps prioritize deeper review and testing."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which user/system risk is most plausible here?"
        },
        {
          "kind": "Aphorism",
          "text": "Name the risk, shrink the risk."
        }
      ],
      "witnesses": [
        {
          "name": "pr_review_covers_risks",
          "language": "python",
          "env": {
            "DIFF_PATH": "artifacts/examples/pr_diff.patch",
            "REVIEW_PATH": "artifacts/examples/pr_review.md"
          },
          "code": "import os, re, json, sys, pathlib\n\ndiff_path   = os.getenv(\"DIFF_PATH\",   \"artifacts/examples/pr_diff.patch\")\nreview_path = os.getenv(\"REVIEW_PATH\", \"artifacts/examples/pr_review.md\")\n\ndp = pathlib.Path(diff_path)\nrp = pathlib.Path(review_path)\nif not dp.exists():\n  print(json.dumps({\"witness\":\"pr_review_covers_risks\",\"error\":f\"missing diff: {dp}\"})); sys.exit(2)\nif not rp.exists():\n  print(json.dumps({\"witness\":\"pr_review_covers_risks\",\"error\":f\"missing review: {rp}\"})); sys.exit(2)\n\ndiff   = dp.read_text(encoding=\"utf-8\", errors=\"replace\")\nreview = rp.read_text(encoding=\"utf-8\", errors=\"replace\")\n\n# Minimal, explainable heuristics → tag the diff\nTAGS = {\n  \"secrets\": r\"(AWS_|SECRET|api[_-]?key|password\\s*=)\",\n  \"auth\":    r\"(oauth|jwt|session|login|auth[^a-z])\",\n  \"net\":     r\"(http[s]?://|requests\\.|fetch\\(|socket\\.)\",\n  \"fs\":      r\"(open\\(|os\\.remove|shutil\\.)\",\n  \"pii\":     r\"(ssn|social[- ]?security|^\\+?\\d{10,}$|[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,})\",\n}\npresent = {tag for tag, rgx in TAGS.items() if re.search(rgx, diff, re.I|re.M)}\n\n# If no risks detected in diff, SKIP (informational)\nif not present:\n    print(json.dumps({\n        \"witness\": \"pr_review_covers_risks\",\n        \"found_tags\": [],\n        \"status\": \"SKIP\",\n        \"inputs\": {\"diff\": str(dp), \"review\": str(rp)}\n    }, indent=2))\n    sys.exit(0)\n\n# Require review to *name* each risk and have a \"Mitigation\" mention\nmissing = []\nfor tag in sorted(present):\n  if not re.search(fr\"\\b{tag}\\b\", review, re.I):\n    missing.append({\"tag\": tag, \"reason\": \"tag-not-mentioned\"})\n  elif not re.search(r\"\\bmitigat(ion|e|ed)\\b\", review, re.I):\n    missing.append({\"tag\": tag, \"reason\": \"no-mitigation\"})\n\nout = {\n  \"witness\": \"pr_review_covers_risks\",\n  \"found_tags\": sorted(present),\n  \"missing\": missing,\n  \"status\": \"PASS\" if not missing else \"FAIL\",\n  \"inputs\": {\"diff\": str(dp), \"review\": str(rp)}\n}\nprint(json.dumps(out, indent=2))\nsys.exit(0 if out[\"status\"]==\"PASS\" else 1)"
        }
      ],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "58c5802699d64ffa2632d255638c27617e0b3cbd1be1c7aa5a6d6bba9eff39a2",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "medium",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.pr_risk_tags_v1.yaml",
      "_raw": "id: llm.pr_risk_tags_v1\nversion: 1.0.0\ndomain: pr_review\ntitle: PR Review - Risk Tags\nstatement: Assign risk tags {security, performance, availability, migration, breaking_change,\n  data_loss} with 0–1 severity and 1–2 line rationale.\nassumptions:\n- Risk framing helps prioritize deeper review and testing.\npedagogy:\n- kind: Socratic\n  text: Which user/system risk is most plausible here?\n- kind: Aphorism\n  text: Name the risk, shrink the risk.\nwitnesses:\n  - name: pr_review_covers_risks\n    language: python\n    env:\n      DIFF_PATH: artifacts/examples/pr_diff.patch\n      REVIEW_PATH: artifacts/examples/pr_review.md\n    code: |-\n      import os, re, json, sys, pathlib\n\n      diff_path   = os.getenv(\"DIFF_PATH\",   \"artifacts/examples/pr_diff.patch\")\n      review_path = os.getenv(\"REVIEW_PATH\", \"artifacts/examples/pr_review.md\")\n\n      dp = pathlib.Path(diff_path)\n      rp = pathlib.Path(review_path)\n      if not dp.exists():\n        print(json.dumps({\"witness\":\"pr_review_covers_risks\",\"error\":f\"missing diff: {dp}\"})); sys.exit(2)\n      if not rp.exists():\n        print(json.dumps({\"witness\":\"pr_review_covers_risks\",\"error\":f\"missing review: {rp}\"})); sys.exit(2)\n\n      diff   = dp.read_text(encoding=\"utf-8\", errors=\"replace\")\n      review = rp.read_text(encoding=\"utf-8\", errors=\"replace\")\n\n      # Minimal, explainable heuristics → tag the diff\n      TAGS = {\n        \"secrets\": r\"(AWS_|SECRET|api[_-]?key|password\\s*=)\",\n        \"auth\":    r\"(oauth|jwt|session|login|auth[^a-z])\",\n        \"net\":     r\"(http[s]?://|requests\\.|fetch\\(|socket\\.)\",\n        \"fs\":      r\"(open\\(|os\\.remove|shutil\\.)\",\n        \"pii\":     r\"(ssn|social[- ]?security|^\\+?\\d{10,}$|[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,})\",\n      }\n      present = {tag for tag, rgx in TAGS.items() if re.search(rgx, diff, re.I|re.M)}\n\n      # If no risks detected in diff, SKIP (informational)\n      if not present:\n          print(json.dumps({\n              \"witness\": \"pr_review_covers_risks\",\n              \"found_tags\": [],\n              \"status\": \"SKIP\",\n              \"inputs\": {\"diff\": str(dp), \"review\": str(rp)}\n          }, indent=2))\n          sys.exit(0)\n\n      # Require review to *name* each risk and have a \"Mitigation\" mention\n      missing = []\n      for tag in sorted(present):\n        if not re.search(fr\"\\b{tag}\\b\", review, re.I):\n          missing.append({\"tag\": tag, \"reason\": \"tag-not-mentioned\"})\n        elif not re.search(r\"\\bmitigat(ion|e|ed)\\b\", review, re.I):\n          missing.append({\"tag\": tag, \"reason\": \"no-mitigation\"})\n\n      out = {\n        \"witness\": \"pr_review_covers_risks\",\n        \"found_tags\": sorted(present),\n        \"missing\": missing,\n        \"status\": \"PASS\" if not missing else \"FAIL\",\n        \"inputs\": {\"diff\": str(dp), \"review\": str(rp)}\n      }\n      print(json.dumps(out, indent=2))\n      sys.exit(0 if out[\"status\"]==\"PASS\" else 1)\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 58c5802699d64ffa2632d255638c27617e0b3cbd1be1c7aa5a6d6bba9eff39a2\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: medium\n  notes: ''\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "llm.evidence_gap_triage_v1": {
      "id": "llm.evidence_gap_triage_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Evidence Gap Triage",
      "statement": "Identify missing evidence blocking a sound answer; request the single smallest artifact that would unlock progress.",
      "assumptions": [
        "The model/user can ask for one clarifying item."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What one artifact would collapse uncertainty the most?"
        },
        {
          "kind": "Aphorism",
          "text": "Ask once, ask small."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "eb49e65eaa19a8197d7f1b38547a7c66c4ba49b81c1bf18718a57135a3d8e1e4",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.evidence_gap_triage_v1.yaml",
      "_raw": "id: llm.evidence_gap_triage_v1\nversion: 1.0.0\ndomain: llm\ntitle: Evidence Gap Triage\nstatement: Identify missing evidence blocking a sound answer; request the single smallest\n  artifact that would unlock progress.\nassumptions:\n- The model/user can ask for one clarifying item.\npedagogy:\n- kind: Socratic\n  text: What one artifact would collapse uncertainty the most?\n- kind: Aphorism\n  text: Ask once, ask small.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: eb49e65eaa19a8197d7f1b38547a7c66c4ba49b81c1bf18718a57135a3d8e1e4\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.pr_change_impact_v1": {
      "id": "llm.pr_change_impact_v1",
      "version": "1.0.0",
      "domain": "pr_review",
      "title": "PR Review - Change Impact",
      "statement": "Describe user-facing impact (if any), docs to update, and a single line release note.",
      "assumptions": [
        "Every externally visible change gets a note or is explicitly internal-only."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Who will notice this change tomorrow?"
        },
        {
          "kind": "Aphorism",
          "text": "If it matters, document it."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "cb5ede16f518629a9bb6118a91ad15595d7b72c6bec8952edc9a9deb5fcb0fab",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.pr_change_impact_v1.yaml",
      "_raw": "id: llm.pr_change_impact_v1\nversion: 1.0.0\ndomain: pr_review\ntitle: PR Review - Change Impact\nstatement: Describe user-facing impact (if any), docs to update, and a single line\n  release note.\nassumptions:\n- Every externally visible change gets a note or is explicitly internal-only.\npedagogy:\n- kind: Socratic\n  text: Who will notice this change tomorrow?\n- kind: Aphorism\n  text: If it matters, document it.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: cb5ede16f518629a9bb6118a91ad15595d7b72c6bec8952edc9a9deb5fcb0fab\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.counterfactual_probe_v1": {
      "id": "llm.counterfactual_probe_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Counterfactual Probe",
      "statement": "Before concluding, generate 2–3 counterfactual worlds that would flip the decision; list the observable tests that would distinguish them.",
      "assumptions": [
        "There is uncertainty worth exploring.",
        "Budget allows 1–3 tiny tests."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What would have to be true for the opposite decision to be best?"
        },
        {
          "kind": "Aphorism",
          "text": "Seek disconfirming evidence first."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "97645585b83080f11a69418850b492fdde87eb8a9e6b4183d5fbb1ee017f569a",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.counterfactual_probe_v1.yaml",
      "_raw": "id: llm.counterfactual_probe_v1\nversion: 1.0.0\ndomain: llm\ntitle: Counterfactual Probe\nstatement: Before concluding, generate 2–3 counterfactual worlds that would flip the\n  decision; list the observable tests that would distinguish them.\nassumptions:\n- There is uncertainty worth exploring.\n- Budget allows 1–3 tiny tests.\npedagogy:\n- kind: Socratic\n  text: What would have to be true for the opposite decision to be best?\n- kind: Aphorism\n  text: Seek disconfirming evidence first.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 97645585b83080f11a69418850b492fdde87eb8a9e6b4183d5fbb1ee017f569a\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.red_team_assessment_v1": {
      "id": "llm.red_team_assessment_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Red Team Assessment Protocol",
      "statement": "On a red-team request, perform an adversarial evaluation: clarify objective & asset, list assumptions, identify actors & capabilities, enumerate plausible attacks, show at least one concrete exploit path, rate severity×likelihood (0–1), propose mitigations and a 48‑hour action plan.",
      "assumptions": [
        "The user explicitly requests a red-team assessment for constructive hardening.",
        "Information provided is for defense; do not share sensitive exploit details beyond what is necessary to mitigate.",
        "Follow platform safety policies; redact secrets and PII."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What asset are we protecting and from whom (top 2 threat actors)?"
        },
        {
          "kind": "Socratic",
          "text": "What assumption, if false, makes failure most likely?"
        },
        {
          "kind": "Socratic",
          "text": "What is the cheapest path to impact for an attacker?"
        },
        {
          "kind": "Aphorism",
          "text": "Assume a breach; prove recovery."
        },
        {
          "kind": "Aphorism",
          "text": "Strong claims require strong evidence."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "a7ee80b6f0de049176869e5168f2d9968fbcdd97da2dac47206f46c508fcf942",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.red_team_assessment_v1.yaml",
      "_raw": "id: llm.red_team_assessment_v1\nversion: 1.0.0\ndomain: llm\ntitle: Red Team Assessment Protocol\nstatement: 'On a red-team request, perform an adversarial evaluation: clarify objective\n  & asset, list assumptions, identify actors & capabilities, enumerate plausible attacks,\n  show at least one concrete exploit path, rate severity×likelihood (0–1), propose\n  mitigations and a 48‑hour action plan.'\nassumptions:\n- The user explicitly requests a red-team assessment for constructive hardening.\n- Information provided is for defense; do not share sensitive exploit details beyond\n  what is necessary to mitigate.\n- Follow platform safety policies; redact secrets and PII.\npedagogy:\n- kind: Socratic\n  text: What asset are we protecting and from whom (top 2 threat actors)?\n- kind: Socratic\n  text: What assumption, if false, makes failure most likely?\n- kind: Socratic\n  text: What is the cheapest path to impact for an attacker?\n- kind: Aphorism\n  text: Assume a breach; prove recovery.\n- kind: Aphorism\n  text: Strong claims require strong evidence.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: a7ee80b6f0de049176869e5168f2d9968fbcdd97da2dac47206f46c508fcf942\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.tool_json_contract_v1": {
      "id": "llm.tool_json_contract_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Tool JSON contract",
      "statement": "Tool call args must match the JSON schema (required fields & types).",
      "assumptions": [
        "Operating in a general context"
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What evidence supports this claim?"
        },
        {
          "kind": "Aphorism",
          "text": "Cite or abstain."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:53:50.511776Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "1a7282f0873062f269a62fb2de28f3d5971f103b603c87381316e7c1a1161cc0",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.tool_json_contract_v1.yaml",
      "_raw": "id: llm.tool_json_contract_v1\nversion: 1.0.0\ndomain: llm\ntitle: Tool JSON contract\nstatement: Tool call args must match the JSON schema (required fields & types).\nassumptions:\n- Operating in a general context\npedagogy:\n- kind: Socratic\n  text: What evidence supports this claim?\n- kind: Aphorism\n  text: Cite or abstain.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:53:50.511776Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 1a7282f0873062f269a62fb2de28f3d5971f103b603c87381316e7c1a1161cc0\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.five_whys_root_cause_v1": {
      "id": "llm.five_whys_root_cause_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Five Whys (Root Cause)",
      "statement": "Perform a 3–5 Whys drill; propose a countermeasure for the root cause and one guardrail to prevent regression.",
      "assumptions": [
        "Event or defect is concrete and recent."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Why did this happen? Why was that possible? (repeat)"
        },
        {
          "kind": "Aphorism",
          "text": "Fix the system, not the symptom."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "1bbdd1db6b770ba4b9a73c6fe6e9f9d309cc4524e6edb4105199ce83922bc563",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.five_whys_root_cause_v1.yaml",
      "_raw": "id: llm.five_whys_root_cause_v1\nversion: 1.0.0\ndomain: llm\ntitle: Five Whys (Root Cause)\nstatement: Perform a 3–5 Whys drill; propose a countermeasure for the root cause and\n  one guardrail to prevent regression.\nassumptions:\n- Event or defect is concrete and recent.\npedagogy:\n- kind: Socratic\n  text: Why did this happen? Why was that possible? (repeat)\n- kind: Aphorism\n  text: Fix the system, not the symptom.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 1bbdd1db6b770ba4b9a73c6fe6e9f9d309cc4524e6edb4105199ce83922bc563\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.judge_answer_quality_v1": {
      "id": "llm.judge_answer_quality_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Judge answer quality",
      "statement": "LLM-judge must score >= 0.8 with JSON {score, verdict, justification}.",
      "assumptions": [
        "Operating in a general context"
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What evidence supports this claim?"
        },
        {
          "kind": "Aphorism",
          "text": "Cite or abstain."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:53:50.511776Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "8ae3b7c3603d54649baccf26fda915dc95c28484f04b542962afa8e796995caf",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.judge_answer_quality_v1.yaml",
      "_raw": "id: llm.judge_answer_quality_v1\nversion: 1.0.0\ndomain: llm\ntitle: Judge answer quality\nstatement: LLM-judge must score >= 0.8 with JSON {score, verdict, justification}.\nassumptions:\n- Operating in a general context\npedagogy:\n- kind: Socratic\n  text: What evidence supports this claim?\n- kind: Aphorism\n  text: Cite or abstain.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:53:50.511776Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 8ae3b7c3603d54649baccf26fda915dc95c28484f04b542962afa8e796995caf\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.safety_refusal_guard_v1": {
      "id": "llm.safety_refusal_guard_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Safety & Refusal Guard",
      "statement": "If a request risks policy or safety violations, refuse with a brief reason and offer the closest safe alternative.",
      "assumptions": [
        "Policies and safety priorities apply to this context."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What is the minimal safe deliverable that still helps?"
        },
        {
          "kind": "Aphorism",
          "text": "Refuse early, redirect helpfully."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "fc210d0ff24f4f0b6ab7eb320d7c008a30f4a558170b78ae50fc73642b48a7bb",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.safety_refusal_guard_v1.yaml",
      "_raw": "id: llm.safety_refusal_guard_v1\nversion: 1.0.0\ndomain: llm\ntitle: Safety & Refusal Guard\nstatement: If a request risks policy or safety violations, refuse with a brief reason\n  and offer the closest safe alternative.\nassumptions:\n- Policies and safety priorities apply to this context.\npedagogy:\n- kind: Socratic\n  text: What is the minimal safe deliverable that still helps?\n- kind: Aphorism\n  text: Refuse early, redirect helpfully.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: fc210d0ff24f4f0b6ab7eb320d7c008a30f4a558170b78ae50fc73642b48a7bb\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.fermi_estimation_v1": {
      "id": "llm.fermi_estimation_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Fermi Estimation",
      "statement": "Produce an order‑of‑magnitude estimate with explicit factors, ranges, and resulting uncertainty (log‑scale).",
      "assumptions": [
        "A back‑of‑the‑envelope answer is acceptable to guide decision making."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What are the 3–5 multiplicative factors?"
        },
        {
          "kind": "Aphorism",
          "text": "Be roughly right faster, then refine."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "ff0b085cd83a53d0c4493dc44bfe48847f27d399227bb1abcdf0af3155fd29d8",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.fermi_estimation_v1.yaml",
      "_raw": "id: llm.fermi_estimation_v1\nversion: 1.0.0\ndomain: llm\ntitle: Fermi Estimation\nstatement: Produce an order‑of‑magnitude estimate with explicit factors, ranges, and\n  resulting uncertainty (log‑scale).\nassumptions:\n- A back‑of‑the‑envelope answer is acceptable to guide decision making.\npedagogy:\n- kind: Socratic\n  text: What are the 3–5 multiplicative factors?\n- kind: Aphorism\n  text: Be roughly right faster, then refine.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: ff0b085cd83a53d0c4493dc44bfe48847f27d399227bb1abcdf0af3155fd29d8\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.pr_diff_first_v1": {
      "id": "llm.pr_diff_first_v1",
      "version": "1.0.0",
      "domain": "pr_review",
      "title": "PR Review - Diff First",
      "statement": "Always read the diff first. Summarize changes in ≤5 bullets with file counts and risky areas (auth, I/O, concurrency, migrations).",
      "assumptions": [
        "A textual diff or list of changed files is available.",
        "Goal is actionable review, not style nitpicks."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What actually changed (files, functions, interfaces)?"
        },
        {
          "kind": "Aphorism",
          "text": "Review behavior, not just syntax."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "b519f3cdb754d00b97862fd38de1fd74c389b78f691986f34b65de370bb45d82",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.pr_diff_first_v1.yaml",
      "_raw": "id: llm.pr_diff_first_v1\nversion: 1.0.0\ndomain: pr_review\ntitle: PR Review - Diff First\nstatement: Always read the diff first. Summarize changes in ≤5 bullets with file counts\n  and risky areas (auth, I/O, concurrency, migrations).\nassumptions:\n- A textual diff or list of changed files is available.\n- Goal is actionable review, not style nitpicks.\npedagogy:\n- kind: Socratic\n  text: What actually changed (files, functions, interfaces)?\n- kind: Aphorism\n  text: Review behavior, not just syntax.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: b519f3cdb754d00b97862fd38de1fd74c389b78f691986f34b65de370bb45d82\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.bias_checklist_v1": {
      "id": "llm.bias_checklist_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Bias & Mode Collapse Check",
      "statement": "Before finalizing, scan for common failure modes: confirmation bias, selection bias, overconfident tone, mode collapse.",
      "assumptions": [
        "Brief self‑audit improves reliability."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which plausible alternative did we ignore?"
        },
        {
          "kind": "Aphorism",
          "text": "Doubt is a feature."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "ac2b51c4e496a89372de921918c2cacd072e548934aaf385f15f9b0678da2dbb",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.bias_checklist_v1.yaml",
      "_raw": "id: llm.bias_checklist_v1\nversion: 1.0.0\ndomain: llm\ntitle: Bias & Mode Collapse Check\nstatement: 'Before finalizing, scan for common failure modes: confirmation bias, selection\n  bias, overconfident tone, mode collapse.'\nassumptions:\n- Brief self‑audit improves reliability.\npedagogy:\n- kind: Socratic\n  text: Which plausible alternative did we ignore?\n- kind: Aphorism\n  text: Doubt is a feature.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: ac2b51c4e496a89372de921918c2cacd072e548934aaf385f15f9b0678da2dbb\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.plan_verify_answer_v1": {
      "id": "llm.plan_verify_answer_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Plan → Verify → Answer",
      "statement": "Plan→Verify→Answer. The final answer references collected evidence.",
      "assumptions": [
        "Operating in a general context"
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What evidence supports this claim?"
        },
        {
          "kind": "Aphorism",
          "text": "Cite or abstain."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:53:50.511776Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "0aab055bc4c1b504cca4d9ddb8be1074a71835c9b3aab076d7c511c425a9664f",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.plan_verify_answer_v1.yaml",
      "_raw": "id: llm.plan_verify_answer_v1\nversion: 1.0.0\ndomain: llm\ntitle: Plan → Verify → Answer\nstatement: Plan→Verify→Answer. The final answer references collected evidence.\nassumptions:\n- Operating in a general context\npedagogy:\n- kind: Socratic\n  text: What evidence supports this claim?\n- kind: Aphorism\n  text: Cite or abstain.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:53:50.511776Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 0aab055bc4c1b504cca4d9ddb8be1074a71835c9b3aab076d7c511c425a9664f\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.assumption_to_test_v1": {
      "id": "llm.assumption_to_test_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Assumptions → Tests",
      "statement": "Convert each critical assumption into a falsifiable micro-test with owner, required evidence, and a 24–72h timebox.",
      "assumptions": [
        "Assumptions are enumerated or can be elicited with one question."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which single assumption, if wrong, invalidates the plan?"
        },
        {
          "kind": "Aphorism",
          "text": "Make failure explicit and reversible."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "9695ca488e9ab7912ff2e76b08a7205b08fb08627e1cab70fe0caa5fb9f54ed5",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.assumption_to_test_v1.yaml",
      "_raw": "id: llm.assumption_to_test_v1\nversion: 1.0.0\ndomain: llm\ntitle: Assumptions → Tests\nstatement: Convert each critical assumption into a falsifiable micro-test with owner,\n  required evidence, and a 24–72h timebox.\nassumptions:\n- Assumptions are enumerated or can be elicited with one question.\npedagogy:\n- kind: Socratic\n  text: Which single assumption, if wrong, invalidates the plan?\n- kind: Aphorism\n  text: Make failure explicit and reversible.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 9695ca488e9ab7912ff2e76b08a7205b08fb08627e1cab70fe0caa5fb9f54ed5\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "llm.steelmanning_v1": {
      "id": "llm.steelmanning_v1",
      "version": "1.0.0",
      "domain": "llm",
      "title": "Steelmanning",
      "statement": "Before critiquing, restate the strongest version of the opposing view in 3 bullets, then highlight one genuine crux.",
      "assumptions": [
        "There exists an alternative that a reasonable expert could endorse."
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What would a smart critic say against this?"
        },
        {
          "kind": "Aphorism",
          "text": "Steelman before you strike."
        }
      ],
      "witnesses": [],
      "provenance": {
        "schema": "provenance.v1",
        "author": "John Macgregor",
        "org": "Truth Capsules Demo",
        "license": "MIT",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:56:05.351404Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "ba8a2206b3716e290bef35a11a577c7e59bfbb69d9535f640b611e3d4e7e98ee",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/llm/llm.steelmanning_v1.yaml",
      "_raw": "id: llm.steelmanning_v1\nversion: 1.0.0\ndomain: llm\ntitle: Steelmanning\nstatement: Before critiquing, restate the strongest version of the opposing view in\n  3 bullets, then highlight one genuine crux.\nassumptions:\n- There exists an alternative that a reasonable expert could endorse.\npedagogy:\n- kind: Socratic\n  text: What would a smart critic say against this?\n- kind: Aphorism\n  text: Steelman before you strike.\nwitnesses: []\nprovenance:\n  schema: provenance.v1\n  author: John Macgregor\n  org: Truth Capsules Demo\n  license: MIT\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:56:05.351404Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: ba8a2206b3716e290bef35a11a577c7e59bfbb69d9535f640b611e3d4e7e98ee\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "informational",
      "_witness_count": 0
    },
    "business.decision_log_v1": {
      "id": "business.decision_log_v1",
      "version": "1.0.0",
      "domain": "business",
      "title": "Decision Log Gate",
      "statement": "Decision records must include decision, ≥3 options, ≥2 criteria, and a rationale mentioning a trade-off.",
      "assumptions": [
        "Decision records are structured as JSON",
        "Criteria and options can be enumerated"
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "Which option best satisfies the stated criteria?"
        },
        {
          "kind": "Aphorism",
          "text": "Make trade-offs explicit, not implicit."
        }
      ],
      "witnesses": [
        {
          "name": "decision_log_gate",
          "language": "python",
          "code": "import json, os\n\np = os.getenv(\"DEC_REPORT\", \"artifacts/examples/decision_log_ok.json\")\n\nr = json.load(open(p))\n\nassert r.get(\"decision\")\n\nassert isinstance(r.get(\"options\"), list) and len(r[\"options\"])>=3\n\nassert isinstance(r.get(\"criteria\"), list) and len(r[\"criteria\"])>=2\n\nassert \"trade-off\" in (r.get(\"rationale\",\"\")+\"\").lower() or \"because\" in (r.get(\"rationale\",\"\")+\"\").lower()"
        }
      ],
      "provenance": {
        "author": "Truth Capsules",
        "license": "MIT",
        "schema": "provenance.v1",
        "org": "Truth Capsules Demo",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:53:50.511776Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "7f5356a5eb951df4478793f0a90c927331e39ae9031e1197236f18e519c331cb",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/business/business.decision_log_v1.yaml",
      "_raw": "id: business.decision_log_v1\nversion: 1.0.0\ndomain: business\ntitle: Decision Log Gate\nstatement: Decision records must include decision, ≥3 options, ≥2 criteria, and a\n  rationale mentioning a trade-off.\nassumptions:\n- Decision records are structured as JSON\n- Criteria and options can be enumerated\npedagogy:\n- kind: Socratic\n  text: Which option best satisfies the stated criteria?\n- kind: Aphorism\n  text: Make trade-offs explicit, not implicit.\nwitnesses:\n- name: decision_log_gate\n  language: python\n  code: 'import json, os\n\n\n    p = os.getenv(\"DEC_REPORT\", \"artifacts/examples/decision_log_ok.json\")\n\n\n    r = json.load(open(p))\n\n\n    assert r.get(\"decision\")\n\n\n    assert isinstance(r.get(\"options\"), list) and len(r[\"options\"])>=3\n\n\n    assert isinstance(r.get(\"criteria\"), list) and len(r[\"criteria\"])>=2\n\n\n    assert \"trade-off\" in (r.get(\"rationale\",\"\")+\"\").lower() or \"because\" in (r.get(\"rationale\",\"\")+\"\").lower()'\nprovenance:\n  author: Truth Capsules\n  license: MIT\n  schema: provenance.v1\n  org: Truth Capsules Demo\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:53:50.511776Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 7f5356a5eb951df4478793f0a90c927331e39ae9031e1197236f18e519c331cb\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "witnessed",
      "_witness_count": 1
    },
    "ops.rollback_plan_v1": {
      "id": "ops.rollback_plan_v1",
      "version": "1.0.0",
      "domain": "ops",
      "title": "Rollback Plan Required",
      "statement": "Deploy plans must include a rollback step with trigger conditions and owner.",
      "assumptions": [
        "Rollback procedures can be documented in advance",
        "Trigger conditions are measurable"
      ],
      "pedagogy": [
        {
          "kind": "Socratic",
          "text": "What is the worst-case failure mode, and how do we reverse it?"
        },
        {
          "kind": "Aphorism",
          "text": "Make failure explicit and reversible."
        }
      ],
      "witnesses": [
        {
          "name": "rollback_present",
          "language": "python",
          "code": "import json, os\n\np = os.getenv(\"OPS_PLAN\", \"artifacts/examples/ops_plan_ok.json\")\n\nr = json.load(open(p))\n\nrb = r.get(\"rollback\", {})\n\nassert rb.get(\"steps\") and rb.get(\"trigger\") and rb.get(\"owner\"), \"Rollback incomplete\""
        }
      ],
      "provenance": {
        "author": "Truth Capsules",
        "license": "MIT",
        "schema": "provenance.v1",
        "org": "Truth Capsules Demo",
        "source_url": "https://example.com/truth-capsules",
        "created": "2025-11-07T03:53:50.511776Z",
        "updated": "2025-11-07T03:56:05.351404Z",
        "review": {
          "status": "draft",
          "reviewers": [],
          "last_reviewed": null
        },
        "signing": {
          "method": "ed25519",
          "key_id": null,
          "pubkey": null,
          "digest": "7be5f47e5ffd7349c81b50a6e46736573221a938df472aa94fc842ff06eedafe",
          "signature": null
        }
      },
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "dependencies": [],
      "incompatible_with": [],
      "security": {
        "sensitivity": "low",
        "notes": ""
      },
      "_file": "./capsules/legacy_capsules/ops/ops.rollback_plan_v1.yaml",
      "_raw": "id: ops.rollback_plan_v1\nversion: 1.0.0\ndomain: ops\ntitle: Rollback Plan Required\nstatement: Deploy plans must include a rollback step with trigger conditions and owner.\nassumptions:\n- Rollback procedures can be documented in advance\n- Trigger conditions are measurable\npedagogy:\n- kind: Socratic\n  text: What is the worst-case failure mode, and how do we reverse it?\n- kind: Aphorism\n  text: Make failure explicit and reversible.\nwitnesses:\n- name: rollback_present\n  language: python\n  code: 'import json, os\n\n\n    p = os.getenv(\"OPS_PLAN\", \"artifacts/examples/ops_plan_ok.json\")\n\n\n    r = json.load(open(p))\n\n\n    rb = r.get(\"rollback\", {})\n\n\n    assert rb.get(\"steps\") and rb.get(\"trigger\") and rb.get(\"owner\"), \"Rollback incomplete\"'\nprovenance:\n  author: Truth Capsules\n  license: MIT\n  schema: provenance.v1\n  org: Truth Capsules Demo\n  source_url: https://example.com/truth-capsules\n  created: '2025-11-07T03:53:50.511776Z'\n  updated: '2025-11-07T03:56:05.351404Z'\n  review:\n    status: draft\n    reviewers: []\n    last_reviewed: null\n  signing:\n    method: ed25519\n    key_id: null\n    pubkey: null\n    digest: 7be5f47e5ffd7349c81b50a6e46736573221a938df472aa94fc842ff06eedafe\n    signature: null\napplies_to:\n- conversation\n- code_assistant\n- ci\ndependencies: []\nincompatible_with: []\nsecurity:\n  sensitivity: low\n  notes: ''\n",
      "posture": "witnessed",
      "_witness_count": 1
    }
  },
  "bundles": {
    "bundle.ci_quality_gates_v1": {
      "name": "bundle.ci_quality_gates_v1",
      "version": "1.0.0",
      "description": "Release Integrity: SBOM presence, license allowlist, container hardening, reproducible artifact, and build-env secret checks.",
      "applies_to": [
        "ci",
        "release"
      ],
      "capsules": [
        "ci.sbom_present_v1",
        "ci.license_compliance_v1",
        "ci.container_hardening_v1",
        "ci.reproducible_artifact_hash_v1",
        "ci.secrets_in_build_env_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [
        "ci.sbom_present_v1",
        "ci.license_compliance_v1",
        "ci.container_hardening_v1",
        "ci.reproducible_artifact_hash_v1",
        "ci.secrets_in_build_env_v1"
      ],
      "projection": "",
      "tags": [
        "ci",
        "supply_chain",
        "release",
        "v1"
      ],
      "notes": "Witnessed-first: each capsule carries executable checks with JSON outputs. Defaults point at example fixtures in artifacts/examples/ci.\n",
      "env": {},
      "secrets": [],
      "_file": "./bundles/bundle.ci_quality_gates_v1.yaml"
    },
    "bundle.dev_code_assistant_v1": {
      "name": "bundle.dev_code_assistant_v1",
      "version": "1.0.0",
      "description": "Immediate utility for devs: safe prompts, language styles, commit conventions, review checklist + light witnesses.",
      "applies_to": [
        "conversation",
        "code_assistant",
        "review"
      ],
      "capsules": [
        "dev.prompt_safety_rules_v1",
        "dev.style_guide_python_v1",
        "dev.style_guide_js_v1",
        "dev.commit_conventions_v1",
        "dev.review_checklist_v1",
        "dev.diff_risk_tags_v1",
        "dev.enforce_todo_ticket_v1",
        "dev.secret_scan_baseline_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [
        "dev.prompt_safety_rules_v1",
        "dev.style_guide_python_v1",
        "dev.style_guide_js_v1",
        "dev.commit_conventions_v1",
        "dev.review_checklist_v1",
        "dev.diff_risk_tags_v1",
        "dev.enforce_todo_ticket_v1",
        "dev.secret_scan_baseline_v1"
      ],
      "projection": "",
      "tags": [
        "dev",
        "code",
        "review",
        "v1"
      ],
      "notes": "Info capsules render entirely from `statement`. Witnessed capsules use schema-v1 witness fields.\n",
      "env": {},
      "secrets": [],
      "_file": "./bundles/bundle.dev_code_assistant_v1.yaml"
    },
    "support_agent_v1_bundle": {
      "name": "support_agent_v1_bundle",
      "version": "1.1.0",
      "description": "Public-facing Support Copilot: tone/style, escalation, privacy, knowledge citation, and billing playbooks.",
      "applies_to": [
        "conversation",
        "support"
      ],
      "capsules": [
        "support.legal_privacy_rules_v1",
        "support.pii_redaction_smoke_v1",
        "support.escalation_matrix_v1",
        "support.tone_style_guide_v1",
        "support.knowledge_view_projection_v1",
        "support.billing_basics_v1",
        "support.intent_router_sanity_v1"
      ],
      "excludes": [],
      "priority_overrides": {
        "support.legal_privacy_rules_v1": 100,
        "support.pii_redaction_smoke_v1": 95,
        "support.escalation_matrix_v1": 90
      },
      "order": [
        "support.legal_privacy_rules_v1",
        "support.pii_redaction_smoke_v1",
        "support.escalation_matrix_v1",
        "support.tone_style_guide_v1",
        "support.knowledge_view_projection_v1",
        "support.billing_basics_v1",
        "support.intent_router_sanity_v1"
      ],
      "projection": "",
      "tags": [
        "support",
        "kit",
        "v1-schema"
      ],
      "notes": "Content-only capsules encode ALL customer-facing rules under the `statement` field per v1 schema.\n",
      "env": {},
      "secrets": [],
      "_file": "./bundles/support_agent_v1_bundle.yaml"
    },
    "macgyver_core_v1_bundle": {
      "name": "macgyver_core_v1_bundle",
      "version": "1.0.0",
      "description": "MacGyver problem-solving bundle: mindset rails, SOP, safety/ethics, and practice drills.",
      "applies_to": [
        "conversation",
        "planning",
        "prototyping",
        "training"
      ],
      "capsules": [
        "macgyver.five_rails_v1",
        "macgyver.affordances_over_objects_v1",
        "macgyver.property_matching_v1",
        "macgyver.functional_fixedness_avoidance_v1",
        "macgyver.environment_as_component_v1",
        "macgyver.low_tech_first_v1",
        "macgyver.transduction_chains_v1",
        "macgyver.chain_design_v1",
        "macgyver.problem_collapse_v1",
        "macgyver.sop_10min_loop_v1",
        "macgyver.inventory_thinking_v1",
        "macgyver.affordance_matrix_template_v1",
        "macgyver.stock_verbs_v1",
        "macgyver.parallel_options_v1",
        "macgyver.redundancy_chokepoints_v1",
        "macgyver.latency_control_v1",
        "macgyver.prompts_as_programs_v1",
        "macgyver.prompt_skeleton_v1",
        "macgyver.world_as_typed_graph_v1",
        "macgyver.deliberate_practice_v1",
        "macgyver.reflection_loop_v1",
        "macgyver.blast_radius_humility_v1",
        "macgyver.fail_safe_defaults_v1",
        "macgyver.reality_check_v1",
        "macgyver.legal_ethical_guardrails_v1",
        "macgyver.bias_checklist_v1",
        "macgyver.rails_ledgers_hub_mapping_v1"
      ],
      "excludes": [],
      "priority_overrides": {
        "macgyver.legal_ethical_guardrails_v1": 100,
        "macgyver.fail_safe_defaults_v1": 90,
        "macgyver.reality_check_v1": 80,
        "macgyver.bias_checklist_v1": 70,
        "macgyver.sop_10min_loop_v1": 60
      },
      "order": [
        "macgyver.legal_ethical_guardrails_v1",
        "macgyver.fail_safe_defaults_v1",
        "macgyver.reality_check_v1",
        "macgyver.bias_checklist_v1",
        "macgyver.sop_10min_loop_v1",
        "macgyver.five_rails_v1",
        "macgyver.affordances_over_objects_v1",
        "macgyver.property_matching_v1",
        "macgyver.functional_fixedness_avoidance_v1",
        "macgyver.environment_as_component_v1",
        "macgyver.low_tech_first_v1",
        "macgyver.transduction_chains_v1",
        "macgyver.chain_design_v1",
        "macgyver.problem_collapse_v1",
        "macgyver.inventory_thinking_v1",
        "macgyver.affordance_matrix_template_v1",
        "macgyver.stock_verbs_v1",
        "macgyver.parallel_options_v1",
        "macgyver.redundancy_chokepoints_v1",
        "macgyver.latency_control_v1",
        "macgyver.prompts_as_programs_v1",
        "macgyver.prompt_skeleton_v1",
        "macgyver.world_as_typed_graph_v1",
        "macgyver.deliberate_practice_v1",
        "macgyver.reflection_loop_v1",
        "macgyver.rails_ledgers_hub_mapping_v1"
      ],
      "projection": "",
      "tags": [
        "macgyver",
        "kit",
        "v1"
      ],
      "notes": "Core MacGyver kit:\n- Safety/ethics and fail-safe defaults come first.\n- SOP and mindset rails drive consistent, low-risk solutions.\n- Prompts/templates support LLM use with structure and guardrails.\n",
      "env": {},
      "secrets": [],
      "_file": "./bundles/macgyverisms_v1.yaml"
    },
    "test_v1_1_bundle": {
      "name": "test_v1_1_bundle",
      "version": "1.1.0",
      "description": "Test bundle for v1.1 features: priority overrides, exclusions, safety + quality gates.",
      "applies_to": [
        "conversation",
        "code_assistant"
      ],
      "capsules": [
        "llm.safety_refusal_guard_v1",
        "llm.pii_redaction_guard_v1",
        "llm.citation_required_v1",
        "llm.plan_verify_answer_v1",
        "llm.red_team_assessment_v1"
      ],
      "excludes": [
        "llm.red_team_assessment_v1"
      ],
      "priority_overrides": {
        "llm.citation_required_v1": 10,
        "llm.plan_verify_answer_v1": 1
      },
      "order": [
        "llm.plan_verify_answer_v1",
        "llm.safety_refusal_guard_v1",
        "llm.citation_required_v1"
      ],
      "projection": "",
      "tags": [
        "test",
        "v1.1",
        "example"
      ],
      "notes": "This is a test bundle demonstrating all v1.1 features:\n- version field\n- excludes (removes red_team_assessment)\n- priority_overrides (swaps priorities)\n- order (explicit ordering)\n- tags and notes\n",
      "env": {},
      "secrets": [],
      "_file": "./bundles/legacy_bundles/test_v1_1_bundle.yaml"
    },
    "conversation_pedagogy_v1": {
      "name": "conversation_pedagogy_v1",
      "version": "1.0.0",
      "description": "Pedagogical guidance for problem-solving conversations: Socratic method, explicit reasoning steps.",
      "applies_to": [
        "conversation"
      ],
      "capsules": [
        "pedagogy.problem_solving_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [],
      "projection": "",
      "tags": [],
      "notes": "",
      "env": {
        "PS_REPORT": "artifacts/examples/problem_solving_ok.json"
      },
      "secrets": [],
      "_file": "./bundles/legacy_bundles/conversation_pedagogy_v1.yaml"
    },
    "ci_nonllm_baseline_v1": {
      "name": "ci_nonllm_baseline_v1",
      "version": "1.0.0",
      "description": "Non-LLM business rules for CI: decision log validation, rollback plan requirements.",
      "applies_to": [
        "ci"
      ],
      "capsules": [
        "business.decision_log_v1",
        "ops.rollback_plan_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [],
      "projection": "",
      "tags": [],
      "notes": "",
      "env": {
        "DEC_REPORT": "artifacts/examples/decision_log_ok.json",
        "OPS_PLAN": "artifacts/examples/ops_plan_ok.json"
      },
      "secrets": [],
      "_file": "./bundles/legacy_bundles/ci_nonllm_baseline_v1.yaml"
    },
    "pr_review_minibundle_v1": {
      "name": "pr_review_minibundle_v1",
      "version": "1.0.0",
      "description": "PR review essentials: diff-first analysis, risk tags, test hints, deploy checklist, and change impact.",
      "applies_to": [
        "conversation",
        "code_assistant",
        "ci"
      ],
      "capsules": [
        "llm.pr_diff_first_v1",
        "llm.pr_risk_tags_v1",
        "llm.pr_test_hints_v1",
        "llm.pr_deploy_checklist_v1",
        "llm.pr_change_impact_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [],
      "projection": "",
      "tags": [],
      "notes": "",
      "env": {},
      "secrets": [],
      "_file": "./bundles/legacy_bundles/pr_review_minibundle_v1.yaml"
    },
    "ci_llm_baseline_v1": {
      "name": "ci_llm_baseline_v1",
      "version": "1.0.0",
      "description": "CI/CD LLM quality gates: citations, JSON contracts, answer quality judging, PII scanning.",
      "applies_to": [
        "ci"
      ],
      "capsules": [
        "llm.citation_required_v1",
        "llm.tool_json_contract_v1",
        "llm.plan_verify_answer_v1",
        "llm.pii_redaction_guard_v1",
        "llm.judge_answer_quality_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [],
      "projection": "",
      "tags": [],
      "notes": "",
      "env": {
        "TC_ARTIFACT": "artifacts/out/answers.json",
        "TC_SCHEMA": "artifacts/examples/tool_schema_book_meeting.json",
        "TC_CALL": "artifacts/out/tool_calls.json",
        "TC_PVA": "artifacts/out/pva_logs.json",
        "TC_TXT": "artifacts/out/pii_scan.json",
        "TC_CANDIDATE": "artifacts/out/answer_candidate.json",
        "TC_JUDGMENT": "artifacts/judgments/answers.judgment.json"
      },
      "secrets": [
        "OPENAI_API_KEY"
      ],
      "_file": "./bundles/legacy_bundles/ci_llm_baseline_v1.yaml"
    },
    "assistant_baseline_v1": {
      "name": "assistant_baseline_v1",
      "version": "1.0.0",
      "description": "Core assistant rules: citation required, JSON contract validation, plan-verify-answer, PII redaction.",
      "applies_to": [
        "assistant"
      ],
      "capsules": [
        "llm.citation_required_v1",
        "llm.tool_json_contract_v1",
        "llm.plan_verify_answer_v1",
        "llm.pii_redaction_guard_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [],
      "projection": "",
      "tags": [],
      "notes": "",
      "env": {
        "TC_ARTIFACT": "artifacts/examples/answer_with_citation.json",
        "TC_SCHEMA": "artifacts/examples/tool_schema_book_meeting.json",
        "TC_CALL": "artifacts/examples/tool_call_ok.json",
        "TC_PVA": "artifacts/examples/pva_ok.json",
        "TC_TXT": "artifacts/examples/pii_ok.json"
      },
      "secrets": [],
      "_file": "./bundles/legacy_bundles/assistant_baseline_v1.yaml"
    },
    "conversation_red_team_baseline_v1": {
      "name": "conversation_red_team_baseline_v1",
      "version": "1.0.0",
      "description": "Red-team baseline for conversational AI: probes assumptions, bias, counterfactuals, and safety refusals.",
      "applies_to": [
        "conversation",
        "code_assistant"
      ],
      "capsules": [
        "llm.red_team_assessment_v1",
        "llm.counterfactual_probe_v1",
        "llm.assumption_to_test_v1",
        "llm.steelmanning_v1",
        "llm.five_whys_root_cause_v1",
        "llm.fermi_estimation_v1",
        "llm.safety_refusal_guard_v1",
        "llm.evidence_gap_triage_v1",
        "llm.bias_checklist_v1",
        "llm.plan_backtest_v1"
      ],
      "excludes": [],
      "priority_overrides": {},
      "order": [],
      "projection": "",
      "tags": [],
      "notes": "",
      "env": {},
      "secrets": [],
      "_file": "./bundles/legacy_bundles/conversation_red_team_baseline_v1.yaml"
    }
  },
  "profiles": {
    "profile.ci.gates_v1": {
      "id": "profile.ci.gates_v1",
      "title": "CI Quality Gates — Fail Fast",
      "version": "1.0.0",
      "description": "Strict, proof-carrying CI gates. Output GREEN/RED with concise JSON. Abort unless all mandatory witnesses pass.",
      "response": {
        "format": "natural",
        "policy": "Emit crisp GREEN/RED summary with JSON evidence. Fail fast unless all mandatory gates pass.\nDo not speculate; if evidence missing, mark RED with the minimal required next step.\n",
        "system_block": "SYSTEM: Profile=CIGates\nROLE: CI quality gate reporter (witnessed-first)\nSTYLE: terse; bullet verdicts; include JSON snippets for failures.\n",
        "projection": {
          "include": [
            "title",
            "statement"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "enforcement_footer": "ENFORCEMENT: All gates must be GREEN; otherwise mark RED and stop."
          }
        }
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/ci.gates.yaml",
      "_raw": "kind: profile\nid: profile.ci.gates_v1\ntitle: CI Quality Gates — Fail Fast\nversion: 1.0.0\ndescription: Strict, proof-carrying CI gates. Output GREEN/RED with concise JSON. Abort unless all mandatory witnesses pass.\nresponse:\n  format: natural\n  policy: |\n    Emit crisp GREEN/RED summary with JSON evidence. Fail fast unless all mandatory gates pass.\n    Do not speculate; if evidence missing, mark RED with the minimal required next step.\n  system_block: |\n    SYSTEM: Profile=CIGates\n    ROLE: CI quality gate reporter (witnessed-first)\n    STYLE: terse; bullet verdicts; include JSON snippets for failures.\n  projection:\n    include:\n      - title\n      - statement\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      enforcement_footer: \"ENFORCEMENT: All gates must be GREEN; otherwise mark RED and stop.\"\ndownload:\n  suggested_ext: txt\n"
    },
    "profile.support_public_agent_v1": {
      "id": "profile.support_public_agent_v1",
      "title": "Customer Support Copilot (Public-Facing)",
      "version": "1.1.0",
      "description": "Guardrailed, empathetic public support agent with escalation and privacy compliance.",
      "response": {
        "format": "natural",
        "policy": "Cite or abstain; follow Plan→Verify→Answer; never invent customer-specific facts.\nNever echo or store PII. Prefer linking to docs over paraphrasing.\nEscalate per the matrix; avoid promises of refunds/credits unless policy says so.\n",
        "system_block": "SYSTEM: Profile=SupportAgent\nROLE: Public-facing customer support\nALLOWED_ACTIONS: apologize, clarify, summarize, link_to_docs, suggest_next_step, create_ticket, escalate\nFORBIDDEN: legal_advice, medical_advice, store_or_echo_pii, discounts_without_policy, system_commands\nSECRETS: none\nSTYLE: empathetic, concise, specific, polite, plain-language, one actionable next step\n",
        "projection": {
          "include": [
            "title",
            "statement"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "enforcement_footer": "ENFORCEMENT: Follow the rules encoded in statement; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/support_public_agent.yaml",
      "_raw": "kind: profile\nid: profile.support_public_agent_v1\ntitle: Customer Support Copilot (Public-Facing)\nversion: 1.1.0\ndescription: Guardrailed, empathetic public support agent with escalation and privacy compliance.\nresponse:\n  format: natural\n  policy: |\n    Cite or abstain; follow Plan→Verify→Answer; never invent customer-specific facts.\n    Never echo or store PII. Prefer linking to docs over paraphrasing.\n    Escalate per the matrix; avoid promises of refunds/credits unless policy says so.\n  system_block: |\n    SYSTEM: Profile=SupportAgent\n    ROLE: Public-facing customer support\n    ALLOWED_ACTIONS: apologize, clarify, summarize, link_to_docs, suggest_next_step, create_ticket, escalate\n    FORBIDDEN: legal_advice, medical_advice, store_or_echo_pii, discounts_without_policy, system_commands\n    SECRETS: none\n    STYLE: empathetic, concise, specific, polite, plain-language, one actionable next step\n  projection:\n    include:\n      - title\n      - statement\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      enforcement_footer: \"ENFORCEMENT: Follow the rules encoded in statement; otherwise abstain and request the minimal missing info.\"\ndownload:\n  suggested_ext: txt\n"
    },
    "profile.macgyver_v1": {
      "id": "profile.macgyver_v1",
      "title": "Macgyverisms",
      "version": "1.0.0",
      "description": "Bootstrap yourself or an LLM to solve problems like Macgyver.",
      "response": {
        "format": "natural",
        "policy": "Cite or abstain; follow Plan→Verify→Answer; ask ONE crisp follow-up if required.\n",
        "system_block": "SYSTEM: Profile=Macgyver\n\nFORMAT: Natural language.\n",
        "projection": {
          "include": [
            "title",
            "statement",
            "assumptions[:5]",
            "pedagogy.socratic[:3]",
            "pedagogy.aphorisms[:3]"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "assumption_bullet": "  - {text}",
            "socratic_bullet": "  - {text}",
            "aphorism_bullet": "  - {text}",
            "enforcement_footer": "ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/conversational_macgyver.yaml",
      "_raw": "kind: profile\nid: profile.macgyver_v1\ntitle: Macgyverisms\nversion: 1.0.0\ndescription: Bootstrap yourself or an LLM to solve problems like Macgyver.\nresponse:\n  format: natural\n  policy: |\n    Cite or abstain; follow Plan→Verify→Answer; ask ONE crisp follow-up if required.\n  system_block: |\n    SYSTEM: Profile=Macgyver\n\n    FORMAT: Natural language.\n  projection:\n    include:\n    - title\n    - statement\n    - assumptions[:5]\n    - pedagogy.socratic[:3]\n    - pedagogy.aphorisms[:3]\n    render:\n      capsule_header: BEGIN CAPSULE id={id} version={version} domain={domain}\n      assumption_bullet: '  - {text}'\n      socratic_bullet: '  - {text}'\n      aphorism_bullet: '  - {text}'\n      enforcement_footer: 'ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise\n        abstain and request the minimal missing info.'\ndownload:\n  suggested_ext: txt"
    },
    "profile.dev.code_assistant_v1": {
      "id": "profile.dev.code_assistant_v1",
      "title": "Developer Velocity — Code Assistant & Review Copilot",
      "version": "1.0.0",
      "description": "Concise, reproducible developer assistants that work with Cline/Claude/VSCode. Focus on safe prompts, consistent style, and practical reviews.",
      "response": {
        "format": "natural",
        "policy": "Cite or abstain; Plan→Verify→Answer; never leak secrets or PHI/PII.\nPrefer diffs, tests, and minimal patches; avoid broad refactors unless asked.\n",
        "system_block": "SYSTEM: Profile=DevAssistant\nROLE: Code assistant & review copilot\nSTYLE: terse, specific, reproducible; show commands or patches, then explanation.\n",
        "projection": {
          "include": [
            "title",
            "statement"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "enforcement_footer": "ENFORCEMENT: Follow capsule statements; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/dev.code_assistant.yaml",
      "_raw": "kind: profile\nid: profile.dev.code_assistant_v1\ntitle: Developer Velocity — Code Assistant & Review Copilot\nversion: 1.0.0\ndescription: Concise, reproducible developer assistants that work with Cline/Claude/VSCode. Focus on safe prompts, consistent style, and practical reviews.\nresponse:\n  format: natural\n  policy: |\n    Cite or abstain; Plan→Verify→Answer; never leak secrets or PHI/PII.\n    Prefer diffs, tests, and minimal patches; avoid broad refactors unless asked.\n  system_block: |\n    SYSTEM: Profile=DevAssistant\n    ROLE: Code assistant & review copilot\n    STYLE: terse, specific, reproducible; show commands or patches, then explanation.\n  projection:\n    include:\n      - title\n      - statement\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      enforcement_footer: \"ENFORCEMENT: Follow capsule statements; otherwise abstain and request the minimal missing info.\"\ndownload:\n  suggested_ext: txt\n"
    },
    "profile.conversational_guidance_v1": {
      "id": "profile.conversational_guidance_v1",
      "title": "Conversational Guidance",
      "version": "1.0.0",
      "description": "In-chat Q&A with reasoning guardrails; natural language output.",
      "response": {
        "format": "natural",
        "policy": "Cite or abstain; follow Plan→Verify→Answer; ask ONE crisp follow-up if required.\n",
        "system_block": "SYSTEM: Profile=Conversational Guidance\nPOLICY: Cite or abstain; follow Plan→Verify→Answer; ask ONE crisp follow-up if required.\nFORMAT: Natural language (no JSON required).\n",
        "projection": {
          "include": [
            "title",
            "statement",
            "assumptions[:5]",
            "pedagogy.socratic[:3]",
            "pedagogy.aphorisms[:3]"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "assumption_bullet": "  - {text}",
            "socratic_bullet": "  - {text}",
            "aphorism_bullet": "  - {text}",
            "enforcement_footer": "ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/legacy_profiles/conversational.yaml",
      "_raw": "kind: profile\nid: profile.conversational_guidance_v1\ntitle: Conversational Guidance\nversion: 1.0.0\ndescription: In-chat Q&A with reasoning guardrails; natural language output.\nresponse:\n  format: natural\n  policy: |\n    Cite or abstain; follow Plan→Verify→Answer; ask ONE crisp follow-up if required.\n  system_block: |\n    SYSTEM: Profile=Conversational Guidance\n    POLICY: Cite or abstain; follow Plan→Verify→Answer; ask ONE crisp follow-up if required.\n    FORMAT: Natural language (no JSON required).\n  projection:\n    include:\n      - title\n      - statement\n      - assumptions[:5]\n      - pedagogy.socratic[:3]\n      - pedagogy.aphorisms[:3]\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      assumption_bullet: \"  - {text}\"\n      socratic_bullet: \"  - {text}\"\n      aphorism_bullet: \"  - {text}\"\n      enforcement_footer: \"ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info.\"\ndownload:\n  suggested_ext: txt\n"
    },
    "profile.tool_runner_v1": {
      "id": "profile.tool_runner_v1",
      "title": "Tool Runner / Function Caller",
      "version": "1.0.0",
      "description": "Produce ONLY JSON arguments for a tool; ask one clarifier if fields missing.",
      "response": {
        "format": "json",
        "policy": "Output only the JSON arguments matching the tool schema. If fields are missing, ask ONE clarifying question.\n",
        "system_block": "SYSTEM: Profile=Tool Runner\nPOLICY: Output ONLY the JSON arguments matching the tool schema. If missing fields, ask ONE clarifying question.\nFORMAT: JSON only.\n",
        "projection": {
          "include": [
            "title",
            "statement",
            "assumptions[:3]"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "assumption_bullet": "  - {text}",
            "enforcement_footer": "ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "json"
      },
      "_file": "./profiles/legacy_profiles/tool_runner.yaml",
      "_raw": "kind: profile\nid: profile.tool_runner_v1\ntitle: Tool Runner / Function Caller\nversion: 1.0.0\ndescription: Produce ONLY JSON arguments for a tool; ask one clarifier if fields missing.\nresponse:\n  format: json\n  policy: |\n    Output only the JSON arguments matching the tool schema. If fields are missing, ask ONE clarifying question.\n  system_block: |\n    SYSTEM: Profile=Tool Runner\n    POLICY: Output ONLY the JSON arguments matching the tool schema. If missing fields, ask ONE clarifying question.\n    FORMAT: JSON only.\n  projection:\n    include:\n      - title\n      - statement\n      - assumptions[:3]\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      assumption_bullet: \"  - {text}\"\n      enforcement_footer: \"ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info.\"\ndownload:\n  suggested_ext: json\n"
    },
    "profile.ci_llm_judge_v1": {
      "id": "profile.ci_llm_judge_v1",
      "title": "CI Gate - LLM Judge",
      "version": "1.0.0",
      "description": "LLM evaluates artifacts; score + verdict + justification + citations.",
      "response": {
        "format": "json",
        "policy": "Score 0–1; verdict in {pass,fail}; brief justification; cite or abstain.\n",
        "schema_ref": "judge.schema.v1",
        "rubric": [
          "Factual",
          "Reproducible evidence",
          "Citations present (or abstain)"
        ],
        "system_block": "SYSTEM: Profile=CI LLM Judge\nPOLICY: Score 0–1; verdict in {pass,fail}; brief justification; cite or abstain.\nSCHEMA: See JUDGE_SCHEMA below.\n",
        "projection": {
          "include": [
            "title",
            "statement",
            "assumptions[:2]"
          ],
          "render": {
            "capsule_header": "CAPSULE: {id} v{version}",
            "assumption_bullet": "  - {text}",
            "enforcement_footer": "ENFORCEMENT: Obey or abstain."
          }
        }
      },
      "download": {
        "suggested_ext": "json"
      },
      "_file": "./profiles/legacy_profiles/ci_llm_judge.yaml",
      "_raw": "kind: profile\nid: profile.ci_llm_judge_v1\ntitle: CI Gate - LLM Judge\nversion: 1.0.0\ndescription: LLM evaluates artifacts; score + verdict + justification + citations.\nresponse:\n  format: json\n  policy: |\n    Score 0–1; verdict in {pass,fail}; brief justification; cite or abstain.\n  schema_ref: judge.schema.v1\n  rubric:\n    - Factual\n    - Reproducible evidence\n    - Citations present (or abstain)\n  system_block: |\n    SYSTEM: Profile=CI LLM Judge\n    POLICY: Score 0–1; verdict in {pass,fail}; brief justification; cite or abstain.\n    SCHEMA: See JUDGE_SCHEMA below.\n  projection:\n    include:\n      - title\n      - statement\n      - assumptions[:2]\n    render:\n      capsule_header: \"CAPSULE: {id} v{version}\"\n      assumption_bullet: \"  - {text}\"\n      enforcement_footer: \"ENFORCEMENT: Obey or abstain.\"\ndownload:\n  suggested_ext: json\n"
    },
    "profile.code_patch_v1": {
      "id": "profile.code_patch_v1",
      "title": "Code Assistant - Patch/PR",
      "version": "1.0.0",
      "description": "Emit minimal unified diff first; rationale after.",
      "response": {
        "format": "diff",
        "policy": "Produce a minimal unified diff; no prose before the diff. Rationale after the fence.\n",
        "system_block": "SYSTEM: Profile=Code Patch\nPOLICY: Produce a minimal unified diff; no prose before the diff. Rationale after.\nFORMAT: First block is ```diff …``` then a short rationale.\n",
        "projection": {
          "include": [
            "title",
            "statement",
            "assumptions[:3]",
            "pedagogy.socratic[:2]",
            "pedagogy.aphorisms[:2]"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "assumption_bullet": "  - {text}",
            "socratic_bullet": "  - {text}",
            "aphorism_bullet": "  - {text}",
            "enforcement_footer": "ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "txt"
      },
      "_file": "./profiles/legacy_profiles/code_patch.yaml",
      "_raw": "kind: profile\nid: profile.code_patch_v1\ntitle: Code Assistant - Patch/PR\nversion: 1.0.0\ndescription: Emit minimal unified diff first; rationale after.\nresponse:\n  format: diff\n  policy: |\n    Produce a minimal unified diff; no prose before the diff. Rationale after the fence.\n  system_block: |\n    SYSTEM: Profile=Code Patch\n    POLICY: Produce a minimal unified diff; no prose before the diff. Rationale after.\n    FORMAT: First block is ```diff …``` then a short rationale.\n  projection:\n    include:\n      - title\n      - statement\n      - assumptions[:3]\n      - pedagogy.socratic[:2]\n      - pedagogy.aphorisms[:2]\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      assumption_bullet: \"  - {text}\"\n      socratic_bullet: \"  - {text}\"\n      aphorism_bullet: \"  - {text}\"\n      enforcement_footer: \"ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info.\"\ndownload:\n  suggested_ext: txt\n"
    },
    "profile.ci_deterministic_gate_v1": {
      "id": "profile.ci_deterministic_gate_v1",
      "title": "CI Gate - Deterministic",
      "version": "1.0.0",
      "description": "Non-LLM checks in CI; machine-parsed JSON pass/fail.",
      "response": {
        "format": "json",
        "policy": "Output JSON only. No extra text.\n",
        "schema_ref": "report.schema.v1",
        "system_block": "SYSTEM: Profile=CI Deterministic Gate\nPOLICY: Output JSON only. No extra text.\nSCHEMA: See REPORT_SCHEMA below.\n",
        "projection": {
          "include": [
            "title",
            "statement"
          ],
          "render": {
            "capsule_header": "CAPSULE: {id} v{version}",
            "enforcement_footer": "ENFORCEMENT: Obey or abstain."
          }
        }
      },
      "download": {
        "suggested_ext": "json"
      },
      "_file": "./profiles/legacy_profiles/ci_det.yaml",
      "_raw": "kind: profile\nid: profile.ci_deterministic_gate_v1\ntitle: CI Gate - Deterministic\nversion: 1.0.0\ndescription: Non-LLM checks in CI; machine-parsed JSON pass/fail.\nresponse:\n  format: json\n  policy: |\n    Output JSON only. No extra text.\n  schema_ref: report.schema.v1\n  system_block: |\n    SYSTEM: Profile=CI Deterministic Gate\n    POLICY: Output JSON only. No extra text.\n    SCHEMA: See REPORT_SCHEMA below.\n  projection:\n    include:\n      - title\n      - statement\n    render:\n      capsule_header: \"CAPSULE: {id} v{version}\"\n      enforcement_footer: \"ENFORCEMENT: Obey or abstain.\"\ndownload:\n  suggested_ext: json\n"
    },
    "profile.pedagogical_v1": {
      "id": "profile.pedagogical_v1",
      "title": "Pedagogical / Socratic",
      "version": "1.0.0",
      "description": "Teaching/coaching mode; questions first, then takeaways.",
      "response": {
        "format": "natural",
        "policy": "Use 3–5 Socratic questions, then 3 concise takeaways. Prefer tiny, reversible steps.\n",
        "system_block": "SYSTEM: Profile=Pedagogical\nPOLICY: Use 3–5 Socratic questions, then 3 bullet takeaways.\nFORMAT: Bulleted text; no JSON.\n",
        "projection": {
          "include": [
            "title",
            "statement",
            "assumptions[:5]",
            "pedagogy.socratic[:5]",
            "pedagogy.aphorisms[:5]"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "assumption_bullet": "  - {text}",
            "socratic_bullet": "  - {text}",
            "aphorism_bullet": "  - {text}",
            "enforcement_footer": "ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "md"
      },
      "_file": "./profiles/legacy_profiles/pedagogical.yaml",
      "_raw": "kind: profile\nid: profile.pedagogical_v1\ntitle: Pedagogical / Socratic\nversion: 1.0.0\ndescription: Teaching/coaching mode; questions first, then takeaways.\nresponse:\n  format: natural\n  policy: |\n    Use 3–5 Socratic questions, then 3 concise takeaways. Prefer tiny, reversible steps.\n  system_block: |\n    SYSTEM: Profile=Pedagogical\n    POLICY: Use 3–5 Socratic questions, then 3 bullet takeaways.\n    FORMAT: Bulleted text; no JSON.\n  projection:\n    include:\n      - title\n      - statement\n      - assumptions[:5]\n      - pedagogy.socratic[:5]\n      - pedagogy.aphorisms[:5]\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      assumption_bullet: \"  - {text}\"\n      socratic_bullet: \"  - {text}\"\n      aphorism_bullet: \"  - {text}\"\n      enforcement_footer: \"ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info.\"\ndownload:\n  suggested_ext: md\n"
    },
    "profile.rules_generator_v1": {
      "id": "profile.rules_generator_v1",
      "title": "Code Assistant - Rules Generator",
      "version": "1.0.0",
      "description": "Emit a single YAML document for agent/IDE rules.",
      "response": {
        "format": "yaml",
        "policy": "Emit one YAML with sections: rules, violations, meta. No prose outside YAML.\n",
        "system_block": "SYSTEM: Profile=Rules Generator\nPOLICY: Emit a single YAML document with 'rules', 'violations', and 'meta' sections.\nFORMAT: ```yaml``` only.\n",
        "projection": {
          "include": [
            "title",
            "statement",
            "assumptions[:3]",
            "pedagogy.socratic[:3]",
            "pedagogy.aphorisms[:2]"
          ],
          "render": {
            "capsule_header": "BEGIN CAPSULE id={id} version={version} domain={domain}",
            "assumption_bullet": "  - {text}",
            "socratic_bullet": "  - {text}",
            "aphorism_bullet": "  - {text}",
            "enforcement_footer": "ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info."
          }
        }
      },
      "download": {
        "suggested_ext": "yaml"
      },
      "_file": "./profiles/legacy_profiles/rules_gen.yaml",
      "_raw": "kind: profile\nid: profile.rules_generator_v1\ntitle: Code Assistant - Rules Generator\nversion: 1.0.0\ndescription: Emit a single YAML document for agent/IDE rules.\nresponse:\n  format: yaml\n  policy: |\n    Emit one YAML with sections: rules, violations, meta. No prose outside YAML.\n  system_block: |\n    SYSTEM: Profile=Rules Generator\n    POLICY: Emit a single YAML document with 'rules', 'violations', and 'meta' sections.\n    FORMAT: ```yaml``` only.\n  projection:\n    include:\n      - title\n      - statement\n      - assumptions[:3]\n      - pedagogy.socratic[:3]\n      - pedagogy.aphorisms[:2]\n    render:\n      capsule_header: \"BEGIN CAPSULE id={id} version={version} domain={domain}\"\n      assumption_bullet: \"  - {text}\"\n      socratic_bullet: \"  - {text}\"\n      aphorism_bullet: \"  - {text}\"\n      enforcement_footer: \"ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info.\"\ndownload:\n  suggested_ext: yaml\n"
    }
  },
  "schemas": {},
  "llm_templates": [
    {
      "id": "anthropic_sonnet_chat",
      "label": "Anthropic: Claude 3.5 Sonnet (chat)",
      "model": "claude-3-5-sonnet",
      "description": "Chat completion; user input via stdin pipe.",
      "engine": "llm",
      "input_mode": "stdin",
      "extra_flags": [
        "--no-stream"
      ],
      "cmd_template": "{{SYS_HEREDOC}}\n{{STDIN_PIPE}} llm -m {{MODEL}} --system \"$TC_SYSTEM\" {{EXTRA_FLAGS}}\n"
    },
    {
      "id": "ollama_llama3_local",
      "label": "Ollama: llama3 (local)",
      "model": "llama3",
      "description": "Local model; file input.",
      "engine": "llm",
      "input_mode": "file",
      "extra_flags": [],
      "cmd_template": "{{SYS_HEREDOC}}\nllm -m {{MODEL}} --system \"$TC_SYSTEM\" {{EXTRA_FLAGS}} {{FILE_PATH}}\n"
    },
    {
      "id": "openai_gpt4o_chat",
      "label": "OpenAI: GPT-4o mini (chat)",
      "model": "gpt-4o-mini",
      "description": "Chat completion; user input as arg.",
      "engine": "llm",
      "input_mode": "arg",
      "extra_flags": [],
      "cmd_template": "{{SYS_HEREDOC}}\nllm -m {{MODEL}} --system \"$TC_SYSTEM\" {{EXTRA_FLAGS}} {{INPUT_FRAGMENT}}\n"
    }
  ]
}</script>

    <script>
      /* ------------ Data ------------ */
      const DATA = JSON.parse(document.getElementById('tc-data').textContent);


      // Derive posture/witness_count if missing; keep raw yaml if provided upstream
      (function hydrateCapsules() {
        const caps = DATA.capsules || {};
        for (const [id, c] of Object.entries(caps)) {
          c._id = id;
          c._witness_count = Array.isArray(c.witnesses) ? c.witnesses.length : (c._witness_count || 0);
          if (!c.posture) c.posture = c._witness_count > 0 ? 'witnessed' : 'informational';
          // keep any existing c._raw for modal; nothing to do if not present
        }
      })();

    </script>

    <script>
      /* ------------ State & helpers ------------ */
      const STATE = { selectedBundles: new Set(), selectedCaps: new Set(), order: [], manualCaps: new Set(), profile: null, filter: "" };
      const $ = id => document.getElementById(id);
      const esc = s => (s == null ? "" : String(s).replace(/[&<>]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[m])));



        // ---- Theme Controller ----
        (function themeController() {
          const STORAGE_KEY = 'tc_theme'; // 'light' | 'dark'
          const root = document.documentElement;

          function apply(theme) {
            if (theme === 'light') {
              root.setAttribute('data-theme', 'light');
              $('themeBtn').textContent = '☀️';
              $('themeBtn').setAttribute('aria-label', 'Switch to dark mode');
            } else {
              root.setAttribute('data-theme', 'dark');
              $('themeBtn').textContent = '🌙';
              $('themeBtn').setAttribute('aria-label', 'Switch to light mode');
            }
          }

          // initial theme: saved → system → dark fallback
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved === 'light' || saved === 'dark') {
            apply(saved);
          } else {
            const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            apply(systemDark ? 'dark' : 'light');
          }

          // respond to future system changes if user hasn't chosen
          const mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
          if (!saved && mql && mql.addEventListener) {
            mql.addEventListener('change', e => apply(e.matches ? 'dark' : 'light'));
          }

          // wire up button
          window.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('themeBtn');
            if (!btn) return;
            btn.addEventListener('click', () => {
              const next = (root.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
              localStorage.setItem(STORAGE_KEY, next);
              apply(next);
            });
          });
        })();

      // persist domain open/closed state across renders + reloads
      STATE.domainOpen = JSON.parse(localStorage.getItem('tc_domain_open') || '{}');
      const DOMAIN_DEFAULT_OPEN = true; // first render behavior

      function setDomainOpen(domain, open) {
        const key = String(domain || 'misc').toLowerCase();
        STATE.domainOpen[key] = !!open;
        localStorage.setItem('tc_domain_open', JSON.stringify(STATE.domainOpen));
      }

      function getDomainOpen(domain) {
        const key = String(domain || 'misc').toLowerCase();
        return Object.prototype.hasOwnProperty.call(STATE.domainOpen, key)
          ? !!STATE.domainOpen[key]
          : DOMAIN_DEFAULT_OPEN;
      }

      // Bundles panel open/closed state
      // Bundles open/closed state
      STATE.bundlesOpen = (localStorage.getItem('tc_bundles_open') !== '0'); // default open

      function setBundlesOpen(open){
        STATE.bundlesOpen = !!open;
        localStorage.setItem('tc_bundles_open', STATE.bundlesOpen ? '1' : '0');
        const body = document.getElementById('bundlesBody');
        const btn  = document.getElementById('bundlesToggle');
        if (!body || !btn) return;
        if (STATE.bundlesOpen){
          body.hidden = false;
          btn.textContent = 'Hide';
          btn.setAttribute('aria-expanded','true');
        } else {
          body.hidden = true;
          btn.textContent = 'Show';
          btn.setAttribute('aria-expanded','false');
        }
      }

      function initBundlesCollapsibleSimple(){
        const btn = document.getElementById('bundlesToggle');
        if (!btn) return;
        setBundlesOpen(STATE.bundlesOpen);      // apply initial state
        btn.onclick = () => setBundlesOpen(!STATE.bundlesOpen);
      }
    

      /* Toast */
      function toast(msg) {
        const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t);
        setTimeout(() => t.remove(), 1800);
      }

      function initBundlesCollapsible() {
        const d = $('bundlesSection');
        if (!d) return;
        d.open = getBundlesOpen();
        d.addEventListener('toggle', () => setBundlesOpen(d.open));
      }

      /* Hashing for digest */
      const tenc = s => new TextEncoder().encode(s);
      async function sha256(s) { const buf = await crypto.subtle.digest('SHA-256', tenc(s)); return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(''); }
      function canonicalJSON(x) {
        if (Array.isArray(x)) return "[" + x.map(canonicalJSON).join(",") + "]";
        if (x && typeof x === "object") { const keys = Object.keys(x).sort(); return "{" + keys.map(k => JSON.stringify(k) + ":" + canonicalJSON(x[k])).join(",") + "}"; }
        return JSON.stringify(x);
      }
      function coreForDigest(c) {
        return {
          id: c.id, version: c.version, domain: c.domain, title: c.title, statement: c.statement,
          assumptions: Array.isArray(c.assumptions) ? c.assumptions : [],
          pedagogy: Array.isArray(c.pedagogy) ? c.pedagogy.map(p => ({ kind: p.kind, text: p.text })) : []
        };
      }
      function digestCore(c) { return canonicalJSON(coreForDigest(c)); }
      async function validateDigest(c) {
        const have = await sha256(digestCore(c));
        const want = (((c.provenance || {}).signing || {}).digest) || '';
        if (!want) return { ok: true, na: true, have, want };
        return { ok: (have === want), na: false, have, want };
      }
      function badgeDigest(c) {
        const b = document.createElement('span'); b.className = 'badge'; b.textContent = 'digest…';
        validateDigest(c).then(r => {
          if (r.na) { b.textContent = 'digest n/a'; b.title = 'No reference digest in capsule'; return; }
          b.textContent = r.ok ? 'digest✓' : 'digest✗'; b.className = 'badge ' + (r.ok ? 'ok' : 'err');
          b.title = r.ok ? 'Digest OK' : 'Have ' + r.have + ' want ' + r.want;
        });
        return b;
      }
      function badgeAuthor(c) {
        const p = c.provenance || {}; const b = document.createElement('span'); b.className = 'badge'; b.textContent = (p.author || '?'); return b;
      }

      function badgePosture(c) {
        const b = document.createElement('span');
        const isWitnessed = (c.posture === 'witnessed');
        b.className = 'badge' + (isWitnessed ? ' witnessed' : '');
        b.textContent = isWitnessed ? 'witnessed' : 'informational';
        const n = (typeof c._witness_count === 'number') ? c._witness_count : 0;
        b.title = isWitnessed ? `${n} witness${n === 1 ? '' : 'es'}` : 'No witnesses';
        return b;
      }


      /* ------------ Modal ------------ */
      let MODAL = null;
      function openModal(title, c) {
        MODAL = c;
        $('m_title').textContent = title;
        $('m_body_code').textContent = (c._raw || '');
        if (window.Prism && Prism.highlightElement) {
          Prism.highlightElement($('m_body_code'));
        }
        $('m_result').textContent = 'idle'; $('m_result').className = 'badge';
        $('modal').style.display = 'flex';
      }
      function closeModal() { $('modal').style.display = 'none'; MODAL = null; }
      $('m_close').addEventListener('click', closeModal);
      $('modal').addEventListener('click', e => { if (e.target && e.target.id === 'modal') closeModal(); });
      $('m_copy_yaml').addEventListener('click', () => { if (!MODAL) return; navigator.clipboard.writeText(MODAL._raw || ''); toast('YAML copied'); });
      $('m_copy_prov').addEventListener('click', () => { if (!MODAL) return; navigator.clipboard.writeText(JSON.stringify(MODAL.provenance || {}, null, 2)); toast('Provenance copied'); });
      $('m_validate').addEventListener('click', async () => { if (!MODAL) return; const r = await validateDigest(MODAL); const tag = $('m_result'); tag.textContent = r.ok ? 'digest✓' : 'digest✗'; tag.className = 'badge ' + (r.ok ? 'ok' : 'err'); tag.title = r.ok ? 'OK' : ('have:' + r.have + ' want:' + r.want); });

      $('expandAllBtn')?.addEventListener('click', () => {
        document.querySelectorAll('details.domain-group').forEach(d => {
          d.open = true;
          const domain = d.querySelector('summary .domain-title')?.textContent || 'misc';
          setDomainOpen(domain, true);
        });
      });

      $('collapseAllBtn')?.addEventListener('click', () => {
        document.querySelectorAll('details.domain-group').forEach(d => {
          d.open = false;
          const domain = d.querySelector('summary .domain-title')?.textContent || 'misc';
          setDomainOpen(domain, false);
        });
      });



      /* ------------ Renderers ------------ */
      function renderProfiles() {
  const sel    = $('profiles');
  const descEl = $('profileDesc');
  const pmap   = DATA.profiles || {};
  const keys   = Object.keys(pmap).sort();

  // rebuild options
  sel.textContent = '';
  for (const k of keys) {
    const p = pmap[k] || {};
    const o = document.createElement('option');
    o.value = k;
    o.textContent = (p.title || k) + ' (' + (p.version || '1.0.0') + ')';
    o.dataset.desc = p.description || '';
    sel.appendChild(o);
  }

  // Choose target — IMPORTANT: prefer STATE.profile (e.g., set by importState)
  const saved = localStorage.getItem('tc_profile');
  let target =
    (STATE.profile && pmap[STATE.profile]) ? STATE.profile :
    (saved && pmap[saved]) ? saved :
    (sel.value && pmap[sel.value]) ? sel.value :
    (keys[0] || '');

  sel.value = target;
  STATE.profile = target;

  // description
  if (descEl) {
    const p0 = pmap[target] || {};
    descEl.textContent = p0.description ? ('— ' + p0.description) : '';
  }

  // change handler (unchanged)
  sel.onchange = () => {
    STATE.profile = sel.value;
    const p = pmap[STATE.profile] || {};
    if (descEl) descEl.textContent = p.description ? ('— ' + p.description) : '';
    if (typeof compose === 'function') compose();
  };

  // Fire one change event to initialize downstream (no fake toggle)
  sel.dispatchEvent(new Event('change', { bubbles: true }));
}


      function capsuleRow(c, id, opts = {}) {
        const showDomainChip = !!opts.showDomainChip;

        const item = document.createElement('div');
        item.className = 'item';
        item.dataset.id = id;

        const top = document.createElement('div'); // title + controls row
        top.className = 'row';
        item.appendChild(top);

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = STATE.selectedCaps.has(id);
        cb.addEventListener('change', () => {
          if (cb.checked) {
            STATE.selectedCaps.add(id);
            STATE.manualCaps.add(id);
            if (!STATE.order.includes(id)) STATE.order.push(id);
          } else {
            STATE.selectedCaps.delete(id);
            STATE.manualCaps.delete(id);
            STATE.order = STATE.order.filter(x => x !== id);
          }
          renderCapsules();
          renderPreview();
          compose();
        });
        top.appendChild(cb);

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = (c.title || id);
        top.appendChild(title);

        if (showDomainChip) {
          const dchip = document.createElement('span');
          dchip.className = 'chip domain';
          dchip.textContent = c.domain || 'misc';
          dchip.title = 'domain';
          top.appendChild(dchip);
        }

        top.appendChild(badgeAuthor(c));
        top.appendChild(badgeDigest(c));
        top.appendChild(badgePosture(c));

        const btn = document.createElement('button');
        btn.className = 'btn small';
        btn.textContent = 'View';
        btn.onclick = () => openModal(c.title || id, c);
        top.appendChild(btn);

        const stmt = document.createElement('div');
        stmt.className = 'small clamp-2';
        stmt.textContent = (c.statement || '');
        item.appendChild(stmt);

        // Optional applies_to chips (tiny, muted)
        if (Array.isArray(c.applies_to) && c.applies_to.length) {
          const chips = document.createElement('div');
          chips.className = 'row-chips';
          c.applies_to.forEach(tag => {
            const chip = document.createElement('span');
            chip.className = 'chip applies';
            chip.textContent = tag;
            chips.appendChild(chip);
          });
          item.appendChild(chips);
        }

        return item;
      }


      function renderCapsules() {
        const list = $('capsules');
        list.innerHTML = '';

        const f = (STATE.filter || '').toLowerCase();
        const byDomain = new Map(); // domain => [ids]

        const caps = DATA.capsules || {};
        for (const id of Object.keys(caps)) {
          const c = caps[id] || {};
          const hay = (id + ' ' + (c.title || '') + ' ' + (c.domain || '') + ' ' + (c.statement || '')).toLowerCase();
          if (hay.includes(f)) {
            const d = (c.domain || 'misc').toLowerCase();
            if (!byDomain.has(d)) byDomain.set(d, []);
            byDomain.get(d).push(id);
          }
        }

        // sort domains; and titles within domain
        const domains = Array.from(byDomain.keys()).sort();
        let total = 0;

        domains.forEach(domain => {
          const ids = byDomain.get(domain).sort((a, b) => {
            const A = (caps[a].title || a).toLowerCase();
            const B = (caps[b].title || b).toLowerCase();
            return A.localeCompare(B);
          });
          total += ids.length;

          // Group container
          const group = document.createElement('details');
          group.className = 'domain-group';
          group.open = getDomainOpen(domain);          // ← use saved state
          group.addEventListener('toggle', () => {     // ← save when user opens/closes
            setDomainOpen(domain, group.open);
          });

          // Summary header
          const sum = document.createElement('summary');
          const title = document.createElement('span');
          title.className = 'domain-title';
          title.textContent = domain;

          const count = document.createElement('span');
          count.className = 'badge';
          count.textContent = String(ids.length);

          const spacer = document.createElement('span');
          spacer.className = 'domain-spacer';

          const selAll = document.createElement('input');
          selAll.type = 'checkbox';
          selAll.addEventListener('click', e => e.stopPropagation());
          selAll.addEventListener('mousedown', e => e.stopPropagation());
          const allSelected = ids.every(cid => STATE.selectedCaps.has(cid));
          const someSelected = ids.some(cid => STATE.selectedCaps.has(cid));
          selAll.checked = allSelected;
          selAll.indeterminate = !allSelected && someSelected;
          selAll.title = 'Select all in domain';

          selAll.addEventListener('change', () => {
            if (selAll.checked) {
              ids.forEach(cid => {
                STATE.selectedCaps.add(cid);
                if (!STATE.order.includes(cid)) STATE.order.push(cid);
              });
            } else {
              ids.forEach(cid => {
                STATE.selectedCaps.delete(cid);
                STATE.manualCaps.delete(cid);
              });
              STATE.order = STATE.order.filter(x => STATE.selectedCaps.has(x));
            }
            renderCapsules();
            renderPreview();
            compose();
          });

          sum.appendChild(title);
          sum.appendChild(count);
          sum.appendChild(spacer);
          sum.appendChild(selAll);
          group.appendChild(sum);

          // Body
          const body = document.createElement('div');
          body.className = 'domain-body';
          ids.forEach(cid => {
            body.appendChild(capsuleRow(caps[cid], cid, { showDomainChip: false }));
          });
          group.appendChild(body);

          list.appendChild(group);
        });

        $('capsulesCount').textContent = total;
      }


      function renderBundles() {
        const list = $('bundles'); list.innerHTML = '';
        const keys = Object.keys(DATA.bundles || {}).sort((a, b) => (DATA.bundles[a].name || a).localeCompare(DATA.bundles[b].name || b));
        for (const k of keys) {
          const b = DATA.bundles[k] || {};
          const item = document.createElement('div'); item.className = 'item';
          const row = document.createElement('div'); row.className = 'row'; item.appendChild(row);

          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = STATE.selectedBundles.has(k);
          cb.addEventListener('change', () => {
            if (cb.checked) {
              STATE.selectedBundles.add(k);
              (b.capsules || []).forEach(cid => { STATE.selectedCaps.add(cid); if (!STATE.order.includes(cid)) STATE.order.push(cid); });
            } else {
              STATE.selectedBundles.delete(k);
              const others = [...STATE.selectedBundles];
              (b.capsules || []).forEach(cid => {
                const elsewhere = others.some(name => { const b2 = DATA.bundles[name]; return b2 && Array.isArray(b2.capsules) && b2.capsules.includes(cid); });
                const manual = STATE.manualCaps.has(cid);
                if (!elsewhere && !manual) STATE.selectedCaps.delete(cid);
                STATE.order = STATE.order.filter(x => STATE.selectedCaps.has(x));
              });
            }
            renderCapsules(); renderPreview(); compose();
          });
          row.appendChild(cb);

          const ttl = document.createElement('div'); ttl.textContent = (b.name || k); row.appendChild(ttl);

          // Add description if present
          if (b.description) {
            const desc = document.createElement('div'); desc.className = 'small'; desc.textContent = b.description; item.appendChild(desc);
          }

          list.appendChild(item);
        }
        $('bundlesCount').textContent = keys.length;
      }

      function renderPreview() {
        const list = $('preview'); list.innerHTML = '';
        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id));
        ids.forEach(id => {
          const c = DATA.capsules[id]; if (!c) return;
          const item = document.createElement('div'); item.className = 'item'; item.dataset.id = id;

          const row = document.createElement('div'); row.className = 'row'; item.appendChild(row);
          const handle = document.createElement('span'); handle.className = 'chip drag'; handle.textContent = '☰'; row.appendChild(handle);
          const ttl = document.createElement('div');
          ttl.className = 'title';
          ttl.innerHTML = esc(c.title || id) + ' <span class="muted">— ' + esc(c.domain || '') + '</span>';
          row.appendChild(ttl);

          const btn = document.createElement('button'); btn.className = 'btn small'; btn.textContent = 'View'; btn.onclick = () => openModal(c.title || id, c); row.appendChild(btn);

          list.appendChild(item);
        });

        // Sortable (drag to reorder)
        if (window.__sortable) window.__sortable.destroy();
        window.__sortable = new Sortable(list, {
          animation: 120,
          handle: '.drag',
          ghostClass: 'ghost',
          onEnd: (evt) => {
            const old = STATE.order.filter(id => STATE.selectedCaps.has(id));
            const moved = old.splice(evt.oldIndex, 1)[0];
            old.splice(evt.newIndex, 0, moved);
            STATE.order = old.concat(STATE.order.filter(x => !STATE.selectedCaps.has(x)));
            compose();
          }
        });
      }

      /* ------------ Composition ------------ */
      function parseFieldSpec(spec) {
        const m = String(spec).match(/^([a-z_.]+)(?:\[:(\d+)\])?$/i);
        return { path: m ? m[1].toLowerCase() : String(spec).toLowerCase(), limit: m && m[2] ? parseInt(m[2], 10) : null };
      }

      function applyProjection(capsule, projection, includePedagogy) {
        const proj = projection || {};
        const include = Array.isArray(proj.include) ? proj.include : [];
        const render = proj.render || {};

        const header = render.capsule_header || "BEGIN CAPSULE id={id} version={version} domain={domain}";
        const footer = render.enforcement_footer || "ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info.";
        const aBullet = render.assumption_bullet || "  - {text}";
        const sBullet = render.socratic_bullet || "  - {text}";
        const aphBullet = render.aphorism_bullet || "  - {text}";

        const lines = [];
        lines.push(
          header
            .replace('{id}', capsule.id || '')
            .replace('{version}', capsule.version || '1.0.0')
            .replace('{domain}', capsule.domain || '')
        );

        for (const spec of include) {
          const { path, limit } = parseFieldSpec(spec);
          const lim = (limit == null ? Number.MAX_SAFE_INTEGER : limit);

          if (path === 'title' && capsule.title) lines.push("TITLE: " + capsule.title);
          else if (path === 'statement' && capsule.statement) lines.push("STATEMENT: " + capsule.statement);
          else if (path === 'assumptions') {
            let items = capsule.assumptions || [];
            // allow object assumptions: {text: "..."} or {assumption: "..."}
            items = items.map(a => (typeof a === 'string') ? a : (a?.text || a?.assumption || JSON.stringify(a)));
            items = items.slice(0, lim);
            if (items.length) {
              lines.push("ASSUMPTIONS:");
              items.forEach(t => lines.push(aBullet.replace('{text}', t)));
            }
          }
          else if (path === 'pedagogy.socratic' && includePedagogy) {
            const soc = (capsule.pedagogy || [])
              .filter(p => /socratic/.test((p.kind || '').toLowerCase()))
              .slice(0, lim);
            if (soc.length) {
              lines.push("PEDAGOGY (Socratic):");
              soc.forEach(p => lines.push(sBullet.replace('{text}', p.text || '')));
            }
          }
          else if (path === 'pedagogy.aphorisms' && includePedagogy) {
            const aph = (capsule.pedagogy || [])
              .filter(p => /aphorism/.test((p.kind || '').toLowerCase()))
              .slice(0, lim);
            if (aph.length) {
              lines.push("PEDAGOGY (Aphorisms):");
              aph.forEach(p => lines.push(aphBullet.replace('{text}', p.text || '')));
            }
          }
        }

        lines.push(footer);
        return lines.join("\n");
      }


      function composeLegacy(c, includePedagogy) {
        const lines = [];
        /* lines.push("BEGIN CAPSULE id=" + (c.id || '') + " version=" + (c.version || '1.0.0') + " domain=" + (c.domain || '')); */
        lines.push("BEGIN CAPSULE id=" + (c.id || '') +
          " version=" + (c.version || '1.0.0') +
          " domain=" + (c.domain || '') +
          " posture=" + (c.posture || 'informational') + ")");
        if (c.statement) lines.push("STATEMENT: " + c.statement);
        if (includePedagogy && c.pedagogy) {
          const ped = c.pedagogy.map(p => (p.kind + ': ' + p.text)).join('\n');
          if (ped) lines.push('PEDAGOGY:\n' + ped);
        }
        lines.push('END CAPSULE');
        return lines.join("\n");
      }
      function compose() {
        const prof = DATA.profiles[STATE.profile || ''] || {};
        const response = prof.response || {};
        const projection = response.projection || null;

        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id));
        const blocks = [];

        const policy = response.policy || 'Cite or abstain; follow Plan-Verify-Answer; ask ONE crisp follow-up if required.';
        const format = response.format || 'natural';
        const system_block = response.system_block || ("SYSTEM: Profile=" + (prof.title || 'unknown') + "\nPOLICY: " + policy + "\nFORMAT: " + format);
        blocks.push(system_block);

        // If the profile’s projection includes pedagogy.* then force-enable pedagogy rendering
        const wantsPed = Array.isArray(projection?.include) && projection.include.some(s => String(s).startsWith('pedagogy.'));
        const withPed = $('includePed').checked || wantsPed;

        blocks.push("SYSTEM: Truth Capsules Loader v1\nPURPOSE: Use curated capsules to scaffold reasoning and enforce acceptance rules.\nMETHOD:\n  1) Load capsule rules (below).\n  2) For each task, follow Plan → Verify → Answer.\n  3) If required fields are missing, ask ONE concise follow-up.\n  4) Cite sources or abstain. Redact PII. Validate tool JSON before calling.\n  5) Emit a JSON report when asked (see REPORT SCHEMA).\nFAILURE POLICY: If a capsule cannot be satisfied, abstain + explain what is missing.");
        blocks.push("SYSTEM: Bootstrap Discipline\n• Curation is king - prefer curated fixtures/evidence; abstain when unsure.\n• Show your work - reference evidence in answers.\n• Make failures explicit and reversible - choose tiny experiments.");

        if (ids.length === 0) {
          blocks.push('SYSTEM: Capsule Rules (Selected)\n- (No capsules selected)');
        } else {
          blocks.push('SYSTEM: Capsule Rules (Selected)');
          for (const id of ids) {
            const c = DATA.capsules[id]; if (!c) continue;
            blocks.push((projection && projection.include) ? applyProjection(c, projection, withPed) : composeLegacy(c, withPed));
          }
        }

        let out = blocks.join("\n\n");
        if ($('markdown').checked) out = "```\n" + out + "\n```";
        $('out').value = out;
      }



      /* ------------ Manifest + share ------------ */
      /* ------------ Manifest + share ------------ */

/* Namespace for LocalStorage manifests */
const MANIFEST_NS = 'tc_manifests_v1'; // value: { [name: string]: Manifest }

/* Helpers */
function readAllManifests() {
  try { return JSON.parse(localStorage.getItem(MANIFEST_NS) || '{}'); }
  catch { return {}; }
}
function writeAllManifests(obj) {
  localStorage.setItem(MANIFEST_NS, JSON.stringify(obj || {}));
}
function listManifestNames() {
  return Object.keys(readAllManifests()).sort((a, b) => a.localeCompare(b));
}

/* Filename-ish, human friendly */
function tsCompact(d = new Date()) {
  const p2 = n => String(n).padStart(2, '0');
  return [
    d.getFullYear(),
    p2(d.getMonth() + 1),
    p2(d.getDate()),
    '_',
    p2(d.getHours()),
    p2(d.getMinutes()),
    p2(d.getSeconds())
  ].join('');
}
function suggestedManifestName() {
  const prof = STATE.profile || 'default';
  const nCaps = STATE.order.filter(id => STATE.selectedCaps.has(id)).length;
  return `${tsCompact()}__${prof}__n${nCaps}`;
}

/* Build a complete, safe-to-JSON manifest (includes the composed system prompt) */
function buildManifest() {
  return {
    schema: 'tc.manifest.v1',
    ts: new Date().toISOString(),
    profile: STATE.profile,
    bundles: [...STATE.selectedBundles],
    order: STATE.order.filter(id => STATE.selectedCaps.has(id)),
    includePed: $('includePed').checked ? 1 : 0,
    markdown: $('markdown').checked ? 1 : 0,
    // Save the current composed system prompt WITHOUT markdown fences
    prompt: getCurrentSystemPrompt()
  };
}

/* Export-only (for URL deeplinks) */
function exportState() {
  return {
    profile: STATE.profile,
    bundles: [...STATE.selectedBundles],
    order: STATE.order.filter(id => STATE.selectedCaps.has(id))
  };
}

/* Share-link (does not include prompt; keeps links light) */
function encodeStateToUrl() {
  const s = btoa(unescape(encodeURIComponent(JSON.stringify(exportState()))));
  const url = new URL(window.location.href);
  url.searchParams.set('s', s);
  return url.toString();
}

/* Import state/manifest (from file or LocalStorage). Also applies prompt after render. */
function importState(obj) {
  if (!obj) return;

  // Choose a valid profile (fallback to first available)
  const prof = (obj.profile && DATA.profiles[obj.profile]) ? obj.profile
               : (Object.keys(DATA.profiles || {})[0] || null);

  STATE.profile = prof;
  STATE.selectedBundles = new Set();
  STATE.selectedCaps = new Set();
  STATE.manualCaps = new Set();
  STATE.order = [];

  // Bundles → selectedCaps/ORDER
  (obj.bundles || []).forEach(b => { if (DATA.bundles[b]) STATE.selectedBundles.add(b); });
  STATE.selectedBundles.forEach(b => {
    const caps = (DATA.bundles[b] && DATA.bundles[b].capsules) || [];
    caps.forEach(cid => {
      if (DATA.capsules[cid]) {
        STATE.selectedCaps.add(cid);
        if (!STATE.order.includes(cid)) STATE.order.push(cid);
      }
    });
  });

  // Manual order/caps (explicit)
  (obj.order || []).forEach(cid => {
    if (DATA.capsules[cid]) {
      if (!STATE.order.includes(cid)) STATE.order.push(cid);
      STATE.selectedCaps.add(cid);
    }
  });

  // Render everything (this will call compose(), which would normally overwrite #out)
  render();

  // Restore checkboxes from the manifest (optional, but nice to have)
  if (Object.prototype.hasOwnProperty.call(obj, 'includePed')) {
    $('includePed').checked = !!obj.includePed;
  }
  if (Object.prototype.hasOwnProperty.call(obj, 'markdown')) {
    $('markdown').checked = !!obj.markdown;
  }

  // Apply prompt AFTER render/compose so the loaded prompt wins on load
  if (typeof obj.prompt === 'string') {
    $('out').value = obj.prompt;
  }

  // Update the profile select’s remembered value for future sessions
  if (STATE.profile) localStorage.setItem('tc_profile', STATE.profile);
}

/* Hydrate state from ?s=... link */
function tryHydrateFromUrl() {
  const url = new URL(window.location.href);
  const s = url.searchParams.get('s');
  if (!s) return;
  try {
    const json = decodeURIComponent(escape(atob(s)));
    importState(JSON.parse(json));
  } catch (e) {
    console.error('bad s param', e);
  }
}

/* LocalStorage manifests – UI binding */
function refreshManifestSelect() {
  const sel = $('manifestSelect');
  if (!sel) return;
  sel.innerHTML = '';
  const names = listManifestNames();
  if (names.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = '(no saved manifests)';
    sel.appendChild(opt);
    sel.disabled = true;
  } else {
    sel.disabled = false;
    names.forEach(n => {
      const opt = document.createElement('option');
      opt.value = n;
      opt.textContent = n;
      sel.appendChild(opt);
    });
  }
}

function saveManifestToLocalStorage() {
  const manifest = buildManifest();
  const defaultName = suggestedManifestName();
  const name = prompt('Save manifest as:', defaultName);
  if (!name) return;

  const all = readAllManifests();
  const exists = Object.prototype.hasOwnProperty.call(all, name);
  if (exists) {
    const ok = confirm(`A manifest named "${name}" already exists. Overwrite?`);
    if (!ok) return;
  }

  all[name] = manifest;
  writeAllManifests(all);
  refreshManifestSelect();
  // Preselect the saved item
  const sel = $('manifestSelect');
  if (sel && !sel.disabled) sel.value = name;
  toast(`Saved manifest "${name}"`);
}

function loadSelectedManifestFromLocalStorage() {
  const sel = $('manifestSelect');
  if (!sel || sel.disabled || !sel.value) {
    toast('No saved manifest selected'); 
    return;
  }
  const all = readAllManifests();
  const m = all[sel.value];
  if (!m) { toast('Manifest not found'); return; }
  importState(m);
  toast(`Loaded "${sel.value}"`);
}

function deleteSelectedManifestFromLocalStorage() {
  const sel = $('manifestSelect');
  if (!sel || sel.disabled || !sel.value) {
    toast('No saved manifest selected');
    return;
  }
  const name = sel.value;
  const ok = confirm(`Delete saved manifest "${name}"? This cannot be undone.`);
  if (!ok) return;

  const all = readAllManifests();
  delete all[name];
  writeAllManifests(all);
  refreshManifestSelect();
  toast(`Deleted "${name}"`);
}

/* Wire buttons (file import already exists, we keep it) */
$('dlJsonBtn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(buildManifest(), null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'system_prompt.manifest.json';
  a.click();
});

$('loadJsonBtn').addEventListener('click', () => {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = async () => {
    const f = inp.files[0];
    if (!f) return;
    try {
      const txt = await f.text();
      const obj = JSON.parse(txt);
      importState(obj);
      toast('Manifest loaded from file');
    } catch (e) {
      console.error(e);
      toast('Invalid JSON manifest');
    }
  };
  inp.click();
});

/* New LS controls */
$('manifestSaveBtn').addEventListener('click', saveManifestToLocalStorage);
$('manifestLoadBtn').addEventListener('click', loadSelectedManifestFromLocalStorage);
$('manifestDeleteBtn').addEventListener('click', deleteSelectedManifestFromLocalStorage);

/* Populate the manifest list on load */
window.addEventListener('load', refreshManifestSelect);


      /* ------------ LLM Command Composition ------------ */
      function shQuoteLiteral(s) {
        // POSIX-safe single-quote wrapper: ' becomes '\''
        return "'" + String(s).replace(/'/g, "'\\''") + "'";
      }

      function buildSysHeredoc(promptText) {
        // Use single-quoted heredoc label to disable interpolation/globbing
        // Use TC_SYSTEM to avoid conflicts with user's shell variables
        const label = "__TC_SYSTEM__";
        return [
          `read -r -d '' TC_SYSTEM <<'${label}'`,
          promptText,
          label
        ].join("\n");
      }

      function buildInputFragment(tpl, userText, filePath) {
        const flags = (tpl.extra_flags || []).join(' ');

        if (tpl.input_mode === 'arg') {
          return {
            EXTRA_FLAGS: flags,
            INPUT_FRAGMENT: `<<< ${shQuoteLiteral(userText || "")}`
          };
        }

        if (tpl.input_mode === 'stdin') {
          return {
            EXTRA_FLAGS: flags,
            STDIN_PIPE: `printf %s ${shQuoteLiteral(userText || "")} |`,
            INPUT_FRAGMENT: ""
          };
        }

        if (tpl.input_mode === 'file') {
          return {
            EXTRA_FLAGS: flags,
            FILE_PATH: shQuoteLiteral(filePath || "input.txt"),
            INPUT_FRAGMENT: ""
          };
        }

        return { EXTRA_FLAGS: flags, INPUT_FRAGMENT: "" };
      }

      function composeLlmCommand(tpl, systemPrompt, userText, filePath, minify) {
        const sysText = minify ? systemPrompt.replace(/\s+/g, ' ').trim() : systemPrompt;
        const sysHeredoc = buildSysHeredoc(sysText);
        const frags = buildInputFragment(tpl, userText, filePath);

        // Build the command by replacing all placeholders
        let cmd = String(tpl.cmd_template || '');

        // Replace required placeholders
        cmd = cmd.replace(/\{\{SYS_HEREDOC\}\}/g, sysHeredoc);
        cmd = cmd.replace(/\{\{MODEL\}\}/g, tpl.model || '');
        cmd = cmd.replace(/\{\{INPUT_FRAGMENT\}\}/g, frags.INPUT_FRAGMENT || '');

        // Replace optional placeholders
        cmd = cmd.replace(/\{\{EXTRA_FLAGS\}\}/g, frags.EXTRA_FLAGS || '');
        cmd = cmd.replace(/\{\{STDIN_PIPE\}\}/g, frags.STDIN_PIPE || '');
        cmd = cmd.replace(/\{\{FILE_PATH\}\}/g, frags.FILE_PATH || '');

        // Clean up:
        // 1. Collapse multiple spaces into single space
        cmd = cmd.replace(/ {2,}/g, ' ');
        // 2. Remove trailing spaces on lines
        cmd = cmd.replace(/[ \t]+$/gm, '');
        // 3. Ensure final newline
        cmd = cmd.trim() + "\n";

        return cmd;
      }

      function getCurrentSystemPrompt() {
        // Get the current composed prompt, stripping markdown fences if present
        let prompt = $('out').value;
        if ($('markdown').checked) {
          // Remove leading ``` and trailing ```
          prompt = prompt.replace(/^```\n/, '').replace(/\n```$/, '');
        }
        return prompt;
      }

      function updateLlmPreview() {
        const templates = DATA.llm_templates || [];
        const selectedId = $('llm_template').value;
        const tpl = templates.find(t => t.id === selectedId);

        if (!tpl) {
          $('llm_preview').value = '';
          return;
        }

        const systemPrompt = getCurrentSystemPrompt();
        const userText = $('llm_user_input').value;
        const filePath = $('llm_file_path').value;
        const minify = $('llm_minify').checked;

        const command = composeLlmCommand(tpl, systemPrompt, userText, filePath, minify);
        $('llm_preview').value = command;
      }

      function openLlmModal() {
        const templates = DATA.llm_templates || [];

        if (templates.length === 0) {
          toast('No LLM templates found');
          return;
        }

        // Populate template selector
        const sel = $('llm_template');
        sel.innerHTML = '';
        templates.forEach(tpl => {
          const opt = document.createElement('option');
          opt.value = tpl.id;
          opt.textContent = tpl.label;
          sel.appendChild(opt);
        });

        // Restore last used template from localStorage
        const lastTemplate = localStorage.getItem('llm_last_template');
        if (lastTemplate && templates.find(t => t.id === lastTemplate)) {
          sel.value = lastTemplate;
        }

        // Update description and input mode on template change
        const updateTemplateUI = () => {
          const selectedId = sel.value;
          const tpl = templates.find(t => t.id === selectedId);
          if (!tpl) return;

          $('llm_template_desc').textContent = tpl.description || '';

          // Show/hide input fields based on input_mode
          if (tpl.input_mode === 'file') {
            $('llm_input_row').style.display = 'none';
            $('llm_file_row').style.display = 'flex';
          } else {
            $('llm_input_row').style.display = 'flex';
            $('llm_file_row').style.display = 'none';

            if (tpl.input_mode === 'stdin') {
              $('llm_input_hint').textContent = 'Will be piped to stdin';
            } else {
              $('llm_input_hint').textContent = 'Will be passed as bash here-string (<<<)';
            }
          }

          // Update preview whenever template changes
          updateLlmPreview();
        };

        sel.onchange = updateTemplateUI;

        // Update preview on input changes
        $('llm_user_input').oninput = updateLlmPreview;
        $('llm_file_path').oninput = updateLlmPreview;
        $('llm_minify').onchange = updateLlmPreview;

        updateTemplateUI();

        // Clear inputs (but preserve file path default)
        $('llm_user_input').value = '';
        $('llm_file_path').value = 'input.txt';
        $('llm_minify').checked = false;

        // Initial preview
        updateLlmPreview();

        $('llmModal').style.display = 'flex';
      }

      function closeLlmModal() {
        $('llmModal').style.display = 'none';
      }

      function copyLlmCommand() {
        const command = $('llm_preview').value;

        if (!command) {
          toast('No command to copy');
          return;
        }

        // Save the selected template to localStorage
        const selectedId = $('llm_template').value;
        if (selectedId) {
          localStorage.setItem('llm_last_template', selectedId);
        }

        navigator.clipboard.writeText(command).then(() => {
          toast('Command copied to clipboard!');
          // Don't close the modal - let user copy again or review
        }).catch(err => {
          console.error('Copy failed:', err);
          toast('Copy failed - see console');
        });
      }

      // Save the generated command as a runnable bash script
      function saveLlmScript() {
        const command = $('llm_preview').value;
        if (!command) {
          toast('No command to save');
          return;
        }

        const tplId = $('llm_template').value || 'cmd';
        const nowIso = new Date().toISOString();
        const filename = `llm_${tplId}_${nowIso.replace(/[:.]/g, '-')}.sh`;

        const header =
          `#!/usr/bin/env bash
# Generated by Truth Capsule Composer
# Template: ${tplId}
# Date: ${nowIso}
set -Eeuo pipefail
IFS=$'\\n\\t'

`;

        const blob = new Blob([header, command], { type: 'text/x-shellscript' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
        a.remove();
        toast(`Saved ${filename} (remember: chmod +x ${filename})`);
      }
      function copyLlmCommand() {
        const command = $('llm_preview').value;

        if (!command) {
          toast('No command to copy');
          return;
        }

        // Save the selected template to localStorage
        const selectedId = $('llm_template').value;
        if (selectedId) {
          localStorage.setItem('llm_last_template', selectedId);
        }

        navigator.clipboard.writeText(command).then(() => {
          toast('Command copied to clipboard!');
          // Don't close the modal - let user copy again or review
        }).catch(err => {
          console.error('Copy failed:', err);
          toast('Copy failed - see console');
        });
      }

      // Wire up LLM modal events
      $('copyLlmBtn').addEventListener('click', openLlmModal);
      $('llm_close').addEventListener('click', closeLlmModal);
      $('llm_cancel').addEventListener('click', closeLlmModal);
      $('llm_copy').addEventListener('click', copyLlmCommand);
      $('llm_save').addEventListener('click', saveLlmScript)
      $('llmModal').addEventListener('click', e => {
        if (e.target && e.target.id === 'llmModal') closeLlmModal();
      });

      /* ------------ Wire up UI ------------ */
      $('search').addEventListener('input', () => { STATE.filter = $('search').value; renderCapsules(); });
      $('clearBtn').addEventListener('click', () => { STATE.selectedBundles = new Set(); STATE.selectedCaps = new Set(); STATE.manualCaps = new Set(); STATE.order = []; render(); toast('Cleared'); });
      $('composeBtn').addEventListener('click', compose);
      $('copyBtn').addEventListener('click', () => { navigator.clipboard.writeText($('out').value); toast('Prompt copied'); });
      $('dlBtn').addEventListener('click', () => { const blob = new Blob([$('out').value], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'system_prompt.txt'; a.click(); });
      $('dlJsonBtn').addEventListener('click', () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(buildManifest(), null, 2)], { type: 'application/json' })); a.download = 'system_prompt.manifest.json'; a.click(); });
      $('shareLinkBtn').addEventListener('click', () => { const url = encodeStateToUrl(); navigator.clipboard.writeText(url).then(() => toast('Share link copied')).catch(() => { prompt('Copy link:', url); }); });
      $('loadJsonBtn').addEventListener('click', () => { const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json'; inp.onchange = async () => { const f = inp.files[0]; if (!f) return; const txt = await f.text(); importState(JSON.parse(txt)); toast('State loaded'); }; inp.click(); });
      $('validateAllBtn').addEventListener('click', async () => {
        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id)); const results = [];
        for (const id of ids) { const c = DATA.capsules[id]; if (!c) continue; const v = await validateDigest(c); results.push({ id, ok: v.ok }); }
        const ok = results.filter(r => r.ok).length; const fail = results.length - ok;
        toast(`Digests: ${ok} ok, ${fail} fail`); try { await navigator.clipboard.writeText(results.map(r => (r.ok ? '✓ ' : '✗ ') + r.id).join('\n')); } catch { }
      });
      $('includePed').addEventListener('change', compose);
      $('markdown').addEventListener('change', compose);

      /* Keyboard shortcuts */
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { compose(); }
        if (e.key === '/') { e.preventDefault(); $('search').focus(); }
        if (e.key === 'm') { $('markdown').checked = !$('markdown').checked; compose(); }
        if (e.key === 'p') { $('includePed').checked = !$('includePed').checked; compose(); }
      });

      function render() { renderProfiles(); renderBundles(); renderCapsules(); renderPreview(); compose(); }
      render();
      tryHydrateFromUrl();
      initBundlesCollapsibleSimple();

      // Remember splits
      const mainSizes = JSON.parse(localStorage.getItem('tc_split_main') || '[30,70]');
      Split(['#left', '#right'], { sizes: mainSizes, minSize: 240, gutterSize: 8, onDragEnd: s => localStorage.setItem('tc_split_main', JSON.stringify(s)) });

      const subSizes = JSON.parse(localStorage.getItem('tc_split_sub') || '[45,55]');
      Split(['#bundlesWrap', '#capsulesWrap'], { direction: 'vertical', sizes: subSizes, minSize: [80, 120], gutterSize: 8, onDragEnd: s => localStorage.setItem('tc_split_sub', JSON.stringify(s)) });

      // Remember profile + checkboxes
      $('profiles').addEventListener('change', () => localStorage.setItem('tc_profile', $('profiles').value));
      $('includePed').addEventListener('change', () => localStorage.setItem('tc_inc_ped', $('includePed').checked ? '1' : '0'));
      $('markdown').addEventListener('change', () => localStorage.setItem('tc_md', $('markdown').checked ? '1' : '0'));

      window.addEventListener('load', () => {
        const p = localStorage.getItem('tc_profile'); if (p && DATA.profiles[p]) $('profiles').value = p;
        $('includePed').checked = localStorage.getItem('tc_inc_ped') !== '0';
        $('markdown').checked = localStorage.getItem('tc_md') === '1';
      });

      (function profileHelp(){
        const sel   = document.getElementById('profiles');
        const desc  = document.getElementById('profileDesc');
        const help  = document.getElementById('profileHelp');
        const btn   = document.getElementById('profileInfo');

        // Always show the selected profile's description (from <option data-desc="...">)
        function renderDesc(){
          if (!sel || !desc) return;
          const opt = sel.options[sel.selectedIndex];
          const d   = opt && opt.dataset ? (opt.dataset.desc || '').trim() : '';
          desc.textContent = d ? `— ${d}` : '';   // always visible, empty if none
        }

        // Wire events (guarded)
        if (sel){
          sel.addEventListener('change', renderDesc);
          // Schedule initial render after options are populated by your code
          requestAnimationFrame(renderDesc);
        }

        // Help button toggles the explanatory panel (general concept of profiles)
        if (btn && help){
          btn.addEventListener('click', () => {
            const hidden = help.hasAttribute('hidden');
            if (hidden) help.removeAttribute('hidden'); else help.setAttribute('hidden', '');
            btn.setAttribute('aria-expanded', String(hidden));
          });
        }
      })();

      /* Close <details.menu> when clicking elsewhere, Esc, or when another opens */
      (function menuCloser(){
        const menus = () => Array.from(document.querySelectorAll('details.menu'));

        function closeAll(except = null){
          menus().forEach(d => { if (d !== except) d.removeAttribute('open'); });
        }

        // 1) Click anywhere: keep the menu under the click, close the rest
        document.addEventListener('click', (e) => {
          const keep = e.target.closest('details.menu');
          closeAll(keep || null);
        });

        // 2) When a menu toggles open, close the others
        // Use capture to be safe across browsers.
        document.addEventListener('toggle', (e) => {
          const el = e.target;
          if (el instanceof HTMLDetailsElement && el.classList.contains('menu') && el.open) {
            closeAll(el);
          }
        }, true);

        // 3) Esc closes all menus
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeAll();
        });

        // 4) After a menu-item is activated, close its menu (let handler run first)
        document.addEventListener('click', (e) => {
          const item = e.target.closest('.menu-item');
          if (!item) return;
          const d = item.closest('details.menu');
          if (d) setTimeout(() => d.removeAttribute('open'), 0);
        });
      })();


    </script>
</body>

</html>