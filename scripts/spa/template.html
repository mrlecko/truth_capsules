<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Truth Capsule Prompt Composer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- THEME + LAYOUT -->
  <style>
    :root {
      --bg: #0f1115;
      /* page background */
      --panel: #161a20;
      /* cards / panels */
      --panel-alt: #1b2028;
      /* code blocks */
      --text: #e6eaf2;
      /* primary text */
      --muted: #a9b1c3;
      /* secondary text */
      --accent: #7aa2ff;
      /* interactive/links */
      --border: #232a36;
      /* borders */
      --chip: #212734;
      /* chips */
      --chip-border: #2c3443;
      --ok: #46d39a;
      --danger: #ff6b6b;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 18px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    /* Global *webkit* scrollbars (applied to every scrollable element) */
    *::-webkit-scrollbar {
      width: 12px;
      height: 12px
    }

    *::-webkit-scrollbar-thumb {
      background: #2a3545;
      border-radius: 8px;
      border: 2px solid var(--bg)
    }

    *::-webkit-scrollbar-track {
      background: var(--bg)
    }

    /* header (sticky toolbar) */
    header {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 50
    }

    h1 {
      font-size: 16px;
      margin: 0
    }

    header .small {
      color: var(--muted)
    }

    /* split layout (Split.js) */
    main {
      position: relative;
      height: calc(100vh - 54px)
    }

    #split {
      display: flex;
      height: 100%
    }

    #left,
    #right {
      overflow: hidden
    }

    /* children manage their own overflow */
    #left {
      min-width: 260px;
      max-width: 40vw;
      display: flex;
      flex-direction: column
    }

    /* left top controls (search + profile) */
    #leftTop {
      padding: 12px;
      border-bottom: 1px solid var(--border)
    }

    /* left inner vertical split (bundles/capsules) */
    #leftSplit {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0
    }

    .section-block {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 12px;
      min-height: 0
    }

    .section-title {
      font-weight: 600;
      margin-bottom: 8px;
      flex-shrink: 0
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      min-height: 0
    }

    .item {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .small {
      font-size: 16px;
      color: var(--muted)
    }

    .chip {
      background: var(--chip);
      border: 1px solid var(--chip-border);
      border-radius: 12px;
      padding: 4px 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .chip:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent), transparent 80%)
    }

    .drag {
      cursor: grab;
      user-select: none
    }

    .drag:active {
      cursor: grabbing
    }

    /* right column */
    section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px
    }

    .btn {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0e141e;
      color: var(--text);
      cursor: pointer
    }

    .btn:hover {
      border-color: var(--accent)
    }

    .btn.warn {
      background: color-mix(in oklab, var(--danger), #000 80%);
      color: #ffdcdc
    }

    .btn.small {
      font-size: 14px;
      padding: 4px 8px
    }

    select,
    input[type="text"] {
      background: #0e141e;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px;
      border-radius: 8px;
      font-size:16px;
    }

    /* code / text areas */
    pre,
    textarea {
      width: 100%;
      min-height: 240px;
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--panel-alt);
      border: 1px solid var(--border);
      color: #00ff68; /* var(--text); */
      border-radius: 10px;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 15.5px;
      line-height: 1.5;
      tab-size: 2
    }

    /* badges */
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      background: #20314a;
      color: #c2d1f3;
      font-size: 13px;
      border: 1px solid #1a2537
    }

    .badge.ok {
      background: color-mix(in oklab, var(--ok), #000 75%);
      color: #c6f6df;
      border-color: #1b3a30
    }

    .badge.witnessed {
      background:rgb(142, 47, 47);
    }
    .badge.err {
      background: color-mix(in oklab, var(--danger), #000 75%);
      color: #ffd6d6;
      border-color: #4a1b1b
    }

    /* horizontal (vertical-direction) gutter between Bundles & Capsules */
    .gutter.gutter-vertical {
      height: 8px;
      cursor: row-resize;
      background: linear-gradient(to bottom, transparent 0, transparent 3px, #ffffff33 3px, #ffffff33 5px, transparent 5px);
    }

    .gutter.gutter-vertical:hover {
      background: #ffffff44
    }

    /* vertical (left/right) gutter */
    .gutter {
      background: transparent;
      cursor: col-resize
    }

    .gutter:hover {
      background: rgba(122, 162, 255, .08)
    }

    /* modal */
    #modal,
    #llmModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100
    }

    #modal .modal-inner,
    #llmModal .modal-inner {
      background: var(--panel-alt);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 900px;
      width: 92%;
      max-height: 80vh;
      overflow: auto;
      padding: 12px
    }

    #llmModal .form-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 12px 0
    }

    #llmModal label {
      font-weight: 500;
      font-size: 13px
    }

    #llmModal textarea {
      min-height: 100px
    }

    #llmModal .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px
    }

    /* toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #212734;
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #2c3443;
      z-index: 99
    }

    /* --- Pin the right column to the viewport edge --- */
    #split {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #left {
      flex: 0 0 auto;
      /* left takes only what it needs (Split.js sets size) */
      min-width: 260px;
      /* keep your floor */
    }

    #right {
      flex: 1 1 auto;
      /* right fills the rest */
      min-width: 0;
      /* CRUCIAL: allow shrinking; prevents the phantom gap */
      overflow: auto;
      /* keep internal scrolling */
    }

    /* If you want zero visual gutter on the far right, remove section padding: */
    section#right {
      padding-right: 0;
    }

    /* accessibility patches */
    .small{ color: #bac2d6; }               /* was #a9b1c3 */
    .badge{ color:#d6e1ff; border-color:#253043; }
    .badge.err{ color:#ffdadd; }
    :root{ color-scheme: dark; }            /* hints to OS/browser */

  </style>

  <!-- Prism / Split / Sortable -->
  {% if inline_cdn %}
    <!-- digests (supply-chain breadcrumbs) -->
    <!-- prism_css: sha256={{ digests['prism_css'] }} -->
    <!-- prism_core: sha256={{ digests['prism_core'] }} -->
    <!-- prism_yaml: sha256={{ digests['prism_yaml'] }} -->
    <!-- prism_json: sha256={{ digests['prism_json'] }} -->
    <!-- split_js: sha256={{ digests['split_js'] }} -->
    <!-- sortable_js: sha256={{ digests['sortable_js'] }} -->

    <style>{{ prism_css_inline | safe }}</style>
    <script>{{ prism_core_inline | safe }}</script>
    <script>{{ prism_yaml_inline | safe }}</script>
    <script>{{ prism_json_inline | safe }}</script>
    <script>{{ split_js_inline | safe }}</script>
    <script>{{ sortable_js_inline | safe }}</script>
  {% else %}
    <!-- CDN fallback (deterministic, pinned) -->
    <link rel="stylesheet" href="{{ cdn_urls['prism_css'] }}">
    <script src="{{ cdn_urls['prism_core'] }}"></script>
    <script src="{{ cdn_urls['prism_yaml'] }}"></script>
    <script src="{{ cdn_urls['prism_json'] }}"></script>
    <script src="{{ cdn_urls['split_js'] }}"></script>
    <script src="{{ cdn_urls['sortable_js'] }}"></script>
  {% endif %}

</head>

<body>
  <header class="toolbar">
    <h1>Truth Capsule Prompt Composer</h1>
    <div class="small" style="font-size:12px; margin-top:5px;">Generated {{ generated_at }}</div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button  class="btn" id="composeBtn" title="Compose (Ctrl/Cmd+Enter)">üü¢ Compose</button>
      <button class="btn" id="copyBtn" title="Copy prompt">üìã Copy Prompt</button>
      <button class="btn" id="copyLlmBtn" title="Copy LLM command">üíª Copy LLM Bash</button>
      <button class="btn" id="dlBtn" title="Download prompt">‚¨áÔ∏è Download Prompt</button>
      <button class="btn" id="dlJsonBtn" title="Download manifest JSON">‚¨áÔ∏è Download JSON Manifest</button>
      <button class="btn" id="loadJsonBtn" title="Load manifest JSON">‚¨ÜÔ∏è Load JSON Manifest</button>
      <button class="btn" id="shareLinkBtn" title="Copy shareable link">üìã Share Deeplink</button>
      <button class="btn" id="validateAllBtn" title="Validate digests for selected">üîê Validate Digests</button>
      <button class="btn warn" id="clearBtn" title="Clear selection">üóëÔ∏è Clear Capsules</button>
    </div>
  </header>

  <main>
    <div id="split">
      <!-- LEFT COLUMN -->
      <aside id="left">
        <div id="leftTop">
          <input id="search" type="text" placeholder="Filter by id/title/domain/statement‚Ä¶" style="width:100%">
          <div class="row" style="margin-top:10px">
            <label>PROFILES</label>
            <select id="profiles"></select>
          </div>
          <div class="row small" id="profileHelp" style="margin-top:4px"></div>
        </div>

        <!-- RESIZABLE HORIZONTAL SPLIT: Bundles ‚ü∑ Capsules -->
        <div id="leftSplit">
          <div id="bundlesWrap" class="section-block">
            <div class="section-title">BUNDLES (<span id="bundlesCount">0</span>)</div>
            <div id="bundles" class="list"></div>
          </div>
          <div id="capsulesWrap" class="section-block">
            <div class="section-title">CAPSULES (<span id="capsulesCount">0</span>)</div>
            <div id="capsules" class="list"></div>
          </div>
        </div>
      </aside>

      <!-- RIGHT COLUMN -->
      <section id="right">
        <div class="card">
          <div class="row">
            <label style="display:none;"><input type="checkbox" id="includePed" checked> include pedagogy</label>
            <label><input type="checkbox" id="markdown"> markdown preview</label>
            <span class="small">Drag to reorder in Preview</span>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>COMPOSED SYSTEM PROMPT</strong>
          </div>
          <textarea id="out" style="margin-top:5px;"></textarea>
        </div>

        <div class="card">
          <strong>PREVIEW ‚Äì SELECTED CAPSULES (DRAG TO REORDER)</strong>
          <div id="preview" style="margin-top:5px;" class="list"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Capsule modal (YAML highlighted) -->
  <div id="modal">
    <div class="modal-inner">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="m_title">Capsule</strong>
        <button class="btn small" id="m_close">Close</button>
      </div>
      <div class="row" style="margin:6px 0">
        <button class="btn small" id="m_copy_yaml">Copy YAML</button>
        <button class="btn small" id="m_copy_prov">Copy Provenance</button>
        <button class="btn small" id="m_validate">Validate Digest</button>
        <span id="m_result" class="badge">idle</span>
      </div>
      <pre><code id="m_body_code" class="language-yaml"></code></pre>
    </div>
  </div>

  <!-- LLM Command modal -->
  <div id="llmModal">
    <div class="modal-inner">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Copy LLM Command</strong>
        <div style="margin-top:-3px; font-weight:bolder;">‚ö†Ô∏è bash only - requires the awesome <a style="color:#7aa2ff"
            target="_blank" href="https://llm.datasette.io/en/stable/">llm</a> python package</div>
        <button class="btn small" id="llm_close">Close</button>
      </div>

      <div class="form-row">
        <label for="llm_template">Template:</label>
        <select id="llm_template"></select>
        <div class="hint" id="llm_template_desc"></div>
      </div>

      <div class="form-row" id="llm_input_row">
        <label for="llm_user_input">User input:</label>
        <textarea id="llm_user_input" placeholder="Enter your prompt/question here..."></textarea>
        <div class="hint" id="llm_input_hint"></div>
      </div>

      <div class="form-row" id="llm_file_row" style="display:none">
        <label for="llm_file_path">File path:</label>
        <input type="text" id="llm_file_path" placeholder="/path/to/input.txt" value="input.txt">
      </div>

      <div class="form-row">
        <label>
          <input type="checkbox" id="llm_minify">
          Minify system prompt (collapse whitespace to single line)
        </label>
        <div class="hint">Minification removes newlines and extra spaces. May affect formatting.</div>
      </div>

      <div class="form-row">
        <label for="llm_preview">Generated command:</label>
        <textarea id="llm_preview" readonly
          style="min-height:200px;font-family:monospace;font-size:12px;background:var(--bg);color:#00ff68;"></textarea>
        <div class="hint">This is what will be copied to your clipboard</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="llm_copy">üìã Copy Command</button>
        <button class="btn" id="llm_save">üíæ Save Script</button>
        <button class="btn" id="llm_cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script id="tc-data" type="application/json">{{ data_json | replace("</script>","<\\ /script>") }}</script>

    <script>
      /* ------------ Data ------------ */
      const DATA = JSON.parse(document.getElementById('tc-data').textContent);
    </script>

    <script>
      /* ------------ State & helpers ------------ */
      const STATE = { selectedBundles: new Set(), selectedCaps: new Set(), order: [], manualCaps: new Set(), profile: null, filter: "" };
      const $ = id => document.getElementById(id);
      const esc = s => (s == null ? "" : String(s).replace(/[&<>]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[m])));

      /* Toast */
      function toast(msg) {
        const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t);
        setTimeout(() => t.remove(), 1800);
      }

      /* Hashing for digest */
      const tenc = s => new TextEncoder().encode(s);
      async function sha256(s) { const buf = await crypto.subtle.digest('SHA-256', tenc(s)); return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(''); }
      function canonicalJSON(x) {
        if (Array.isArray(x)) return "[" + x.map(canonicalJSON).join(",") + "]";
        if (x && typeof x === "object") { const keys = Object.keys(x).sort(); return "{" + keys.map(k => JSON.stringify(k) + ":" + canonicalJSON(x[k])).join(",") + "}"; }
        return JSON.stringify(x);
      }
      function coreForDigest(c) {
        return {
          id: c.id, version: c.version, domain: c.domain, title: c.title, statement: c.statement,
          assumptions: Array.isArray(c.assumptions) ? c.assumptions : [],
          pedagogy: Array.isArray(c.pedagogy) ? c.pedagogy.map(p => ({ kind: p.kind, text: p.text })) : []
        };
      }
      function digestCore(c) { return canonicalJSON(coreForDigest(c)); }
      async function validateDigest(c) {
        const have = await sha256(digestCore(c));
        const want = (((c.provenance || {}).signing || {}).digest) || '';
        if (!want) return { ok: true, na: true, have, want };
        return { ok: (have === want), na: false, have, want };
      }
      function badgeDigest(c) {
        const b = document.createElement('span'); b.className = 'badge'; b.textContent = 'digest‚Ä¶';
        validateDigest(c).then(r => {
          if (r.na) { b.textContent = 'digest n/a'; b.title = 'No reference digest in capsule'; return; }
          b.textContent = r.ok ? 'digest‚úì' : 'digest‚úó'; b.className = 'badge ' + (r.ok ? 'ok' : 'err');
          b.title = r.ok ? 'Digest OK' : 'Have ' + r.have + ' want ' + r.want;
        });
        return b;
      }
      function badgeAuthor(c) {
        const p = c.provenance || {}; const b = document.createElement('span'); b.className = 'badge'; b.textContent = (p.author || '?'); return b;
      }

      function badgePosture(c) {
        const b = document.createElement('span');
        const isWitnessed = (c.posture === 'witnessed');
        b.className = 'badge' + (isWitnessed ? ' witnessed' : '');
        b.textContent = isWitnessed ? 'witnessed' : 'informational';
        const n = (typeof c._witness_count === 'number') ? c._witness_count : 0;
        b.title = isWitnessed ? `${n} witness${n === 1 ? '' : 'es'}` : 'No witnesses';
        return b;
      }


      /* ------------ Modal ------------ */
      let MODAL = null;
      function openModal(title, c) {
        MODAL = c;
        $('m_title').textContent = title;
        $('m_body_code').textContent = (c._raw || '');
        if (window.Prism && Prism.highlightElement) {
          Prism.highlightElement($('m_body_code'));
        }
        $('m_result').textContent = 'idle'; $('m_result').className = 'badge';
        $('modal').style.display = 'flex';
      }
      function closeModal() { $('modal').style.display = 'none'; MODAL = null; }
      $('m_close').addEventListener('click', closeModal);
      $('modal').addEventListener('click', e => { if (e.target && e.target.id === 'modal') closeModal(); });
      $('m_copy_yaml').addEventListener('click', () => { if (!MODAL) return; navigator.clipboard.writeText(MODAL._raw || ''); toast('YAML copied'); });
      $('m_copy_prov').addEventListener('click', () => { if (!MODAL) return; navigator.clipboard.writeText(JSON.stringify(MODAL.provenance || {}, null, 2)); toast('Provenance copied'); });
      $('m_validate').addEventListener('click', async () => { if (!MODAL) return; const r = await validateDigest(MODAL); const tag = $('m_result'); tag.textContent = r.ok ? 'digest‚úì' : 'digest‚úó'; tag.className = 'badge ' + (r.ok ? 'ok' : 'err'); tag.title = r.ok ? 'OK' : ('have:' + r.have + ' want:' + r.want); });

      /* ------------ Renderers ------------ */
      function renderProfiles() {
        const sel = $('profiles'); sel.innerHTML = '';
        const keys = Object.keys(DATA.profiles || {}).sort();
        for (const k of keys) { const p = DATA.profiles[k] || {}; const o = document.createElement('option'); o.value = k; o.textContent = (p.title || k) + ' (' + (p.version || '1.0.0') + ')'; sel.appendChild(o); }
        if (!STATE.profile) STATE.profile = keys[0] || null;
        sel.value = STATE.profile || '';
        $('profileHelp').textContent = (DATA.profiles[STATE.profile || ''] || {}).description || '';
        sel.onchange = () => { STATE.profile = sel.value; $('profileHelp').textContent = (DATA.profiles[STATE.profile] || {}).description || ''; compose(); };
      }

      function capsuleRow(c, id) {
        const item = document.createElement('div'); item.className = 'item'; item.dataset.id = id;
        const row = document.createElement('div'); row.className = 'row'; item.appendChild(row);

        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = STATE.selectedCaps.has(id);
        cb.addEventListener('change', () => {
          if (cb.checked) { STATE.selectedCaps.add(id); STATE.manualCaps.add(id); if (!STATE.order.includes(id)) STATE.order.push(id); }
          else { STATE.selectedCaps.delete(id); STATE.manualCaps.delete(id); STATE.order = STATE.order.filter(x => x !== id); }
          renderPreview(); compose();
        });
        row.appendChild(cb);

        const ttl = document.createElement('div'); ttl.textContent = (c.title || id) + '  -  ' + (c.domain || ''); row.appendChild(ttl);
        
        row.appendChild(badgeAuthor(c)); 
        row.appendChild(badgeDigest(c));
        row.appendChild(badgePosture(c));

        const btn = document.createElement('button'); btn.className = 'btn small'; btn.textContent = 'View'; btn.onclick = () => openModal(c.title || id, c);
        row.appendChild(btn);

        const small = document.createElement('div'); small.className = 'small'; small.textContent = (c.statement || ''); item.appendChild(small);
        return item;
      }

      function renderCapsules() {
        const list = $('capsules'); list.innerHTML = '';
        const f = (STATE.filter || '').toLowerCase();
        const ids = Object.keys(DATA.capsules || {}).filter(id => {
          const c = DATA.capsules[id] || {}; const hay = (id + ' ' + (c.title || '') + ' ' + (c.domain || '') + ' ' + (c.statement || '')).toLowerCase();
          return hay.includes(f);
        }).sort();
        ids.forEach(id => list.appendChild(capsuleRow(DATA.capsules[id], id)));
        $('capsulesCount').textContent = ids.length;
      }

      function renderBundles() {
        const list = $('bundles'); list.innerHTML = '';
        const keys = Object.keys(DATA.bundles || {}).sort((a, b) => (DATA.bundles[a].name || a).localeCompare(DATA.bundles[b].name || b));
        for (const k of keys) {
          const b = DATA.bundles[k] || {};
          const item = document.createElement('div'); item.className = 'item';
          const row = document.createElement('div'); row.className = 'row'; item.appendChild(row);

          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = STATE.selectedBundles.has(k);
          cb.addEventListener('change', () => {
            if (cb.checked) {
              STATE.selectedBundles.add(k);
              (b.capsules || []).forEach(cid => { STATE.selectedCaps.add(cid); if (!STATE.order.includes(cid)) STATE.order.push(cid); });
            } else {
              STATE.selectedBundles.delete(k);
              const others = [...STATE.selectedBundles];
              (b.capsules || []).forEach(cid => {
                const elsewhere = others.some(name => { const b2 = DATA.bundles[name]; return b2 && Array.isArray(b2.capsules) && b2.capsules.includes(cid); });
                const manual = STATE.manualCaps.has(cid);
                if (!elsewhere && !manual) STATE.selectedCaps.delete(cid);
                STATE.order = STATE.order.filter(x => STATE.selectedCaps.has(x));
              });
            }
            renderCapsules(); renderPreview(); compose();
          });
          row.appendChild(cb);

          const ttl = document.createElement('div'); ttl.textContent = (b.name || k); row.appendChild(ttl);

          // Add description if present
          if (b.description) {
            const desc = document.createElement('div'); desc.className = 'small'; desc.textContent = b.description; item.appendChild(desc);
          }

          list.appendChild(item);
        }
        $('bundlesCount').textContent = keys.length;
      }

      function renderPreview() {
        const list = $('preview'); list.innerHTML = '';
        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id));
        ids.forEach(id => {
          const c = DATA.capsules[id]; if (!c) return;
          const item = document.createElement('div'); item.className = 'item'; item.dataset.id = id;

          const row = document.createElement('div'); row.className = 'row'; item.appendChild(row);
          const handle = document.createElement('span'); handle.className = 'chip drag'; handle.textContent = '‚ò∞'; row.appendChild(handle);
          const ttl = document.createElement('div'); ttl.textContent = (c.title || id) + '  -  ' + (c.domain || ''); row.appendChild(ttl);
          const btn = document.createElement('button'); btn.className = 'btn small'; btn.textContent = 'View'; btn.onclick = () => openModal(c.title || id, c); row.appendChild(btn);

          list.appendChild(item);
        });

        // Sortable (drag to reorder)
        if (window.__sortable) window.__sortable.destroy();
        window.__sortable = new Sortable(list, {
          animation: 120,
          handle: '.drag',
          ghostClass: 'ghost',
          onEnd: (evt) => {
            const old = STATE.order.filter(id => STATE.selectedCaps.has(id));
            const moved = old.splice(evt.oldIndex, 1)[0];
            old.splice(evt.newIndex, 0, moved);
            STATE.order = old.concat(STATE.order.filter(x => !STATE.selectedCaps.has(x)));
            compose();
          }
        });
      }

      /* ------------ Composition ------------ */
      function parseFieldSpec(spec) { const m = spec.match(/^([a-z_.]+)(?:\[:(\d+)\])?$/); return { path: m ? m[1] : spec, limit: m && m[2] ? parseInt(m[2]) : null }; }
      function applyProjection(capsule, projection, includePedagogy) {
        const proj = projection || {}; const include = proj.include || []; const render = proj.render || {};
        const header = render.capsule_header || "BEGIN CAPSULE id={id} version={version} domain={domain}";
        const footer = render.enforcement_footer || "ENFORCEMENT: Ensure outputs satisfy this capsule; otherwise abstain and request the minimal missing info.";
        const aBullet = render.assumption_bullet || "  - {text}";
        const sBullet = render.socratic_bullet || "  - {text}";
        const aphBullet = render.aphorism_bullet || "  - {text}";
        const lines = [];

        lines.push(header.replace('{id}', capsule.id || '').replace('{version}', capsule.version || '1.0.0').replace('{domain}', capsule.domain || ''));

        for (const spec of include) {
          const { path, limit } = parseFieldSpec(spec);
          if (path === 'title') { if (capsule.title) lines.push("TITLE: " + capsule.title); }
          else if (path === 'statement') { if (capsule.statement) lines.push("STATEMENT: " + capsule.statement); }
          else if (path === 'assumptions') {
            const items = (capsule.assumptions || []).slice(0, limit || Number.MAX_SAFE_INTEGER);
            if (items.length) { lines.push("ASSUMPTIONS:"); items.forEach(a => lines.push(aBullet.replace('{text}', a))); }
          }
          else if (path === 'pedagogy.socratic' && includePedagogy) {
            const soc = (capsule.pedagogy || []).filter(p => (p.kind || '').toLowerCase() === 'socratic').slice(0, limit || Number.MAX_SAFE_INTEGER);
            if (soc.length) { lines.push("PEDAGOGY (Socratic):"); soc.forEach(p => lines.push(sBullet.replace('{text}', p.text || ''))); }
          }
          else if (path === 'pedagogy.aphorisms' && includePedagogy) {
            const aph = (capsule.pedagogy || []).filter(p => (p.kind || '').toLowerCase() === 'aphorism').slice(0, limit || Number.MAX_SAFE_INTEGER);
            if (aph.length) { lines.push("PEDAGOGY (Aphorisms):"); aph.forEach(p => lines.push(aphBullet.replace('{text}', p.text || ''))); }
          }
        }

        lines.push(footer);
        return lines.join("\n");
      }
      function composeLegacy(c, includePedagogy) {
        const lines = [];
        /* lines.push("BEGIN CAPSULE id=" + (c.id || '') + " version=" + (c.version || '1.0.0') + " domain=" + (c.domain || '')); */
        lines.push("BEGIN CAPSULE id=" + (c.id || '') + 
          " version=" + (c.version || '1.0.0') +
          " domain=" + (c.domain || '') +
          " posture=" + (c.posture || 'informational') + ")");
        if (c.statement) lines.push("STATEMENT: " + c.statement);
        if (includePedagogy && c.pedagogy) {
          const ped = c.pedagogy.map(p => (p.kind + ': ' + p.text)).join('\n');
          if (ped) lines.push('PEDAGOGY:\n' + ped);
        }
        lines.push('END CAPSULE');
        return lines.join("\n");
      }
      function compose() {
        const prof = DATA.profiles[STATE.profile || ''] || {};
        const response = prof.response || {};
        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id));
        const blocks = [];

        const policy = response.policy || 'Cite or abstain; follow Plan-Verify-Answer; ask ONE crisp follow-up if required.';
        const format = response.format || 'natural';
        const system_block = response.system_block || ("SYSTEM: Profile=" + (prof.title || 'unknown') + "\nPOLICY: " + policy + "\nFORMAT: " + format);
        blocks.push(system_block);

        blocks.push("SYSTEM: Truth Capsules Loader v1\nPURPOSE: Use curated capsules to scaffold reasoning and enforce acceptance rules.\nMETHOD:\n  1) Load capsule rules (below).\n  2) For each task, follow Plan ‚Üí Verify ‚Üí Answer.\n  3) If required fields are missing, ask ONE concise follow-up.\n  4) Cite sources or abstain. Redact PII. Validate tool JSON before calling.\n  5) Emit a JSON report when asked (see REPORT SCHEMA).\nFAILURE POLICY: If a capsule cannot be satisfied, abstain + explain what is missing.");
        blocks.push("SYSTEM: Bootstrap Discipline\n‚Ä¢ Curation is king - prefer curated fixtures/evidence; abstain when unsure.\n‚Ä¢ Show your work - reference evidence in answers.\n‚Ä¢ Make failures explicit and reversible - choose tiny experiments.");

        if (ids.length === 0) {
          blocks.push('SYSTEM: Capsule Rules (Selected)\n- (No capsules selected)');
        } else {
          blocks.push('SYSTEM: Capsule Rules (Selected)');
          const projection = response.projection || null;
          const withPed = $('includePed').checked;
          for (const id of ids) {
            const c = DATA.capsules[id]; if (!c) continue;
            blocks.push((projection && projection.include) ? applyProjection(c, projection, withPed) : composeLegacy(c, withPed));
          }
        }

        let out = blocks.join("\n\n");
        if ($('markdown').checked) out = "```\n" + out + "\n```";
        $('out').value = out;
      }

      /* ------------ Manifest + share ------------ */
      function buildManifest() { return { profile: STATE.profile, order: STATE.order.filter(id => STATE.selectedCaps.has(id)), bundles: [...STATE.selectedBundles], ts: new Date().toISOString() }; }
      function exportState() { return { profile: STATE.profile, bundles: [...STATE.selectedBundles], order: STATE.order.filter(id => STATE.selectedCaps.has(id)) }; }
      function encodeStateToUrl() {
        const s = btoa(unescape(encodeURIComponent(JSON.stringify(exportState()))));
        const url = new URL(window.location.href); url.searchParams.set('s', s); return url.toString();
      }
      function importState(obj) {
        if (!obj) return;
        const prof = obj.profile && DATA.profiles[obj.profile] ? obj.profile : (Object.keys(DATA.profiles || {})[0] || null);
        STATE.profile = prof; STATE.selectedBundles = new Set(); STATE.selectedCaps = new Set(); STATE.manualCaps = new Set(); STATE.order = [];
        (obj.bundles || []).forEach(b => { if (DATA.bundles[b]) STATE.selectedBundles.add(b); });
        STATE.selectedBundles.forEach(b => {
          const caps = (DATA.bundles[b] && DATA.bundles[b].capsules) || [];
          caps.forEach(cid => { if (DATA.capsules[cid]) { STATE.selectedCaps.add(cid); if (!STATE.order.includes(cid)) STATE.order.push(cid); } });
        });
        (obj.order || []).forEach(cid => { if (DATA.capsules[cid]) { if (!STATE.order.includes(cid)) STATE.order.push(cid); STATE.selectedCaps.add(cid); } });
        render();
      }
      function tryHydrateFromUrl() {
        const url = new URL(window.location.href); const s = url.searchParams.get('s'); if (!s) return;
        try { const json = decodeURIComponent(escape(atob(s))); importState(JSON.parse(json)); } catch (e) { console.error('bad s param', e); }
      }

      /* ------------ LLM Command Composition ------------ */
      function shQuoteLiteral(s) {
        // POSIX-safe single-quote wrapper: ' becomes '\''
        return "'" + String(s).replace(/'/g, "'\\''") + "'";
      }

      function buildSysHeredoc(promptText) {
        // Use single-quoted heredoc label to disable interpolation/globbing
        // Use TC_SYSTEM to avoid conflicts with user's shell variables
        const label = "__TC_SYSTEM__";
        return [
          `read -r -d '' TC_SYSTEM <<'${label}'`,
          promptText,
          label
        ].join("\n");
      }

      function buildInputFragment(tpl, userText, filePath) {
        const flags = (tpl.extra_flags || []).join(' ');

        if (tpl.input_mode === 'arg') {
          return {
            EXTRA_FLAGS: flags,
            INPUT_FRAGMENT: `<<< ${shQuoteLiteral(userText || "")}`
          };
        }

        if (tpl.input_mode === 'stdin') {
          return {
            EXTRA_FLAGS: flags,
            STDIN_PIPE: `printf %s ${shQuoteLiteral(userText || "")} |`,
            INPUT_FRAGMENT: ""
          };
        }

        if (tpl.input_mode === 'file') {
          return {
            EXTRA_FLAGS: flags,
            FILE_PATH: shQuoteLiteral(filePath || "input.txt"),
            INPUT_FRAGMENT: ""
          };
        }

        return { EXTRA_FLAGS: flags, INPUT_FRAGMENT: "" };
      }

      function composeLlmCommand(tpl, systemPrompt, userText, filePath, minify) {
        const sysText = minify ? systemPrompt.replace(/\s+/g, ' ').trim() : systemPrompt;
        const sysHeredoc = buildSysHeredoc(sysText);
        const frags = buildInputFragment(tpl, userText, filePath);

        // Build the command by replacing all placeholders
        let cmd = String(tpl.cmd_template || '');

        // Replace required placeholders
        cmd = cmd.replace(/\{\{SYS_HEREDOC\}\}/g, sysHeredoc);
        cmd = cmd.replace(/\{\{MODEL\}\}/g, tpl.model || '');
        cmd = cmd.replace(/\{\{INPUT_FRAGMENT\}\}/g, frags.INPUT_FRAGMENT || '');

        // Replace optional placeholders
        cmd = cmd.replace(/\{\{EXTRA_FLAGS\}\}/g, frags.EXTRA_FLAGS || '');
        cmd = cmd.replace(/\{\{STDIN_PIPE\}\}/g, frags.STDIN_PIPE || '');
        cmd = cmd.replace(/\{\{FILE_PATH\}\}/g, frags.FILE_PATH || '');

        // Clean up:
        // 1. Collapse multiple spaces into single space
        cmd = cmd.replace(/ {2,}/g, ' ');
        // 2. Remove trailing spaces on lines
        cmd = cmd.replace(/[ \t]+$/gm, '');
        // 3. Ensure final newline
        cmd = cmd.trim() + "\n";

        return cmd;
      }

      function getCurrentSystemPrompt() {
        // Get the current composed prompt, stripping markdown fences if present
        let prompt = $('out').value;
        if ($('markdown').checked) {
          // Remove leading ``` and trailing ```
          prompt = prompt.replace(/^```\n/, '').replace(/\n```$/, '');
        }
        return prompt;
      }

      function updateLlmPreview() {
        const templates = DATA.llm_templates || [];
        const selectedId = $('llm_template').value;
        const tpl = templates.find(t => t.id === selectedId);

        if (!tpl) {
          $('llm_preview').value = '';
          return;
        }

        const systemPrompt = getCurrentSystemPrompt();
        const userText = $('llm_user_input').value;
        const filePath = $('llm_file_path').value;
        const minify = $('llm_minify').checked;

        const command = composeLlmCommand(tpl, systemPrompt, userText, filePath, minify);
        $('llm_preview').value = command;
      }

      function openLlmModal() {
        const templates = DATA.llm_templates || [];

        if (templates.length === 0) {
          toast('No LLM templates found');
          return;
        }

        // Populate template selector
        const sel = $('llm_template');
        sel.innerHTML = '';
        templates.forEach(tpl => {
          const opt = document.createElement('option');
          opt.value = tpl.id;
          opt.textContent = tpl.label;
          sel.appendChild(opt);
        });

        // Restore last used template from localStorage
        const lastTemplate = localStorage.getItem('llm_last_template');
        if (lastTemplate && templates.find(t => t.id === lastTemplate)) {
          sel.value = lastTemplate;
        }

        // Update description and input mode on template change
        const updateTemplateUI = () => {
          const selectedId = sel.value;
          const tpl = templates.find(t => t.id === selectedId);
          if (!tpl) return;

          $('llm_template_desc').textContent = tpl.description || '';

          // Show/hide input fields based on input_mode
          if (tpl.input_mode === 'file') {
            $('llm_input_row').style.display = 'none';
            $('llm_file_row').style.display = 'flex';
          } else {
            $('llm_input_row').style.display = 'flex';
            $('llm_file_row').style.display = 'none';

            if (tpl.input_mode === 'stdin') {
              $('llm_input_hint').textContent = 'Will be piped to stdin';
            } else {
              $('llm_input_hint').textContent = 'Will be passed as bash here-string (<<<)';
            }
          }

          // Update preview whenever template changes
          updateLlmPreview();
        };

        sel.onchange = updateTemplateUI;

        // Update preview on input changes
        $('llm_user_input').oninput = updateLlmPreview;
        $('llm_file_path').oninput = updateLlmPreview;
        $('llm_minify').onchange = updateLlmPreview;

        updateTemplateUI();

        // Clear inputs (but preserve file path default)
        $('llm_user_input').value = '';
        $('llm_file_path').value = 'input.txt';
        $('llm_minify').checked = false;

        // Initial preview
        updateLlmPreview();

        $('llmModal').style.display = 'flex';
      }

      function closeLlmModal() {
        $('llmModal').style.display = 'none';
      }

      function copyLlmCommand() {
        const command = $('llm_preview').value;

        if (!command) {
          toast('No command to copy');
          return;
        }

        // Save the selected template to localStorage
        const selectedId = $('llm_template').value;
        if (selectedId) {
          localStorage.setItem('llm_last_template', selectedId);
        }

        navigator.clipboard.writeText(command).then(() => {
          toast('Command copied to clipboard!');
          // Don't close the modal - let user copy again or review
        }).catch(err => {
          console.error('Copy failed:', err);
          toast('Copy failed - see console');
        });
      }

      // Save the generated command as a runnable bash script
      function saveLlmScript() {
        const command = $('llm_preview').value;
        if (!command) {
          toast('No command to save');
          return;
        }

        const tplId = $('llm_template').value || 'cmd';
        const nowIso = new Date().toISOString();
        const filename = `llm_${tplId}_${nowIso.replace(/[:.]/g, '-')}.sh`;

        const header =
          `#!/usr/bin/env bash
# Generated by Truth Capsule Composer
# Template: ${tplId}
# Date: ${nowIso}
set -Eeuo pipefail
IFS=$'\\n\\t'

`;

        const blob = new Blob([header, command], { type: 'text/x-shellscript' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
        a.remove();
        toast(`Saved ${filename} (remember: chmod +x ${filename})`);
      }
      function copyLlmCommand() {
        const command = $('llm_preview').value;

        if (!command) {
          toast('No command to copy');
          return;
        }

        // Save the selected template to localStorage
        const selectedId = $('llm_template').value;
        if (selectedId) {
          localStorage.setItem('llm_last_template', selectedId);
        }

        navigator.clipboard.writeText(command).then(() => {
          toast('Command copied to clipboard!');
          // Don't close the modal - let user copy again or review
        }).catch(err => {
          console.error('Copy failed:', err);
          toast('Copy failed - see console');
        });
      }

      // Wire up LLM modal events
      $('copyLlmBtn').addEventListener('click', openLlmModal);
      $('llm_close').addEventListener('click', closeLlmModal);
      $('llm_cancel').addEventListener('click', closeLlmModal);
      $('llm_copy').addEventListener('click', copyLlmCommand);
      $('llm_save').addEventListener('click', saveLlmScript)
      $('llmModal').addEventListener('click', e => {
        if (e.target && e.target.id === 'llmModal') closeLlmModal();
      });

      /* ------------ Wire up UI ------------ */
      $('search').addEventListener('input', () => { STATE.filter = $('search').value; renderCapsules(); });
      $('clearBtn').addEventListener('click', () => { STATE.selectedBundles = new Set(); STATE.selectedCaps = new Set(); STATE.manualCaps = new Set(); STATE.order = []; render(); toast('Cleared'); });
      $('composeBtn').addEventListener('click', compose);
      $('copyBtn').addEventListener('click', () => { navigator.clipboard.writeText($('out').value); toast('Prompt copied'); });
      $('dlBtn').addEventListener('click', () => { const blob = new Blob([$('out').value], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'system_prompt.txt'; a.click(); });
      $('dlJsonBtn').addEventListener('click', () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(buildManifest(), null, 2)], { type: 'application/json' })); a.download = 'system_prompt.manifest.json'; a.click(); });
      $('shareLinkBtn').addEventListener('click', () => { const url = encodeStateToUrl(); navigator.clipboard.writeText(url).then(() => toast('Share link copied')).catch(() => { prompt('Copy link:', url); }); });
      $('loadJsonBtn').addEventListener('click', () => { const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json'; inp.onchange = async () => { const f = inp.files[0]; if (!f) return; const txt = await f.text(); importState(JSON.parse(txt)); toast('State loaded'); }; inp.click(); });
      $('validateAllBtn').addEventListener('click', async () => {
        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id)); const results = [];
        for (const id of ids) { const c = DATA.capsules[id]; if (!c) continue; const v = await validateDigest(c); results.push({ id, ok: v.ok }); }
        const ok = results.filter(r => r.ok).length; const fail = results.length - ok;
        toast(`Digests: ${ok} ok, ${fail} fail`); try { await navigator.clipboard.writeText(results.map(r => (r.ok ? '‚úì ' : '‚úó ') + r.id).join('\n')); } catch { }
      });
      $('includePed').addEventListener('change', compose);
      $('markdown').addEventListener('change', compose);

      /* Keyboard shortcuts */
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { compose(); }
        if (e.key === '/') { e.preventDefault(); $('search').focus(); }
        if (e.key === 'm') { $('markdown').checked = !$('markdown').checked; compose(); }
        if (e.key === 'p') { $('includePed').checked = !$('includePed').checked; compose(); }
      });

      function render() { renderProfiles(); renderBundles(); renderCapsules(); renderPreview(); compose(); }
      render();
      tryHydrateFromUrl();

      // Remember splits
      const mainSizes = JSON.parse(localStorage.getItem('tc_split_main') || '[30,70]');
      Split(['#left', '#right'], { sizes: mainSizes, minSize: 240, gutterSize: 8, onDragEnd: s => localStorage.setItem('tc_split_main', JSON.stringify(s)) });

      const subSizes = JSON.parse(localStorage.getItem('tc_split_sub') || '[45,55]');
      Split(['#bundlesWrap', '#capsulesWrap'], { direction: 'vertical', sizes: subSizes, minSize: [80, 120], gutterSize: 8, onDragEnd: s => localStorage.setItem('tc_split_sub', JSON.stringify(s)) });

      // Remember profile + checkboxes
      $('profiles').addEventListener('change', () => localStorage.setItem('tc_profile', $('profiles').value));
      $('includePed').addEventListener('change', () => localStorage.setItem('tc_inc_ped', $('includePed').checked ? '1' : '0'));
      $('markdown').addEventListener('change', () => localStorage.setItem('tc_md', $('markdown').checked ? '1' : '0'));

      window.addEventListener('load', () => {
        const p = localStorage.getItem('tc_profile'); if (p && DATA.profiles[p]) $('profiles').value = p;
        $('includePed').checked = localStorage.getItem('tc_inc_ped') !== '0';
        $('markdown').checked = localStorage.getItem('tc_md') === '1';
      });


    </script>
</body>

</html>