<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Truth Capsule Viewer & Prompt Composer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon"
    href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='.8%20.8%2014.4%2014.4'%3e%3cpath%20d='M10%208.99a1%201%200%2000-.695%201.717l4.004%204a1%201%200%20101.414-1.414l-4.004-4A1%201%200%200010%208.99z'%20fill='%2380b0ff'%20stroke='%235D7FDDaa'%20stroke-width='.3'/%3e%3cpath%20d='M6.508%201C3.48%201%201.002%203.474%201.002%206.5S3.48%2012%206.508%2012s5.504-2.474%205.504-5.5S9.536%201%206.508%201zm0%202a3.486%203.486%200%20013.504%203.5c0%201.944-1.556%203.5-3.504%203.5a3.488%203.488%200%2001-3.506-3.5C3.002%204.556%204.56%203%206.508%203z'%20fill='%2380b0ff'%20stroke='%235D7FDDaa'%20stroke-width='.3'/%3e%3c/svg%3e">
  <!-- THEME + LAYOUT -->
  <style>
    /* ---- Tokens (Dark default) ---- */
    :root {
      /* Surfaces */
      --bg: #0e1116;
      --panel: #151a21;
      --panel-raise: #171d24;
      /* subtle elevated */
      --panel-alt: #1a212b;
      --divider: #232a36;
      /* hairlines / separators */
      --border: #232a36;

      /* Text & accents */
      --text: #e8ecf2;
      --muted: #a6b0c2;
      --accent: #76a2ff;
      /* link/brand */
      --accent-strong: #4b86ff;
      --ok: #19e184;
      --danger: #ff6b6b;
      --warn: #ffae3a;

      /* UI */
      --chip: #1f2632;
      --chip-border: #2a3444;

      /* Controls */
      --input-bg: #0f141d;
      --btn-bg: #0f141d;
      --btn-fg: var(--text);

      /* Textareas (default, non-terminal) */
      --textarea-bg: var(--panel-alt);
      --textarea-fg: var(--text);

      /* Terminal (syscode) */
      --code-bg: #0f1117;
      --code-fg: #a9ffb8;
      --code-border: #1c2330;

      /* Shadows */
      --shadow-sm: 0 1px 0 rgba(0, 0, 0, .04);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, .22);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, .28);

      /* Motion & radii */
      --radius: 12px;
      --radius-sm: 10px;
      --transition: 140ms cubic-bezier(.2, .8, .2, 1);

      /* Scroll & gutters */
      --scroll-thumb: #2a3546;
      --scroll-track: var(--bg);
      --gutter-idle: linear-gradient(to right, transparent, rgba(255, 255, 255, .08), transparent);
      --gutter-hover: linear-gradient(to right, transparent, rgba(118, 162, 255, .35), transparent);
    }

    /* Explicit light theme: override ALL tokens */
    html[data-theme="light"] {
      color-scheme: light;

      --bg: #f6f8fc;
      --panel: #ffffff;
      --panel-raise: #ffffff;
      --panel-alt: #f4f7fd;
      --divider: #e8eef7;
      --border: #175cb7;

      --text: #0e1320;
      --muted: #5b6680;
      --accent: #265ff1;
      --accent-strong: #1f55e6;
      --ok: #19e184;
      --danger: #d83a3a;
      --warn: #d48a14;

      --chip: #eef2fb;
      --chip-border: #d8e1f1;

      --input-bg: #f1f5fb;
      --btn-bg: #c5c5c5;
      --btn-fg: var(--text);

      /* Keep terminals dark in light mode for contrast */
      --textarea-bg: #f7f9ff;
      --textarea-fg: #0e1320;

      --code-bg: #0f1117;
      --code-fg: #a9ffb8;
      --code-border: #1c2330;

      --shadow-sm: 0 1px 0 rgba(0, 0, 0, .05);
      --shadow-md: 0 8px 28px rgba(12, 26, 54, .10);
      --shadow-lg: 0 16px 52px rgba(12, 26, 54, .14);

      --scroll-thumb: #c9d4e8;
      --scroll-track: var(--bg);
      --gutter-idle: linear-gradient(to right, transparent, rgba(13, 26, 49, .10), transparent);
      --gutter-hover: linear-gradient(to right, transparent, rgba(36, 99, 235, .35), transparent);
    }

    /* Optional: make an explicit dark theme switch also work */
    html[data-theme="dark"] {
      color-scheme: dark;
      /* (No token overrides needed since :root is already dark) */
    }


    /* Follow OS if no explicit theme attribute is set */
    @media (prefers-color-scheme: light) {
      html:not([data-theme]) {
        color-scheme: light;

        --bg: #f6f8fc;
        --panel: #ffffff;
        --panel-raise: #ffffff;
        --panel-alt: #f4f7fd;
        --divider: #e8eef7;
        --border: #dde6f2;

        --text: #0e1320;
        --muted: #5b6680;
        --accent: #265ff1;
        --accent-strong: #1f55e6;

        --chip: #eef2fb;
        --chip-border: #d8e1f1;

        --input-bg: #f1f5fb;
        --btn-bg: #c5c5c5;
        --btn-fg: var(--text);

        --textarea-bg: #f7f9ff;
        --textarea-fg: #0e1320;

        /* Keep terminal dark in light mode for contrast */
        --code-bg: #0f1117;
        --code-fg: #a9ffb8;
        --code-border: #1c2330;

        --shadow-sm: 0 1px 0 rgba(0, 0, 0, .05);
        --shadow-md: 0 8px 28px rgba(12, 26, 54, .10);
        --shadow-lg: 0 16px 52px rgba(12, 26, 54, .14);

        --scroll-thumb: #c9d4e8;
        --scroll-track: var(--bg);
        --gutter-idle: linear-gradient(to right, transparent, rgba(13, 26, 49, .10), transparent);
        --gutter-hover: linear-gradient(to right, transparent, rgba(36, 99, 235, .35), transparent);
      }
    }

    /* Explicit theme overrides */
    html[data-theme="dark"] {
      color-scheme: dark;
    }

    html[data-theme="light"] {
      color-scheme: light;
    }

    /* ---------- Light theme refinement ---------- */
    html[data-theme="light"] {
      /* neutrals */
      --bg: #f8fafc;
      --panel: #ffffff;
      --panel-alt: #f7f9fc;
      /* less blue than before */
      --text: #0f172a;
      --muted: #64748b;

      /* accents & structure */
      --accent: #2563eb;
      --border: #568fe0;
      /* neutral, not saturated blue */
      --border-strong: #d6dde7;
      /* for separators/hover */
      --chip: #f5f7fb;
      --chip-border: #e4eaf4;

      --input-bg: #f9fbfe;
      --btn-bg: #ced3df;
      --btn-fg: var(--text);

      /* code stays dark in light mode */
      --code-bg: #0f1117;
      --code-fg: #c7ffcf;
      --code-border: #1d2330;

      /* rings & elevation */
      --ring: color-mix(in oklab, var(--accent), white 70%);
      --ring-strong: color-mix(in oklab, var(--accent), white 55%);
      --shadow: 0 1px 2px rgba(17, 24, 39, .05), 0 2px 12px rgba(17, 24, 39, .08);
    }

    /* vertical separator between panes */
    #left {
      border-right: 1px solid var(--border-strong);
    }

    /* cards/items: neutral frames, modern hover */
    .card,
    .item,
    .chip {
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .item:hover,
    .card:hover {
      border-color: var(--border-strong);
      box-shadow: 0 1px 2px rgba(17, 24, 39, .06), 0 8px 20px rgba(17, 24, 39, .08);
    }

    .section-title {
      color: var(--muted);
      letter-spacing: .02em;
      font-weight: 600;
    }

    /* inputs/selects */
    input[type="text"],
    select {
      background: var(--input-bg);
      border: 1px solid var(--border);
      color: var(--text);
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: var(--ring-strong);
      box-shadow: 0 0 0 3px var(--ring);
    }

    /* text areas: use .code to get dark terminal treatment */
    textarea:not(.code),
    pre:not(.code) {
      background: var(--panel-alt);
      color: var(--text);
      border-color: var(--border);
    }

    textarea.code,
    pre.code,
    .terminal {
      background: var(--code-bg);
      color: var(--code-fg);
      border-color: var(--code-border);
    }

    /* buttons */
    .btn {
      background: var(--btn-bg);
      color: var(--btn-fg);
      border: 1px solid var(--border);
    }

    .btn:hover {
      border-color: var(--ring-strong);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), white 85%);
    }

    /* chips / badges */
    .chip {
      background: var(--chip);
      border-color: var(--chip-border);
      color: var(--muted);
    }

    .badge {
      background: #eef2f8;
      color: #3b4a6b;
      border: 1px solid #d7deea;
    }

    .badge.ok {
      background: #eaf7f0;
      color: #166534;
      border-color: #cde8d9;
    }

    .badge.err {
      background: #fdecec;
      color: #7f1d1d;
      border-color: #f6b4b4;
    }

    /* softer, consistent focus across the app */
    :focus-visible {
      outline: none;
      border-color: var(--ring-strong);
      box-shadow: 0 0 0 3px var(--ring);
      border-radius: var(--radius);
    }


    /* ==============
   Base / Layout
   ============== */
    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font: 16px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial, "Noto Sans";
      letter-spacing: .01em;
    }

    /* Typographic scale */
    h1 {
      font-size: 15px;
      font-weight: 650;
      margin: 0;
      letter-spacing: .02em;
    }

    h2.section-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin: 0 0 8px;
    }

    /* Scrollbars (webkit) */
    *::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    *::-webkit-scrollbar-thumb {
      background: var(--scroll-thumb);
      border-radius: 8px;
      border: 2px solid var(--scroll-track);
    }

    *::-webkit-scrollbar-track {
      background: var(--scroll-track);
    }

    /* Smooth theme transitions */
    html,
    body,
    .card,
    .item,
    header,
    section,
    textarea,
    pre,
    input,
    select,
    .chip,
    .badge,
    details,
    .collapsible,
    #gutter,
    .gutter {
      transition: background-color var(--transition), color var(--transition), border-color var(--transition), box-shadow var(--transition);
    }

    /* Focus ring */
    :focus-visible {
      outline: 2px solid color-mix(in oklab, var(--accent), transparent 30%);
      outline-offset: 2px;
      border-radius: calc(var(--radius-sm) - 2px);
    }

    /* Header / App bar */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--panel-raise);
      border-bottom: 1px solid var(--divider);
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow-sm);
    }

    header .small {
      color: var(--muted);
    }

    /* Split layout */
    main {
      height: calc(100vh - 54px);
      position: relative;
    }

    #split {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #left,
    #right {
      overflow: hidden;
    }

    #left {
      flex: 0 0 auto;
      min-width: 280px;
      max-width: 42vw;
      display: flex;
      flex-direction: column;
      background: var(--panel);
      /* Always-visible hairline on left panel edge in case gutter collapses */
      box-shadow: inset -1px 0 0 var(--divider);
    }

    #right {
      flex: 1 1 auto;
      min-width: 0;
      overflow: auto;
      background: var(--panel-raise);
    }

    /* Visible vertical separator (Split.js gutter) */
    .gutter {
      width: 10px !important;
      cursor: col-resize;
      background: var(--gutter-idle);
    }

    .gutter:hover {
      background: var(--gutter-hover);
    }

    .gutter.gutter-vertical {
      height: 8px;
      cursor: row-resize;
      width: 100% !important;
      background: var(--gutter-idle);
    }

    .gutter.gutter-vertical:hover {
      background: linear-gradient(to bottom, transparent, rgba(118, 162, 255, .35), transparent);
    }

    /* Left panel internals */
    #leftTop {
      padding: 25px;
      border-bottom: 1px solid var(--divider);
      background: var(--panel-raise);
    }

    #leftSplit {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .section-block {
      display: flex;
      flex-direction: column;
      padding: 12px;
      min-height: 0;
      gap: 10px;
    }

    .section-title {
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    /* Lists */
    .list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: auto;
      min-height: 0;
      padding: 2px;
    }

    .item {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px;
      box-shadow: var(--shadow-sm), var(--shadow-md);
    }

    .item:hover {
      border-color: color-mix(in oklab, var(--accent), transparent 70%);
    }

    .item.is-active {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 82%);
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .small,
    .muted {
      color: var(--muted) !important;
    }

    /* Chips & badges */
    .chip {
      background: var(--chip);
      border: 1px solid var(--chip-border);
      color: var(--text);
      border-radius: 12px;
      padding: 4px 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 550;
      letter-spacing: .02em;
    }

    .chip:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent), transparent 82%);
      transform: translateY(-1px);
    }

    .chip.domain {
      background: color-mix(in oklab, var(--chip), var(--accent) 10%);
    }

    .chip.applies {
      background: color-mix(in oklab, var(--chip), var(--ok) 10%);
    }

    .badge {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      background: color-mix(in oklab, var(--chip), #000 0%);
      color: color-mix(in oklab, var(--text), #fff 0%);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: .02em;
      border: 1px solid var(--chip-border);
    }

    .badge.ok {
      background: var(--ok);
      color: #000;
    }

    .badge.err {
      background: color-mix(in oklab, var(--danger), #000 70%);
      color: #ffe0e0;
      border-color: #4a1b1b;
    }

    .badge.witnessed {
      background: var(--warn);
      color: #fff4dd;
    }

    /* Cards */
    section {
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 14px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow-sm), var(--shadow-md);
    }

    /* Buttons */
    .btn {
      padding: 7px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--btn-bg);
      color: var(--btn-fg);
      cursor: pointer;
      font-weight: 600;
      letter-spacing: .02em;
      box-shadow: var(--shadow-sm);
    }

    .btn.small {
      font-size: 13px;
      padding: 4px 9px;
      border-radius: 9px;
    }

    .btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 85%);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.primary {
      background: color-mix(in oklab, var(--accent), #000 80%);
      border-color: var(--accent);
    }

    .btn.warn {
      background: color-mix(in oklab, var(--danger), #571d1d 80%);
      color: #ffdcdc;
    }

    /* Inputs */
    select,
    input[type="text"] {
      background: var(--input-bg);
      border: 2px solid #444;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 14px;
    }

    input[type="checkbox"] {
      accent-color: var(--accent);
    }

    /* Textareas & pre */
    textarea,
    pre {
      width: 100%;
      min-height: 240px;
      background: var(--textarea-bg);
      color: var(--textarea-fg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 15.5px;
      line-height: 1.55;
      tab-size: 2;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Terminal-style (prompt + LLM output) */
    .syscode {
      background: var(--code-bg) !important;
      color: var(--code-fg) !important;
      border: 1px solid var(--code-border) !important;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .02);
      caret-color: var(--code-fg);
    }

    .syscode::selection {
      background: rgba(122, 162, 255, .25);
    }

    textarea.syscode {
      min-height: 240px;
      resize: vertical;
      white-space: pre;
      overflow: auto;
    }

    /* Details / collapsibles */
    details.domain-group {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
      box-shadow: var(--shadow-sm);
      padding: 6px 6px 8px;
    }

    details.domain-group+details.domain-group {
      margin-top: 8px;
    }

    details.domain-group>summary {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--panel-raise);
      border: 1px solid var(--border);
    }

    details.domain-group>summary::-webkit-details-marker {
      display: none;
    }

    .domain-title {
      font-weight: 700;
      letter-spacing: .02em;
    }

    .domain-spacer {
      flex: 1;
    }

    .domain-body {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Collapsible content blocks (panels) */
    details.panel-collapsible {
      display: flex;
      flex-direction: column;
      min-height: 0;
      max-height: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
      box-shadow: var(--shadow-sm);
    }

    details.panel-collapsible>summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
      padding: 10px 12px;
      border-bottom: 1px solid var(--divider);
      border-radius: 10px;
      background: var(--panel-raise);
      font-weight: 650;
    }

    details.panel-collapsible>summary::-webkit-details-marker {
      display: none;
    }

    details.panel-collapsible>.list {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 8px;
    }

    /* Bundles wrap variants */
    #bundlesWrap details.panel-collapsible {
      flex: 1 1 0;
    }

    #bundlesWrap details.panel-collapsible>summary {
      flex: 0 0 auto;
    }

    #bundlesWrap details.panel-collapsible>.list {
      flex: 1 1 0;
    }

    /* Non-<details> collapsible */
    #bundlesWrap .collapsible {
      display: flex;
      flex-direction: column;
      flex: 1 1 0;
      min-height: 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
      box-shadow: var(--shadow-sm);
    }

    #bundlesWrap .collapsible-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--panel-raise);
      border-bottom: 1px solid var(--divider);
      border-radius: 10px 10px 0 0;
      font-weight: 650;
    }

    #bundlesWrap .collapsible-body {
      display: flex;
      flex-direction: column;
      flex: 1 1 0;
      min-height: 0;
      border-radius: 0 0 10px 10px;
    }

    #bundlesWrap .collapsible-body[hidden] {
      display: none;
    }

    #bundlesWrap #bundles.list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 8px;
    }

    /* Utility */
    .clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Modal */
    #modal,
    #llmModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .48);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(2px);
    }

    #modal .modal-inner,
    #llmModal .modal-inner {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 900px;
      width: 92%;
      max-height: 80vh;
      overflow: auto;
      padding: 14px;
      box-shadow: var(--shadow-lg);
    }

    #llmModal .form-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
    }

    #llmModal label {
      font-weight: 600;
      font-size: 12px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    #llmModal textarea {
      min-height: 120px;
    }

    #llmModal .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--panel-raise);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      z-index: 99;
      box-shadow: var(--shadow-md);
    }

    /* Hover affordances */
    .item:hover,
    .chip:hover,
    .btn:hover,
    details.panel-collapsible>summary:hover {
      transform: translateY(-1px);
    }

    /* Normalize radii on interactive blocks */
    .item,
    .chip,
    .badge,
    .btn,
    .card,
    pre,
    textarea {
      border-radius: var(--radius);
    }


    .label-with-help {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .icon-btn {
      border: 1px solid var(--border);
      background: var(--btn-bg);
      color: var(--text);
      width: 28px;
      height: 28px;
      line-height: 26px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
    }

    .icon-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 85%)
    }

    #profileHelp .muted {
      color: var(--muted)
    }

    #profileDesc {
      margin-left: .5ch
    }

    .help-box {
      margin-top: 6px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 10px;
    }

    .help-box>summary {
      list-style: none;
      cursor: pointer;
      font-weight: 600;
      color: var(--muted);
      margin: -2px 0 4px 0;
    }

    .help-box[open]>summary {
      margin-bottom: 6px;
    }

    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--btn-bg);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      line-height: 1;
      padding: 0;
    }

    .icon-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 85%);
    }

    .help-box {
      margin-top: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
    }

    .help-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .muted {
      color: var(--muted);
    }

    /* Layout */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toolbar .title-wrap {
      display: flex;
      flex-direction: column;
      padding-left: 30px;
    }

    .toolbar-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-right: 30px;
    }

    /* Groups = compact button clusters */
    .group {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px;
      /* border: 1px solid var(--border, #3a3f55); */
      border-radius: 10px;
      background: var(--panel, rgba(127, 127, 127, 0.08));
    }

    /* Icon-sized buttons */
    .btn.icon {
      padding: 6px 8px;
      min-width: auto;
    }

    /* Dropdown menu built from <details> */
    .menu {
      position: relative;
    }

    .menu>summary {
      list-style: none;
      cursor: pointer;
    }

    .menu>summary::-webkit-details-marker {
      display: none;
    }

    .menu[open] .menu-list {
      display: block;
    }

    .menu-list {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 6px;
      padding: 6px;
      background: var(--bgElevated, var(--bg));
      border: 1px solid var(--border, #3a3f55);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      z-index: 1000;
      min-width: 220px;
    }

    .menu-item {
      display: block;
      width: 100%;
      padding: 8px 10px;
      text-align: left;
      background: none;
      border: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
    }

    .menu-item:hover {
      background: rgba(127, 127, 127, 0.12);
      border-radius: 8px;
    }

    .menu-item.warn {
      color: var(--danger, #e06c75);
    }

    .menu-field {
      padding: 4px 6px 8px;
    }

    .menu-row {
      display: flex;
      gap: 6px;
      padding: 4px 6px;
    }

    .menu-sep {
      border: 0;
      height: 1px;
      margin: 6px 0;
      background: linear-gradient(to right, transparent, var(--border, #3a3f55), transparent);
    }

    /* Small muted label */
    .small.muted {
      opacity: 0.7;
      font-size: 12px;
    }

    /* === Modern ghost pills (borderless groups) === */
    :root {
      --btn-h: 30px;
      --btn-r: 12px;
      --hairline: color-mix(in oklab, var(--border), transparent 35%);
      --hover: color-mix(in oklab, var(--accent), transparent 88%);
      --press: color-mix(in oklab, var(--accent), transparent 70%);
    }

    .toolbar {
      gap: 10px;
      padding: 6px 0;
    }

    .toolbar-actions {
      gap: 8px;
    }

    /* No chrome around clusters */
    .group {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0;
      border: 0;
      background: transparent;
      border-radius: 0;
    }

    /* kill any old highlight rings */
    .group:has(.menu[open]) {
      box-shadow: none;
    }

    /* Pills */
    .btn {
      -webkit-appearance: none;
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: var(--btn-h);
      padding: 0 12px;
      border-radius: var(--btn-r);
      border: 1px solid var(--hairline);
      /* hairline, not heavy */
      background: color-mix(in oklab, var(--btn-bg), transparent 10%);
      color: var(--text);
      font-weight: 600;
      line-height: 1;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease,
        box-shadow .15s ease, transform .04s ease;
    }

    .btn:hover {
      background: var(--hover);
      border-color: color-mix(in oklab, var(--border), var(--accent) 40%);
      box-shadow: 0 2px 10px rgba(0, 0, 0, .12);
    }

    .btn:active {
      background: var(--press);
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(0, 0, 0, .18) inset;
    }

    /* Subtle, accessible focus */
    .btn:focus {
      outline: none;
    }

    .btn:focus-visible {
      outline: 2px solid color-mix(in oklab, var(--accent), transparent 60%);
      outline-offset: 2px;
      box-shadow: none;
    }

    /* Icon-only = circular ghost */
    .btn.icon {
      width: var(--btn-h);
      min-width: var(--btn-h);
      padding: 0;
      border-radius: 999px;
    }

    /* Caution tone stays ghost (no filled red blob) */
    .btn.warn {
      color: var(--danger, #e06c75);
      background: color-mix(in oklab, var(--btn-bg), transparent 6%);
      border-color: color-mix(in oklab, var(--danger, #e06c75), var(--border) 75%);
    }

    /* Details/summary dropdown matches pills */
    .menu {
      position: relative;
    }

    .menu>summary {
      list-style: none;
      cursor: pointer;
    }

    .menu>summary::-webkit-details-marker {
      display: none;
    }

    /* Panel */
    .menu[open] .menu-list {
      display: block;
    }

    .menu-list {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      padding: 8px;
      background: var(--bgElevated, var(--bg));
      border: 1px solid var(--hairline);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      z-index: 1000;
    }

    .menu-item {
      display: block;
      width: 100%;
      padding: 8px 10px;
      text-align: left;
      background: none;
      border: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
      border-radius: 8px;
    }

    .menu-item:hover {
      background: color-mix(in oklab, var(--panel), var(--text) 4%);
    }

    .menu-item.warn {
      color: var(--danger, #e06c75);
    }

    .menu-field {
      padding: 6px 6px 8px;
    }

    .menu-row {
      display: flex;
      gap: 6px;
      padding: 4px 6px;
    }

    .menu-row .menu-item {
      flex: 1;
      text-align: center;
    }

    .menu-sep {
      border: 0;
      height: 1px;
      margin: 6px 0;
      background: linear-gradient(to right, transparent, var(--hairline), transparent);
    }

    /* Tiny screen tweak */
    @media (max-width: 900px) {
      :root {
        --btn-h: 28px;
      }
    }

    /* Make section headers clickable for collapse */
    .section-block.collapsible .section-title { cursor: pointer; user-select: none; }

    /* Keep a small visual gap when the previous collapsible is closed */
    .section-block.collapsible.is-collapsed + .section-block { margin-top: 8px; }

    /* When we decide to hide the Split.js gutter */
    .gutter.gutter-vertical.is-hidden { display: none !important; }

    /* 1) keep a small gap under the collapsed BUNDLES header */
    .panel-collapsible { margin-bottom: 8px; }

    /* 2) make the header sit above the Split.js gutter */
    .panel-collapsible > summary.section-title { position: relative; z-index: 3; }

    /* keep Split.js handle behind headers */
    .gutter { z-index: 1 !important; }
    .section-title { position: relative; z-index: 2; background: var(--surface); }

    /* optional: add a touch of breathing room when a <details> is closed */
    .panel-collapsible:not([open]) { margin-bottom: 8px; }

    .modal[hidden] { display: none; }
    .modal {
      position: fixed; inset: 0; display: grid; place-items: center;
      z-index: 1000; /* sits above Split.js gutter */
    }
    .modal-backdrop {
      position: absolute; inset: 0;
      background: color-mix(in oklab, var(--surface, #000), transparent 30%);
      backdrop-filter: blur(2px);
    }
    .modal-card {
      position: relative; max-width: 720px; width: min(96vw, 720px);
      background: var(--panel); color: var(--text);
      border: 1px solid var(--border); border-radius: var(--radius);
      box-shadow: 0 10px 40px rgba(0,0,0,.5);
    }
    .modal-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px; border-bottom: 1px solid var(--hairline, var(--border));
    }
    .modal-body { padding: 14px 16px; }
    .modal-body h4 { margin: 12px 0 6px; font-size: 14px; opacity: .9; }
    .modal-body ul { margin: 0 0 10px 18px; }

  </style>




  <!-- Prism / Split / Sortable -->
  {% if inline_cdn %}
  <!-- digests (supply-chain breadcrumbs) -->
  <!-- prism_css: sha256={{ digests['prism_css'] }} -->
  <!-- prism_core: sha256={{ digests['prism_core'] }} -->
  <!-- prism_yaml: sha256={{ digests['prism_yaml'] }} -->
  <!-- prism_json: sha256={{ digests['prism_json'] }} -->
  <!-- split_js: sha256={{ digests['split_js'] }} -->
  <!-- sortable_js: sha256={{ digests['sortable_js'] }} -->

  <style>{{prism_css_inline | safe}}</style>

  <script>{{prism_core_inline | safe}}</script>
  <script>{{prism_yaml_inline | safe}}</script>
  <script>{{prism_json_inline | safe}}</script>
  <script>{{split_js_inline | safe}}</script>
  <script>{{sortable_js_inline | safe}}</script>
  {% else %}
  <!-- CDN fallback (deterministic, pinned) -->
  <link rel="stylesheet" href="{{ cdn_urls['prism_css'] }}">
  <script src="{{ cdn_urls['prism_core'] }}"></script>
  <script src="{{ cdn_urls['prism_yaml'] }}"></script>
  <script src="{{ cdn_urls['prism_json'] }}"></script>
  <script src="{{ cdn_urls['split_js'] }}"></script>
  <script src="{{ cdn_urls['sortable_js'] }}"></script>
  {% endif %}

</head>

<body>
  <header class="toolbar">
    <div class="title-wrap">
      <h1>Truth Capsule Viewer & Prompt Composer</h1>
      <div class="small" style="font-size:12px;margin-top:4px;">Generated {{ generated_at }}</div>
    </div>

    <nav class="toolbar-actions">

      <!-- Group 1: Prompt (primary = Copy; extras in dropdown) -->
      <div class="group">
        <button style="display:none;" class="btn" id="composeBtn" title="Compose (Ctrl/Cmd+Enter)">üü¢ Compose</button>
        <button class="btn" id="copyBtn" title="Copy prompt">üìã Copy</button>
        <details class="menu">
          <summary class="btn icon" title="More prompt actions">‚ñæ</summary>
          <div class="menu-list">
            <button class="menu-item" id="dlBtn" title="Download prompt">‚¨áÔ∏è Download Prompt</button>
            <button class="menu-item" id="copyLlmBtn" title="Copy LLM command">üíª Copy LLM Bash</button>
            <button class="menu-item" id="shareLinkBtn" title="Copy shareable link">üîó Share Deeplink</button>
          </div>
        </details>
      </div>

      <!-- Group 2: Manifests (primary = Save; dropdown holds Select, Load, Delete, JSON I/O) -->
      <div class="group">
        <button class="btn" id="manifestSaveBtn" title="Save manifest to this browser">üíæ Save</button>
        <details class="menu">
          <summary class="btn icon" title="More manifest actions">‚ñæ</summary>
          <div class="menu-list" style="min-width:280px">
            <div class="menu-field">
              <label class="small muted" for="manifestSelect" style="display:block;margin-bottom:4px;">Saved
                manifests</label>
              <select id="manifestSelect" title="Saved manifests" style="width:100%"></select>
            </div>
            <div class="menu-row">
              <button class="menu-item" id="manifestLoadBtn" title="Load selected manifest">üìÇ Load</button>
              <button class="menu-item warn" id="manifestDeleteBtn" title="Delete selected manifest">üóëÔ∏è Delete</button>
            </div>
            <hr class="menu-sep">
            <button class="menu-item" id="dlJsonBtn" title="Download manifest JSON">‚¨áÔ∏è Download JSON Manifest</button>
            <button class="menu-item" id="loadJsonBtn" title="Load manifest JSON">‚¨ÜÔ∏è Load JSON Manifest</button>
          </div>
        </details>
      </div>

      <!-- Group 3: Tools (quick actions) -->
      <div class="group">
        <button class="btn icon" id="validateAllBtn" title="Validate digests for selected">üîê</button>
        <button class="btn icon warn" id="clearBtn" title="Clear selection">üßπ</button>
      </div>

      <!-- Theme -->
      <button class="btn icon" id="themeBtn" title="Toggle theme" aria-label="Toggle color theme">üåô</button>
      <button class="icon-btn" id="helpBtn" title="Help & Shortcuts">‚ùì</button>
    </nav>
  </header>


  <main>
    <div id="split">
      <!-- LEFT COLUMN -->
      <aside id="left">
        <div id="leftTop">

          <div class="row" style="margin-top:10px; align-items:center; gap:8px">
            <label for="profiles" class="section-title">PROFILES</label>
            <button id="profileInfo" class="icon-btn" type="button" aria-haspopup="dialog" aria-expanded="false"
              title="What are Profiles?">?</button>
            <select id="profiles"></select>
            <button id="profileView" class="btn small" type="button" title="View profile YAML">View</button>
          </div>

          <div id="profileDesc" class="small" style="margin-top:4px"></div>

          <div id="profileHelp" class="help-box" hidden>
            <div class="help-title">What are Profiles?</div>
            <p class="small">
              Profiles are presets for a specific use-case (e.g., CI Judge, Code Patch, PR Review).
              A profile sets the basic <em>system prompt</em> and which <em>capsule properties/policies</em> are applied
              (visible).
              Switching profiles does not modify your capsule library; it only changes the composed rules for this run.
            </p>
          </div>

        </div>

        <!-- RESIZABLE HORIZONTAL SPLIT: Bundles ‚ü∑ Capsules -->
        <div id="leftSplit">
          <div id="bundlesWrap" class="section-block">
            <div id="bundlesPanel" class="collapsible">
              <div class="collapsible-header">
                <span class="section-title">BUNDLES (<span id="bundlesCount">0</span>)</span><span class="small muted"> a collection of capsules</span>
                <span class="domain-spacer"></span>
                <!-- <button id="bundlesToggle" class="btn small" type="button" aria-expanded="true">Hide</button> -->
              </div>
              <div id="bundlesBody" class="collapsible-body">
                <div id="bundles" class="list"></div>
              </div>
            </div>
          </div>

          <div id="capsulesWrap" class="section-block">
            <div style="padding-left:12px; padding-right:12px;" class="section-title">
              CAPSULES (<span id="capsulesCount">0</span>)
              <span style="float:right; display:flex; gap:6px;">
                <button class="btn small" id="expandAllBtn">Expand all</button>
                <button class="btn small" id="collapseAllBtn">Collapse all</button>
              </span>
            </div>
            <input id="search" type="text" placeholder="Filter loaded capsules by id/title/domain/statement‚Ä¶"
              style="margin-left: 12px; max-width:432px; width:100%">
            <div id="capsules" class="list"></div>
          </div>
        </div>
      </aside>

      <!-- RIGHT COLUMN -->
      <section id="right">
        <div class="card">
          <div class="row">
            <label style="display:none;"><input type="checkbox" id="includePed" checked> include pedagogy</label>
            <label><input type="checkbox" id="markdown"> markdown preview</label>
            <!-- <span class="small">Drag to reorder in Preview</span> -->
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>COMPOSED SYSTEM PROMPT</strong>
          </div>
          <textarea id="out" style="margin-top:5px;"></textarea>
        </div>

        <div class="card">
          <strong>PREVIEW ‚Äì SELECTED CAPSULES</strong> (DRAG TO REORDER)
          <div id="preview" style="margin-top:5px;" class="list"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Capsule modal (YAML highlighted) -->
  <div id="modal">
    <div class="modal-inner">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="m_title">Capsule</strong>
        <button class="btn small" id="m_close">Close</button>
      </div>
      <div class="row" style="margin:6px 0">
        <button class="btn small" id="m_copy_yaml">Copy YAML</button>
        <button class="btn small" id="m_copy_prov">Copy Provenance</button>
        <button class="btn small" id="m_validate">Validate Digest</button>
        <span id="m_result" class="badge">idle</span>
      </div>
      <pre><code id="m_body_code" class="language-yaml"></code></pre>
    </div>
  </div>

  <!-- LLM Command modal -->
  <div id="llmModal">
    <div class="modal-inner">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Copy LLM Command</strong>
        <div style="margin-top:-3px; font-weight:bolder;">‚ö†Ô∏è bash only - requires the awesome <a style="color:#7aa2ff"
            target="_blank" href="https://llm.datasette.io/en/stable/">llm</a> python package</div>
        <button class="btn small" id="llm_close">Close</button>
      </div>

      <div class="form-row">
        <label for="llm_template">Template:</label>
        <select id="llm_template"></select>
        <div class="hint" id="llm_template_desc"></div>
      </div>

      <div class="form-row" id="llm_input_row">
        <label for="llm_user_input">User input:</label>
        <textarea id="llm_user_input" placeholder="Enter your prompt/question here..."></textarea>
        <div class="hint" id="llm_input_hint"></div>
      </div>

      <div class="form-row" id="llm_file_row" style="display:none">
        <label for="llm_file_path">File path:</label>
        <input type="text" id="llm_file_path" placeholder="/path/to/input.txt" value="input.txt">
      </div>

      <div class="form-row">
        <label>
          <input type="checkbox" id="llm_minify">
          Minify system prompt (collapse whitespace to single line)
        </label>
        <div class="hint">Minification removes newlines and extra spaces. May affect formatting.</div>
      </div>

      <div class="form-row">
        <label for="llm_preview">Generated shell command: (‚ö†Ô∏è <u>always sanity check what you execute in your
            shell!</u>)</label>
        <textarea id="llm_preview" readonly
          style="min-height:200px;font-family:monospace;font-size:12px;background:var(--bg);color:var(--text)"></textarea>
        <div class="hint">This is what will be copied to your clipboard</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="llm_copy">üìã Copy Command</button>
        <button class="btn" id="llm_save">üíæ Save Script</button>
        <button class="btn" id="llm_cancel">Cancel</button>
      </div>
    </div>
  </div>

<div id="helpModal" class="modal" hidden aria-hidden="true">
  <div class="modal-backdrop" data-close></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <header class="modal-head">
      <h3 id="helpTitle">How to use this Viewer & Composer</h3>
      <button class="icon-btn" title="Close" data-close aria-label="Close">‚úï</button>
    </header>

    <div class="modal-body">
      <h4>Profiles</h4>
      <ul>
        <li>Pick a <em>Profile</em> to control how capsules are projected (what fields render, CI vs conversational tone).</li>
        <li>The description under the dropdown explains what that profile does.</li>
      </ul>

      <h4>Bundles</h4>
      <ul>
        <li>Use the BUNDLES section to load an ordered kit of capsules.</li>
        <li>Click a bundle‚Äôs checkbox to include/exclude it; expand to see contents.</li>
      </ul>

      <h4>Capsules</h4>
      <ul>
        <li>Filter with the search box (id, title, domain, statement).</li>
        <li>Open a domain group and tick individual capsules. ‚ÄúView‚Äù previews details.</li>
        <li>Use <strong>Expand all</strong> / <strong>Collapse all</strong> for all domains.</li>
      </ul>

      <h4>Compose & Export</h4>
      <ul>
        <li><strong>Compose</strong> builds the prompt from selected capsules (profile-aware).</li>
        <li><strong>Copy Prompt</strong> copies the current projection to the clipboard.</li>
      </ul>

      <h4>Shortcuts</h4>
      <ul>
        <li><kbd>?</kbd> (or <kbd>Shift</kbd>+<kbd>/</kbd>) ‚Äî Open Help</li>
        <li><kbd>/</kbd> ‚Äî Focus filter</li>
        <li><kbd>Ctrl</kbd>/<kbd>Cmd</kbd>+<kbd>Enter</kbd> ‚Äî Compose</li>
        <li><kbd>E</kbd> ‚Äî Expand all domains</li>
        <li><kbd>C</kbd> ‚Äî Collapse all domains</li>
        <li><kbd>Esc</kbd> ‚Äî Close modals</li>
      </ul>
    </div>
  </div>
</div>


  <script id="tc-data" type="application/json">{{ data_json | replace("</script>","<\\ /script>") }}</script>

    <script>
      /* ------------ Data ------------ */
      const DATA = JSON.parse(document.getElementById('tc-data').textContent);



      // Derive posture/witness_count if missing; keep raw yaml if provided upstream
      (function hydrateCapsules() {
        const caps = DATA.capsules || {};
        for (const [id, c] of Object.entries(caps)) {
          c._id = id;
          c._witness_count = Array.isArray(c.witnesses) ? c.witnesses.length : (c._witness_count || 0);
          if (!c.posture) c.posture = c._witness_count > 0 ? 'witnessed' : 'informational';
          // keep any existing c._raw for modal; nothing to do if not present
        }
      })();

    </script>

    <script>
      /* ------------ State & helpers ------------ */
      const STATE = { selectedBundles: new Set(), selectedCaps: new Set(), order: [], manualCaps: new Set(), profile: null, filter: "" };
      const $ = id => document.getElementById(id);
      const esc = s => (s == null ? "" : String(s).replace(/[&<>]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[m])));



      // ---- Theme Controller ----
      (function themeController() {
        const STORAGE_KEY = 'tc_theme'; // 'light' | 'dark'
        const root = document.documentElement;

        function apply(theme) {
          if (theme === 'light') {
            root.setAttribute('data-theme', 'light');
            $('themeBtn').textContent = '‚òÄÔ∏è';
            $('themeBtn').setAttribute('aria-label', 'Switch to dark mode');
          } else {
            root.setAttribute('data-theme', 'dark');
            $('themeBtn').textContent = 'üåô';
            $('themeBtn').setAttribute('aria-label', 'Switch to light mode');
          }
        }

        // initial theme: saved ‚Üí system ‚Üí dark fallback
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved === 'light' || saved === 'dark') {
          apply(saved);
        } else {
          const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          apply(systemDark ? 'dark' : 'light');
        }

        // respond to future system changes if user hasn't chosen
        const mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        if (!saved && mql && mql.addEventListener) {
          mql.addEventListener('change', e => apply(e.matches ? 'dark' : 'light'));
        }

        // wire up button
        window.addEventListener('DOMContentLoaded', () => {
          const btn = document.getElementById('themeBtn');
          if (!btn) return;
          btn.addEventListener('click', () => {
            const next = (root.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
            localStorage.setItem(STORAGE_KEY, next);
            apply(next);
          });
        });
      })();

      // persist domain open/closed state across renders + reloads
      STATE.domainOpen = JSON.parse(localStorage.getItem('tc_domain_open') || '{}');
      const DOMAIN_DEFAULT_OPEN = false; // first render behavior

      function setDomainOpen(domain, open) {
        const key = String(domain || 'misc').toLowerCase();
        STATE.domainOpen[key] = !!open;
        localStorage.setItem('tc_domain_open', JSON.stringify(STATE.domainOpen));
      }

      function getDomainOpen(domain) {
        const key = String(domain || 'misc').toLowerCase();
        return Object.prototype.hasOwnProperty.call(STATE.domainOpen, key)
          ? !!STATE.domainOpen[key]
          : DOMAIN_DEFAULT_OPEN;
      }

      // Bundles panel open/closed state
      // Bundles open/closed state
      STATE.bundlesOpen = (localStorage.getItem('tc_bundles_open') !== '0'); // default open

      function setBundlesOpen(open) {
        STATE.bundlesOpen = !!open;
        localStorage.setItem('tc_bundles_open', STATE.bundlesOpen ? '1' : '0');
        const body = document.getElementById('bundlesBody');
        const btn = document.getElementById('bundlesToggle');
        if (!body || !btn) return;
        if (STATE.bundlesOpen) {
          body.hidden = false;
          btn.textContent = 'Hide';
          btn.setAttribute('aria-expanded', 'true');
          // restore previous height if we have it, else whatever Split already has
          const last = Number(localStorage.getItem('tc_bundles_height') || '45');
          if (window.__subsplit) {
            const sizes = window.__subsplit.getSizes();
            const target = isFinite(last) ? last : sizes[0];
            const other = 100 - target;
            window.__subsplit.setSizes([target, other]);
            localStorage.setItem('tc_split_sub', JSON.stringify([target, other]));
            }
        } else {
          body.hidden = true;
          btn.textContent = 'Show';
          btn.setAttribute('aria-expanded', 'false');
          // remember current height, then collapse
          if (window.__subsplit) {
            const sizes = window.__subsplit.getSizes();   // [bundles%, capsules%]
            localStorage.setItem('tc_bundles_height', String(sizes[0])); // remember bundles height
            window.__subsplit.setSizes([0, 100]);
            localStorage.setItem('tc_split_sub', JSON.stringify([0, 100]));
            }          
        }
      }

      const header = document.querySelector('#bundlesPanel .collapsible-header');
      if (header) {
        header.addEventListener('click', (e) => {
          // don‚Äôt double-handle if the explicit Hide/Show button was clicked
          if (e.target.closest('#bundlesToggle')) return;
          setBundlesOpen(!STATE.bundlesOpen);
        });
      }


      function initBundlesCollapsibleSimple() {
        const btn = document.getElementById('bundlesToggle');
        if (!btn) return;
        setBundlesOpen(STATE.bundlesOpen);      // apply initial state
        btn.onclick = () => setBundlesOpen(!STATE.bundlesOpen);
      }


      /* Toast */
      function toast(msg) {
        const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t);
        setTimeout(() => t.remove(), 1800);
      }

      function initBundlesCollapsible() {
        const d = $('bundlesSection');
        if (!d) return;
        d.open = getBundlesOpen();
        d.addEventListener('toggle', () => setBundlesOpen(d.open));
      }

      /* Hashing for digest */
      const tenc = s => new TextEncoder().encode(s);
      async function sha256(s) { const buf = await crypto.subtle.digest('SHA-256', tenc(s)); return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(''); }
      function canonicalJSON(x) {
        if (Array.isArray(x)) return "[" + x.map(canonicalJSON).join(",") + "]";
        if (x && typeof x === "object") { const keys = Object.keys(x).sort(); return "{" + keys.map(k => JSON.stringify(k) + ":" + canonicalJSON(x[k])).join(",") + "}"; }
        return JSON.stringify(x);
      }
      function coreForDigest(c) {
        return {
          id: c.id, version: c.version, domain: c.domain, title: c.title, statement: c.statement,
          assumptions: Array.isArray(c.assumptions) ? c.assumptions : [],
          pedagogy: Array.isArray(c.pedagogy) ? c.pedagogy.map(p => ({ kind: p.kind, text: p.text })) : []
        };
      }
      function digestCore(c) { return canonicalJSON(coreForDigest(c)); }
      async function validateDigest(c) {
        const have = await sha256(digestCore(c));
        const want = (((c.provenance || {}).signing || {}).digest) || '';
        if (!want) return { ok: true, na: true, have, want };
        return { ok: (have === want), na: false, have, want };
      }
      function badgeDigest(c) {
        const b = document.createElement('span'); b.className = 'badge'; b.textContent = 'digest‚Ä¶';
        validateDigest(c).then(r => {
          if (r.na) { b.textContent = 'digest n/a'; b.title = 'No reference digest in capsule'; return; }
          b.textContent = r.ok ? 'digest‚úì' : 'digest‚úó'; b.className = 'badge ' + (r.ok ? 'ok' : 'err');
          b.title = r.ok ? 'Digest OK' : 'Have ' + r.have + ' want ' + r.want;
        });
        return b;
      }
      function badgeAuthor(c) {
        const p = c.provenance || {}; const b = document.createElement('span'); b.className = 'badge'; b.textContent = (p.author || '?'); return b;
      }

      function badgePosture(c) {
        const b = document.createElement('span');
        const isWitnessed = (c.posture === 'witnessed');
        b.className = 'badge' + (isWitnessed ? ' witnessed' : '');
        b.textContent = isWitnessed ? 'witnessed' : 'informational';
        const n = (typeof c._witness_count === 'number') ? c._witness_count : 0;
        b.title = isWitnessed ? `${n} witness${n === 1 ? '' : 'es'}` : 'No witnesses';
        return b;
      }


      /* ------------ Modal (upgraded: capsules + profiles + bundles) ------------ */
      let MODAL_CTX = null;
      // kind ‚àà {'capsule','profile','bundle'}
      // data = the object (capsule/profile/bundle)
      // raw  = preferred text to show (YAML if available; JSON pretty as fallback)
      function openModal(title, data, { kind = 'capsule' } = {}) {
        // Prefer YAML when provided as _raw; else pretty JSON
        let raw = (data && data._raw) ? String(data._raw) : null;
        let lang = 'yaml';
        if (!raw) {
          raw = JSON.stringify(data || {}, null, 2);
          lang = 'json';
        }

        MODAL_CTX = { kind, data, raw };

        $('m_title').textContent = title || (kind === 'bundle' ? 'Bundle' : kind === 'profile' ? 'Profile' : 'Capsule');

        // Toggle controls based on kind
        const showProv = (kind === 'capsule');
        const showValidate = (kind === 'capsule');
        $('m_copy_prov').style.display = showProv ? '' : 'none';
        $('m_validate').style.display = showValidate ? '' : 'none';

        // Set code block + highlight
        const code = $('m_body_code');
        code.className = 'language-' + lang;
        code.textContent = raw;
        if (window.Prism && Prism.highlightElement) Prism.highlightElement(code);

        $('m_result').textContent = 'idle';
        $('m_result').className = 'badge';
        $('modal').style.display = 'flex';
      }

      function closeModal() { $('modal').style.display = 'none'; MODAL_CTX = null; }

      $('m_close').addEventListener('click', closeModal);
      $('modal').addEventListener('click', e => { if (e.target && e.target.id === 'modal') closeModal(); });

      $('m_copy_yaml').addEventListener('click', () => {
        if (!MODAL_CTX) return;
        navigator.clipboard.writeText(MODAL_CTX.raw || '').then(() => toast('YAML/JSON copied'));
      });

      $('m_copy_prov').addEventListener('click', () => {
        if (!MODAL_CTX) return;
        if (MODAL_CTX.kind !== 'capsule') { toast('No provenance for this type'); return; }
        navigator.clipboard.writeText(JSON.stringify((MODAL_CTX.data && MODAL_CTX.data.provenance) || {}, null, 2))
          .then(() => toast('Provenance copied'));
      });

      $('m_validate').addEventListener('click', async () => {
        if (!MODAL_CTX) return;
        const tag = $('m_result');
        if (MODAL_CTX.kind !== 'capsule') {
          tag.textContent = 'n/a';
          tag.className = 'badge';
          tag.title = 'Validation only applies to capsules';
          return;
        }
        const r = await validateDigest(MODAL_CTX.data);
        tag.textContent = r.ok ? 'digest‚úì' : 'digest‚úó';
        tag.className = 'badge ' + (r.ok ? 'ok' : 'err');
        tag.title = r.ok ? 'OK' : ('have:' + r.have + ' want:' + r.want);
      });




      /* ------------ Renderers ------------ */
      function renderProfiles() {
        const sel = $('profiles');
        const descEl = $('profileDesc');
        const pmap = DATA.profiles || {};
        const keys = Object.keys(pmap).sort();

        // rebuild options
        sel.textContent = '';
        for (const k of keys) {
          const p = pmap[k] || {};
          const o = document.createElement('option');
          o.value = k;
          o.textContent = (p.title || k) + ' (' + (p.version || '1.0.0') + ')';
          o.dataset.desc = p.description || '';
          sel.appendChild(o);
        }

        // Choose target  -  IMPORTANT: prefer STATE.profile (e.g., set by importState)
        const saved = localStorage.getItem('tc_profile');
        let target =
          (STATE.profile && pmap[STATE.profile]) ? STATE.profile :
            (saved && pmap[saved]) ? saved :
              (sel.value && pmap[sel.value]) ? sel.value :
                (keys[0] || '');

        sel.value = target;
        STATE.profile = target;

        // description
        if (descEl) {
          const p0 = pmap[target] || {};
          descEl.textContent = p0.description ? (' -  ' + p0.description) : '';
        }

        // change handler (unchanged)
        sel.onchange = () => {
          STATE.profile = sel.value;
          const p = pmap[STATE.profile] || {};
          if (descEl) descEl.textContent = p.description ? (' -  ' + p.description) : '';
          if (typeof compose === 'function') compose();
        };

        // Fire one change event to initialize downstream (no fake toggle)
        sel.dispatchEvent(new Event('change', { bubbles: true }));
      }

      // Profile YAML/JSON modal
      (function wireProfileView() {
        const btn = $('profileView');
        if (!btn) return;
        btn.addEventListener('click', () => {
          const id = STATE.profile;
          const p = (DATA.profiles || {})[id];
          if (!p) { toast('No profile selected'); return; }
          openModal(p.title || id || 'Profile', p, { kind: 'profile' });
        });
      })();

      function capsuleRow(c, id, opts = {}) {
        const showDomainChip = !!opts.showDomainChip;

        const item = document.createElement('div');
        item.className = 'item';
        item.dataset.id = id;

        const top = document.createElement('div'); // title + controls row
        top.className = 'row';
        item.appendChild(top);

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = STATE.selectedCaps.has(id);
        cb.addEventListener('change', () => {
          if (cb.checked) {
            STATE.selectedCaps.add(id);
            STATE.manualCaps.add(id);
            if (!STATE.order.includes(id)) STATE.order.push(id);
          } else {
            STATE.selectedCaps.delete(id);
            STATE.manualCaps.delete(id);
            STATE.order = STATE.order.filter(x => x !== id);
          }
          renderCapsules();
          renderPreview();
          compose();
        });
        top.appendChild(cb);

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = (c.title || id);
        top.appendChild(title);

        if (showDomainChip) {
          const dchip = document.createElement('span');
          dchip.className = 'chip domain';
          dchip.textContent = c.domain || 'misc';
          dchip.title = 'domain';
          top.appendChild(dchip);
        }

        top.appendChild(badgeAuthor(c));
        top.appendChild(badgeDigest(c));
        top.appendChild(badgePosture(c));

        const btn = document.createElement('button');
        btn.className = 'btn small';
        btn.textContent = 'View';
        btn.onclick = () => openModal(c.title || id, c, { kind: 'capsule' });
        top.appendChild(btn);

        const stmt = document.createElement('div');
        stmt.className = 'small clamp-2';
        stmt.textContent = (c.statement || '');
        item.appendChild(stmt);

        // Optional applies_to chips (tiny, muted)
        if (Array.isArray(c.applies_to) && c.applies_to.length) {
          const chips = document.createElement('div');
          chips.className = 'row-chips';
          c.applies_to.forEach(tag => {
            const chip = document.createElement('span');
            chip.className = 'chip applies';
            chip.textContent = tag;
            chips.appendChild(chip);
          });
          item.appendChild(chips);
        }

        return item;
      }


      function renderCapsules() {
        const list = $('capsules');
        list.innerHTML = '';

        const f = (STATE.filter || '').toLowerCase();
        const byDomain = new Map(); // domain => [ids]

        const caps = DATA.capsules || {};
        for (const id of Object.keys(caps)) {
          const c = caps[id] || {};
          const hay = (id + ' ' + (c.title || '') + ' ' + (c.domain || '') + ' ' + (c.statement || '')).toLowerCase();
          if (hay.includes(f)) {
            const d = (c.domain || 'misc').toLowerCase();
            if (!byDomain.has(d)) byDomain.set(d, []);
            byDomain.get(d).push(id);
          }
        }

        // sort domains; and titles within domain
        const domains = Array.from(byDomain.keys()).sort();
        let total = 0;

        domains.forEach(domain => {
          const ids = byDomain.get(domain).sort((a, b) => {
            const A = (caps[a].title || a).toLowerCase();
            const B = (caps[b].title || b).toLowerCase();
            return A.localeCompare(B);
          });
          total += ids.length;

          // Group container
          const group = document.createElement('details');
          group.className = 'domain-group';
          group.dataset.domain = domain;             // allow global toggles to persist state
          group.open = getDomainOpen(domain);
          group.addEventListener('toggle', () => { setDomainOpen(domain, group.open); });


          // Summary header
          const sum = document.createElement('summary');
          const title = document.createElement('span');
          title.className = 'domain-title';
          title.textContent = domain;

          const count = document.createElement('span');
          count.className = 'badge';
          count.textContent = String(ids.length);

          const spacer = document.createElement('span');
          spacer.className = 'domain-spacer';

          const selAll = document.createElement('input');
          selAll.type = 'checkbox';
          selAll.addEventListener('click', e => e.stopPropagation());
          selAll.addEventListener('mousedown', e => e.stopPropagation());
          const allSelected = ids.every(cid => STATE.selectedCaps.has(cid));
          const someSelected = ids.some(cid => STATE.selectedCaps.has(cid));
          selAll.checked = allSelected;
          selAll.indeterminate = !allSelected && someSelected;
          selAll.title = 'Select all in domain';

          selAll.addEventListener('change', () => {
            if (selAll.checked) {
              ids.forEach(cid => {
                STATE.selectedCaps.add(cid);
                if (!STATE.order.includes(cid)) STATE.order.push(cid);
              });
            } else {
              ids.forEach(cid => {
                STATE.selectedCaps.delete(cid);
                STATE.manualCaps.delete(cid);
              });
              STATE.order = STATE.order.filter(x => STATE.selectedCaps.has(x));
            }
            renderCapsules();
            renderPreview();
            compose();
          });

          sum.appendChild(title);
          sum.appendChild(count);
          sum.appendChild(spacer);
          sum.appendChild(selAll);
          group.appendChild(sum);

          // Body
          const body = document.createElement('div');
          body.className = 'domain-body';
          ids.forEach(cid => {
            body.appendChild(capsuleRow(caps[cid], cid, { showDomainChip: false }));
          });
          group.appendChild(body);

          list.appendChild(group);
        });

        $('capsulesCount').textContent = total;
      }


      function renderBundles() {
        const list = $('bundles'); list.innerHTML = '';
        const keys = Object.keys(DATA.bundles || {}).sort((a, b) => (DATA.bundles[a].name || a).localeCompare(DATA.bundles[b].name || b));

        for (const k of keys) {
          const b = DATA.bundles[k] || {};
          const item = document.createElement('div'); item.className = 'item';
          const row = document.createElement('div'); row.className = 'row'; item.appendChild(row);

          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = STATE.selectedBundles.has(k);
          cb.addEventListener('change', () => {
            if (cb.checked) {
              STATE.selectedBundles.add(k);
              (b.capsules || []).forEach(cid => { STATE.selectedCaps.add(cid); if (!STATE.order.includes(cid)) STATE.order.push(cid); });
            } else {
              STATE.selectedBundles.delete(k);
              const others = [...STATE.selectedBundles];
              (b.capsules || []).forEach(cid => {
                const elsewhere = others.some(name => {
                  const b2 = DATA.bundles[name];
                  return b2 && Array.isArray(b2.capsules) && b2.capsules.includes(cid);
                });
                const manual = STATE.manualCaps.has(cid);
                if (!elsewhere && !manual) STATE.selectedCaps.delete(cid);
                STATE.order = STATE.order.filter(x => STATE.selectedCaps.has(x));
              });
            }
            renderCapsules(); renderPreview(); compose();
          });
          row.appendChild(cb);

          const ttl = document.createElement('div'); ttl.textContent = (b.name || k); row.appendChild(ttl);

          // NEW: "View" button for bundle YAML/JSON
          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn small';
          viewBtn.textContent = 'View';
          viewBtn.onclick = () => openModal(b.name || k || 'Bundle', b, { kind: 'bundle' });
          row.appendChild(viewBtn);

          // optional description
          if (b.description) {
            const desc = document.createElement('div'); desc.className = 'small'; desc.textContent = b.description; item.appendChild(desc);
          }

          list.appendChild(item);
        }
        $('bundlesCount').textContent = keys.length;
      }


      function renderPreview() {
        const list = $('preview'); list.innerHTML = '';
        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id));
        ids.forEach(id => {
          const c = DATA.capsules[id]; if (!c) return;
          const item = document.createElement('div'); item.className = 'item'; item.dataset.id = id;

          const row = document.createElement('div'); row.className = 'row'; item.appendChild(row);
          const handle = document.createElement('span'); handle.className = 'chip drag'; handle.textContent = '‚ò∞'; row.appendChild(handle);
          const ttl = document.createElement('div');
          ttl.className = 'title';
          ttl.innerHTML = esc(c.title || id) + ' <span class="muted"> -  ' + esc(c.domain || '') + '</span>';
          row.appendChild(ttl);

          const btn = document.createElement('button');
          btn.className = 'btn small';
          btn.textContent = 'View';
          btn.onclick = () => openModal(c.title || id, c, { kind: 'capsule' });
          row.appendChild(btn);


          list.appendChild(item);
        });

        // Sortable (drag to reorder)
        if (window.__sortable) window.__sortable.destroy();
        window.__sortable = new Sortable(list, {
          animation: 120,
          handle: '.drag',
          ghostClass: 'ghost',
          onEnd: (evt) => {
            const old = STATE.order.filter(id => STATE.selectedCaps.has(id));
            const moved = old.splice(evt.oldIndex, 1)[0];
            old.splice(evt.newIndex, 0, moved);
            STATE.order = old.concat(STATE.order.filter(x => !STATE.selectedCaps.has(x)));
            compose();
          }
        });
      }
      /* ------------ Composition (hardened) ------------ */

      /* Canonicalize ids so filenames/paths/exts match capsule ids/keys */
      function canonicalizeId(s) {
        return String(s || '')
          .trim()
          .replace(/^.*[\\/]/, '')              // strip any leading path
          .replace(/\.(yaml|yml|json)$/i, '');  // strip extension
      }

      /* Turn a Set or object-map of selections into a canonical Set of ids */
      function toIdSet(x) {
        if (x instanceof Set) return new Set([...x].map(canonicalizeId));
        if (x && typeof x === 'object') {
          return new Set(Object.keys(x).filter(k => x[k]).map(canonicalizeId));
        }
        return new Set();
      }

      /* Find a capsule by id, key, or filename-like string */
      function getCapsuleByAnyId(anyId) {
        const canon = canonicalizeId(anyId);
        const store = (DATA && DATA.capsules) || {};
        if (store[anyId]) return store[anyId]; // exact key hit
        for (const k in store) {
          const cap = store[k];
          const capIdCanon = canonicalizeId(cap.id || '');
          const keyCanon = canonicalizeId(k);
          if (capIdCanon === canon || keyCanon === canon) return cap;
        }
        return null;
      }

      /* Selection that survives order/selected mismatches */
      function getSelectedIdsSafe() {
        const order = Array.isArray(STATE.order) ? STATE.order.slice() : [];
        const sel = toIdSet(STATE.selectedCaps);
        const ordered = [];
        const seen = new Set();

        for (const raw of order) {
          const canon = canonicalizeId(raw);
          if (sel.has(canon) && !seen.has(canon)) {
            ordered.push(canon);
            seen.add(canon);
          }
        }
        for (const canon of sel) {
          if (!seen.has(canon)) ordered.push(canon);
        }
        return ordered;
      }

      /* Optional legacy helper (kept for completeness if you use it elsewhere) */
      function parseFieldSpec(spec) {
        const m = String(spec).match(/^([a-z_.]+)(?:\[:(\d+)\])?$/i);
        return {
          path: m ? m[1].toLowerCase() : String(spec).toLowerCase(),
          limit: m && m[2] ? parseInt(m[2], 10) : null
        };
      }

      /* ---------- Pedagogy normalization (supports both schemas) ---------- */
      function normalizePedagogy(capsule) {
        // A) pedagogy: [{kind:'Socratic'|'Aphorism', text:'...'}, ...]
        // B) pedagogy: { socratic:[...], aphorisms:[...] }
        const out = { socratic: [], aphorisms: [] };
        const p = capsule && capsule.pedagogy;
        if (!p) return out;

        if (Array.isArray(p)) {
          for (const item of p) {
            if (!item) continue;
            const kind = String(item.kind || '').toLowerCase();
            const text = (item.text == null) ? '' : String(item.text);
            if (!text) continue;
            if (kind === 'socratic') out.socratic.push(text);
            else if (kind === 'aphorism' || kind === 'aphorisms') out.aphorisms.push(text);
          }
        } else if (typeof p === 'object') {
          if (Array.isArray(p.socratic)) out.socratic.push(...p.socratic.map(String));
          if (Array.isArray(p.aphorisms)) out.aphorisms.push(...p.aphorisms.map(String));
        }
        return out;
      }

      /* ---------- Projection Renderer (profile-driven) ---------- */
      function applyProjection(capsule, projection, withPed) {
        const lines = [];

        // Header (supports {title}/{statement})
        const headerTpl = (projection.render && typeof projection.render.capsule_header === 'string')
          ? projection.render.capsule_header
          : null;

        if (headerTpl && headerTpl.length > 0) {
          lines.push(applyTemplate(headerTpl, {
            id: capsule.id || '',
            version: capsule.version || '',
            domain: capsule.domain || '',
            title: capsule.title || capsule.TITLE || '',
            statement: capsule.statement || capsule.STATEMENT || ''
          }).trim());
        }

        // Normalize pedagogy for consistent addressing
        const ped = normalizePedagogy(capsule);

        // Build include list; ensure pedagogy is present when forced
        let includes = Array.isArray(projection.include) ? projection.include.slice() : [];
        const forcePed = !!(projection && projection.force_pedagogy);
        const hasPedInList = includes.some(s => String(s).startsWith('pedagogy.'));
        if (forcePed && !hasPedInList) {
          includes.push('pedagogy.socratic', 'pedagogy.aphorisms');
        }

        for (const inc of includes) {
          const { path, sliceFrom, sliceTo } = parseInclude(inc);

          // Respect UI/profile gating
          if (!withPed && path.startsWith('pedagogy.')) continue;

          let val = null;
          if (path === 'pedagogy.socratic') val = ped.socratic;
          else if (path === 'pedagogy.aphorisms') val = ped.aphorisms;
          else val = getByPath(capsule, path);

          if (val == null) continue;

          if (Array.isArray(val)) {
            const sub = sliceArray(val, sliceFrom, sliceTo);
            const bulletKey = path.endsWith('socratic') ? 'socratic_bullet'
              : path.endsWith('aphorisms') ? 'aphorism_bullet'
                : null;
            const bulletTpl = (projection.render && projection.render[bulletKey]) || '  - {text}';
            for (const item of sub) lines.push(applyTemplate(bulletTpl, { text: String(item) }));
            continue;
          }

          if (typeof val === 'string') {
            const lineTpl = (projection.render && projection.render[`${path}_line`]) || null;
            lines.push(lineTpl ? applyTemplate(lineTpl, { text: val }) : val);
          }
        }

        // Footer (suppressed when empty string)
        const footer = projection.render ? projection.render.enforcement_footer : null;
        if (typeof footer === 'string' && footer.trim().length > 0) lines.push(footer.trim());

        return lines.join("\n").trim();
      }

      /* ---------- Legacy capsule composer (only used if no projection provided) ---------- */
      function composeLegacy(c, includePedagogy) {
        const lines = [];
        lines.push(
          "BEGIN CAPSULE id=" + (c.id || '') +
          " version=" + (c.version || '1.0.0') +
          " domain=" + (c.domain || '') +
          " posture=" + (c.posture || 'informational')
        );
        if (c.statement) lines.push("STATEMENT: " + c.statement);
        if (includePedagogy && c.pedagogy) {
          const ped = normalizePedagogy(c);
          const body = []
            .concat(ped.socratic.map(t => "Socratic: " + t))
            .concat(ped.aphorisms.map(t => "Aphorism: " + t))
            .join('\n');
          if (body) lines.push('PEDAGOGY:\n' + body);
        }
        lines.push('END CAPSULE');
        return lines.join("\n");
      }

      /* ---------- Main compose ---------- */
      function compose() {
        try {
          const prof = (DATA && DATA.profiles && STATE.profile && DATA.profiles[STATE.profile]) || {};
          const response = prof.response || {};
          const projection = response.projection || {};
          const blocks = [];

          // Fragments / system
          const overrideDefaults = !!response.override_compose_defaults;
          const fragments = Array.isArray(response.fragments) ? response.fragments : [];

          const sysFragments = fragments.filter(f => f && f.include !== false && f.kind === 'system');
          if (sysFragments.length) {
            for (const f of sysFragments) blocks.push(String(f.content || '').trim());
          } else {
            const policy = response.policy || 'Cite or abstain; follow Plan‚ÜíVerify‚ÜíAnswer; ask ONE crisp follow-up if required.';
            const format = response.format || 'natural';
            const system_block = response.system_block ||
              ("SYSTEM: Profile=" + (prof.title || 'unknown') + "\nPOLICY: " + policy + "\nFORMAT: " + format);
            blocks.push(system_block);
          }

          const auxFragments = fragments.filter(f => f && f.include !== false && f.kind !== 'system');
          if (auxFragments.length) {
            for (const f of auxFragments) blocks.push(String(f.content || '').trim());
          } else if (!overrideDefaults) {
            // Legacy defaults only if profile does not override
            blocks.push("SYSTEM: Truth Capsules Loader v1\nPURPOSE: Use curated capsules to scaffold reasoning and enforce acceptance rules.\nMETHOD:\n  1) Load capsule rules (below).\n  2) For each task, follow Plan ‚Üí Verify ‚Üí Answer.\n  3) If required fields are missing, ask ONE concise follow-up.\n  4) Cite sources or abstain. Redact PII. Validate tool JSON before calling.\n  5) Emit a JSON report when asked (see REPORT SCHEMA).\nFAILURE POLICY: If a capsule cannot be satisfied, abstain + explain what is missing.");
            blocks.push("SYSTEM: Bootstrap Discipline\n‚Ä¢ Curation is king - prefer curated fixtures/evidence; abstain when unsure.\n‚Ä¢ Show your work - reference evidence in answers.\n‚Ä¢ Make failures explicit and reversible - choose tiny experiments.");
          }

          // Heading + pedagogy policy
          const heading = response.capsules_heading || 'SYSTEM: Capsule Rules (Selected)';
          const wantsPedInProfile = Array.isArray(projection.include) && projection.include.some(s => String(s).startsWith('pedagogy.'));
          const forcePed = !!(projection && projection.force_pedagogy) || !!response.force_pedagogy;
          const withPedUI = !!($('includePed') && $('includePed').checked);
          const withPed = forcePed || withPedUI || wantsPedInProfile;

          // Robust selected ids
          const idsCanon = getSelectedIdsSafe();
          if (!idsCanon.length) {
            blocks.push(heading + "\n- (No capsules selected)");
          } else {
            blocks.push(heading);
            for (const canon of idsCanon) {
              const cap = getCapsuleByAnyId(canon);
              if (!cap) continue;
              if (projection && projection.include) blocks.push(applyProjection(cap, projection, withPed));
              else blocks.push(composeLegacy(cap, withPed));
            }
          }

          // --- footer (profile-controlled) ---
          if (typeof response.footer === 'string' && response.footer.trim().length) {
            blocks.push(response.footer.trim());
          }

          // Markdown wrap choice: UI wins; otherwise profile default (if provided)
          const wrapDefault = !!response.markdown_wrap_default;
          const wrapUI = !!($('markdown') && $('markdown').checked);
          const wrap = wrapUI || (wrapDefault && !$('markdown'));
          let out = blocks.filter(Boolean).join("\n\n").trim();
          if (wrap) out = "```\n" + out + "\n```";
          $('out').value = out;

        } catch (err) {
          console.error(err);
          $('out').value = "ERROR composing prompt: " + (err && err.message ? err.message : String(err));
        }
      }

      /* ---------- Small templating & structure helpers ---------- */
      function applyTemplate(tpl, dict) {
        return String(tpl).replace(/\{([\w.]+)\}/g, (_, k) => {
          const v = dict[k];
          return (v === undefined || v === null) ? '' : String(v);
        });
      }
      function parseInclude(spec) {
        // e.g., "pedagogy.socratic[:2]" or "pedagogy.aphorisms[1:3]"
        const s = String(spec);
        const m = s.match(/^([\w.]+)(\[(?::?\d*)?(?::\d*)?\])?$/);
        const path = m ? m[1] : s;
        let sliceFrom = null, sliceTo = null;
        const slice = m && m[2] ? m[2].slice(1, -1) : null;
        if (slice != null && slice.length) {
          const parts = slice.split(':');
          if (parts.length === 2) {
            sliceFrom = parts[0].length ? parseInt(parts[0], 10) : null;
            sliceTo = parts[1].length ? parseInt(parts[1], 10) : null;
          } else if (parts.length === 1 && parts[0].length) {
            const idx = parseInt(parts[0], 10);
            sliceFrom = isNaN(idx) ? null : idx;
            sliceTo = isNaN(idx) ? null : (idx + 1);
          }
        }
        return { path, sliceFrom, sliceTo };
      }
      function sliceArray(arr, from, to) {
        const n = Array.isArray(arr) ? arr.length : 0;
        const start = (from == null) ? 0 : Math.max(0, from);
        const end = (to == null) ? n : Math.max(start, Math.min(n, to));
        return arr.slice(start, end);
      }
      function getByPath(obj, path) {
        if (!obj || !path) return null;
        const parts = path.split('.');
        let cur = obj;
        for (const p of parts) {
          if (cur == null) return null;
          cur = cur[p];
        }
        return cur;
      }

      /* ------------ Manifest + share ------------ */

      /* Namespace for LocalStorage manifests */
      const MANIFEST_NS = 'tc_manifests_v1'; // value: { [name: string]: Manifest }

      /* Helpers */
      function readAllManifests() {
        try { return JSON.parse(localStorage.getItem(MANIFEST_NS) || '{}'); }
        catch { return {}; }
      }
      function writeAllManifests(obj) {
        localStorage.setItem(MANIFEST_NS, JSON.stringify(obj || {}));
      }
      function listManifestNames() {
        return Object.keys(readAllManifests()).sort((a, b) => a.localeCompare(b));
      }

      /* Filename-ish, human friendly */
      function tsCompact(d = new Date()) {
        const p2 = n => String(n).padStart(2, '0');
        return [
          d.getFullYear(),
          p2(d.getMonth() + 1),
          p2(d.getDate()),
          '_',
          p2(d.getHours()),
          p2(d.getMinutes()),
          p2(d.getSeconds())
        ].join('');
      }
      function suggestedManifestName() {
        const prof = STATE.profile || 'default';
        const nCaps = STATE.order.filter(id => STATE.selectedCaps.has(id)).length;
        return `${tsCompact()}__${prof}__n${nCaps}`;
      }

      /* Build a complete, safe-to-JSON manifest (includes the composed system prompt) */
      function buildManifest() {
        return {
          schema: 'tc.manifest.v1',
          ts: new Date().toISOString(),
          profile: STATE.profile,
          bundles: [...STATE.selectedBundles],
          order: STATE.order.filter(id => STATE.selectedCaps.has(id)),
          includePed: $('includePed').checked ? 1 : 0,
          markdown: $('markdown').checked ? 1 : 0,
          // Save the current composed system prompt WITHOUT markdown fences
          prompt: getCurrentSystemPrompt()
        };
      }

      /* Export-only (for URL deeplinks) */
      function exportState() {
        return {
          profile: STATE.profile,
          bundles: [...STATE.selectedBundles],
          order: STATE.order.filter(id => STATE.selectedCaps.has(id))
        };
      }

      /* Share-link (does not include prompt; keeps links light) */
      function encodeStateToUrl() {
        const s = btoa(unescape(encodeURIComponent(JSON.stringify(exportState()))));
        const url = new URL(window.location.href);
        url.searchParams.set('s', s);
        return url.toString();
      }

      /* Import state/manifest (from file or LocalStorage). Also applies prompt after render. */
      function importState(obj) {
        if (!obj) return;

        // Choose a valid profile (fallback to first available)
        const prof = (obj.profile && DATA.profiles[obj.profile]) ? obj.profile
          : (Object.keys(DATA.profiles || {})[0] || null);

        STATE.profile = prof;
        STATE.selectedBundles = new Set();
        STATE.selectedCaps = new Set();
        STATE.manualCaps = new Set();
        STATE.order = [];

        // Bundles ‚Üí selectedCaps/ORDER
        (obj.bundles || []).forEach(b => { if (DATA.bundles[b]) STATE.selectedBundles.add(b); });
        STATE.selectedBundles.forEach(b => {
          const caps = (DATA.bundles[b] && DATA.bundles[b].capsules) || [];
          caps.forEach(cid => {
            if (DATA.capsules[cid]) {
              STATE.selectedCaps.add(cid);
              if (!STATE.order.includes(cid)) STATE.order.push(cid);
            }
          });
        });

        // Manual order/caps (explicit)
        (obj.order || []).forEach(cid => {
          if (DATA.capsules[cid]) {
            if (!STATE.order.includes(cid)) STATE.order.push(cid);
            STATE.selectedCaps.add(cid);
          }
        });

        // Render everything (this will call compose(), which would normally overwrite #out)
        render();

        // Restore checkboxes from the manifest (optional, but nice to have)
        if (Object.prototype.hasOwnProperty.call(obj, 'includePed')) {
          $('includePed').checked = !!obj.includePed;
        }
        if (Object.prototype.hasOwnProperty.call(obj, 'markdown')) {
          $('markdown').checked = !!obj.markdown;
        }

        // Apply prompt AFTER render/compose so the loaded prompt wins on load
        if (typeof obj.prompt === 'string') {
          $('out').value = obj.prompt;
        }

        // Update the profile select‚Äôs remembered value for future sessions
        if (STATE.profile) localStorage.setItem('tc_profile', STATE.profile);
      }

      /* Hydrate state from ?s=... link */
      function tryHydrateFromUrl() {
        const url = new URL(window.location.href);
        const s = url.searchParams.get('s');
        if (!s) return;
        try {
          const json = decodeURIComponent(escape(atob(s)));
          importState(JSON.parse(json));
        } catch (e) {
          console.error('bad s param', e);
        }
      }

      /* LocalStorage manifests ‚Äì UI binding */
      function refreshManifestSelect() {
        const sel = $('manifestSelect');
        if (!sel) return;
        sel.innerHTML = '';
        const names = listManifestNames();
        if (names.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '(no saved manifests)';
          sel.appendChild(opt);
          sel.disabled = true;
        } else {
          sel.disabled = false;
          names.forEach(n => {
            const opt = document.createElement('option');
            opt.value = n;
            opt.textContent = n;
            sel.appendChild(opt);
          });
        }
      }

      function saveManifestToLocalStorage() {
        const manifest = buildManifest();
        const defaultName = suggestedManifestName();
        const name = prompt('Save manifest as:', defaultName);
        if (!name) return;

        const all = readAllManifests();
        const exists = Object.prototype.hasOwnProperty.call(all, name);
        if (exists) {
          const ok = confirm(`A manifest named "${name}" already exists. Overwrite?`);
          if (!ok) return;
        }

        all[name] = manifest;
        writeAllManifests(all);
        refreshManifestSelect();
        // Preselect the saved item
        const sel = $('manifestSelect');
        if (sel && !sel.disabled) sel.value = name;
        toast(`Saved manifest "${name}"`);
      }

      function loadSelectedManifestFromLocalStorage() {
        const sel = $('manifestSelect');
        if (!sel || sel.disabled || !sel.value) {
          toast('No saved manifest selected');
          return;
        }
        const all = readAllManifests();
        const m = all[sel.value];
        if (!m) { toast('Manifest not found'); return; }
        importState(m);
        toast(`Loaded "${sel.value}"`);
      }

      function deleteSelectedManifestFromLocalStorage() {
        const sel = $('manifestSelect');
        if (!sel || sel.disabled || !sel.value) {
          toast('No saved manifest selected');
          return;
        }
        const name = sel.value;
        const ok = confirm(`Delete saved manifest "${name}"? This cannot be undone.`);
        if (!ok) return;

        const all = readAllManifests();
        delete all[name];
        writeAllManifests(all);
        refreshManifestSelect();
        toast(`Deleted "${name}"`);
      }

      /* Wire buttons (file import already exists, we keep it) */
      $('dlJsonBtn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(buildManifest(), null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'system_prompt.manifest.json';
        a.click();
      });

      $('loadJsonBtn').addEventListener('click', () => {
        const inp = document.createElement('input');
        inp.type = 'file';
        inp.accept = 'application/json';
        inp.onchange = async () => {
          const f = inp.files[0];
          if (!f) return;
          try {
            const txt = await f.text();
            const obj = JSON.parse(txt);
            importState(obj);
            toast('Manifest loaded from file');
          } catch (e) {
            console.error(e);
            toast('Invalid JSON manifest');
          }
        };
        inp.click();
      });

      /* New LS controls */
      $('manifestSaveBtn').addEventListener('click', saveManifestToLocalStorage);
      $('manifestLoadBtn').addEventListener('click', loadSelectedManifestFromLocalStorage);
      $('manifestDeleteBtn').addEventListener('click', deleteSelectedManifestFromLocalStorage);

      /* Populate the manifest list on load */
      window.addEventListener('load', refreshManifestSelect);


      /* ------------ LLM Command Composition ------------ */
      function shQuoteLiteral(s) {
        // POSIX-safe single-quote wrapper: ' becomes '\''
        return "'" + String(s).replace(/'/g, "'\\''") + "'";
      }

      function buildSysHeredoc(promptText) {
        // Use single-quoted heredoc label to disable interpolation/globbing
        // Use TC_SYSTEM to avoid conflicts with user's shell variables
        const label = "__TC_SYSTEM__";
        return [
          `read -r -d '' TC_SYSTEM <<'${label}'`,
          promptText,
          label
        ].join("\n");
      }

      function buildInputFragment(tpl, userText, filePath) {
        const flags = (tpl.extra_flags || []).join(' ');

        if (tpl.input_mode === 'arg') {
          return {
            EXTRA_FLAGS: flags,
            INPUT_FRAGMENT: `<<< ${shQuoteLiteral(userText || "")}`
          };
        }

        if (tpl.input_mode === 'stdin') {
          return {
            EXTRA_FLAGS: flags,
            STDIN_PIPE: `printf %s ${shQuoteLiteral(userText || "")} |`,
            INPUT_FRAGMENT: ""
          };
        }

        if (tpl.input_mode === 'file') {
          return {
            EXTRA_FLAGS: flags,
            FILE_PATH: shQuoteLiteral(filePath || "input.txt"),
            INPUT_FRAGMENT: ""
          };
        }

        return { EXTRA_FLAGS: flags, INPUT_FRAGMENT: "" };
      }

      function composeLlmCommand(tpl, systemPrompt, userText, filePath, minify) {
        const sysText = minify ? systemPrompt.replace(/\s+/g, ' ').trim() : systemPrompt;
        const sysHeredoc = buildSysHeredoc(sysText);
        const frags = buildInputFragment(tpl, userText, filePath);

        // Build the command by replacing all placeholders
        let cmd = String(tpl.cmd_template || '');

        // Replace required placeholders
        cmd = cmd.replace(/\{\{SYS_HEREDOC\}\}/g, sysHeredoc);
        cmd = cmd.replace(/\{\{MODEL\}\}/g, tpl.model || '');
        cmd = cmd.replace(/\{\{INPUT_FRAGMENT\}\}/g, frags.INPUT_FRAGMENT || '');

        // Replace optional placeholders
        cmd = cmd.replace(/\{\{EXTRA_FLAGS\}\}/g, frags.EXTRA_FLAGS || '');
        cmd = cmd.replace(/\{\{STDIN_PIPE\}\}/g, frags.STDIN_PIPE || '');
        cmd = cmd.replace(/\{\{FILE_PATH\}\}/g, frags.FILE_PATH || '');

        // Clean up:
        // 1. Collapse multiple spaces into single space
        cmd = cmd.replace(/ {2,}/g, ' ');
        // 2. Remove trailing spaces on lines
        cmd = cmd.replace(/[ \t]+$/gm, '');
        // 3. Ensure final newline
        cmd = cmd.trim() + "\n";

        return cmd;
      }

      function getCurrentSystemPrompt() {
        // Get the current composed prompt, stripping markdown fences if present
        let prompt = $('out').value;
        if ($('markdown').checked) {
          // Remove leading ``` and trailing ```
          prompt = prompt.replace(/^```\n/, '').replace(/\n```$/, '');
        }
        return prompt;
      }

      function updateLlmPreview() {
        const templates = DATA.llm_templates || [];
        const selectedId = $('llm_template').value;
        const tpl = templates.find(t => t.id === selectedId);

        if (!tpl) {
          $('llm_preview').value = '';
          return;
        }

        const systemPrompt = getCurrentSystemPrompt();
        const userText = $('llm_user_input').value;
        const filePath = $('llm_file_path').value;
        const minify = $('llm_minify').checked;

        const command = composeLlmCommand(tpl, systemPrompt, userText, filePath, minify);
        $('llm_preview').value = command;
      }

      function openLlmModal() {
        const templates = DATA.llm_templates || [];

        if (templates.length === 0) {
          toast('No LLM templates found');
          return;
        }

        // Populate template selector
        const sel = $('llm_template');
        sel.innerHTML = '';
        templates.forEach(tpl => {
          const opt = document.createElement('option');
          opt.value = tpl.id;
          opt.textContent = tpl.label;
          sel.appendChild(opt);
        });

        // Restore last used template from localStorage
        const lastTemplate = localStorage.getItem('llm_last_template');
        if (lastTemplate && templates.find(t => t.id === lastTemplate)) {
          sel.value = lastTemplate;
        }

        // Update description and input mode on template change
        const updateTemplateUI = () => {
          const selectedId = sel.value;
          const tpl = templates.find(t => t.id === selectedId);
          if (!tpl) return;

          $('llm_template_desc').textContent = tpl.description || '';

          // Show/hide input fields based on input_mode
          if (tpl.input_mode === 'file') {
            $('llm_input_row').style.display = 'none';
            $('llm_file_row').style.display = 'flex';
          } else {
            $('llm_input_row').style.display = 'flex';
            $('llm_file_row').style.display = 'none';

            if (tpl.input_mode === 'stdin') {
              $('llm_input_hint').textContent = 'Will be piped to stdin';
            } else {
              $('llm_input_hint').textContent = 'Will be passed as bash here-string (<<<)';
            }
          }

          // Update preview whenever template changes
          updateLlmPreview();
        };

        sel.onchange = updateTemplateUI;

        // Update preview on input changes
        $('llm_user_input').oninput = updateLlmPreview;
        $('llm_file_path').oninput = updateLlmPreview;
        $('llm_minify').onchange = updateLlmPreview;

        updateTemplateUI();

        // Clear inputs (but preserve file path default)
        $('llm_user_input').value = '';
        $('llm_file_path').value = 'input.txt';
        $('llm_minify').checked = false;

        // Initial preview
        updateLlmPreview();

        $('llmModal').style.display = 'flex';
      }

      function closeLlmModal() {
        $('llmModal').style.display = 'none';
      }

      function copyLlmCommand() {
        const command = $('llm_preview').value;

        if (!command) {
          toast('No command to copy');
          return;
        }

        // Save the selected template to localStorage
        const selectedId = $('llm_template').value;
        if (selectedId) {
          localStorage.setItem('llm_last_template', selectedId);
        }

        navigator.clipboard.writeText(command).then(() => {
          toast('Command copied to clipboard!');
          // Don't close the modal - let user copy again or review
        }).catch(err => {
          console.error('Copy failed:', err);
          toast('Copy failed - see console');
        });
      }

      // Save the generated command as a runnable bash script
      function saveLlmScript() {
        const command = $('llm_preview').value;
        if (!command) {
          toast('No command to save');
          return;
        }

        const tplId = $('llm_template').value || 'cmd';
        const nowIso = new Date().toISOString();
        const filename = `llm_${tplId}_${nowIso.replace(/[:.]/g, '-')}.sh`;

        const header =
          `#!/usr/bin/env bash
# Generated by Truth Capsule Composer
# Template: ${tplId}
# Date: ${nowIso}
set -Eeuo pipefail
IFS=$'\\n\\t'

`;

        const blob = new Blob([header, command], { type: 'text/x-shellscript' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
        a.remove();
        toast(`Saved ${filename} (remember: chmod +x ${filename})`);
      }
      function copyLlmCommand() {
        const command = $('llm_preview').value;

        if (!command) {
          toast('No command to copy');
          return;
        }

        // Save the selected template to localStorage
        const selectedId = $('llm_template').value;
        if (selectedId) {
          localStorage.setItem('llm_last_template', selectedId);
        }

        navigator.clipboard.writeText(command).then(() => {
          toast('Command copied to clipboard!');
          // Don't close the modal - let user copy again or review
        }).catch(err => {
          console.error('Copy failed:', err);
          toast('Copy failed - see console');
        });
      }

      // Wire up LLM modal events
      $('copyLlmBtn').addEventListener('click', openLlmModal);
      $('llm_close').addEventListener('click', closeLlmModal);
      $('llm_cancel').addEventListener('click', closeLlmModal);
      $('llm_copy').addEventListener('click', copyLlmCommand);
      $('llm_save').addEventListener('click', saveLlmScript)
      $('llmModal').addEventListener('click', e => {
        if (e.target && e.target.id === 'llmModal') closeLlmModal();
      });

      /* ------------ Wire up UI ------------ */
      $('search').addEventListener('input', () => { STATE.filter = $('search').value; renderCapsules(); });
      $('clearBtn').addEventListener('click', () => { STATE.selectedBundles = new Set(); STATE.selectedCaps = new Set(); STATE.manualCaps = new Set(); STATE.order = []; render(); toast('Cleared'); });
      $('composeBtn').addEventListener('click', compose);
      $('copyBtn').addEventListener('click', () => { navigator.clipboard.writeText($('out').value); toast('Prompt copied'); });
      $('dlBtn').addEventListener('click', () => { const blob = new Blob([$('out').value], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'system_prompt.txt'; a.click(); });
      $('dlJsonBtn').addEventListener('click', () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(buildManifest(), null, 2)], { type: 'application/json' })); a.download = 'system_prompt.manifest.json'; a.click(); });
      $('shareLinkBtn').addEventListener('click', () => { const url = encodeStateToUrl(); navigator.clipboard.writeText(url).then(() => toast('Share link copied')).catch(() => { prompt('Copy link:', url); }); });
      $('loadJsonBtn').addEventListener('click', () => { const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json'; inp.onchange = async () => { const f = inp.files[0]; if (!f) return; const txt = await f.text(); importState(JSON.parse(txt)); toast('State loaded'); }; inp.click(); });
      $('validateAllBtn').addEventListener('click', async () => {
        const ids = STATE.order.filter(id => STATE.selectedCaps.has(id)); const results = [];
        for (const id of ids) { const c = DATA.capsules[id]; if (!c) continue; const v = await validateDigest(c); results.push({ id, ok: v.ok }); }
        const ok = results.filter(r => r.ok).length; const fail = results.length - ok;
        toast(`Digests: ${ok} ok, ${fail} fail`); try { await navigator.clipboard.writeText(results.map(r => (r.ok ? '‚úì ' : '‚úó ') + r.id).join('\n')); } catch { }
      });
      $('includePed').addEventListener('change', compose);
      $('markdown').addEventListener('change', compose);

      /* Keyboard shortcuts */
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { compose(); }
        if (e.key === '/') { e.preventDefault(); $('search').focus(); }
        if (e.key === 'm') { $('markdown').checked = !$('markdown').checked; compose(); }
        if (e.key === 'p') { $('includePed').checked = !$('includePed').checked; compose(); }
      });

      function render() { renderProfiles(); renderBundles(); renderCapsules(); renderPreview(); compose(); }
      render();
      tryHydrateFromUrl();
      initBundlesCollapsibleSimple();

      // Remember splits
      const mainSizes = JSON.parse(localStorage.getItem('tc_split_main') || '[40,60]');
      Split(['#left', '#right'], { sizes: mainSizes, minSize: 240, gutterSize: 8, onDragEnd: s => localStorage.setItem('tc_split_main', JSON.stringify(s)) });

      const subSizes = JSON.parse(localStorage.getItem('tc_split_sub') || '[45,55]');
      window.__subsplit = Split(
        ['#bundlesWrap', '#capsulesWrap'],
        {
          direction: 'vertical',
          sizes: subSizes,
          minSize: [0, 120],                // allow collapsing bundles pane to 0
          gutterSize: 8,
          onDragEnd: s => localStorage.setItem('tc_split_sub', JSON.stringify(s))
        }
      );
      // Remember profile + checkboxes
      $('profiles').addEventListener('change', () => localStorage.setItem('tc_profile', $('profiles').value));
      $('includePed').addEventListener('change', () => localStorage.setItem('tc_inc_ped', $('includePed').checked ? '1' : '0'));
      $('markdown').addEventListener('change', () => localStorage.setItem('tc_md', $('markdown').checked ? '1' : '0'));

      function getGutter() {
        // gutter sits between the two panes
        return document.querySelector('#bundlesWrap + .gutter.gutter-vertical')
            || document.querySelector('.gutter.gutter-vertical');
      }

      function updateGutterVisibility() {
        if (!window.__subsplit) return;
        const gutter = getGutter();
        if (!gutter) return;
        const [topPct, botPct] = window.__subsplit.getSizes();
        const hidden = (topPct <= 0.5) || (botPct <= 0.5);
        gutter.classList.toggle('is-hidden', hidden);
      }

      function setBundlesOpen(open, opts={}) {
        const wrap = document.getElementById('bundlesWrap');
        const other = document.getElementById('capsulesWrap');
        if (!wrap || !other) return;

        const last = Number(localStorage.getItem('tc_bundles_height') || '45'); // %
        if (open) {
          wrap.classList.remove('is-collapsed');
          if (window.__subsplit) {
            const target = Number.isFinite(last) ? Math.min(Math.max(last, 10), 90) : 45;
            window.__subsplit.setSizes([target, 100 - target]);
            localStorage.setItem('tc_split_sub', JSON.stringify([target, 100 - target]));
          }
          localStorage.setItem('tc_bundles_open', '1');
        } else {
          // remember then collapse to 0
          if (window.__subsplit) {
            const [curTop] = window.__subsplit.getSizes();
            localStorage.setItem('tc_bundles_height', String(curTop));
            window.__subsplit.setSizes([0, 100]);
            localStorage.setItem('tc_split_sub', JSON.stringify([0, 100]));
          }
          wrap.classList.add('is-collapsed');
          localStorage.setItem('tc_bundles_open', '0');
        }
        if (!opts.silent) updateGutterVisibility();
      }

      function setCapsulesOpen(open, opts={}) {
        const wrap = document.getElementById('capsulesWrap');
        if (!wrap) return;

        // body = everything except the header row (keep header visible)
        const bodyNodes = Array.from(wrap.children).filter(n => !n.classList.contains('section-title'));

        const last = Number(localStorage.getItem('tc_capsules_height') || '55'); // %

        if (open) {
          wrap.classList.remove('is-collapsed');
          bodyNodes.forEach(n => n.hidden = false);
          if (window.__subsplit) {
            const target = Number.isFinite(last) ? Math.min(Math.max(last, 10), 90) : 55;
            window.__subsplit.setSizes([100 - target, target]);
            localStorage.setItem('tc_split_sub', JSON.stringify([100 - target, target]));
          }
          localStorage.setItem('tc_capsules_open', '1');
        } else {
          // hide body and collapse bottom pane to 0
          bodyNodes.forEach(n => n.hidden = true);
          if (window.__subsplit) {
            const [, curBot] = window.__subsplit.getSizes();
            localStorage.setItem('tc_capsules_height', String(curBot));
            window.__subsplit.setSizes([100, 0]);
            localStorage.setItem('tc_split_sub', JSON.stringify([100, 0]));
          }
          wrap.classList.add('is-collapsed');
          localStorage.setItem('tc_capsules_open', '0');
        }
        if (!opts.silent) updateGutterVisibility();
      }

      // Hook up header clicks
      (function wireCollapsers() {
        const bundlesHeader = document.querySelector('#bundlesWrap .section-title');
        if (bundlesHeader) {
          bundlesHeader.addEventListener('click', (e) => {
            // ignore clicks on dedicated buttons if you have them
            if (e.target.closest('#bundlesToggle')) return;
            const open = localStorage.getItem('tc_bundles_open') !== '0';
            setBundlesOpen(!open);
          });
        }

        const capsulesHeader = document.querySelector('#capsulesWrap .section-title');
        if (capsulesHeader) {
          capsulesHeader.addEventListener('click', (e) => {
            if (e.target.closest('#expandAllBtn, #collapseAllBtn')) return; // keep those working
            const open = localStorage.getItem('tc_capsules_open') !== '0';
            setCapsulesOpen(!open);
          });
        }

        // Initial restore
        const bundlesOpen = localStorage.getItem('tc_bundles_open') !== '0';
        setBundlesOpen(bundlesOpen, {silent:true});
        const capsulesOpen = localStorage.getItem('tc_capsules_open') !== '0';
        setCapsulesOpen(capsulesOpen, {silent:true});
        updateGutterVisibility();
      })();



      window.addEventListener('load', () => {
        const p = localStorage.getItem('tc_profile'); if (p && DATA.profiles[p]) $('profiles').value = p;
        $('includePed').checked = localStorage.getItem('tc_inc_ped') !== '0';
        $('markdown').checked = localStorage.getItem('tc_md') === '1';
      });

      (function profileHelp() {
        const sel = document.getElementById('profiles');
        const desc = document.getElementById('profileDesc');
        const help = document.getElementById('profileHelp');
        const btn = document.getElementById('profileInfo');

        // Always show the selected profile's description (from <option data-desc="...">)
        function renderDesc() {
          if (!sel || !desc) return;
          const opt = sel.options[sel.selectedIndex];
          const d = opt && opt.dataset ? (opt.dataset.desc || '').trim() : '';
          desc.textContent = d ? ` -  ${d}` : '';   // always visible, empty if none
        }

        // Wire events (guarded)
        if (sel) {
          sel.addEventListener('change', renderDesc);
          // Schedule initial render after options are populated by your code
          requestAnimationFrame(renderDesc);
        }

        // Help button toggles the explanatory panel (general concept of profiles)
        if (btn && help) {
          btn.addEventListener('click', () => {
            const hidden = help.hasAttribute('hidden');
            if (hidden) help.removeAttribute('hidden'); else help.setAttribute('hidden', '');
            btn.setAttribute('aria-expanded', String(hidden));
          });
        }
      })();

      function toggleAllDomainGroups(open) {
        document.querySelectorAll('#capsules details.domain-group').forEach(d => {
          d.open = open;
          const dom =
            d.dataset.domain ||
            (d.querySelector('.domain-title')?.textContent || 'misc');
          setDomainOpen(dom, open);
        });
      }

      $('expandAllBtn').addEventListener('click', () => toggleAllDomainGroups(true));
      $('collapseAllBtn').addEventListener('click', () => toggleAllDomainGroups(false));


      /* Close <details.menu> when clicking elsewhere, Esc, or when another opens */
      (function menuCloser() {
        const menus = () => Array.from(document.querySelectorAll('details.menu'));

        function closeAll(except = null) {
          menus().forEach(d => { if (d !== except) d.removeAttribute('open'); });
        }

        // 1) Click anywhere: keep the menu under the click, close the rest
        document.addEventListener('click', (e) => {
          const keep = e.target.closest('details.menu');
          closeAll(keep || null);
        });

        // 2) When a menu toggles open, close the others
        // Use capture to be safe across browsers.
        document.addEventListener('toggle', (e) => {
          const el = e.target;
          if (el instanceof HTMLDetailsElement && el.classList.contains('menu') && el.open) {
            closeAll(el);
          }
        }, true);

        // 3) Esc closes all menus
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeAll();
        });

        // 4) After a menu-item is activated, close its menu (let handler run first)
        document.addEventListener('click', (e) => {
          const item = e.target.closest('.menu-item');
          if (!item) return;
          const d = item.closest('details.menu');
          if (d) setTimeout(() => d.removeAttribute('open'), 0);
        });
      })();
    </script>

    <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const modal = $('helpModal');
      const btn   = $('helpBtn');

      let lastFocus = null;

      function openModal() {
        lastFocus = document.activeElement;
        modal.hidden = false;
        modal.setAttribute('aria-hidden', 'false');
        // focus first focusable inside
        const first = modal.querySelector('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
        (first || modal).focus();
        document.addEventListener('keydown', onKey);
        document.addEventListener('click', onOutside, true);
      }

      function closeModal() {
        modal.hidden = true;
        modal.setAttribute('aria-hidden', 'true');
        document.removeEventListener('keydown', onKey);
        document.removeEventListener('click', onOutside, true);
        if (lastFocus) lastFocus.focus();
      }

      function onKey(e) {
        if (e.key === 'Escape') closeModal();
        if ((e.key === '?' ) || (e.key === '/' && e.shiftKey)) {
          // prevent typing '?' in inputs from re-opening
          const t = e.target;
          if (t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable)) return;
          e.preventDefault(); e.stopPropagation();
          if (modal.hidden) openModal();
        }
      }

      function onOutside(e) {
        if (e.target.closest('[data-close]')) { e.preventDefault(); closeModal(); return; }
        if (!e.target.closest('.modal-card') && !modal.hidden) closeModal();
      }

      // wire up
      if (btn) btn.addEventListener('click', openModal);
      // global '?' shortcut
      document.addEventListener('keydown', onKey);
    })();
    </script>


</body>

</html>