name: capsules-llm-judge
on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Profile ID (LLM judge)'
        required: true
        default: 'profile.ci_llm_judge_v1'
      bundles:
        description: 'Comma-separated bundles'
        required: true
        default: 'conversation_red_team_baseline_v1'
jobs:
  judge:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install pyyaml requests
      - name: Compose judge prompt
        run: |
          IFS=',' read -ra BARR <<< "${{ github.event.inputs.bundles }}"
          ARGS=""
          for b in "${BARR[@]}"; do ARGS="$ARGS --bundle $b"; done
          python scripts/compose_capsules_cli.py --root truth-capsules-v1             --profile "${{ github.event.inputs.profile }}"             $ARGS             --out examples/ci/judge_prompt.txt             --manifest examples/ci/judge.manifest.json
      - name: (Optional) Run model judge
        if: env.OPENAI_API_KEY != ''
        run: |
          python - << 'PY'
import os, json, requests, time
prompt = open('examples/ci/judge_prompt.txt','r',encoding='utf-8').read()
# NOTE: Replace with your preferred API endpoint/SDK.
print("Stub: would send prompt to model here.")
print(prompt[:400] + '...')
# Simulate a pass result for demo
open('examples/ci/judge_result.json','w').write(json.dumps({"score": 0.9, "verdict":"pass","justification":"demo stub"}, indent=2))
PY
      - name: Enforce judge threshold
        run: |
          if [ -f examples/ci/judge_result.json ]; then
            python - << 'PY'
import json, sys
r = json.load(open('examples/ci/judge_result.json'))
score = float(r.get('score', 0))
print("Judge score:", score)
sys.exit(0 if score >= 0.8 else 1)
PY
          else
            echo "No judge_result.json present (skipping)."
          fi
      - name: Upload judge artifacts
        uses: actions/upload-artifact@v4
        with:
          name: truth-capsules-judge
          path: |
            examples/ci/judge_prompt.txt
            examples/ci/judge.manifest.json
            examples/ci/judge_result.json
